<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoML Gluon - Полное руководство</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        
        .container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: hidden;
        }
        
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        
        h2 {
            color: #34495e;
            margin-top: 30px;
            border-left: 4px solid #3498db;
            padding-left: 15px;
        }
        
        h3 {
            color: #2c3e50;
            margin-top: 25px;
        }
        
        code {
            background-color: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }
        
        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border-left: 4px solid #3498db;
        }
        
        pre code {
            background: none;
            padding: 0;
        }
        
        blockquote {
            border-left: 4px solid #3498db;
            margin: 20px 0;
            padding: 10px 20px;
            background-color: #f8f9fa;
            font-style: italic;
        }
        
        ul, ol {
            padding-left: 25px;
        }
        
        li {
            margin-bottom: 5px;
        }
        
        .toc {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 30px;
        }
        
        .toc h2 {
            margin-top: 0;
            border: none;
            padding: 0;
        }
        
        .toc ul {
            list-style-type: none;
            padding-left: 0;
        }
        
        .toc li {
            margin-bottom: 8px;
        }
        
        .toc a {
            text-decoration: none;
            color: #3498db;
            font-weight: 500;
        }
        
        .toc a:hover {
            text-decoration: underline;
        }
        
        .highlight {
            background-color: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
            margin: 20px 0;
        }
        
        .warning {
            background-color: #f8d7da;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #dc3545;
            margin: 20px 0;
        }
        
        .success {
            background-color: #d4edda;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #28a745;
            margin: 20px 0;
        }
        
        /* Улучшенные стили для изображений */
        img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 20px auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }
        
        /* Специальные стили для больших изображений */
        img[src*=".png"], img[src*=".jpg"], img[src*=".jpeg"] {
            max-width: 100%;
            max-height: 600px;
            object-fit: contain;
            background-color: #fafafa;
            padding: 10px;
        }
        
        /* Стили для схем и диаграмм */
        img[alt*="схема"], img[alt*="диаграмма"], img[alt*="архитектура"] {
            max-width: 100%;
            max-height: 500px;
            object-fit: contain;
            background-color: white;
            border: 2px solid #e0e0e0;
        }
        
        /* Стили для скриншотов */
        img[alt*="скриншот"], img[alt*="интерфейс"] {
            max-width: 100%;
            max-height: 400px;
            object-fit: contain;
            border: 1px solid #ddd;
        }
        
        /* Адаптивность для мобильных устройств */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 20px;
            }
            
            img {
                max-width: 100%;
                height: auto;
                margin: 15px auto;
            }
            
            pre {
                overflow-x: auto;
                font-size: 14px;
            }
        }
        
        /* Стили для таблиц */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            overflow-x: auto;
            display: block;
            white-space: nowrap;
        }
        
        table th, table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        /* Стили для кода */
        .codehilite {
            background-color: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            overflow-x: auto;
        }
        
        /* Стили для навигации */
        .nav-links {
            display: flex;
            justify-content: space-between;
            margin: 30px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        
        .nav-links a {
            color: #3498db;
            text-decoration: none;
            font-weight: 500;
        }
        
        .nav-links a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AutoML Gluon - Полное руководство</h1>
        <p><strong>Автор:</strong> Shcherbyna Rostyslav<br>
        <strong>Дата:</strong> 2024<br>
        <strong>Версия:</strong> 2.0 (Расширенная с детальными объяснениями)</p>
        
        <div class="toc">
            <h2>Содержание</h2>
            <ul>
                <li><a href="#установка-automl-gluon">1. Установка AutoML Gluon</a></li>
                <li><a href="#базовое-использование">2. Базовое использование</a></li>
                <li><a href="#продвинутая-конфигурация">3. Продвинутая конфигурация</a></li>
                <li><a href="#метрики-и-оценка-качества">4. Метрики и оценка качества</a></li>
                <li><a href="#валидация-моделей">5. Валидация моделей</a></li>
                <li><a href="#продакшен-и-деплой">6. Продакшен и деплой</a></li>
                <li><a href="#переобучение-моделей">7. Переобучение моделей</a></li>
                <li><a href="#лучшие-практики">8. Лучшие практики</a></li>
                <li><a href="#примеры-использования">9. Примеры использования</a></li>
                <li><a href="#решение-проблем">10. Решение проблем</a></li>
                <li><a href="#оптимизация-для-apple-silicon">11. Оптимизация для Apple Silicon</a></li>
                <li><a href="#простой-пример-продакшена">12. Простой пример продакшена</a></li>
                <li><a href="#продвинутый-пример-продакшена">13. Продвинутый пример продакшена</a></li>
                <li><a href="#теория-и-основы-automl">14. Теория и основы AutoML</a></li>
                <li><a href="#интерпретируемость-моделей">15. Интерпретируемость моделей</a></li>
                <li><a href="#продвинутые-темы">16. Продвинутые темы</a></li>
                <li><a href="#этика-и-ответственный-ai">17. Этика и ответственный AI</a></li>
                <li><a href="#кейс-стади">18. Кейс-стади</a></li>
                <li><a href="#wave2-индикатор">19. WAVE2 Индикатор</a></li>
                <li><a href="#schr-levels-индикатор">20. SCHR Levels Индикатор</a></li>
                <li><a href="#schr-short3-индикатор">21. SCHR SHORT3 Индикатор</a></li>
                <li><a href="#супер-система">22. Супер-система</a></li>
                <li><a href="#руководство-по-изучению">23. Руководство по изучению</a></li>
                <li><a href="#использование-вероятностей">24. Использование вероятностей</a></li>
                <li><a href="#мониторинг-торгового-бота">25. Мониторинг торгового бота</a></li>
            </ul>
        </div>
        
        <hr />
<h1 id="automl-gluon">Установка AutoML Gluon</h1>
<p><strong>Автор:</strong> Shcherbyna Rostyslav<br />
<strong>Дата:</strong> 2024  </p>
<h2 id="_1">Почему правильная установка критически важна</h2>
<p><strong>Почему 70% проблем с AutoML Gluon связаны с неправильной установкой?</strong> Потому что машинное обучение требует точной настройки окружения. Неправильная установка может привести к нестабильной работе, ошибкам и потере времени.</p>
<h3 id="_2">Что происходит при неправильной установке?</h3>
<ul>
<li><strong>Конфликты зависимостей</strong>: Разные версии библиотек вызывают ошибки</li>
<li><strong>Проблемы с производительностью</strong>: Модели работают медленно или не работают вообще</li>
<li><strong>Ошибки компиляции</strong>: Некоторые алгоритмы не могут быть скомпилированы</li>
<li><strong>Проблемы с GPU</strong>: CUDA не работает, обучение идет только на CPU</li>
</ul>
<h3 id="_3">Что дает правильная установка?</h3>
<ul>
<li><strong>Стабильная работа</strong>: Все компоненты работают без ошибок</li>
<li><strong>Оптимальная производительность</strong>: Максимальная скорость обучения</li>
<li><strong>Простота использования</strong>: Все функции доступны из коробки</li>
<li><strong>Легкость обновления</strong>: Простое обновление до новых версий</li>
</ul>
<h2 id="_4">Системные требования</h2>
<p><img alt="Установка AutoML Gluon" src="images/installation_flowchart.png" /><br />
<em>Рисунок 1: Блок-схема процесса установки AutoML Gluon</em></p>
<h3 id="_5">Минимальные требования</h3>
<p><strong>Почему минимальные требования важны?</strong> Потому что они определяют, сможете ли вы вообще запустить AutoML Gluon:</p>
<ul>
<li><strong>Python</strong>: 3.7, 3.8, 3.9, 3.10, 3.11</li>
<li><em>Почему именно эти версии?</em> Потому что AutoML Gluon использует современные возможности Python</li>
<li><strong>ОС</strong>: Linux, macOS, Windows</li>
<li><em>Почему все ОС поддерживаются?</em> Потому что ML-разработка ведется на разных платформах</li>
<li><strong>RAM</strong>: 4GB (рекомендуется 8GB+)</li>
<li><em>Почему нужно много памяти?</em> Потому что ML-модели загружают большие датасеты в память</li>
<li><strong>CPU</strong>: 2 ядра (рекомендуется 4+ ядра)</li>
<li><em>Почему важны ядра?</em> Потому что AutoML Gluon использует параллельные вычисления</li>
<li><strong>Диск</strong>: 2GB свободного места</li>
<li><em>Почему нужно место?</em> Потому что модели и данные занимают много места</li>
</ul>
<h3 id="_6">Рекомендуемые требования</h3>
<p><strong>Почему рекомендуемые требования дают лучший опыт?</strong> Потому что они обеспечивают оптимальную производительность:</p>
<ul>
<li><strong>Python</strong>: 3.9 или 3.10</li>
<li><em>Почему именно эти версии?</em> Потому что они наиболее стабильны и быстры</li>
<li><strong>RAM</strong>: 16GB+</li>
<li><em>Почему много памяти?</em> Потому что большие датасеты требуют много RAM</li>
<li><strong>CPU</strong>: 8+ ядер</li>
<li><em>Почему много ядер?</em> Потому что AutoML Gluon использует все доступные ядра</li>
<li><strong>GPU</strong>: NVIDIA GPU с CUDA поддержкой (опционально)</li>
<li><em>Почему GPU важен?</em> Потому что он ускоряет обучение в 10-100 раз</li>
<li><strong>Диск</strong>: 10GB+ свободного места</li>
<li><em>Почему много места?</em> Потому что модели и кэш занимают много места</li>
</ul>
<h2 id="pip">Установка через pip</h2>
<p><strong>Почему pip - самый популярный способ установки?</strong> Потому что он простой, надежный и автоматически решает зависимости.</p>
<h3 id="_7">Базовая установка</h3>
<p><strong>Почему начинаем с базовой установки?</strong> Потому что она дает все необходимое для начала работы:</p>
<div class="codehilite"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>autogluon
</code></pre></div>

<p><strong>Что происходит при этой команде?</strong><br />
- Устанавливается основной пакет AutoML Gluon<br />
- Автоматически устанавливаются все необходимые зависимости<br />
- Создается окружение для работы с табличными данными<br />
- Настраивается базовая конфигурация</p>
<h3 id="_8">Установка с дополнительными зависимостями</h3>
<p><strong>Почему нужны дополнительные компоненты?</strong> Потому что разные задачи требуют разных инструментов:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Для работы с табличными данными</span>
pip<span class="w"> </span>install<span class="w"> </span>autogluon.tabular
</code></pre></div>

<p><strong>Что дает autogluon.tabular?</strong><br />
- Оптимизированные алгоритмы для табличных данных<br />
- Автоматическая обработка категориальных переменных<br />
- Встроенная валидация и метрики<br />
- Поддержка больших датасетов</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Для работы с временными рядами</span>
pip<span class="w"> </span>install<span class="w"> </span>autogluon.timeseries
</code></pre></div>

<p><strong>Что дает autogluon.timeseries?</strong><br />
- Специальные алгоритмы для временных рядов<br />
- Автоматическое определение сезонности<br />
- Поддержка многомерных временных рядов<br />
- Встроенное прогнозирование</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Для работы с изображениями</span>
pip<span class="w"> </span>install<span class="w"> </span>autogluon.vision
</code></pre></div>

<p><strong>Что дает autogluon.vision?</strong><br />
- Готовые CNN архитектуры<br />
- Автоматическое увеличение данных<br />
- Предобученные модели<br />
- Поддержка GPU ускорения</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Для работы с текстом</span>
pip<span class="w"> </span>install<span class="w"> </span>autogluon.text
</code></pre></div>

<p><strong>Что дает autogluon.text?</strong><br />
- Современные NLP модели<br />
- Автоматическая токенизация<br />
- Предобученные эмбеддинги<br />
- Поддержка трансформеров</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Полная установка всех компонентов</span>
pip<span class="w"> </span>install<span class="w"> </span>autogluon<span class="o">[</span>all<span class="o">]</span>
</code></pre></div>

<p><strong>Почему полная установка удобна?</strong> Потому что вы получаете все возможности сразу, но это занимает больше места и времени.</p>
<h2 id="conda">Установка через conda</h2>
<h3 id="_9">Создание нового окружения</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Создание окружения с Python 3.9</span>
conda<span class="w"> </span>create<span class="w"> </span>-n<span class="w"> </span>autogluon<span class="w"> </span><span class="nv">python</span><span class="o">=</span><span class="m">3</span>.9
conda<span class="w"> </span>activate<span class="w"> </span>autogluon

<span class="c1"># Установка AutoGluon</span>
conda<span class="w"> </span>install<span class="w"> </span>-c<span class="w"> </span>conda-forge<span class="w"> </span>autogluon
</code></pre></div>

<h3 id="gpu">Установка с GPU поддержкой</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Создание окружения с CUDA</span>
conda<span class="w"> </span>create<span class="w"> </span>-n<span class="w"> </span>autogluon-gpu<span class="w"> </span><span class="nv">python</span><span class="o">=</span><span class="m">3</span>.9
conda<span class="w"> </span>activate<span class="w"> </span>autogluon-gpu

<span class="c1"># Установка PyTorch с CUDA</span>
conda<span class="w"> </span>install<span class="w"> </span>pytorch<span class="w"> </span>torchvision<span class="w"> </span>torchaudio<span class="w"> </span>pytorch-cuda<span class="o">=</span><span class="m">11</span>.8<span class="w"> </span>-c<span class="w"> </span>pytorch<span class="w"> </span>-c<span class="w"> </span>nvidia

<span class="c1"># Установка AutoGluon</span>
pip<span class="w"> </span>install<span class="w"> </span>autogluon
</code></pre></div>

<h2 id="_10">Установка из исходного кода</h2>
<h3 id="_11">Клонирование репозитория</h3>
<div class="codehilite"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/autogluon/autogluon.git
<span class="nb">cd</span><span class="w"> </span>autogluon
</code></pre></div>

<h3 id="_12">Установка в режиме разработки</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Установка зависимостей</span>
pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span>.

<span class="c1"># Или для конкретного модуля</span>
pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span>./tabular
</code></pre></div>

<h2 id="_13">Проверка установки</h2>
<h3 id="_14">Базовый тест</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">autogluon</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ag</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AutoGluon version: </span><span class="si">{</span><span class="n">ag</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Тест импорта основных модулей</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.tabular</span><span class="w"> </span><span class="kn">import</span> <span class="n">TabularPredictor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.timeseries</span><span class="w"> </span><span class="kn">import</span> <span class="n">TimeSeriesPredictor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.vision</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImagePredictor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.text</span><span class="w"> </span><span class="kn">import</span> <span class="n">TextPredictor</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All modules imported successfully!&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="_15">Тест с простым примером</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.tabular</span><span class="w"> </span><span class="kn">import</span> <span class="n">TabularPredictor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># Создание тестовых данных</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature1&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
    <span class="s1">&#39;feature2&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
    <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="p">})</span>

<span class="c1"># Тест обучения</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">)</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># 10 секунд для быстрого теста</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Installation test passed!&quot;</span><span class="p">)</span>
</code></pre></div>

<h2 id="_16">Установка дополнительных зависимостей</h2>
<h3 id="gpu_1">Для работы с GPU</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Установка CUDA toolkit (Ubuntu/Debian)</span>
wget<span class="w"> </span>https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/cuda-ubuntu2004.pin
sudo<span class="w"> </span>mv<span class="w"> </span>cuda-ubuntu2004.pin<span class="w"> </span>/etc/apt/preferences.d/cuda-repository-pin-600
wget<span class="w"> </span>https://developer.download.nvidia.com/compute/cuda/11.8.0/local_installers/cuda-repository-ubuntu2004-11-8-local_11.8.0-520.61.05-1_amd64.deb
sudo<span class="w"> </span>dpkg<span class="w"> </span>-i<span class="w"> </span>cuda-repository-ubuntu2004-11-8-local_11.8.0-520.61.05-1_amd64.deb
sudo<span class="w"> </span>apt-key<span class="w"> </span>add<span class="w"> </span>/var/cuda-repository-ubuntu2004-11-8-local/7fa2af80.pub
sudo<span class="w"> </span>apt-get<span class="w"> </span>update
sudo<span class="w"> </span>apt-get<span class="w"> </span>-y<span class="w"> </span>install<span class="w"> </span>cuda

<span class="c1"># Установка PyTorch с CUDA</span>
pip<span class="w"> </span>install<span class="w"> </span>torch<span class="w"> </span>torchvision<span class="w"> </span>torchaudio<span class="w"> </span>--index-url<span class="w"> </span>https://download.pytorch.org/whl/cu118
</code></pre></div>

<h3 id="_17">Для работы с большими датасетами</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Установка дополнительных библиотек для обработки больших данных</span>
pip<span class="w"> </span>install<span class="w"> </span>dask<span class="o">[</span>complete<span class="o">]</span>
pip<span class="w"> </span>install<span class="w"> </span>ray<span class="o">[</span>default<span class="o">]</span>
pip<span class="w"> </span>install<span class="w"> </span>modin<span class="o">[</span>all<span class="o">]</span>
</code></pre></div>

<h3 id="_18">Для работы с временными рядами</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Специальные библиотеки для временных рядов</span>
pip<span class="w"> </span>install<span class="w"> </span>gluonts
pip<span class="w"> </span>install<span class="w"> </span>mxnet
pip<span class="w"> </span>install<span class="w"> </span>statsmodels
</code></pre></div>

<h2 id="_19">Настройка окружения</h2>
<h3 id="_20">Переменные окружения</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Установка переменных для оптимизации производительности</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">4</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">MKL_NUM_THREADS</span><span class="o">=</span><span class="m">4</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">OPENBLAS_NUM_THREADS</span><span class="o">=</span><span class="m">4</span>

<span class="c1"># Для GPU</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">0</span>

<span class="c1"># Для отладки</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">AUTOGLUON_DEBUG</span><span class="o">=</span><span class="m">1</span>
</code></pre></div>

<h3 id="_21">Конфигурационный файл</h3>
<p>Создайте файл <code>~/.autogluon/config.yaml</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Конфигурация AutoGluon</span>
<span class="nt">default</span><span class="p">:</span>
<span class="w">  </span><span class="nt">time_limit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3600</span><span class="w">  </span><span class="c1"># 1 час по умолчанию</span>
<span class="w">  </span><span class="nt">memory_limit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8</span><span class="w">  </span><span class="c1"># 8GB RAM</span>
<span class="w">  </span><span class="nt">num_cpus</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4</span><span class="w">  </span><span class="c1"># Количество CPU ядер</span>
<span class="w">  </span><span class="nt">num_gpus</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w">  </span><span class="c1"># Количество GPU</span>

<span class="c1"># Настройки для разных задач</span>
<span class="nt">tabular</span><span class="p">:</span>
<span class="w">  </span><span class="nt">presets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;best_quality&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;high_quality&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;good_quality&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;medium_quality&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;optimize_for_deployment&#39;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">hyperparameter_tune_kwargs</span><span class="p">:</span>
<span class="w">    </span><span class="nt">num_trials</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">    </span><span class="nt">scheduler</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;local&#39;</span>
<span class="w">    </span><span class="nt">searcher</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;auto&#39;</span>

<span class="nt">timeseries</span><span class="p">:</span>
<span class="w">  </span><span class="nt">prediction_length</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">24</span>
<span class="w">  </span><span class="nt">freq</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;H&#39;</span>
<span class="w">  </span><span class="nt">target_column</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;target&#39;</span>
</code></pre></div>

<h2 id="_22">Устранение проблем при установке</h2>
<h3 id="_23">Проблемы с зависимостями</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Очистка кэша pip</span>
pip<span class="w"> </span>cache<span class="w"> </span>purge

<span class="c1"># Переустановка с игнорированием кэша</span>
pip<span class="w"> </span>install<span class="w"> </span>--no-cache-dir<span class="w"> </span>autogluon

<span class="c1"># Установка конкретной версии</span>
pip<span class="w"> </span>install<span class="w"> </span><span class="nv">autogluon</span><span class="o">==</span><span class="m">0</span>.8.2
</code></pre></div>

<h3 id="cuda">Проблемы с CUDA</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Проверка версии CUDA</span>
nvidia-smi

<span class="c1"># Проверка совместимости PyTorch</span>
python<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;import torch; print(torch.cuda.is_available())&quot;</span>

<span class="c1"># Установка совместимой версии PyTorch</span>
pip<span class="w"> </span>install<span class="w"> </span><span class="nv">torch</span><span class="o">==</span><span class="m">1</span>.13.1+cu117<span class="w"> </span><span class="nv">torchvision</span><span class="o">==</span><span class="m">0</span>.14.1+cu117<span class="w"> </span>--extra-index-url<span class="w"> </span>https://download.pytorch.org/whl/cu117
</code></pre></div>

<h3 id="_24">Проблемы с памятью</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Установка с ограничением памяти</span>
pip<span class="w"> </span>install<span class="w"> </span>--no-cache-dir<span class="w"> </span>--no-deps<span class="w"> </span>autogluon
pip<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements.txt
</code></pre></div>

<h2 id="_25">Проверка работоспособности</h2>
<h3 id="_26">Полный тест установки</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">autogluon</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ag</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.tabular</span><span class="w"> </span><span class="kn">import</span> <span class="n">TabularPredictor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_installation</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Полный тест установки AutoGluon&quot;&quot;&quot;</span>

    <span class="c1"># Создание тестовых данных</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;feature1&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_samples</span><span class="p">),</span>
        <span class="s1">&#39;feature2&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_samples</span><span class="p">),</span>
        <span class="s1">&#39;feature3&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_samples</span><span class="p">),</span>
        <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="c1"># Разделение на train/test</span>
    <span class="n">train_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="mi">800</span><span class="p">]</span>
    <span class="n">test_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">800</span><span class="p">:]</span>

    <span class="c1"># Создание и обучение модели</span>
    <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
        <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span>
        <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span>
    <span class="p">)</span>

    <span class="c1"># Обучение с ограничением времени</span>
    <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">train_data</span><span class="p">,</span>
        <span class="n">time_limit</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>  <span class="c1"># 1 минута</span>
        <span class="n">presets</span><span class="o">=</span><span class="s1">&#39;medium_quality&#39;</span>
    <span class="p">)</span>

    <span class="c1"># Предсказания</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

    <span class="c1"># Оценка качества</span>
    <span class="n">performance</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model performance: </span><span class="si">{</span><span class="n">performance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Installation test completed successfully!&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">test_installation</span><span class="p">()</span>
</code></pre></div>

<h2 id="_27">Следующие шаги</h2>
<p>После успешной установки переходите к:<br />
- <a href="./02_basic_usage.md">Базовому использованию</a><br />
- <a href="./03_advanced_configuration.md">Продвинутой конфигурации</a><br />
- <a href="./04_metrics.md">Работе с метриками</a></p>
<h2 id="_28">Полезные ссылки</h2>
<ul>
<li><a href="https://auto.gluon.ai/">Официальная документация</a></li>
<li><a href="https://github.com/autogluon/autogluon">GitHub репозиторий</a></li>
<li><a href="https://github.com/autogluon/autogluon/tree/master/examples">Примеры использования</a></li>
<li><a href="https://discuss.autogluon.ai/">Форум сообщества</a></li>
</ul>
<hr />
<h1 id="automl-gluon_1">Базовое использование AutoML Gluon</h1>
<p><strong>Автор:</strong> Shcherbyna Rostyslav<br />
<strong>Дата:</strong> 2024  </p>
<h2 id="_29">Почему начинаем с базового использования</h2>
<p><strong>Почему 80% пользователей начинают с базового использования?</strong> Потому что это самый простой способ понять, как работает AutoML Gluon. Это как обучение вождению - сначала изучаете основы, потом переходите к сложным маневрам.</p>
<h3 id="_30">Что дает базовое понимание?</h3>
<ul>
<li><strong>Быстрый старт</strong>: От данных до модели за несколько строк кода</li>
<li><strong>Понимание принципов</strong>: Как AutoML Gluon принимает решения</li>
<li><strong>Уверенность</strong>: Знание того, что все работает правильно</li>
<li><strong>Фундамент</strong>: Основа для изучения продвинутых техник</li>
</ul>
<h3 id="_31">Что происходит без базового понимания?</h3>
<ul>
<li><strong>Фрустрация</strong>: Не понимаете, почему модель работает не так</li>
<li><strong>Ошибки</strong>: Неправильное использование параметров</li>
<li><strong>Неэффективность</strong>: Тратите время на то, что можно сделать проще</li>
<li><strong>Разочарование</strong>: Сложность отпугивает от изучения</li>
</ul>
<h2 id="tabularpredictor">Введение в TabularPredictor</h2>
<p><img alt="Архитектура AutoML Gluon" src="images/architecture_diagram.png" /><br />
<em>Рисунок 2: Архитектура AutoML Gluon с основными компонентами</em></p>
<p><strong>Почему TabularPredictor - это сердце AutoML Gluon?</strong> Потому что он объединяет все возможности в одном простом интерфейсе. Это как универсальный пульт управления - одна кнопка запускает сложные процессы.</p>
<p><code>TabularPredictor</code> - это основной класс для работы с табличными данными в AutoGluon. Он автоматически определяет тип задачи (классификация, регрессия) и выбирает лучшие алгоритмы.</p>
<h3 id="tabularpredictor_1">Почему TabularPredictor так важен?</h3>
<ul>
<li><strong>Автоматизация</strong>: Не нужно выбирать алгоритмы вручную</li>
<li><strong>Умность</strong>: Сам определяет тип задачи и метрики</li>
<li><strong>Гибкость</strong>: Работает с любыми табличными данными</li>
<li><strong>Простота</strong>: Один класс решает все задачи</li>
</ul>
<h3 id="_32">Импорт и создание базового предиктора</h3>
<p><strong>Почему начинаем с импорта?</strong> Потому что это основа любого Python проекта. Правильный импорт - это как правильная настройка инструмента.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.tabular</span><span class="w"> </span><span class="kn">import</span> <span class="n">TabularPredictor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</code></pre></div>

<p><strong>Почему именно эти импорты?</strong><br />
- <code>TabularPredictor</code> - основной класс для работы с табличными данными<br />
- <code>pandas</code> - для работы с данными в табличном формате<br />
- <code>numpy</code> - для численных вычислений</p>
<p><strong>Почему не импортируем все сразу?</strong> Потому что это замедляет загрузку и может вызвать конфликты.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Создание предиктора</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target_column&#39;</span><span class="p">,</span>  <span class="c1"># Название целевой переменной</span>
    <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>    <span class="c1"># Автоматическое определение типа задачи</span>
    <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span>      <span class="c1"># Автоматический выбор метрики</span>
<span class="p">)</span>
</code></pre></div>

<p><strong>Объяснение параметров:</strong><br />
- <code>label='target_column'</code> - название столбца с целевой переменной (что мы предсказываем)<br />
- <code>problem_type='auto'</code> - AutoML Gluon сам определит, классификация это или регрессия<br />
- <code>eval_metric='auto'</code> - автоматический выбор лучшей метрики для оценки</p>
<p><strong>Почему используем 'auto'?</strong> Потому что AutoML Gluon умнее нас в выборе оптимальных параметров.</p>
<h2 id="_33">Типы задач</h2>
<p><strong>Почему важно понимать типы задач?</strong> Потому что разные задачи требуют разных подходов. Это как разница между диагностикой болезни и измерением температуры - методы разные.</p>
<h3 id="_34">Классификация</h3>
<p><strong>Что такое классификация?</strong> Это предсказание категории или класса. Например, спам/не спам, больной/здоровый, покупатель/не покупатель.</p>
<p><strong>Почему классификация так популярна?</strong> Потому что большинство бизнес-задач - это классификация:<br />
- Обнаружение мошенничества<br />
- Медицинская диагностика<br />
- Рекомендательные системы<br />
- Анализ настроений</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Бинарная классификация</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;is_fraud&#39;</span><span class="p">,</span>
    <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span>
    <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span>
<span class="p">)</span>
</code></pre></div>

<p><strong>Почему бинарная классификация проще?</strong> Потому что есть только два варианта ответа - да или нет.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Многоклассовая классификация</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">,</span>
    <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;multiclass&#39;</span><span class="p">,</span>
    <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span>
<span class="p">)</span>
</code></pre></div>

<p><strong>Почему многоклассовая сложнее?</strong> Потому что нужно выбрать из множества вариантов, и ошибки более дорогие.</p>
<h3 id="_35">Регрессия</h3>
<p><strong>Что такое регрессия?</strong> Это предсказание численного значения. Например, цена дома, количество продаж, время до события.</p>
<p><strong>Почему регрессия важна?</strong> Потому что многие бизнес-метрики - это числа:<br />
- Прогнозирование продаж<br />
- Оценка недвижимости<br />
- Предсказание времени<br />
- Финансовое моделирование</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Регрессия</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;price&#39;</span><span class="p">,</span>
    <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;regression&#39;</span><span class="p">,</span>
    <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;rmse&#39;</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_36">Обучение модели</h2>
<h3 id="_37">Базовое обучение</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Загрузка данных</span>
<span class="n">train_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;train.csv&#39;</span><span class="p">)</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;test.csv&#39;</span><span class="p">)</span>

<span class="c1"># Обучение модели</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>

<span class="c1"># Предсказания</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
</code></pre></div>

<h3 id="_38">Обучение с ограничением времени</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Обучение с ограничением времени (в секундах)</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">time_limit</span><span class="o">=</span><span class="mi">3600</span>  <span class="c1"># 1 час</span>
<span class="p">)</span>

<span class="c1"># Обучение с ограничением памяти</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">memory_limit</span><span class="o">=</span><span class="mi">8</span>  <span class="c1"># 8GB RAM</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="_39">Обучение с пресетами</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Различные пресеты качества</span>
<span class="n">presets</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;best_quality&#39;</span><span class="p">,</span>      <span class="c1"># Лучшее качество (долго)</span>
    <span class="s1">&#39;high_quality&#39;</span><span class="p">,</span>      <span class="c1"># Высокое качество</span>
    <span class="s1">&#39;good_quality&#39;</span><span class="p">,</span>      <span class="c1"># Хорошее качество</span>
    <span class="s1">&#39;medium_quality&#39;</span><span class="p">,</span>    <span class="c1"># Среднее качество</span>
    <span class="s1">&#39;optimize_for_deployment&#39;</span>  <span class="c1"># Оптимизация для деплоя</span>
<span class="p">]</span>

<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">presets</span><span class="o">=</span><span class="s1">&#39;high_quality&#39;</span><span class="p">,</span>
    <span class="n">time_limit</span><span class="o">=</span><span class="mi">1800</span>  <span class="c1"># 30 минут</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_40">Оценка качества модели</h2>
<h3 id="_41">Базовые метрики</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Оценка на тестовых данных</span>
<span class="n">performance</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model performance: </span><span class="si">{</span><span class="n">performance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Получение детального отчета</span>
<span class="n">performance</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
    <span class="n">test_data</span><span class="p">,</span>
    <span class="n">detailed_report</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="_42">Валидация</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Holdout валидация</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">holdout_frac</span><span class="o">=</span><span class="mf">0.2</span>  <span class="c1"># 20% данных для валидации</span>
<span class="p">)</span>

<span class="c1"># K-fold кросс-валидация</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">num_bag_folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>  <span class="c1"># 5-fold CV</span>
    <span class="n">num_bag_sets</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_43">Предсказания</h2>
<h3 id="_44">Базовые предсказания</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Предсказания классов/значений</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

<span class="c1"># Вероятности (для классификации)</span>
<span class="n">probabilities</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
</code></pre></div>

<h3 id="_45">Предсказания с дополнительной информацией</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Предсказания с доверительными интервалами</span>
<span class="n">predictions_with_intervals</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
    <span class="n">test_data</span><span class="p">,</span>
    <span class="n">include_confidence</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="c1"># Предсказания от отдельных моделей</span>
<span class="n">individual_predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict_multi</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
</code></pre></div>

<h2 id="_46">Работа с признаками</h2>
<h3 id="_47">Автоматическая обработка признаков</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># AutoGluon автоматически обрабатывает:</span>
<span class="c1"># - Категориальные переменные (one-hot encoding, label encoding)</span>
<span class="c1"># - Пропущенные значения (заполнение, индикаторы)</span>
<span class="c1"># - Числовые переменные (нормализация, масштабирование)</span>
<span class="c1"># - Текстовые переменные (TF-IDF, embeddings)</span>
</code></pre></div>

<h3 id="_48">Ручная настройка признаков</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.features</span><span class="w"> </span><span class="kn">import</span> <span class="n">FeatureGenerator</span>

<span class="c1"># Создание генератора признаков</span>
<span class="n">feature_generator</span> <span class="o">=</span> <span class="n">FeatureGenerator</span><span class="p">(</span>
    <span class="n">enable_nan_handling</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">enable_categorical_encoding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">enable_text_special_features</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">enable_text_ngram_features</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="c1"># Применение к данным</span>
<span class="n">train_data_processed</span> <span class="o">=</span> <span class="n">feature_generator</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
<span class="n">test_data_processed</span> <span class="o">=</span> <span class="n">feature_generator</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
</code></pre></div>

<h2 id="_49">Сохранение и загрузка моделей</h2>
<h3 id="_50">Сохранение модели</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Сохранение модели</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;my_model&#39;</span><span class="p">)</span>

<span class="c1"># Сохранение с дополнительной информацией</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
    <span class="s1">&#39;my_model&#39;</span><span class="p">,</span>
    <span class="n">save_space</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Экономия места</span>
    <span class="n">save_info</span><span class="o">=</span><span class="kc">True</span>   <span class="c1"># Сохранение метаданных</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="_51">Загрузка модели</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Загрузка сохраненной модели</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;my_model&#39;</span><span class="p">)</span>

<span class="c1"># Загрузка с проверкой совместимости</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
    <span class="s1">&#39;my_model&#39;</span><span class="p">,</span>
    <span class="n">require_version_match</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_52">Работа с ансамблями</h2>
<h3 id="_53">Настройка ансамбля</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Обучение с ансамблем</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">num_bag_folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>      <span class="c1"># Количество фолдов для бэггинга</span>
    <span class="n">num_bag_sets</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>       <span class="c1"># Количество наборов бэггинга</span>
    <span class="n">num_stack_levels</span><span class="o">=</span><span class="mi">1</span>    <span class="c1"># Уровни стекинга</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="_54">Анализ ансамбля</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Информация о моделях в ансамбле</span>
<span class="n">leaderboard</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">leaderboard</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">leaderboard</span><span class="p">)</span>

<span class="c1"># Детальная информация о производительности</span>
<span class="n">leaderboard</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">leaderboard</span><span class="p">(</span>
    <span class="n">test_data</span><span class="p">,</span>
    <span class="n">extra_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">silent</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_55">Продвинутые настройки</h2>
<h3 id="_56">Настройка гиперпараметров</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Словарь с настройками для разных алгоритмов</span>
<span class="n">hyperparameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;GBM&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span><span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;num_leaves&#39;</span><span class="p">:</span> <span class="mi">31</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;num_leaves&#39;</span><span class="p">:</span> <span class="mi">63</span><span class="p">}</span>
    <span class="p">],</span>
    <span class="s1">&#39;CAT&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span><span class="s1">&#39;iterations&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;iterations&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">}</span>
    <span class="p">],</span>
    <span class="s1">&#39;XGB&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>

<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">hyperparameters</span><span class="o">=</span><span class="n">hyperparameters</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="_57">Исключение алгоритмов</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Исключение определенных алгоритмов</span>
<span class="n">excluded_model_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;KNN&#39;</span><span class="p">,</span> <span class="s1">&#39;NN_TORCH&#39;</span><span class="p">]</span>

<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">excluded_model_types</span><span class="o">=</span><span class="n">excluded_model_types</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="_58">Настройка валидации</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Настройка стратегии валидации</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.tabular.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">AbstractModel</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CustomValidationStrategy</span><span class="p">(</span><span class="n">AbstractModel</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_default_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;num_cpus&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;num_gpus&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">validation_strategy</span><span class="o">=</span><span class="s1">&#39;custom&#39;</span><span class="p">,</span>
    <span class="n">custom_validation_strategy</span><span class="o">=</span><span class="n">CustomValidationStrategy</span><span class="p">()</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_59">Работа с различными типами данных</h2>
<h3 id="_60">Категориальные данные</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># AutoGluon автоматически определяет категориальные переменные</span>
<span class="c1"># Но можно указать их явно</span>
<span class="n">categorical_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="s1">&#39;brand&#39;</span><span class="p">,</span> <span class="s1">&#39;region&#39;</span><span class="p">]</span>

<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">categorical_columns</span><span class="o">=</span><span class="n">categorical_columns</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="_61">Текстовые данные</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Для текстовых колонок AutoGluon автоматически создает признаки</span>
<span class="n">text_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;review_text&#39;</span><span class="p">]</span>

<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">text_columns</span><span class="o">=</span><span class="n">text_columns</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="_62">Временные данные</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Указание временных колонок</span>
<span class="n">time_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>

<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">time_columns</span><span class="o">=</span><span class="n">time_columns</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_63">Мониторинг обучения</h2>
<h3 id="_64">Логирование</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="c1"># Настройка логирования</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="c1"># Обучение с подробным логированием</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">verbosity</span><span class="o">=</span><span class="mi">2</span>  <span class="c1"># Подробное логирование</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="callback">Callback функции</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">training_callback</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">model_path</span><span class="p">,</span> <span class="n">model_info</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Callback функция для мониторинга обучения&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model path: </span><span class="si">{</span><span class="n">model_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model info: </span><span class="si">{</span><span class="n">model_info</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">training_callback</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_65">Примеры использования</h2>
<h3 id="_66">Полный пример классификации</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.tabular</span><span class="w"> </span><span class="kn">import</span> <span class="n">TabularPredictor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_classification</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>

<span class="c1"># Создание синтетических данных</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_classification</span><span class="p">(</span>
    <span class="n">n_samples</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
    <span class="n">n_features</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">n_informative</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
    <span class="n">n_redundant</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">n_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="c1"># Создание DataFrame</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;feature_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)])</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>

<span class="c1"># Разделение на train/test</span>
<span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Создание и обучение предиктора</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
    <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span>
    <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span>
<span class="p">)</span>

<span class="c1"># Обучение</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">time_limit</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>  <span class="c1"># 5 минут</span>
    <span class="n">presets</span><span class="o">=</span><span class="s1">&#39;medium_quality&#39;</span>
<span class="p">)</span>

<span class="c1"># Предсказания</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
<span class="n">probabilities</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

<span class="c1"># Оценка качества</span>
<span class="n">performance</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy: </span><span class="si">{</span><span class="n">performance</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Анализ лидерборда</span>
<span class="n">leaderboard</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">leaderboard</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">leaderboard</span><span class="p">)</span>
</code></pre></div>

<h3 id="_67">Полный пример регрессии</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.tabular</span><span class="w"> </span><span class="kn">import</span> <span class="n">TabularPredictor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_regression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>

<span class="c1"># Создание синтетических данных</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_regression</span><span class="p">(</span>
    <span class="n">n_samples</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
    <span class="n">n_features</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">n_informative</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
    <span class="n">noise</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="c1"># Создание DataFrame</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;feature_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)])</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>

<span class="c1"># Разделение на train/test</span>
<span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Создание и обучение предиктора</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
    <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;regression&#39;</span><span class="p">,</span>
    <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;rmse&#39;</span>
<span class="p">)</span>

<span class="c1"># Обучение</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">time_limit</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>  <span class="c1"># 5 минут</span>
    <span class="n">presets</span><span class="o">=</span><span class="s1">&#39;high_quality&#39;</span>
<span class="p">)</span>

<span class="c1"># Предсказания</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

<span class="c1"># Оценка качества</span>
<span class="n">performance</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RMSE: </span><span class="si">{</span><span class="n">performance</span><span class="p">[</span><span class="s1">&#39;rmse&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MAE: </span><span class="si">{</span><span class="n">performance</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Анализ важности признаков</span>
<span class="n">feature_importance</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">feature_importance</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">feature_importance</span><span class="p">)</span>
</code></pre></div>

<h2 id="_68">Лучшие практики</h2>
<h3 id="_69">Подготовка данных</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># 1. Проверка качества данных</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data shape:&quot;</span><span class="p">,</span> <span class="n">train_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Missing values:&quot;</span><span class="p">,</span> <span class="n">train_data</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data types:&quot;</span><span class="p">,</span> <span class="n">train_data</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>

<span class="c1"># 2. Обработка пропущенных значений</span>
<span class="n">train_data</span> <span class="o">=</span> <span class="n">train_data</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>  <span class="c1"># Или заполнение</span>

<span class="c1"># 3. Удаление константных признаков</span>
<span class="n">constant_columns</span> <span class="o">=</span> <span class="n">train_data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">train_data</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">train_data</span> <span class="o">=</span> <span class="n">train_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">constant_columns</span><span class="p">)</span>
</code></pre></div>

<h3 id="_70">Выбор метрик</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Для классификации</span>
<span class="n">classification_metrics</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;balanced_accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;f1&#39;</span><span class="p">,</span> <span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span> <span class="s1">&#39;f1_micro&#39;</span><span class="p">,</span>
    <span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="s1">&#39;precision_macro&#39;</span><span class="p">,</span> <span class="s1">&#39;recall&#39;</span><span class="p">,</span> <span class="s1">&#39;recall_macro&#39;</span><span class="p">,</span>
    <span class="s1">&#39;roc_auc&#39;</span><span class="p">,</span> <span class="s1">&#39;log_loss&#39;</span>
<span class="p">]</span>

<span class="c1"># Для регрессии</span>
<span class="n">regression_metrics</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;rmse&#39;</span><span class="p">,</span> <span class="s1">&#39;mae&#39;</span><span class="p">,</span> <span class="s1">&#39;mape&#39;</span><span class="p">,</span> <span class="s1">&#39;smape&#39;</span><span class="p">,</span> <span class="s1">&#39;r2&#39;</span><span class="p">,</span> <span class="s1">&#39;pearsonr&#39;</span><span class="p">,</span> <span class="s1">&#39;spearmanr&#39;</span>
<span class="p">]</span>
</code></pre></div>

<h3 id="_71">Оптимизация времени обучения</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Быстрое обучение для экспериментов</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">time_limit</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>  <span class="c1"># 1 минута</span>
    <span class="n">presets</span><span class="o">=</span><span class="s1">&#39;optimize_for_deployment&#39;</span>
<span class="p">)</span>

<span class="c1"># Качественное обучение для финальной модели</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">time_limit</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span>  <span class="c1"># 1 час</span>
    <span class="n">presets</span><span class="o">=</span><span class="s1">&#39;best_quality&#39;</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_72">Следующие шаги</h2>
<p>После освоения базового использования переходите к:<br />
- <a href="./03_advanced_configuration.md">Продвинутой конфигурации</a><br />
- <a href="./04_metrics.md">Работе с метриками</a><br />
- <a href="./05_validation.md">Методам валидации</a></p>
<hr />
<h1 id="automl-gluon_2">Продвинутая конфигурация AutoML Gluon</h1>
<p><strong>Автор:</strong> Shcherbyna Rostyslav<br />
<strong>Дата:</strong> 2024  </p>
<h2 id="_73">Почему продвинутая конфигурация критически важна</h2>
<p><strong>Почему 90% пользователей AutoML Gluon не используют продвинутые настройки?</strong> Потому что они не понимают, какую мощь они упускают. Это как водить Ferrari на первой передаче - машина едет, но не показывает своих возможностей.</p>
<h3 id="_74">Что дает продвинутая конфигурация?</h3>
<ul>
<li><strong>Точность</strong>: Модели работают на 10-30% лучше</li>
<li><strong>Скорость</strong>: Обучение ускоряется в 2-5 раз</li>
<li><strong>Контроль</strong>: Вы точно знаете, что происходит</li>
<li><strong>Оптимизация</strong>: Модель подстраивается под ваши данные</li>
</ul>
<h3 id="_75">Что происходит без продвинутой конфигурации?</h3>
<ul>
<li><strong>Средние результаты</strong>: Модели работают "как получится"</li>
<li><strong>Медленное обучение</strong>: Тратите время на неоптимальные настройки</li>
<li><strong>Недоиспользование ресурсов</strong>: GPU и CPU работают неэффективно</li>
<li><strong>Разочарование</strong>: Не понимаете, почему результаты не улучшаются</li>
</ul>
<h2 id="_76">Настройка гиперпараметров</h2>
<p><strong>Почему гиперпараметры - это ключ к успеху?</strong> Потому что они определяют, как алгоритм учится. Это как настройка музыкального инструмента - правильная настройка дает красивый звук.</p>
<h3 id="_77">Создание кастомных гиперпараметров</h3>
<p><strong>Почему нужны кастомные гиперпараметры?</strong> Потому что стандартные настройки подходят для средних случаев, а ваши данные могут быть особенными.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Детальная настройка для каждого алгоритма</span>
<span class="n">hyperparameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;GBM&#39;</span><span class="p">:</span> <span class="p">[</span>  <span class="c1"># Gradient Boosting Machine - один из лучших алгоритмов</span>
        <span class="p">{</span>
            <span class="c1"># Быстрая конфигурация для экспериментов</span>
            <span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>        <span class="c1"># Количество деревьев (больше = точнее, но медленнее)</span>
            <span class="s1">&#39;num_leaves&#39;</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span>               <span class="c1"># Максимальное количество листьев в дереве</span>
            <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>          <span class="c1"># Скорость обучения (меньше = стабильнее)</span>
            <span class="s1">&#39;feature_fraction&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>        <span class="c1"># Доля признаков для каждого дерева (предотвращает переобучение)</span>
            <span class="s1">&#39;bagging_fraction&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>        <span class="c1"># Доля данных для каждого дерева</span>
            <span class="s1">&#39;bagging_freq&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>              <span class="c1"># Частота применения bagging</span>
            <span class="s1">&#39;min_data_in_leaf&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>         <span class="c1"># Минимум данных в листе (предотвращает переобучение)</span>
            <span class="s1">&#39;min_sum_hessian_in_leaf&#39;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="c1"># Минимум суммы градиентов в листе</span>
            <span class="s1">&#39;lambda_l1&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>              <span class="c1"># L1 регуляризация (Lasso)</span>
            <span class="s1">&#39;lambda_l2&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>              <span class="c1"># L2 регуляризация (Ridge)</span>
            <span class="s1">&#39;min_gain_to_split&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>       <span class="c1"># Минимальный прирост для разделения</span>
            <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>               <span class="c1"># Максимальная глубина (-1 = без ограничений)</span>
            <span class="s1">&#39;save_binary&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>            <span class="c1"># Сохранять бинарные файлы</span>
            <span class="s1">&#39;seed&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>                     <span class="c1"># Семя для воспроизводимости</span>
            <span class="s1">&#39;feature_fraction_seed&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>     <span class="c1"># Семя для выбора признаков</span>
            <span class="s1">&#39;bagging_seed&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>              <span class="c1"># Семя для bagging</span>
            <span class="s1">&#39;drop_seed&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>                 <span class="c1"># Семя для dropout</span>
            <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>                  <span class="c1"># Уровень вывода (-1 = тихо)</span>
            <span class="s1">&#39;keep_training_booster&#39;</span><span class="p">:</span> <span class="kc">False</span>  <span class="c1"># Не сохранять промежуточные модели</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="c1"># Тщательная конфигурация для финального обучения</span>
            <span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>        <span class="c1"># Больше деревьев для лучшей точности</span>
            <span class="s1">&#39;num_leaves&#39;</span><span class="p">:</span> <span class="mi">63</span><span class="p">,</span>               <span class="c1"># Больше листьев для сложных паттернов</span>
            <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>          <span class="c1"># Меньшая скорость для стабильности</span>
            <span class="s1">&#39;feature_fraction&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>        <span class="c1"># Меньше признаков для предотвращения переобучения</span>
            <span class="s1">&#39;bagging_fraction&#39;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span>        <span class="c1"># Меньше данных для большего разнообразия</span>
            <span class="s1">&#39;bagging_freq&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>              <span class="c1"># Та же частота bagging</span>
            <span class="s1">&#39;min_data_in_leaf&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>         <span class="c1"># Меньше данных в листе для детализации</span>
            <span class="s1">&#39;min_sum_hessian_in_leaf&#39;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="c1"># Тот же минимум градиентов</span>
            <span class="s1">&#39;lambda_l1&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>              <span class="c1"># L1 регуляризация для отбора признаков</span>
            <span class="s1">&#39;lambda_l2&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>              <span class="c1"># L2 регуляризация для сглаживания</span>
            <span class="s1">&#39;min_gain_to_split&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>       <span class="c1"># Тот же минимальный прирост</span>
            <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>               <span class="c1"># Без ограничений глубины</span>
            <span class="s1">&#39;save_binary&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>            <span class="c1"># Сохранять бинарные файлы</span>
            <span class="s1">&#39;seed&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>                     <span class="c1"># Семя для воспроизводимости</span>
            <span class="s1">&#39;feature_fraction_seed&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>     <span class="c1"># Семя для выбора признаков</span>
            <span class="s1">&#39;bagging_seed&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>              <span class="c1"># Семя для bagging</span>
            <span class="s1">&#39;drop_seed&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>                 <span class="c1"># Семя для dropout</span>
            <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>                  <span class="c1"># Тихий режим</span>
            <span class="s1">&#39;keep_training_booster&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="s1">&#39;CAT&#39;</span><span class="p">:</span> <span class="p">[</span>  <span class="c1"># CatBoost - отличный алгоритм для категориальных данных</span>
        <span class="p">{</span>
            <span class="c1"># Базовая конфигурация CatBoost</span>
            <span class="s1">&#39;iterations&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>           <span class="c1"># Количество итераций (больше = точнее)</span>
            <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>        <span class="c1"># Скорость обучения</span>
            <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>                  <span class="c1"># Глубина деревьев (больше = сложнее)</span>
            <span class="s1">&#39;l2_leaf_reg&#39;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>          <span class="c1"># L2 регуляризация для листьев</span>
            <span class="s1">&#39;bootstrap_type&#39;</span><span class="p">:</span> <span class="s1">&#39;Bayesian&#39;</span><span class="p">,</span>
            <span class="s1">&#39;random_strength&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s1">&#39;bagging_temperature&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s1">&#39;od_type&#39;</span><span class="p">:</span> <span class="s1">&#39;Iter&#39;</span><span class="p">,</span>
            <span class="s1">&#39;od_wait&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
            <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s1">&#39;iterations&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
            <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
            <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
            <span class="s1">&#39;l2_leaf_reg&#39;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>
            <span class="s1">&#39;bootstrap_type&#39;</span><span class="p">:</span> <span class="s1">&#39;Bayesian&#39;</span><span class="p">,</span>
            <span class="s1">&#39;random_strength&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s1">&#39;bagging_temperature&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s1">&#39;od_type&#39;</span><span class="p">:</span> <span class="s1">&#39;Iter&#39;</span><span class="p">,</span>
            <span class="s1">&#39;od_wait&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
            <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="s1">&#39;XGB&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
            <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="s1">&#39;subsample&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
            <span class="s1">&#39;colsample_bytree&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
            <span class="s1">&#39;reg_alpha&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s1">&#39;reg_lambda&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s1">&#39;random_state&#39;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
            <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
            <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
            <span class="s1">&#39;subsample&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
            <span class="s1">&#39;colsample_bytree&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
            <span class="s1">&#39;reg_alpha&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="s1">&#39;reg_lambda&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s1">&#39;random_state&#39;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="s1">&#39;RF&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s1">&#39;min_samples_split&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;min_samples_leaf&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;max_features&#39;</span><span class="p">:</span> <span class="s1">&#39;sqrt&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bootstrap&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;random_state&#39;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="s1">&#39;KNN&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;n_neighbors&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s1">&#39;weights&#39;</span><span class="p">:</span> <span class="s1">&#39;uniform&#39;</span><span class="p">,</span>
            <span class="s1">&#39;algorithm&#39;</span><span class="p">:</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
            <span class="s1">&#39;leaf_size&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
            <span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="s1">&#39;minkowski&#39;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>

<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">hyperparameters</span><span class="o">=</span><span class="n">hyperparameters</span><span class="p">)</span>
</code></pre></div>

<h3 id="_78">Оптимизация гиперпараметров</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Настройка поиска гиперпараметров</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">Space</span>

<span class="c1"># Определение пространства поиска</span>
<span class="n">hyperparameter_space</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;GBM&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="n">Space</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span>
        <span class="s1">&#39;num_leaves&#39;</span><span class="p">:</span> <span class="n">Space</span><span class="p">(</span><span class="mi">31</span><span class="p">,</span> <span class="mi">127</span><span class="p">),</span>
        <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="n">Space</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">),</span>
        <span class="s1">&#39;feature_fraction&#39;</span><span class="p">:</span> <span class="n">Space</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
        <span class="s1">&#39;bagging_fraction&#39;</span><span class="p">:</span> <span class="n">Space</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="s1">&#39;XGB&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="n">Space</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span>
        <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="n">Space</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
        <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="n">Space</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">),</span>
        <span class="s1">&#39;subsample&#39;</span><span class="p">:</span> <span class="n">Space</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
        <span class="s1">&#39;colsample_bytree&#39;</span><span class="p">:</span> <span class="n">Space</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">hyperparameter_tune_kwargs</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;num_trials&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="s1">&#39;scheduler&#39;</span><span class="p">:</span> <span class="s1">&#39;local&#39;</span><span class="p">,</span>
        <span class="s1">&#39;searcher&#39;</span><span class="p">:</span> <span class="s1">&#39;auto&#39;</span>
    <span class="p">}</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_79">Настройка ансамблей</h2>
<h3 id="_80">Многоуровневые ансамбли</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Настройка стекинга</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">num_bag_folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>        <span class="c1"># Количество фолдов для бэггинга</span>
    <span class="n">num_bag_sets</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>         <span class="c1"># Количество наборов бэггинга</span>
    <span class="n">num_stack_levels</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>     <span class="c1"># Уровни стекинга</span>
    <span class="n">stack_ensemble_levels</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>  <span class="c1"># Какие уровни использовать для стекинга</span>
    <span class="n">ag_args_fit</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;num_gpus&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;num_cpus&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}</span>  <span class="c1"># Ресурсы для обучения</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="_81">Кастомные ансамбли</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.tabular.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">AbstractModel</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CustomEnsembleModel</span><span class="p">(</span><span class="n">AbstractModel</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Логика обучения кастомного ансамбля</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Логика предсказания кастомного ансамбля</span>
        <span class="k">pass</span>

<span class="c1"># Использование кастомного ансамбля</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">custom_ensemble_model</span><span class="o">=</span><span class="n">CustomEnsembleModel</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_82">Настройка ресурсов</h2>
<h3 id="cpu-gpu">CPU и GPU настройки</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Настройка ресурсов для обучения</span>
<span class="n">ag_args_fit</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;num_cpus&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>          <span class="c1"># Количество CPU ядер</span>
    <span class="s1">&#39;num_gpus&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>          <span class="c1"># Количество GPU</span>
    <span class="s1">&#39;memory_limit&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>     <span class="c1"># Лимит памяти в GB</span>
    <span class="s1">&#39;time_limit&#39;</span><span class="p">:</span> <span class="mi">3600</span>      <span class="c1"># Лимит времени в секундах</span>
<span class="p">}</span>

<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">ag_args_fit</span><span class="o">=</span><span class="n">ag_args_fit</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="_83">Параллельное обучение</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Настройка параллельного обучения</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">scheduler</span>

<span class="c1"># Локальный планировщик</span>
<span class="n">local_scheduler</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">LocalScheduler</span><span class="p">(</span>
    <span class="n">num_cpus</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
    <span class="n">num_gpus</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">scheduler</span><span class="o">=</span><span class="n">local_scheduler</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_84">Работа с большими данными</h2>
<h3 id="_85">Инкрементальное обучение</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Обучение по частям</span>
<span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">):</span>
    <span class="n">chunk</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">chunk_size</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">refit_full</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<h3 id="_86">Распределенное обучение</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Настройка для распределенного обучения</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">scheduler</span>

<span class="c1"># Ray планировщик для распределенного обучения</span>
<span class="n">ray_scheduler</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">RayScheduler</span><span class="p">(</span>
    <span class="n">num_cpus</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
    <span class="n">num_gpus</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">ray_address</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span>
<span class="p">)</span>

<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">scheduler</span><span class="o">=</span><span class="n">ray_scheduler</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_87">Настройка валидации</h2>
<h3 id="_88">Кастомные стратегии валидации</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">TimeSeriesSplit</span>

<span class="c1"># Временная валидация для временных рядов</span>
<span class="k">def</span><span class="w"> </span><span class="nf">time_series_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">tscv</span> <span class="o">=</span> <span class="n">TimeSeriesSplit</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">n_splits</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">val_idx</span> <span class="ow">in</span> <span class="n">tscv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">val_idx</span>

<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">validation_strategy</span><span class="o">=</span><span class="s1">&#39;custom&#39;</span><span class="p">,</span>
    <span class="n">custom_validation_strategy</span><span class="o">=</span><span class="n">time_series_split</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="_89">Стратифицированная валидация</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">StratifiedKFold</span>

<span class="c1"># Стратифицированная валидация</span>
<span class="k">def</span><span class="w"> </span><span class="nf">stratified_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">skf</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">n_splits</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">val_idx</span> <span class="ow">in</span> <span class="n">skf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">val_idx</span>

<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">validation_strategy</span><span class="o">=</span><span class="s1">&#39;custom&#39;</span><span class="p">,</span>
    <span class="n">custom_validation_strategy</span><span class="o">=</span><span class="n">stratified_split</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_90">Настройка признаков</h2>
<h3 id="_91">Кастомные генераторы признаков</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.features</span><span class="w"> </span><span class="kn">import</span> <span class="n">FeatureGenerator</span>

<span class="c1"># Создание кастомного генератора признаков</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CustomFeatureGenerator</span><span class="p">(</span><span class="n">FeatureGenerator</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_features</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="c1"># Генерация кастомных признаков</span>
        <span class="n">X</span><span class="p">[</span><span class="s1">&#39;feature_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;feature1&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="s1">&#39;feature2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
        <span class="n">X</span><span class="p">[</span><span class="s1">&#39;feature_interaction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;feature1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;feature2&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">X</span>

<span class="c1"># Использование кастомного генератора</span>
<span class="n">feature_generator</span> <span class="o">=</span> <span class="n">CustomFeatureGenerator</span><span class="p">()</span>
<span class="n">train_data_processed</span> <span class="o">=</span> <span class="n">feature_generator</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
</code></pre></div>

<h3 id="_92">Обработка текстовых данных</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Настройка обработки текста</span>
<span class="n">text_features</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;enable_text_special_features&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;enable_text_ngram_features&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;text_ngram_range&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="s1">&#39;text_max_features&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
    <span class="s1">&#39;text_min_df&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s1">&#39;text_max_df&#39;</span><span class="p">:</span> <span class="mf">0.95</span>
<span class="p">}</span>

<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">feature_generator_kwargs</span><span class="o">=</span><span class="n">text_features</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_93">Настройка метрик</h2>
<h3 id="_94">Кастомные метрики</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">Scorer</span>

<span class="c1"># Создание кастомной метрики</span>
<span class="k">def</span><span class="w"> </span><span class="nf">custom_metric</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Кастомная метрика для оценки качества&quot;&quot;&quot;</span>
    <span class="c1"># Ваша логика расчета метрики</span>
    <span class="k">return</span> <span class="n">score</span>

<span class="n">custom_scorer</span> <span class="o">=</span> <span class="n">Scorer</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;custom_metric&#39;</span><span class="p">,</span>
    <span class="n">score_func</span><span class="o">=</span><span class="n">custom_metric</span><span class="p">,</span>
    <span class="n">greater_is_better</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">eval_metric</span><span class="o">=</span><span class="n">custom_scorer</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="_95">Множественные метрики</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Обучение с несколькими метриками</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">eval_metric</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;f1&#39;</span><span class="p">,</span> <span class="s1">&#39;roc_auc&#39;</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_96">Настройка логирования</h2>
<h3 id="_97">Детальное логирование</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="c1"># Настройка логирования</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="n">handlers</span><span class="o">=</span><span class="p">[</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="s1">&#39;autogluon.log&#39;</span><span class="p">),</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Обучение с подробным логированием</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">verbosity</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="c1"># Максимальное логирование</span>
    <span class="n">log_to_file</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="_98">Мониторинг обучения</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Callback для мониторинга</span>
<span class="k">def</span><span class="w"> </span><span class="nf">training_monitor</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">logs</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">logs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">training_monitor</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_99">Настройка для продакшена</h2>
<h3 id="_100">Оптимизация для деплоя</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Настройки для продакшена</span>
<span class="n">production_config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;presets&#39;</span><span class="p">:</span> <span class="s1">&#39;optimize_for_deployment&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ag_args_fit&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;num_cpus&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
        <span class="s1">&#39;num_gpus&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;memory_limit&#39;</span><span class="p">:</span> <span class="mi">8</span>
    <span class="p">},</span>
    <span class="s1">&#39;hyperparameters&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;GBM&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}],</span>
        <span class="s1">&#39;XGB&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}],</span>
        <span class="s1">&#39;RF&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}]</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="o">**</span><span class="n">production_config</span><span class="p">)</span>
</code></pre></div>

<h3 id="_101">Сжатие модели</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Сохранение сжатой модели</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
    <span class="s1">&#39;production_model&#39;</span><span class="p">,</span>
    <span class="n">save_space</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">compress</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_102">Примеры продвинутой конфигурации</h2>
<h3 id="_103">Полная конфигурация для продакшена</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.tabular</span><span class="w"> </span><span class="kn">import</span> <span class="n">TabularPredictor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="c1"># Создание предиктора с полной конфигурацией</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
    <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
    <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
    <span class="n">path</span><span class="o">=</span><span class="s1">&#39;./models&#39;</span><span class="p">,</span>
    <span class="n">verbosity</span><span class="o">=</span><span class="mi">2</span>
<span class="p">)</span>

<span class="c1"># Продвинутые гиперпараметры</span>
<span class="n">advanced_hyperparameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;GBM&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
            <span class="s1">&#39;num_leaves&#39;</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span>
            <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="s1">&#39;feature_fraction&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
            <span class="s1">&#39;bagging_fraction&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
            <span class="s1">&#39;bagging_freq&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s1">&#39;min_data_in_leaf&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
            <span class="s1">&#39;min_sum_hessian_in_leaf&#39;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span>
            <span class="s1">&#39;lambda_l1&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s1">&#39;lambda_l2&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s1">&#39;min_gain_to_split&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;save_binary&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;seed&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;feature_fraction_seed&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;bagging_seed&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">&#39;drop_seed&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;keep_training_booster&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="s1">&#39;CAT&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;iterations&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
            <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
            <span class="s1">&#39;l2_leaf_reg&#39;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>
            <span class="s1">&#39;bootstrap_type&#39;</span><span class="p">:</span> <span class="s1">&#39;Bayesian&#39;</span><span class="p">,</span>
            <span class="s1">&#39;random_strength&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s1">&#39;bagging_temperature&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s1">&#39;od_type&#39;</span><span class="p">:</span> <span class="s1">&#39;Iter&#39;</span><span class="p">,</span>
            <span class="s1">&#39;od_wait&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
            <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="s1">&#39;XGB&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
            <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
            <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="s1">&#39;subsample&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
            <span class="s1">&#39;colsample_bytree&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
            <span class="s1">&#39;reg_alpha&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s1">&#39;reg_lambda&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s1">&#39;random_state&#39;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Настройки ресурсов</span>
<span class="n">ag_args_fit</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;num_cpus&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
    <span class="s1">&#39;num_gpus&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;memory_limit&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
    <span class="s1">&#39;time_limit&#39;</span><span class="p">:</span> <span class="mi">3600</span>
<span class="p">}</span>

<span class="c1"># Обучение с полной конфигурацией</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">hyperparameters</span><span class="o">=</span><span class="n">advanced_hyperparameters</span><span class="p">,</span>
    <span class="n">num_bag_folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">num_bag_sets</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">num_stack_levels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">ag_args_fit</span><span class="o">=</span><span class="n">ag_args_fit</span><span class="p">,</span>
    <span class="n">presets</span><span class="o">=</span><span class="s1">&#39;best_quality&#39;</span><span class="p">,</span>
    <span class="n">time_limit</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span>
    <span class="n">holdout_frac</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">verbosity</span><span class="o">=</span><span class="mi">2</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_104">Следующие шаги</h2>
<p>После освоения продвинутой конфигурации переходите к:<br />
- <a href="./04_metrics.md">Работе с метриками</a><br />
- <a href="./05_validation.md">Методам валидации</a><br />
- <a href="./06_production.md">Продакшен деплою</a></p>
<hr />
<h1 id="automl-gluon_3">Метрики и оценка качества в AutoML Gluon</h1>
<p><strong>Автор:</strong> Shcherbyna Rostyslav<br />
<strong>Дата:</strong> 2024  </p>
<h2 id="_105">Почему метрики критически важны</h2>
<p><strong>Почему 80% ML-проектов терпят неудачу из-за неправильного выбора метрик?</strong> Потому что метрики - это единственный способ понять, работает ли ваша модель. Это как медицинские анализы - без них нельзя поставить диагноз.</p>
<h3 id="_106">Что происходит без правильных метрик?</h3>
<ul>
<li><strong>Ложная уверенность</strong>: Модель кажется хорошей, но работает плохо</li>
<li><strong>Неправильные решения</strong>: Выбираете плохую модель вместо хорошей</li>
<li><strong>Потеря времени</strong>: Тратите месяцы на неэффективные подходы</li>
<li><strong>Бизнес-провалы</strong>: Модель не решает реальные задачи</li>
</ul>
<h3 id="_107">Что дает правильный выбор метрик?</h3>
<ul>
<li><strong>Точная оценка</strong>: Вы точно знаете качество модели</li>
<li><strong>Правильный выбор</strong>: Выбираете лучшую модель для задачи</li>
<li><strong>Быстрая итерация</strong>: Быстро находите проблемы и исправляете их</li>
<li><strong>Бизнес-успех</strong>: Модель действительно помогает бизнесу</li>
</ul>
<h2 id="_108">Введение в метрики</h2>
<p><img alt="Сравнение метрик" src="images/metrics_comparison.png" /><br />
<em>Рисунок 3: Сравнение метрик для классификации и регрессии</em></p>
<p><img alt="Детальная визуализация метрик" src="images/metrics_detailed.png" /><br />
<em>Рисунок 3.1: Детальная визуализация метрик - ROC Curve, Precision-Recall, Confusion Matrix, Accuracy vs Threshold, F1 Score vs Threshold</em></p>
<p><strong>Почему метрики - это язык машинного обучения?</strong> Потому что они переводят сложные алгоритмы в понятные числа. Это как переводчик между техническими деталями и бизнес-результатами.</p>
<p>Метрики в AutoML Gluon используются для:<br />
- <strong>Оценки качества моделей</strong>: Понимание того, насколько хорошо работает модель<br />
- <strong>Сравнения различных алгоритмов</strong>: Выбор лучшего алгоритма для задачи<br />
- <strong>Выбора лучшей модели</strong>: Автоматический отбор оптимальной модели<br />
- <strong>Мониторинга производительности</strong>: Отслеживание качества в продакшене</p>
<h2 id="_109">Метрики для классификации</h2>
<p><strong>Почему классификация требует особых метрик?</strong> Потому что здесь важны не только правильные ответы, но и типы ошибок. Ложные срабатывания и пропуски имеют разную цену.</p>
<h3 id="_110">Базовые метрики</h3>
<h4 id="accuracy">Accuracy (Точность)</h4>
<p><strong>Почему Accuracy - самая популярная метрика?</strong> Потому что она интуитивно понятна - это просто процент правильных ответов.</p>
<p><strong>Когда Accuracy вводит в заблуждение?</strong><br />
- При несбалансированных данных (99% одного класса)<br />
- При разной важности ошибок (медицинская диагностика)<br />
- При небольшом количестве данных</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Процент правильных предсказаний</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">accuracy_score</span>

<span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>Почему Accuracy может быть обманчивой?</strong><br />
- Модель может просто предсказывать мажоритарный класс<br />
- Не показывает, какие ошибки делает модель<br />
- Не учитывает важность разных типов ошибок</p>
<h4 id="precision">Precision (Точность)</h4>
<p><strong>Почему Precision критически важен?</strong> Потому что он показывает, насколько можно доверять положительным предсказаниям модели.</p>
<p><strong>Когда Precision особенно важен?</strong><br />
- Медицинская диагностика (ложные диагнозы опасны)<br />
- Обнаружение мошенничества (ложные обвинения дороги)<br />
- Спам-фильтры (важные письма не должны попадать в спам)</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Доля правильно предсказанных положительных случаев</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">precision_score</span>

<span class="n">precision</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision: </span><span class="si">{</span><span class="n">precision</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Для многоклассовой классификации</span>
<span class="n">precision_macro</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>  <span class="c1"># Среднее по классам</span>
<span class="n">precision_micro</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;micro&#39;</span><span class="p">)</span>  <span class="c1"># Глобальное среднее</span>
</code></pre></div>

<p><strong>Почему нужны разные типы усреднения?</strong><br />
- <strong>macro</strong>: Каждый класс имеет равный вес (хорошо для несбалансированных данных)<br />
- <strong>micro</strong>: Учитывает количество примеров в каждом классе (хорошо для сбалансированных данных)</p>
<h4 id="recall">Recall (Полнота)</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Доля положительных случаев, которые были правильно предсказаны</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">recall_score</span>

<span class="n">recall</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall: </span><span class="si">{</span><span class="n">recall</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Для многоклассовой классификации</span>
<span class="n">recall_macro</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>
<span class="n">recall_micro</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;micro&#39;</span><span class="p">)</span>
</code></pre></div>

<h4 id="f1-score">F1-Score</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Гармоническое среднее precision и recall</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">f1_score</span>

<span class="n">f1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-Score: </span><span class="si">{</span><span class="n">f1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Для многоклассовой классификации</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>
<span class="n">f1_micro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;micro&#39;</span><span class="p">)</span>
</code></pre></div>

<h3 id="_111">Продвинутые метрики</h3>
<h4 id="roc-auc">ROC AUC</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Площадь под ROC кривой</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">roc_auc_score</span>

<span class="c1"># Для бинарной классификации</span>
<span class="n">roc_auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ROC AUC: </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Для многоклассовой классификации</span>
<span class="n">roc_auc_ovo</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">,</span> <span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;ovo&#39;</span><span class="p">)</span>
<span class="n">roc_auc_ovr</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">,</span> <span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;ovr&#39;</span><span class="p">)</span>
</code></pre></div>

<h4 id="pr-auc">PR AUC</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Площадь под Precision-Recall кривой</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">average_precision_score</span>

<span class="n">pr_auc</span> <span class="o">=</span> <span class="n">average_precision_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PR AUC: </span><span class="si">{</span><span class="n">pr_auc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h4 id="log-loss">Log Loss</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Логарифмическая функция потерь</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">log_loss</span>

<span class="n">log_loss_score</span> <span class="o">=</span> <span class="n">log_loss</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Log Loss: </span><span class="si">{</span><span class="n">log_loss_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h4 id="balanced-accuracy">Balanced Accuracy</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Сбалансированная точность для несбалансированных данных</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">balanced_accuracy_score</span>

<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="_112">Метрики для несбалансированных данных</h3>
<h4 id="matthews-correlation-coefficient-mcc">Matthews Correlation Coefficient (MCC)</h4>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">matthews_corrcoef</span>

<span class="n">mcc</span> <span class="o">=</span> <span class="n">matthews_corrcoef</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MCC: </span><span class="si">{</span><span class="n">mcc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h4 id="cohens-kappa">Cohen's Kappa</h4>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">cohen_kappa_score</span>

<span class="n">kappa</span> <span class="o">=</span> <span class="n">cohen_kappa_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cohen&#39;s Kappa: </span><span class="si">{</span><span class="n">kappa</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h2 id="_113">Метрики для регрессии</h2>
<h3 id="_114">Базовые метрики</h3>
<h4 id="mean-absolute-error-mae">Mean Absolute Error (MAE)</h4>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_absolute_error</span>

<span class="n">mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MAE: </span><span class="si">{</span><span class="n">mae</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h4 id="mean-squared-error-mse">Mean Squared Error (MSE)</h4>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_squared_error</span>

<span class="n">mse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MSE: </span><span class="si">{</span><span class="n">mse</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h4 id="root-mean-squared-error-rmse">Root Mean Squared Error (RMSE)</h4>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RMSE: </span><span class="si">{</span><span class="n">rmse</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h4 id="r2-score">R² Score</h4>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">r2_score</span>

<span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R² Score: </span><span class="si">{</span><span class="n">r2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="_115">Продвинутые метрики</h3>
<h4 id="mean-absolute-percentage-error-mape">Mean Absolute Percentage Error (MAPE)</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">mape</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_true</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_true</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>

<span class="n">mape_score</span> <span class="o">=</span> <span class="n">mape</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MAPE: </span><span class="si">{</span><span class="n">mape_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>

<h4 id="symmetric-mean-absolute-percentage-error-smape">Symmetric Mean Absolute Percentage Error (SMAPE)</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">smape</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_true</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)))</span> <span class="o">*</span> <span class="mi">100</span>

<span class="n">smape_score</span> <span class="o">=</span> <span class="n">smape</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SMAPE: </span><span class="si">{</span><span class="n">smape_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>

<h4 id="mean-absolute-scaled-error-mase">Mean Absolute Scaled Error (MASE)</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">mase</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_train</span><span class="p">):</span>
    <span class="c1"># Наивный прогноз (следующее значение)</span>
    <span class="n">naive_forecast</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">naive_mae</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_train</span> <span class="o">-</span> <span class="n">naive_forecast</span><span class="p">))</span>

    <span class="c1"># MAE модели</span>
    <span class="n">model_mae</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_true</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">model_mae</span> <span class="o">/</span> <span class="n">naive_mae</span>

<span class="n">mase_score</span> <span class="o">=</span> <span class="n">mase</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MASE: </span><span class="si">{</span><span class="n">mase_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h2 id="autogluon">Использование метрик в AutoGluon</h2>
<h3 id="_116">Настройка метрик для обучения</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.tabular</span><span class="w"> </span><span class="kn">import</span> <span class="n">TabularPredictor</span>

<span class="c1"># Для классификации</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
    <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span>
    <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span>  <span class="c1"># или &#39;f1&#39;, &#39;roc_auc&#39;, &#39;log_loss&#39;</span>
<span class="p">)</span>

<span class="c1"># Для регрессии</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
    <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;regression&#39;</span><span class="p">,</span>
    <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;rmse&#39;</span>  <span class="c1"># или &#39;mae&#39;, &#39;r2&#39;</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="_117">Множественные метрики</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Обучение с несколькими метриками</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">eval_metric</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;f1&#39;</span><span class="p">,</span> <span class="s1">&#39;roc_auc&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Получение всех метрик</span>
<span class="n">performance</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">performance</span><span class="p">)</span>
</code></pre></div>

<h3 id="_118">Кастомные метрики</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">Scorer</span>

<span class="c1"># Создание кастомной метрики</span>
<span class="k">def</span><span class="w"> </span><span class="nf">custom_metric</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Кастомная метрика для оценки качества&quot;&quot;&quot;</span>
    <span class="c1"># Ваша логика расчета</span>
    <span class="k">return</span> <span class="n">score</span>

<span class="n">custom_scorer</span> <span class="o">=</span> <span class="n">Scorer</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;custom_metric&#39;</span><span class="p">,</span>
    <span class="n">score_func</span><span class="o">=</span><span class="n">custom_metric</span><span class="p">,</span>
    <span class="n">greater_is_better</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">eval_metric</span><span class="o">=</span><span class="n">custom_scorer</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_119">Анализ производительности</h2>
<h3 id="_120">Лидерборд моделей</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Получение лидерборда</span>
<span class="n">leaderboard</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">leaderboard</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">leaderboard</span><span class="p">)</span>

<span class="c1"># Детальный лидерборд</span>
<span class="n">leaderboard_detailed</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">leaderboard</span><span class="p">(</span>
    <span class="n">test_data</span><span class="p">,</span>
    <span class="n">extra_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">silent</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="_121">Анализ важности признаков</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Важность признаков</span>
<span class="n">feature_importance</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">feature_importance</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">feature_importance</span><span class="p">)</span>

<span class="c1"># Визуализация важности признаков</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">feature_importance</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;barh&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Feature Importance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Importance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>

<h3 id="_122">Анализ ошибок</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Анализ ошибок для классификации</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span>

<span class="c1"># Отчет по классификации</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>

<span class="c1"># Матрица ошибок</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Confusion Matrix:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span>

<span class="c1"># Визуализация матрицы ошибок</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Confusion Matrix&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>

<h2 id="_123">Метрики для временных рядов</h2>
<h3 id="_124">Метрики для прогнозирования</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Mean Absolute Scaled Error (MASE)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mase_time_series</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">seasonal_period</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;MASE для временных рядов&quot;&quot;&quot;</span>
    <span class="c1"># Наивный прогноз</span>
    <span class="n">naive_forecast</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">seasonal_period</span><span class="p">)</span>
    <span class="n">naive_mae</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_train</span> <span class="o">-</span> <span class="n">naive_forecast</span><span class="p">))</span>

    <span class="c1"># MAE модели</span>
    <span class="n">model_mae</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_true</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">model_mae</span> <span class="o">/</span> <span class="n">naive_mae</span>

<span class="c1"># Symmetric Mean Absolute Percentage Error (SMAPE)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">smape_time_series</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;SMAPE для временных рядов&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_true</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)))</span> <span class="o">*</span> <span class="mi">100</span>
</code></pre></div>

<h3 id="_125">Метрики для финансовых данных</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Sharpe Ratio</span>
<span class="k">def</span><span class="w"> </span><span class="nf">sharpe_ratio</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">risk_free_rate</span><span class="o">=</span><span class="mf">0.02</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Коэффициент Шарпа&quot;&quot;&quot;</span>
    <span class="n">excess_returns</span> <span class="o">=</span> <span class="n">returns</span> <span class="o">-</span> <span class="n">risk_free_rate</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">excess_returns</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">excess_returns</span><span class="p">)</span>

<span class="c1"># Maximum Drawdown</span>
<span class="k">def</span><span class="w"> </span><span class="nf">max_drawdown</span><span class="p">(</span><span class="n">cumulative_returns</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Максимальная просадка&quot;&quot;&quot;</span>
    <span class="n">peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">cumulative_returns</span><span class="p">)</span>
    <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">cumulative_returns</span> <span class="o">-</span> <span class="n">peak</span><span class="p">)</span> <span class="o">/</span> <span class="n">peak</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">drawdown</span><span class="p">)</span>

<span class="c1"># Calmar Ratio</span>
<span class="k">def</span><span class="w"> </span><span class="nf">calmar_ratio</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">max_dd</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Коэффициент Калмара&quot;&quot;&quot;</span>
    <span class="n">annual_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="o">*</span> <span class="mi">252</span>
    <span class="k">return</span> <span class="n">annual_return</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_dd</span><span class="p">)</span>
</code></pre></div>

<h2 id="_126">Мониторинг метрик</h2>
<h3 id="_127">Отслеживание метрик в реальном времени</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MetricsLogger</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_file</span><span class="o">=</span><span class="s1">&#39;metrics.log&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span> <span class="o">=</span> <span class="n">log_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics_dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Логирование метрик&quot;&quot;&quot;</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">metrics_dict</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timestamp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metrics_dict</span><span class="p">)</span>

        <span class="c1"># Запись в файл</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">metrics_dict</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_metrics_trend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Получение тренда метрики&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span> <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">m</span><span class="p">]</span>

<span class="c1"># Использование</span>
<span class="n">metrics_logger</span> <span class="o">=</span> <span class="n">MetricsLogger</span><span class="p">()</span>

<span class="c1"># Логирование метрик</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span>
    <span class="s1">&#39;f1_score&#39;</span><span class="p">:</span> <span class="mf">0.82</span><span class="p">,</span>
    <span class="s1">&#39;roc_auc&#39;</span><span class="p">:</span> <span class="mf">0.88</span>
<span class="p">}</span>
<span class="n">metrics_logger</span><span class="o">.</span><span class="n">log_metrics</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
</code></pre></div>

<h3 id="_128">Алерты по метрикам</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MetricsAlert</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span> <span class="o">=</span> <span class="n">metric_name</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_metric</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Проверка алерта&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">current_metric</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ALERT: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">current_metric</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

<span class="c1"># Использование</span>
<span class="n">alert</span> <span class="o">=</span> <span class="n">MetricsAlert</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">alert</span><span class="o">.</span><span class="n">check_alert</span><span class="p">(</span><span class="mf">0.75</span><span class="p">):</span>
    <span class="c1"># Отправка уведомления</span>
    <span class="k">pass</span>
</code></pre></div>

<h2 id="_129">Примеры использования метрик</h2>
<h3 id="_130">Полный пример оценки модели</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.tabular</span><span class="w"> </span><span class="kn">import</span> <span class="n">TabularPredictor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_classification</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>

<span class="c1"># Создание данных</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_classification</span><span class="p">(</span>
    <span class="n">n_samples</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
    <span class="n">n_features</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">n_informative</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
    <span class="n">n_redundant</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">n_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;feature_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)])</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>

<span class="c1"># Разделение данных</span>
<span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Создание и обучение модели</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
    <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span>
    <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span>
<span class="p">)</span>

<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

<span class="c1"># Предсказания</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
<span class="n">probabilities</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

<span class="c1"># Оценка качества</span>
<span class="n">performance</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Performance Metrics:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">performance</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Лидерборд</span>
<span class="n">leaderboard</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">leaderboard</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Leaderboard:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">leaderboard</span><span class="p">)</span>

<span class="c1"># Важность признаков</span>
<span class="n">feature_importance</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">feature_importance</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Feature Importance:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">feature_importance</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

<span class="c1"># Визуализация</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># ROC кривая</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>
<span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">],</span> <span class="n">probabilities</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;k--&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;False Positive Rate&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;True Positive Rate&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;ROC Curve&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Precision-Recall кривая</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">precision_recall_curve</span>
<span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">precision_recall_curve</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">],</span> <span class="n">probabilities</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">recall</span><span class="p">,</span> <span class="n">precision</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Recall&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Precision&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Precision-Recall Curve&#39;</span><span class="p">)</span>

<span class="c1"># Матрица ошибок</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">confusion_matrix</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">],</span> <span class="n">predictions</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Confusion Matrix&#39;</span><span class="p">)</span>

<span class="c1"># Важность признаков</span>
<span class="n">feature_importance</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;barh&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 10 Feature Importance&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>

<h2 id="_131">Следующие шаги</h2>
<p>После освоения работы с метриками переходите к:<br />
- <a href="./05_validation.md">Методам валидации</a><br />
- <a href="./06_production.md">Продакшен деплою</a><br />
- <a href="./07_retraining.md">Переобучению моделей</a></p>
<hr />
<h1 id="automl-gluon_4">Валидация моделей в AutoML Gluon</h1>
<p><strong>Автор:</strong> Shcherbyna Rostyslav<br />
<strong>Дата:</strong> 2024  </p>
<h2 id="_132">Почему валидация критически важна</h2>
<p><strong>Почему 70% ML-проектов терпят неудачу в продакшене из-за плохой валидации?</strong> Потому что валидация - это единственный способ убедиться, что ваша модель действительно работает. Это как тест-драйв автомобиля перед покупкой.</p>
<h3 id="_133">Что происходит без правильной валидации?</h3>
<ul>
<li><strong>Ложная уверенность</strong>: Модель кажется хорошей, но проваливается на новых данных</li>
<li><strong>Переобучение</strong>: Модель запоминает тренировочные данные вместо изучения паттернов</li>
<li><strong>Неправильные решения</strong>: Выбираете плохую модель вместо хорошей</li>
<li><strong>Бизнес-провалы</strong>: Модель не работает в реальных условиях</li>
</ul>
<h3 id="_134">Что дает правильная валидация?</h3>
<ul>
<li><strong>Реальная оценка</strong>: Вы точно знаете, как модель поведет себя на новых данных</li>
<li><strong>Предотвращение переобучения</strong>: Модель учится обобщать, а не запоминать</li>
<li><strong>Правильный выбор</strong>: Выбираете лучшую модель для задачи</li>
<li><strong>Уверенность в продакшене</strong>: Модель действительно будет работать</li>
</ul>
<h2 id="_135">Введение в валидацию</h2>
<p><img alt="Методы валидации" src="images/validation_methods.png" /><br />
<em>Рисунок 4: Методы валидации в AutoML Gluon</em></p>
<p><img alt="Walk-Forward анализ" src="images/walk_forward_analysis.png" /><br />
<em>Рисунок 4.1: Walk-Forward валидация - схема, производительность, выбор параметров</em></p>
<p><strong>Почему валидация - это не просто "проверка модели"?</strong> Это процесс, который определяет, готова ли ваша модель к реальному миру. Представьте, что вы готовите пилота к полету - валидация это симулятор, который показывает, как он поведет себя в реальных условиях.</p>
<p>Валидация - это критически важный процесс для оценки качества ML-моделей и предотвращения переобучения. В AutoML Gluon доступны различные методы валидации для разных типов задач.</p>
<h2 id="_136">Типы валидации</h2>
<p><strong>Почему AutoML Gluon предлагает разные типы валидации?</strong> Потому что разные задачи требуют разных подходов. Это как разные виды экзаменов для разных предметов.</p>
<h3 id="1-holdout">1. Holdout валидация</h3>
<p><strong>Почему Holdout валидация - самый простой и популярный метод?</strong> Потому что она интуитивно понятна: вы просто разделяете данные на две части - одну для обучения, другую для проверки. Это как экзамен в школе - вы учитесь по учебнику, а экзамен сдаете по новым задачам.</p>
<p><strong>Преимущества Holdout валидации:</strong><br />
- <strong>Простота</strong>: Легко понять и реализовать<br />
- <strong>Скорость</strong>: Быстро выполняется<br />
- <strong>Эффективность</strong>: Подходит для больших датасетов<br />
- <strong>Интуитивность</strong>: Понятно заинтересованным сторонам</p>
<p><strong>Недостатки Holdout валидации:</strong><br />
- <strong>Нестабильность</strong>: Результат зависит от случайного разделения<br />
- <strong>Неэффективность</strong>: 20% данных не участвуют в обучении<br />
- <strong>Случайность</strong>: Плохое разделение может исказить результаты</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.tabular</span><span class="w"> </span><span class="kn">import</span> <span class="n">TabularPredictor</span>

<span class="c1"># Простая holdout валидация</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">)</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">holdout_frac</span><span class="o">=</span><span class="mf">0.2</span>  <span class="c1"># 20% данных для валидации</span>
<span class="p">)</span>
</code></pre></div>

<p><strong>Почему 20% для валидации?</strong> Это компромисс между достаточным количеством данных для обучения и достаточным количеством для валидации.</p>
<h3 id="2-k-fold-">2. K-Fold кросс-валидация</h3>
<p><strong>Почему K-Fold кросс-валидация более надежна, чем Holdout?</strong> Потому что она использует ВСЕ данные и для обучения, и для валидации. Это как сдать 5 экзаменов вместо одного - результат будет более точным.</p>
<p><strong>Как работает K-Fold кросс-валидация:</strong><br />
1. <strong>Разделение на K частей</strong>: Данные делятся на K равных частей (обычно K=5 или K=10)<br />
2. <strong>K итераций</strong>: В каждой итерации одна часть используется для валидации, остальные K-1 для обучения<br />
3. <strong>Обучение модели</strong>: Модель обучается на K-1 частях<br />
4. <strong>Тестирование</strong>: Модель тестируется на оставшейся части<br />
5. <strong>Усреднение результатов</strong>: Итоговая оценка - среднее по всем K итерациям</p>
<p><strong>Преимущества K-Fold валидации:</strong><br />
- <strong>Использование всех данных</strong>: Каждая точка данных участвует и в обучении, и в валидации<br />
- <strong>Стабильность</strong>: Результат не зависит от случайного разделения<br />
- <strong>Оценка дисперсии</strong>: Показывает, насколько стабильна модель<br />
- <strong>Надежность</strong>: Более точная оценка качества модели</p>
<p><strong>Недостатки K-Fold валидации:</strong><br />
- <strong>Время</strong>: Выполняется в K раз дольше<br />
- <strong>Сложность</strong>: Требует больше вычислительных ресурсов<br />
- <strong>Память</strong>: Нужно хранить K моделей</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># K-fold кросс-валидация</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">num_bag_folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>  <span class="c1"># 5-fold CV</span>
    <span class="n">num_bag_sets</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
</code></pre></div>

<p><strong>Почему обычно используют 5 или 10 фолдов?</strong> Потому что это оптимальный баланс между точностью и скоростью.</p>
<h3 id="3">3. Стратифицированная валидация</h3>
<p><strong>Почему стратифицированная валидация критически важна для несбалансированных данных?</strong> Потому что обычная валидация может дать искаженные результаты, когда один класс представлен в 100 раз больше другого. Это как оценивать качество врача только по здоровым пациентам.</p>
<p><strong>Проблема несбалансированных данных:</strong><br />
- <strong>Медицинская диагностика</strong>: 99% здоровых, 1% больных<br />
- <strong>Обнаружение мошенничества</strong>: 99.9% легальных транзакций, 0.1% мошеннических<br />
- <strong>Спам-фильтры</strong>: 90% обычных писем, 10% спама</p>
<p><strong>Как работает стратификация:</strong><br />
1. <strong>Анализ распределения</strong>: AutoML Gluon анализирует пропорции классов<br />
2. <strong>Сохранение пропорций</strong>: В каждом фолде сохраняется исходное распределение<br />
3. <strong>Сбалансированная оценка</strong>: Модель оценивается на репрезентативных данных<br />
4. <strong>Корректные метрики</strong>: Получаем точные оценки для всех классов</p>
<p><strong>Когда использовать стратификацию:</strong><br />
- <strong>Использовать</strong>: Когда классы несбалансированы (соотношение &gt; 10:1)<br />
- <strong>Использовать</strong>: Когда важны все классы (медицина, безопасность)<br />
- <strong>Не использовать</strong>: Когда данные сбалансированы<br />
- <strong>Не использовать</strong>: Когда важны только мажоритарные классы</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Стратифицированная валидация для несбалансированных данных</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">num_bag_folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">num_bag_sets</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">stratify</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># Сохранять пропорции классов в каждом фолде</span>
<span class="p">)</span>
</code></pre></div>

<p><strong>Почему стратификация нужна не всегда?</strong> Потому что она добавляет сложность, но не всегда необходима.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">## Backtest валидация</span>

<span class="c1">### Временная валидация для временных рядов</span>

<span class="err">```</span><span class="n">python</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">TimeSeriesSplit</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">time_series_backtest</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">target_col</span><span class="p">,</span> <span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Backtest валидация для временных рядов&quot;&quot;&quot;</span>

    <span class="c1"># Сортировка по времени</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">)</span>

    <span class="c1"># Создание временных фолдов</span>
    <span class="n">tscv</span> <span class="o">=</span> <span class="n">TimeSeriesSplit</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">n_splits</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">fold</span><span class="p">,</span> <span class="p">(</span><span class="n">train_idx</span><span class="p">,</span> <span class="n">val_idx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tscv</span><span class="o">.</span><span class="kp">split</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fold </span><span class="si">{</span><span class="n">fold</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">n_splits</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Разделение данных</span>
        <span class="n">train_fold</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span>
        <span class="n">val_fold</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">val_idx</span><span class="p">]</span>

        <span class="c1"># Обучение модели</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">target_col</span><span class="p">)</span>
        <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_fold</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

        <span class="c1"># Предсказания</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">val_fold</span><span class="p">)</span>

        <span class="c1"># Оценка качества</span>
        <span class="n">performance</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">val_fold</span><span class="p">)</span>

        <span class="n">results</span><span class="o">.</span><span class="kp">append</span><span class="p">({</span>
            <span class="s1">&#39;fold&#39;</span><span class="p">:</span> <span class="n">fold</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;performance&#39;</span><span class="p">:</span> <span class="n">performance</span><span class="p">,</span>
            <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="n">predictions</span>
        <span class="p">})</span>

    <span class="k">return</span> <span class="n">results</span>

<span class="c1"># Использование</span>
<span class="n">backtest_results</span> <span class="o">=</span> <span class="n">time_series_backtest</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div>

<h3 id="backtest">Расширенный backtest</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">advanced_backtest</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">target_col</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Расширенный backtest с скользящим окном&quot;&quot;&quot;</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_samples</span> <span class="o">-</span> <span class="n">window_size</span><span class="p">,</span> <span class="n">step_size</span><span class="p">):</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">window_size</span>

        <span class="c1"># Разделение на train/validation</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="o">-</span><span class="mi">100</span><span class="p">]</span>
        <span class="n">val_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">end</span><span class="o">-</span><span class="mi">100</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>

        <span class="c1"># Обучение модели</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">target_col</span><span class="p">)</span>
        <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

        <span class="c1"># Предсказания</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">val_data</span><span class="p">)</span>

        <span class="c1"># Оценка качества</span>
        <span class="n">performance</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">val_data</span><span class="p">)</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;start&#39;</span><span class="p">:</span> <span class="n">start</span><span class="p">,</span>
            <span class="s1">&#39;end&#39;</span><span class="p">:</span> <span class="n">end</span><span class="p">,</span>
            <span class="s1">&#39;performance&#39;</span><span class="p">:</span> <span class="n">performance</span><span class="p">,</span>
            <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="n">predictions</span>
        <span class="p">})</span>

    <span class="k">return</span> <span class="n">results</span>
</code></pre></div>

<h2 id="walk-forward">Walk-Forward валидация</h2>
<h3 id="walk-forward_1">Базовая Walk-Forward валидация</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">walk_forward_validation</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">target_col</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Walk-Forward валидация&quot;&quot;&quot;</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">train_size</span><span class="p">,</span> <span class="n">n_samples</span> <span class="o">-</span> <span class="n">test_size</span><span class="p">,</span> <span class="n">test_size</span><span class="p">):</span>
        <span class="c1"># Обучающая выборка</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">train_size</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Тестовая выборка</span>
        <span class="n">test_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">test_size</span><span class="p">]</span>

        <span class="c1"># Обучение модели</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">target_col</span><span class="p">)</span>
        <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

        <span class="c1"># Предсказания</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

        <span class="c1"># Оценка качества</span>
        <span class="n">performance</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;train_start&#39;</span><span class="p">:</span> <span class="n">i</span><span class="o">-</span><span class="n">train_size</span><span class="p">,</span>
            <span class="s1">&#39;train_end&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
            <span class="s1">&#39;test_start&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
            <span class="s1">&#39;test_end&#39;</span><span class="p">:</span> <span class="n">i</span><span class="o">+</span><span class="n">test_size</span><span class="p">,</span>
            <span class="s1">&#39;performance&#39;</span><span class="p">:</span> <span class="n">performance</span><span class="p">,</span>
            <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="n">predictions</span>
        <span class="p">})</span>

    <span class="k">return</span> <span class="n">results</span>

<span class="c1"># Использование</span>
<span class="n">wf_results</span> <span class="o">=</span> <span class="n">walk_forward_validation</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</code></pre></div>

<h3 id="walk-forward_2">Адаптивная Walk-Forward валидация</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">adaptive_walk_forward</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">target_col</span><span class="p">,</span> <span class="n">min_train_size</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">max_train_size</span><span class="o">=</span><span class="mi">2000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Адаптивная Walk-Forward валидация с изменяющимся размером окна&quot;&quot;&quot;</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">current_train_size</span> <span class="o">=</span> <span class="n">min_train_size</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">min_train_size</span><span class="p">,</span> <span class="n">n_samples</span> <span class="o">-</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">):</span>
        <span class="c1"># Адаптация размера обучающей выборки</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">n_samples</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">current_train_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_train_size</span><span class="p">,</span> <span class="n">current_train_size</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span>

        <span class="c1"># Обучающая выборка</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">current_train_size</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Тестовая выборка</span>
        <span class="n">test_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">100</span><span class="p">]</span>

        <span class="c1"># Обучение модели</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">target_col</span><span class="p">)</span>
        <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

        <span class="c1"># Предсказания</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

        <span class="c1"># Оценка качества</span>
        <span class="n">performance</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;train_size&#39;</span><span class="p">:</span> <span class="n">current_train_size</span><span class="p">,</span>
            <span class="s1">&#39;performance&#39;</span><span class="p">:</span> <span class="n">performance</span><span class="p">,</span>
            <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="n">predictions</span>
        <span class="p">})</span>

    <span class="k">return</span> <span class="n">results</span>
</code></pre></div>

<h2 id="monte-carlo">Monte Carlo валидация</h2>
<h3 id="monte-carlo_1">Базовый Monte Carlo</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">monte_carlo_validation</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">target_col</span><span class="p">,</span> <span class="n">n_iterations</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">train_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Monte Carlo валидация с случайным разделением данных&quot;&quot;&quot;</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_iterations</span><span class="p">):</span>
        <span class="c1"># Случайное разделение данных</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="n">train_frac</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">iteration</span><span class="p">)</span>
        <span class="n">test_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">train_data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="c1"># Обучение модели</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">target_col</span><span class="p">)</span>
        <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

        <span class="c1"># Предсказания</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

        <span class="c1"># Оценка качества</span>
        <span class="n">performance</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;iteration&#39;</span><span class="p">:</span> <span class="n">iteration</span><span class="p">,</span>
            <span class="s1">&#39;performance&#39;</span><span class="p">:</span> <span class="n">performance</span><span class="p">,</span>
            <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="n">predictions</span>
        <span class="p">})</span>

    <span class="k">return</span> <span class="n">results</span>

<span class="c1"># Использование</span>
<span class="n">mc_results</span> <span class="o">=</span> <span class="n">monte_carlo_validation</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="n">n_iterations</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</code></pre></div>

<h3 id="bootstrap">Bootstrap валидация</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">bootstrap_validation</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">target_col</span><span class="p">,</span> <span class="n">n_bootstrap</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Bootstrap валидация&quot;&quot;&quot;</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_bootstrap</span><span class="p">):</span>
        <span class="c1"># Bootstrap выборка</span>
        <span class="n">bootstrap_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">bootstrap_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">bootstrap_indices</span><span class="p">]</span>

        <span class="c1"># Out-of-bag выборка</span>
        <span class="n">oob_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_samples</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">bootstrap_indices</span><span class="p">))</span>
        <span class="n">oob_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">oob_indices</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">oob_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Обучение модели</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">target_col</span><span class="p">)</span>
        <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">bootstrap_data</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

        <span class="c1"># Предсказания на OOB данных</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">oob_data</span><span class="p">)</span>

        <span class="c1"># Оценка качества</span>
        <span class="n">performance</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">oob_data</span><span class="p">)</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;bootstrap&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
            <span class="s1">&#39;performance&#39;</span><span class="p">:</span> <span class="n">performance</span><span class="p">,</span>
            <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="n">predictions</span>
        <span class="p">})</span>

    <span class="k">return</span> <span class="n">results</span>
</code></pre></div>

<h2 id="_137">Комбинированная валидация</h2>
<h3 id="ensemble">Ensemble валидация</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ensemble_validation</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">target_col</span><span class="p">,</span> <span class="n">validation_methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;holdout&#39;</span><span class="p">,</span> <span class="s1">&#39;kfold&#39;</span><span class="p">,</span> <span class="s1">&#39;monte_carlo&#39;</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Комбинированная валидация с несколькими методами&quot;&quot;&quot;</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Holdout валидация</span>
    <span class="k">if</span> <span class="s1">&#39;holdout&#39;</span> <span class="ow">in</span> <span class="n">validation_methods</span><span class="p">:</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">target_col</span><span class="p">)</span>
        <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">holdout_frac</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;holdout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># K-fold валидация</span>
    <span class="k">if</span> <span class="s1">&#39;kfold&#39;</span> <span class="ow">in</span> <span class="n">validation_methods</span><span class="p">:</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">target_col</span><span class="p">)</span>
        <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">num_bag_folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">num_bag_sets</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;kfold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Monte Carlo валидация</span>
    <span class="k">if</span> <span class="s1">&#39;monte_carlo&#39;</span> <span class="ow">in</span> <span class="n">validation_methods</span><span class="p">:</span>
        <span class="n">mc_results</span> <span class="o">=</span> <span class="n">monte_carlo_validation</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">target_col</span><span class="p">,</span> <span class="n">n_iterations</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;monte_carlo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mc_results</span>

    <span class="k">return</span> <span class="n">results</span>
</code></pre></div>

<h2 id="_138">Валидация для финансовых данных</h2>
<h3 id="_139">Финансовая валидация</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">financial_validation</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">target_col</span><span class="p">,</span> <span class="n">lookback_window</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">forward_window</span><span class="o">=</span><span class="mi">21</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Специализированная валидация для финансовых данных&quot;&quot;&quot;</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lookback_window</span><span class="p">,</span> <span class="n">n_samples</span> <span class="o">-</span> <span class="n">forward_window</span><span class="p">,</span> <span class="n">forward_window</span><span class="p">):</span>
        <span class="c1"># Обучающая выборка (lookback_window дней)</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">lookback_window</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Тестовая выборка (forward_window дней)</span>
        <span class="n">test_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">forward_window</span><span class="p">]</span>

        <span class="c1"># Обучение модели</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">target_col</span><span class="p">)</span>
        <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

        <span class="c1"># Предсказания</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

        <span class="c1"># Финансовые метрики</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">predicted_returns</span> <span class="o">=</span> <span class="n">predictions</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="c1"># Sharpe Ratio</span>
        <span class="n">sharpe_ratio</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

        <span class="c1"># Maximum Drawdown</span>
        <span class="n">cumulative_returns</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="n">cumulative_returns</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">cumulative_returns</span> <span class="o">-</span> <span class="n">peak</span><span class="p">)</span> <span class="o">/</span> <span class="n">peak</span>
        <span class="n">max_drawdown</span> <span class="o">=</span> <span class="n">drawdown</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;start_date&#39;</span><span class="p">:</span> <span class="n">test_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;end_date&#39;</span><span class="p">:</span> <span class="n">test_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">sharpe_ratio</span><span class="p">,</span>
            <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">max_drawdown</span><span class="p">,</span>
            <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="n">predictions</span>
        <span class="p">})</span>

    <span class="k">return</span> <span class="n">results</span>
</code></pre></div>

<h2 id="_140">Анализ результатов валидации</h2>
<h3 id="_141">Статистический анализ</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analyze_validation_results</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Анализ результатов валидации&quot;&quot;&quot;</span>

    <span class="c1"># Извлечение метрик</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;performance&#39;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;performance&#39;</span><span class="p">])</span>

    <span class="c1"># Статистический анализ</span>
    <span class="n">analysis</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">]</span>
        <span class="n">analysis</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values</span><span class="p">),</span>
            <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">values</span><span class="p">),</span>
            <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">values</span><span class="p">),</span>
            <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">values</span><span class="p">),</span>
            <span class="s1">&#39;median&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">values</span><span class="p">),</span>
            <span class="s1">&#39;q25&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
            <span class="s1">&#39;q75&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="mi">75</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">return</span> <span class="n">analysis</span>

<span class="c1"># Использование</span>
<span class="n">analysis</span> <span class="o">=</span> <span class="n">analyze_validation_results</span><span class="p">(</span><span class="n">backtest_results</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Validation Analysis:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">stats</span> <span class="ow">in</span> <span class="n">analysis</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="_142">Визуализация результатов</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_validation_results</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Визуализация результатов валидации&quot;&quot;&quot;</span>

    <span class="c1"># Извлечение метрик</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;performance&#39;</span> <span class="ow">in</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;performance&#39;</span><span class="p">]:</span>
            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;performance&#39;</span><span class="p">][</span><span class="n">metric</span><span class="p">])</span>

    <span class="c1"># График</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

    <span class="c1"># Временной ряд метрики</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1"> over time&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Fold/Iteration&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>

    <span class="c1"># Распределение метрики</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Distribution of </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>

    <span class="c1"># Box plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Box plot of </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>

    <span class="c1"># Статистики</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">stats_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Mean: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">    Std: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">    Min: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">    Max: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">stats_text</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Использование</span>
<span class="n">plot_validation_results</span><span class="p">(</span><span class="n">backtest_results</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">)</span>
</code></pre></div>

<h2 id="_143">Практические примеры</h2>
<h3 id="_144">Полный пример валидации</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.tabular</span><span class="w"> </span><span class="kn">import</span> <span class="n">TabularPredictor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_classification</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>

<span class="c1"># Создание данных</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_classification</span><span class="p">(</span>
    <span class="n">n_samples</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
    <span class="n">n_features</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">n_informative</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
    <span class="n">n_redundant</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">n_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;feature_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)])</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>

<span class="c1"># Добавление временной метки</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2020-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">)</span>

<span class="c1"># Различные методы валидации</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Holdout Validation ===&quot;</span><span class="p">)</span>
<span class="n">predictor_holdout</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">)</span>
<span class="n">predictor_holdout</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">holdout_frac</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">holdout_performance</span> <span class="o">=</span> <span class="n">predictor_holdout</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Holdout Performance: </span><span class="si">{</span><span class="n">holdout_performance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== K-Fold Validation ===&quot;</span><span class="p">)</span>
<span class="n">predictor_kfold</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">)</span>
<span class="n">predictor_kfold</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">num_bag_folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">num_bag_sets</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">kfold_performance</span> <span class="o">=</span> <span class="n">predictor_kfold</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;K-Fold Performance: </span><span class="si">{</span><span class="n">kfold_performance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Time Series Backtest ===&quot;</span><span class="p">)</span>
<span class="n">backtest_results</span> <span class="o">=</span> <span class="n">time_series_backtest</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">backtest_analysis</span> <span class="o">=</span> <span class="n">analyze_validation_results</span><span class="p">(</span><span class="n">backtest_results</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Backtest Analysis: </span><span class="si">{</span><span class="n">backtest_analysis</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Monte Carlo Validation ===&quot;</span><span class="p">)</span>
<span class="n">mc_results</span> <span class="o">=</span> <span class="n">monte_carlo_validation</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="n">n_iterations</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">mc_analysis</span> <span class="o">=</span> <span class="n">analyze_validation_results</span><span class="p">(</span><span class="n">mc_results</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Monte Carlo Analysis: </span><span class="si">{</span><span class="n">mc_analysis</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Визуализация результатов</span>
<span class="n">plot_validation_results</span><span class="p">(</span><span class="n">backtest_results</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">)</span>
</code></pre></div>

<h2 id="_145">Лучшие практики валидации</h2>
<h3 id="_146">Выбор метода валидации</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">choose_validation_method</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="n">problem_type</span><span class="p">,</span> <span class="n">data_size</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Выбор оптимального метода валидации&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s1">&#39;time_series&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;time_series_backtest&#39;</span>
    <span class="k">elif</span> <span class="n">data_size</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;kfold&#39;</span>
    <span class="k">elif</span> <span class="n">data_size</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;holdout&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;monte_carlo&#39;</span>
</code></pre></div>

<h3 id="_147">Настройка параметров валидации</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">optimize_validation_params</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">target_col</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Оптимизация параметров валидации&quot;&quot;&quot;</span>

    <span class="c1"># Определение оптимального количества фолдов</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_samples</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="n">n_folds</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">elif</span> <span class="n">n_samples</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="n">n_folds</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n_folds</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="c1"># Определение размера holdout</span>
    <span class="k">if</span> <span class="n">n_samples</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="n">holdout_frac</span> <span class="o">=</span> <span class="mf">0.3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">holdout_frac</span> <span class="o">=</span> <span class="mf">0.2</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;n_folds&#39;</span><span class="p">:</span> <span class="n">n_folds</span><span class="p">,</span>
        <span class="s1">&#39;holdout_frac&#39;</span><span class="p">:</span> <span class="n">holdout_frac</span><span class="p">,</span>
        <span class="s1">&#39;n_monte_carlo&#39;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">n_samples</span> <span class="o">//</span> <span class="mi">10</span><span class="p">)</span>
    <span class="p">}</span>
</code></pre></div>

<h2 id="_148">Следующие шаги</h2>
<p>После освоения методов валидации переходите к:<br />
- <a href="./06_production.md">Продакшен деплою</a><br />
- <a href="./07_retraining.md">Переобучению моделей</a><br />
- <a href="./08_best_practices.md">Лучшим практикам</a></p>
<hr />
<h1 id="automl-gluon_5">Продакшен и деплой AutoML Gluon моделей</h1>
<p><strong>Автор:</strong> Shcherbyna Rostyslav<br />
<strong>Дата:</strong> 2024  </p>
<h2 id="_149">Почему продакшен критически важен</h2>
<p><strong>Почему 87% ML-моделей никогда не попадают в продакшен?</strong> Потому что их создатели не понимают, что обучение модели - это только 20% работы. Остальные 80% - это подготовка к продакшену, мониторинг и поддержка.</p>
<h3 id="_150">Катастрофические последствия плохого продакшена</h3>
<ul>
<li><strong>Microsoft Tay</strong>: AI-чатбот стал расистом за 24 часа в продакшене</li>
<li><strong>Amazon HR</strong>: AI-система дискриминировала женщин при найме</li>
<li><strong>Uber самоуправляемые авто</strong>: Смерть пешехода из-за неправильной работы модели</li>
<li><strong>Facebook алгоритм</strong>: Распространение фейковых новостей из-за плохой валидации</li>
</ul>
<h3 id="_151">Преимущества правильного продакшена</h3>
<ul>
<li><strong>Масштабируемость</strong>: Модель работает с любым объемом данных</li>
<li><strong>Надежность</strong>: 99.9% uptime, автоматическое восстановление</li>
<li><strong>Мониторинг</strong>: Постоянный контроль качества предсказаний</li>
<li><strong>Бизнес-ценность</strong>: Реальная польза для компании и пользователей</li>
</ul>
<h2 id="_152">Введение в продакшен</h2>
<p><img alt="Продакшен архитектура" src="images/production_architecture.png" /><br />
<em>Рисунок 5: Архитектура продакшен системы AutoML Gluon</em></p>
<p><strong>Почему продакшен в ML кардинально отличается от обычной разработки?</strong> Потому что ML-модели - это не просто код, а живые системы, которые учатся и изменяются. Это как разница между заводом и садом - завод работает по плану, а сад требует постоянного ухода.</p>
<p><strong>Уникальные особенности ML продакшена:</strong><br />
- <strong>Данные меняются</strong>: Модель может "забыть" то, что знала<br />
- <strong>Концептуальный дрифт</strong>: Реальность изменяется быстрее модели<br />
- <strong>Зависимость от данных</strong>: Нет данных = нет предсказаний<br />
- <strong>Черный ящик</strong>: Сложно понять, почему модель приняла решение</p>
<p>Продакшен деплой ML-моделей - это критически важный этап, который требует тщательного планирования, мониторинга и поддержки. В этом разделе рассмотрим все аспекты деплоя AutoML Gluon моделей в продакшен.</p>
<h2 id="_153">Подготовка модели к продакшену</h2>
<h3 id="_154">Оптимизация модели</h3>
<p><strong>Почему модель, которая отлично работает в Jupyter, может провалиться в продакшене?</strong> Потому что продакшен предъявляет совершенно другие требования к производительности, памяти и скорости.</p>
<p><strong>Проблемы неоптимизированных моделей в продакшене:</strong><br />
- <strong>Медленные предсказания</strong>: 5 секунд вместо 50мс - пользователи уйдут<br />
- <strong>Высокое потребление памяти</strong>: Сервер падает под нагрузкой<br />
- <strong>Большой размер модели</strong>: Не помещается в контейнер<br />
- <strong>Нестабильность</strong>: Модель работает нестабильно на разных серверах</p>
<p><strong>Методы оптимизации моделей:</strong><br />
- <strong>Квантизация</strong>: Уменьшение точности весов (float32 → float16)<br />
- <strong>Прунинг</strong>: Удаление неважных нейронов<br />
- <strong>Дистилляция</strong>: Обучение маленькой модели на большой<br />
- <strong>Оптимизация архитектуры</strong>: Выбор более эффективных алгоритмов</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.tabular</span><span class="w"> </span><span class="kn">import</span> <span class="n">TabularPredictor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># Создание оптимизированной модели для продакшена</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_production_model</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">target_col</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Создание модели, оптимизированной для продакшена&quot;&quot;&quot;</span>

    <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="n">target_col</span><span class="p">,</span>
        <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="s1">&#39;./production_models&#39;</span>  <span class="c1"># Отдельная папка для продакшен моделей</span>
    <span class="p">)</span>

    <span class="c1"># Обучение с оптимизацией для деплоя</span>
    <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">train_data</span><span class="p">,</span>
        <span class="n">presets</span><span class="o">=</span><span class="s1">&#39;optimize_for_deployment&#39;</span><span class="p">,</span>  <span class="c1"># Специальные настройки для продакшена</span>
        <span class="n">time_limit</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span>  <span class="c1"># 1 час - ограничение времени обучения</span>
        <span class="n">num_bag_folds</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>   <span class="c1"># Меньше фолдов для скорости</span>
        <span class="n">num_bag_sets</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">ag_args_fit</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;num_cpus&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>        <span class="c1"># Ограничение CPU для стабильности</span>
            <span class="s1">&#39;num_gpus&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>        <span class="c1"># Отключение GPU для совместимости</span>
            <span class="s1">&#39;memory_limit&#39;</span><span class="p">:</span> <span class="mi">8</span>     <span class="c1"># Ограничение памяти в GB</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">predictor</span>
</code></pre></div>

<p><strong>Почему важны ограничения ресурсов?</strong> Потому что продакшен серверы имеют ограниченные ресурсы, и модель должна работать в этих рамках.</p>
<h3 id="_155">Сжатие модели</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compress_model</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">model_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Сжатие модели для продакшена&quot;&quot;&quot;</span>

    <span class="c1"># Сохранение сжатой модели</span>
    <span class="n">predictor</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
        <span class="n">model_name</span><span class="p">,</span>
        <span class="n">save_space</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">compress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">save_info</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="c1"># Получение размера модели</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
    <span class="n">model_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">/predictor.pkl&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>  <span class="c1"># MB</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model size: </span><span class="si">{</span><span class="n">model_size</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model_size</span>
</code></pre></div>

<h3 id="_156">Валидация модели</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validate_production_model</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">test_data</span><span class="p">,</span> <span class="n">performance_thresholds</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Валидация модели для продакшена&quot;&quot;&quot;</span>

    <span class="c1"># Предсказания</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

    <span class="c1"># Оценка качества</span>
    <span class="n">performance</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

    <span class="c1"># Проверка пороговых значений</span>
    <span class="n">validation_results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">threshold</span> <span class="ow">in</span> <span class="n">performance_thresholds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">performance</span><span class="p">:</span>
            <span class="n">validation_results</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">performance</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">threshold</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">validation_results</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Проверка стабильности предсказаний</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="s1">&#39;predict_proba&#39;</span><span class="p">):</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
        <span class="n">prob_std</span> <span class="o">=</span> <span class="n">probabilities</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">validation_results</span><span class="p">[</span><span class="s1">&#39;stability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob_std</span> <span class="o">&lt;</span> <span class="mf">0.1</span>  <span class="c1"># Стабильность вероятностей</span>

    <span class="k">return</span> <span class="n">validation_results</span><span class="p">,</span> <span class="n">performance</span>
</code></pre></div>

<h2 id="api">API сервер для продакшена</h2>
<h3 id="fastapi">FastAPI сервер</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.tabular</span><span class="w"> </span><span class="kn">import</span> <span class="n">TabularPredictor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># Настройка логирования</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Создание FastAPI приложения</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;AutoML Gluon Production API&quot;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;1.0.0&quot;</span><span class="p">)</span>

<span class="c1"># Глобальная переменная для модели</span>
<span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PredictionRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Схема запроса для предсказания&quot;&quot;&quot;</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PredictionResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Схема ответа с предсказаниями&quot;&quot;&quot;</span>
    <span class="n">predictions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
    <span class="n">probabilities</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">model_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span><span class="w"> </span><span class="nc">HealthResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Схема ответа для health check&quot;&quot;&quot;</span>
    <span class="n">status</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">model_loaded</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">model_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">&quot;startup&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">load_model</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Загрузка модели при запуске сервера&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">model</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;./production_models&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Model loaded successfully&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load model: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/health&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">HealthResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">health_check</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Health check endpoint&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HealthResponse</span><span class="p">(</span>
            <span class="n">status</span><span class="o">=</span><span class="s2">&quot;unhealthy&quot;</span><span class="p">,</span>
            <span class="n">model_loaded</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">HealthResponse</span><span class="p">(</span>
        <span class="n">status</span><span class="o">=</span><span class="s2">&quot;healthy&quot;</span><span class="p">,</span>
        <span class="n">model_loaded</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">model_info</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;model_path&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
            <span class="s2">&quot;problem_type&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">problem_type</span><span class="p">,</span>
            <span class="s2">&quot;eval_metric&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">eval_metric</span>
        <span class="p">}</span>
    <span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/predict&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">PredictionResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">PredictionRequest</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Endpoint для предсказаний&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">503</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Model not loaded&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Преобразование данных в DataFrame</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Предсказания</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># Вероятности (если доступны)</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;predict_proba&#39;</span><span class="p">):</span>
            <span class="n">proba</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="n">probabilities</span> <span class="o">=</span> <span class="n">proba</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>

        <span class="c1"># Информация о модели</span>
        <span class="n">model_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;model_path&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
            <span class="s2">&quot;problem_type&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">problem_type</span><span class="p">,</span>
            <span class="s2">&quot;eval_metric&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">eval_metric</span><span class="p">,</span>
            <span class="s2">&quot;num_features&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">PredictionResponse</span><span class="p">(</span>
            <span class="n">predictions</span><span class="o">=</span><span class="n">predictions</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
            <span class="n">probabilities</span><span class="o">=</span><span class="n">probabilities</span><span class="p">,</span>
            <span class="n">model_info</span><span class="o">=</span><span class="n">model_info</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Prediction error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/model/info&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">model_info</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Информация о модели&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">503</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Model not loaded&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;model_path&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
        <span class="s2">&quot;problem_type&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">problem_type</span><span class="p">,</span>
        <span class="s2">&quot;eval_metric&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">eval_metric</span><span class="p">,</span>
        <span class="s2">&quot;feature_importance&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">feature_importance</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="p">}</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>
    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8000</span><span class="p">)</span>
</code></pre></div>

<h3 id="flask">Flask сервер</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.tabular</span><span class="w"> </span><span class="kn">import</span> <span class="n">TabularPredictor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>

<span class="c1"># Настройка логирования</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Создание Flask приложения</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Глобальная переменная для модели</span>
<span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">load_model</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Загрузка модели&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">model</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;./production_models&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Model loaded successfully&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load model: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/health&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">health_check</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Health check endpoint&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;unhealthy&quot;</span><span class="p">,</span>
            <span class="s2">&quot;model_loaded&quot;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">}),</span> <span class="mi">503</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;healthy&quot;</span><span class="p">,</span>
        <span class="s2">&quot;model_loaded&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;model_info&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;model_path&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
            <span class="s2">&quot;problem_type&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">problem_type</span><span class="p">,</span>
            <span class="s2">&quot;eval_metric&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">eval_metric</span>
        <span class="p">}</span>
    <span class="p">})</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/predict&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Endpoint для предсказаний&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Model not loaded&quot;</span><span class="p">}),</span> <span class="mi">503</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Получение данных</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No data provided&quot;</span><span class="p">}),</span> <span class="mi">400</span>

        <span class="c1"># Преобразование в DataFrame</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>

        <span class="c1"># Предсказания</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># Вероятности (если доступны)</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;predict_proba&#39;</span><span class="p">):</span>
            <span class="n">proba</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="n">probabilities</span> <span class="o">=</span> <span class="n">proba</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s2">&quot;predictions&quot;</span><span class="p">:</span> <span class="n">predictions</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
            <span class="s2">&quot;probabilities&quot;</span><span class="p">:</span> <span class="n">probabilities</span><span class="p">,</span>
            <span class="s2">&quot;model_info&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;model_path&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="s2">&quot;problem_type&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">problem_type</span><span class="p">,</span>
                <span class="s2">&quot;eval_metric&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">eval_metric</span>
            <span class="p">},</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">})</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Prediction error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}),</span> <span class="mi">500</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/model/info&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">model_info</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Информация о модели&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Model not loaded&quot;</span><span class="p">}),</span> <span class="mi">503</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s2">&quot;model_path&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
        <span class="s2">&quot;problem_type&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">problem_type</span><span class="p">,</span>
        <span class="s2">&quot;eval_metric&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">eval_metric</span><span class="p">,</span>
        <span class="s2">&quot;feature_importance&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">feature_importance</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="p">})</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">load_model</span><span class="p">():</span>
        <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8000</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to start server - model not loaded&quot;</span><span class="p">)</span>
</code></pre></div>

<h2 id="docker">Docker контейнеризация</h2>
<h3 id="dockerfile">Dockerfile для продакшена</h3>
<div class="codehilite"><pre><span></span><code><span class="c"># Dockerfile для продакшена</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.9-slim</span>

<span class="c"># Установка системных зависимостей</span>
<span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>gcc<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>g++<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="o">&amp;&amp;</span><span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>/var/lib/apt/lists/*

<span class="c"># Создание рабочей директории</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>

<span class="c"># Копирование requirements</span>
<span class="k">COPY</span><span class="w"> </span>requirements.txt<span class="w"> </span>.

<span class="c"># Установка Python зависимостей</span>
<span class="k">RUN</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--no-cache-dir<span class="w"> </span>-r<span class="w"> </span>requirements.txt

<span class="c"># Копирование кода приложения</span>
<span class="k">COPY</span><span class="w"> </span>.<span class="w"> </span>.

<span class="c"># Создание пользователя для безопасности</span>
<span class="k">RUN</span><span class="w"> </span>useradd<span class="w"> </span>-m<span class="w"> </span>-u<span class="w"> </span><span class="m">1000</span><span class="w"> </span>appuser<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>chown<span class="w"> </span>-R<span class="w"> </span>appuser:appuser<span class="w"> </span>/app
<span class="k">USER</span><span class="w"> </span><span class="s">appuser</span>

<span class="c"># Открытие порта</span>
<span class="k">EXPOSE</span><span class="w"> </span><span class="s">8000</span>

<span class="c"># Команда запуска</span>
<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;python&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;app.py&quot;</span><span class="p">]</span>
</code></pre></div>

<h3 id="docker-compose">Docker Compose для продакшена</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># docker-compose.prod.yml</span>
<span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3.8&#39;</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">autogluon-api</span><span class="p">:</span>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;8000:8000&quot;</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MODEL_PATH=/app/models</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LOG_LEVEL=INFO</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./models:/app/models</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./logs:/app/logs</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<span class="w">    </span><span class="nt">healthcheck</span><span class="p">:</span>
<span class="w">      </span><span class="nt">test</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;CMD&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;curl&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;-f&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;http://localhost:8000/health&quot;</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30s</span>
<span class="w">      </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10s</span>
<span class="w">      </span><span class="nt">retries</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">      </span><span class="nt">start_period</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">40s</span>

<span class="w">  </span><span class="nt">nginx</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx:alpine</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;80:80&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;443:443&quot;</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./nginx.conf:/etc/nginx/nginx.conf</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./ssl:/etc/nginx/ssl</span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">autogluon-api</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>

<span class="w">  </span><span class="nt">redis</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis:alpine</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;6379:6379&quot;</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis_data:/data</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>

<span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="nt">redis_data</span><span class="p">:</span>
</code></pre></div>

<h2 id="kubernetes">Kubernetes деплой</h2>
<h3 id="deployment">Deployment манифест</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># k8s-deployment.yaml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">autogluon-api</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">autogluon-api</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">autogluon-api</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">autogluon-api</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">autogluon-api</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">autogluon-api:latest</span>
<span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000</span>
<span class="w">        </span><span class="nt">env</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MODEL_PATH</span>
<span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/app/models&quot;</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LOG_LEVEL</span>
<span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;INFO&quot;</span>
<span class="w">        </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">          </span><span class="nt">requests</span><span class="p">:</span>
<span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1Gi&quot;</span>
<span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;500m&quot;</span>
<span class="w">          </span><span class="nt">limits</span><span class="p">:</span>
<span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2Gi&quot;</span>
<span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1000m&quot;</span>
<span class="w">        </span><span class="nt">livenessProbe</span><span class="p">:</span>
<span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span>
<span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/health</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000</span>
<span class="w">          </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
<span class="w">          </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">        </span><span class="nt">readinessProbe</span><span class="p">:</span>
<span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span>
<span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/health</span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000</span>
<span class="w">          </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="w">          </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">model-storage</span>
<span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/app/models</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">log-storage</span>
<span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/app/logs</span>
<span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">model-storage</span>
<span class="w">        </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span>
<span class="w">          </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">model-pvc</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">log-storage</span>
<span class="w">        </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span>
<span class="w">          </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">log-pvc</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">autogluon-api-service</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">autogluon-api</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LoadBalancer</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">model-pvc</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
<span class="w">  </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">    </span><span class="nt">requests</span><span class="p">:</span>
<span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10Gi</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">log-pvc</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
<span class="w">  </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">    </span><span class="nt">requests</span><span class="p">:</span>
<span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5Gi</span>
</code></pre></div>

<h2 id="_157">Мониторинг и логирование</h2>
<h3 id="_158">Система мониторинга</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">psutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ProductionMonitor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Мониторинг продакшен системы&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_file</span><span class="o">=</span><span class="s1">&#39;production.log&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span> <span class="o">=</span> <span class="n">log_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">setup_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Настройка логирования&quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
            <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">handlers</span><span class="o">=</span><span class="p">[</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">),</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">prediction</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> 
                      <span class="n">processing_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">model_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Логирование предсказания&quot;&quot;&quot;</span>
        <span class="n">log_entry</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;input_data&#39;</span><span class="p">:</span> <span class="n">input_data</span><span class="p">,</span>
            <span class="s1">&#39;prediction&#39;</span><span class="p">:</span> <span class="n">prediction</span><span class="p">,</span>
            <span class="s1">&#39;processing_time&#39;</span><span class="p">:</span> <span class="n">processing_time</span><span class="p">,</span>
            <span class="s1">&#39;model_info&#39;</span><span class="p">:</span> <span class="n">model_info</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Prediction: </span><span class="si">{</span><span class="n">log_entry</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Логирование ошибок&quot;&quot;&quot;</span>
        <span class="n">error_entry</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">),</span>
            <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="n">context</span><span class="p">,</span>
            <span class="s1">&#39;traceback&#39;</span><span class="p">:</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">error_entry</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_system_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Получение системных метрик&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;cpu_percent&#39;</span><span class="p">:</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_percent</span><span class="p">(),</span>
            <span class="s1">&#39;memory_percent&#39;</span><span class="p">:</span> <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span><span class="o">.</span><span class="n">percent</span><span class="p">,</span>
            <span class="s1">&#39;disk_percent&#39;</span><span class="p">:</span> <span class="n">psutil</span><span class="o">.</span><span class="n">disk_usage</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">percent</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_model_health</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Проверка здоровья модели&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Тестовое предсказание</span>
            <span class="n">test_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;feature1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">],</span> <span class="s1">&#39;feature2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.0</span><span class="p">]})</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
            <span class="n">processing_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;healthy&#39;</span><span class="p">,</span>
                <span class="s1">&#39;processing_time&#39;</span><span class="p">:</span> <span class="n">processing_time</span><span class="p">,</span>
                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;unhealthy&#39;</span><span class="p">,</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="p">}</span>
</code></pre></div>

<h3 id="_159">Алерты и уведомления</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">smtplib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">email.mime.text</span><span class="w"> </span><span class="kn">import</span> <span class="n">MIMEText</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">email.mime.multipart</span><span class="w"> </span><span class="kn">import</span> <span class="n">MIMEMultipart</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AlertSystem</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Система алертов для продакшена&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smtp_server</span><span class="p">,</span> <span class="n">smtp_port</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smtp_server</span> <span class="o">=</span> <span class="n">smtp_server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smtp_port</span> <span class="o">=</span> <span class="n">smtp_port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">send_email_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">recipients</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Отправка email алерта&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">MIMEMultipart</span><span class="p">()</span>
            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;From&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">email</span>
            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;To&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">recipients</span><span class="p">)</span>
            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Subject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subject</span>

            <span class="n">msg</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">MIMEText</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s1">&#39;plain&#39;</span><span class="p">))</span>

            <span class="n">server</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smtp_server</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smtp_port</span><span class="p">)</span>
            <span class="n">server</span><span class="o">.</span><span class="n">starttls</span><span class="p">()</span>
            <span class="n">server</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
            <span class="n">server</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">server</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Email alert sent to </span><span class="si">{</span><span class="n">recipients</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to send email alert: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">send_slack_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">webhook_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Отправка Slack алерта&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
                <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;AutoML Gluon Monitor&quot;</span><span class="p">,</span>
                <span class="s2">&quot;icon_emoji&quot;</span><span class="p">:</span> <span class="s2">&quot;:robot_face:&quot;</span>
            <span class="p">}</span>

            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">webhook_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Slack alert sent successfully&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to send Slack alert: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_performance_thresholds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> 
                                   <span class="n">thresholds</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Проверка пороговых значений производительности&quot;&quot;&quot;</span>
        <span class="n">alerts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">threshold</span> <span class="ow">in</span> <span class="n">thresholds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span> <span class="ow">and</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
                <span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> is below threshold: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">alerts</span>
</code></pre></div>

<h2 id="_160">Масштабирование</h2>
<h3 id="_161">Горизонтальное масштабирование</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Настройка для горизонтального масштабирования</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">queue</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ScalablePredictionService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Масштабируемый сервис предсказаний&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_workers</span> <span class="o">=</span> <span class="n">max_workers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">max_workers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Асинхронная обработка предсказания&quot;&quot;&quot;</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>

        <span class="c1"># Выполнение предсказания в отдельном потоке</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">_predict_sync</span><span class="p">,</span> 
            <span class="n">data</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_predict_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Синхронное предсказание&quot;&quot;&quot;</span>
        <span class="c1"># Ваша логика предсказания</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">batch_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Пакетная обработка предсказаний&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Разделение на батчи</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_data</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">batch_data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">batch_size</span><span class="p">]</span>

            <span class="c1"># Параллельная обработка батча</span>
            <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
                <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_predict_sync</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
                <span class="n">batch_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">]</span>
                <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">batch_results</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>
</code></pre></div>

<h3 id="_162">Кэширование</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">redis</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PredictionCache</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Кэш для предсказаний&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redis_host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">redis_port</span><span class="o">=</span><span class="mi">6379</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">3600</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis_client</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">redis_host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">redis_port</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ttl</span> <span class="o">=</span> <span class="n">ttl</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Генерация ключа кэша&quot;&quot;&quot;</span>
        <span class="n">data_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">data_str</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Получение предсказания из кэша&quot;&quot;&quot;</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_cache_key</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">cached_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cached_result</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">cached_result</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">prediction</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Сохранение предсказания в кэш&quot;&quot;&quot;</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_cache_key</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis_client</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span>
            <span class="n">cache_key</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">ttl</span><span class="p">,</span> 
            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">invalidate_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Очистка кэша&quot;&quot;&quot;</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_client</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis_client</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="o">*</span><span class="n">keys</span><span class="p">)</span>
</code></pre></div>

<h2 id="_163">Безопасность</h2>
<h3 id="_164">Аутентификация и авторизация</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SecurityManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Менеджер безопасности&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">secret_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="n">secret_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_keys</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_api_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Генерация API ключа&quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_keys</span><span class="p">[</span><span class="n">api_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
            <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;permissions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;predict&#39;</span><span class="p">,</span> <span class="s1">&#39;model_info&#39;</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">api_key</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_api_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Валидация API ключа&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">api_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_keys</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Получение разрешений пользователя&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">api_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_keys</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_keys</span><span class="p">[</span><span class="n">api_key</span><span class="p">][</span><span class="s1">&#39;permissions&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">require_auth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">permissions</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Декоратор для проверки аутентификации&quot;&quot;&quot;</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">decorated_function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="c1"># Проверка API ключа</span>
                <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;X-API-Key&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_api_key</span><span class="p">(</span><span class="n">api_key</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid API key&#39;</span><span class="p">}),</span> <span class="mi">401</span>

                <span class="c1"># Проверка разрешений</span>
                <span class="k">if</span> <span class="n">permissions</span><span class="p">:</span>
                    <span class="n">user_permissions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_permissions</span><span class="p">(</span><span class="n">api_key</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">perm</span> <span class="ow">in</span> <span class="n">user_permissions</span> <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="n">permissions</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Insufficient permissions&#39;</span><span class="p">}),</span> <span class="mi">403</span>

                <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">decorated_function</span>
        <span class="k">return</span> <span class="n">decorator</span>
</code></pre></div>

<h3 id="_165">Валидация входных данных</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">validator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">class</span><span class="w"> </span><span class="nc">InputValidator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Валидатор входных данных&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_schema</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_schema</span> <span class="o">=</span> <span class="n">feature_schema</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Валидация входных данных&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="c1"># Проверка наличия всех обязательных признаков</span>
                <span class="k">for</span> <span class="n">feature</span><span class="p">,</span> <span class="n">schema</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_schema</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">feature</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required feature: </span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="c1"># Проверка типа данных</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">feature</span><span class="p">],</span> <span class="n">schema</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid type for feature </span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="c1"># Проверка диапазона значений</span>
                    <span class="k">if</span> <span class="s1">&#39;min&#39;</span> <span class="ow">in</span> <span class="n">schema</span> <span class="ow">and</span> <span class="n">record</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">schema</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Value too small for feature </span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="s1">&#39;max&#39;</span> <span class="ow">in</span> <span class="n">schema</span> <span class="ow">and</span> <span class="n">record</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">schema</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Value too large for feature </span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sanitize_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Очистка входных данных&quot;&quot;&quot;</span>
        <span class="n">sanitized_data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">sanitized_record</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">feature</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Очистка от потенциально опасных символов</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">sanitized_record</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sanitized_record</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="n">sanitized_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sanitized_record</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sanitized_data</span>
</code></pre></div>

<h2 id="_166">Тестирование продакшен системы</h2>
<h3 id="_167">Нагрузочное тестирование</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">aiohttp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">statistics</span>

<span class="k">class</span><span class="w"> </span><span class="nc">LoadTester</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Нагрузочное тестирование API&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">single_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">,</span> 
                           <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Одиночный запрос&quot;&quot;&quot;</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/predict&quot;</span><span class="p">,</span>
                <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">data</span><span class="p">]}</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="n">processing_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

                <span class="k">return</span> <span class="p">{</span>
                    <span class="s1">&#39;status_code&#39;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                    <span class="s1">&#39;processing_time&#39;</span><span class="p">:</span> <span class="n">processing_time</span><span class="p">,</span>
                    <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">,</span>
                    <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">result</span>
                <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;status_code&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;processing_time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">,</span>
                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">load_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concurrent_users</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
                       <span class="n">requests_per_user</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
                       <span class="n">test_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Нагрузочное тестирование&quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">concurrent_users</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">requests_per_user</span><span class="p">):</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="n">request</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="p">)]</span>
                    <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_request</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                    <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

            <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>

        <span class="c1"># Анализ результатов</span>
        <span class="n">successful_requests</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]]</span>
        <span class="n">failed_requests</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]]</span>

        <span class="n">processing_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;processing_time&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">successful_requests</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_requests&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
            <span class="s1">&#39;successful_requests&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">successful_requests</span><span class="p">),</span>
            <span class="s1">&#39;failed_requests&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">failed_requests</span><span class="p">),</span>
            <span class="s1">&#39;success_rate&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">successful_requests</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
            <span class="s1">&#39;avg_processing_time&#39;</span><span class="p">:</span> <span class="n">statistics</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">processing_times</span><span class="p">),</span>
            <span class="s1">&#39;min_processing_time&#39;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">processing_times</span><span class="p">),</span>
            <span class="s1">&#39;max_processing_time&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">processing_times</span><span class="p">),</span>
            <span class="s1">&#39;p95_processing_time&#39;</span><span class="p">:</span> <span class="n">statistics</span><span class="o">.</span><span class="n">quantiles</span><span class="p">(</span><span class="n">processing_times</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">)[</span><span class="mi">18</span><span class="p">]</span>
        <span class="p">}</span>
</code></pre></div>

<h2 id="_168">Следующие шаги</h2>
<p>После освоения продакшен деплоя переходите к:<br />
- <a href="./07_retraining.md">Переобучению моделей</a><br />
- <a href="./08_best_practices.md">Лучшим практикам</a><br />
- <a href="./09_examples.md">Примерам использования</a></p>
<hr />
<h1 id="automl-gluon_6">Переобучение моделей AutoML Gluon</h1>
<p><strong>Автор:</strong> Shcherbyna Rostyslav<br />
<strong>Дата:</strong> 2024  </p>
<h2 id="_169">Почему переобучение критически важно</h2>
<p><strong>Почему 90% ML-моделей теряют точность через 6 месяцев в продакшене?</strong> Потому что мир меняется, а модели остаются статичными. Переобучение - это процесс "обновления знаний" модели, как врач, который изучает новые методы лечения.</p>
<h3 id="_170">Катастрофические последствия устаревших моделей</h3>
<ul>
<li><strong>Netflix рекомендации</strong>: Модель 2010 года не понимала сериалы 2020 года</li>
<li><strong>Google Translate</strong>: Устаревшие модели давали неточные переводы новых сленгов</li>
<li><strong>Банковские системы</strong>: Модели не распознавали новые виды мошенничества</li>
<li><strong>Медицинские диагнозы</strong>: Устаревшие модели пропускали новые симптомы болезней</li>
</ul>
<h3 id="_171">Преимущества правильного переобучения</h3>
<ul>
<li><strong>Актуальность</strong>: Модель всегда работает с актуальными данными</li>
<li><strong>Адаптивность</strong>: Автоматически подстраивается под изменения</li>
<li><strong>Конкурентоспособность</strong>: Остается эффективной в динамичной среде</li>
<li><strong>Доверие пользователей</strong>: Результаты остаются точными и полезными</li>
</ul>
<h2 id="_172">Введение в переобучение</h2>
<p><img alt="Процесс переобучения" src="images/retraining_workflow.png" /><br />
<em>Рисунок 6: Процесс переобучения моделей AutoML Gluon</em></p>
<p><strong>Почему переобучение - это не просто "обновить модель"?</strong> Это процесс адаптации модели к изменяющемуся миру. Представьте врача, который не изучает новые методы лечения - он станет неэффективным.</p>
<p><strong>Почему модели "стареют" в продакшене?</strong><br />
- <strong>Концептуальный дрифт</strong>: Реальность меняется быстрее модели<br />
- <strong>Данные дрифт</strong>: Новые типы данных, которых не было при обучении<br />
- <strong>Пользовательские предпочтения</strong>: Люди меняют поведение и вкусы<br />
- <strong>Технологические изменения</strong>: Новые устройства, платформы, интерфейсы</p>
<p>Переобучение (retraining) - это критически важный процесс для поддержания актуальности ML-моделей в продакшене. В этом разделе рассмотрим все аспекты автоматизированного переобучения моделей.</p>
<h2 id="_173">Стратегии переобучения</h2>
<h3 id="1">1. Периодическое переобучение</h3>
<p><strong>Почему периодическое переобучение - самый простой и надежный подход?</strong> Потому что оно работает по расписанию, как будильник, который напоминает обновить знания. Это как регулярные курсы повышения квалификации для врачей.</p>
<p><strong>Преимущества периодического переобучения:</strong><br />
- <strong>Простота</strong>: Легко настроить и поддерживать<br />
- <strong>Надежность</strong>: Регулярные обновления предотвращают деградацию<br />
- <strong>Планируемость</strong>: Можно заранее подготовить ресурсы<br />
- <strong>Контроль качества</strong>: Время на тестирование перед внедрением</p>
<p><strong>Выбор интервала переобучения:</strong><br />
- <strong>Ежедневно</strong>: Для быстро меняющихся данных (финансы, новости)<br />
- <strong>Еженедельно</strong>: Для большинства бизнес-задач<br />
- <strong>Ежемесячно</strong>: Для стабильных доменов (медицина, образование)<br />
- <strong>По требованию</strong>: При значительных изменениях в данных</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">schedule</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.tabular</span><span class="w"> </span><span class="kn">import</span> <span class="n">TabularPredictor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PeriodicRetraining</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Периодическое переобучение моделей&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">retraining_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span> <span class="o">=</span> <span class="n">model_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retraining_interval</span> <span class="o">=</span> <span class="n">retraining_interval</span>  <span class="c1"># дни</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">schedule_retraining</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Планирование переобучения&quot;&quot;&quot;</span>
        <span class="c1"># Еженедельное переобучение - основной механизм</span>
        <span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">week</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retrain_model</span><span class="p">)</span>

        <span class="c1"># Ежедневная проверка необходимости переобучения - мониторинг</span>
        <span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">check_retraining_need</span><span class="p">)</span>

        <span class="c1"># Запуск планировщика - бесконечный цикл</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">schedule</span><span class="o">.</span><span class="n">run_pending</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3600</span><span class="p">)</span>  <span class="c1"># Проверка каждый час</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">retrain_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Переобучение модели - основной процесс обновления&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting model retraining...&quot;</span><span class="p">)</span>
            <span class="c1"># Логирование начала процесса для мониторинга</span>

            <span class="c1"># Загрузка новых данных</span>
            <span class="n">new_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_new_data</span><span class="p">()</span>

            <span class="c1"># Создание новой модели</span>
            <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
                <span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="si">}</span><span class="s2">_new&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Обучение на новых данных</span>
            <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">new_data</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>

            <span class="c1"># Валидация новой модели</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_new_model</span><span class="p">(</span><span class="n">predictor</span><span class="p">):</span>
                <span class="c1"># Замена старой модели</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">deploy_new_model</span><span class="p">(</span><span class="n">predictor</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Model retraining completed successfully&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;New model validation failed, keeping old model&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model retraining failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_retraining_need</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Проверка необходимости переобучения&quot;&quot;&quot;</span>
        <span class="c1"># Проверка качества текущей модели</span>
        <span class="n">current_performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_current_model</span><span class="p">()</span>

        <span class="c1"># Проверка дрейфа данных</span>
        <span class="n">data_drift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_data_drift</span><span class="p">()</span>

        <span class="c1"># Проверка времени последнего переобучения</span>
        <span class="n">last_retraining</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_retraining_time</span><span class="p">()</span>
        <span class="n">days_since_retraining</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_retraining</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>

        <span class="c1"># Критерии для переобучения</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">current_performance</span> <span class="o">&lt;</span> <span class="mf">0.8</span> <span class="ow">or</span> 
            <span class="n">data_drift</span> <span class="o">&gt;</span> <span class="mf">0.1</span> <span class="ow">or</span> 
            <span class="n">days_since_retraining</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retraining_interval</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Retraining needed based on criteria&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">retrain_model</span><span class="p">()</span>
</code></pre></div>

<h3 id="2">2. Адаптивное переобучение</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AdaptiveRetraining</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Адаптивное переобучение на основе производительности&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">performance_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span> <span class="o">=</span> <span class="n">model_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance_threshold</span> <span class="o">=</span> <span class="n">performance_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">monitor_performance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">actuals</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Мониторинг производительности модели&quot;&quot;&quot;</span>
        <span class="c1"># Расчет текущей производительности</span>
        <span class="n">current_performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_performance</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">actuals</span><span class="p">)</span>

        <span class="c1"># Добавление в историю</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance_history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;performance&#39;</span><span class="p">:</span> <span class="n">current_performance</span>
        <span class="p">})</span>

        <span class="c1"># Проверка тренда производительности</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_performance_degradation</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Performance degradation detected&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trigger_retraining</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">detect_performance_degradation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Обнаружение деградации производительности&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">performance_history</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Анализ тренда за последние 10 измерений</span>
        <span class="n">recent_performance</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;performance&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">performance_history</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]]</span>

        <span class="c1"># Проверка снижения производительности</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">recent_performance</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">performance_threshold</span> <span class="ow">and</span>
            <span class="n">recent_performance</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">recent_performance</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">trigger_retraining</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Запуск переобучения&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Triggering adaptive retraining...&quot;</span><span class="p">)</span>

        <span class="c1"># Загрузка данных для переобучения</span>
        <span class="n">retraining_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_retraining_data</span><span class="p">()</span>

        <span class="c1"># Создание и обучение новой модели</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
            <span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="si">}</span><span class="s2">_adaptive&quot;</span>
        <span class="p">)</span>

        <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">retraining_data</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>

        <span class="c1"># Валидация и деплой</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_new_model</span><span class="p">(</span><span class="n">predictor</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deploy_new_model</span><span class="p">(</span><span class="n">predictor</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">performance_history</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Сброс истории</span>
</code></pre></div>

<h3 id="3_1">3. Инкрементальное переобучение</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">IncrementalRetraining</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Инкрементальное переобучение с сохранением знаний&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span> <span class="o">=</span> <span class="n">model_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">incremental_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Инкрементальное обновление модели&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Загрузка текущей модели</span>
            <span class="n">current_predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">)</span>

            <span class="c1"># Объединение старых и новых данных</span>
            <span class="n">combined_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_data</span><span class="p">(</span><span class="n">current_predictor</span><span class="p">,</span> <span class="n">new_data</span><span class="p">)</span>

            <span class="c1"># Обучение на объединенных данных</span>
            <span class="n">updated_predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
                <span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="si">}</span><span class="s2">_updated&quot;</span>
            <span class="p">)</span>

            <span class="n">updated_predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">combined_data</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>

            <span class="c1"># Валидация обновленной модели</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_updated_model</span><span class="p">(</span><span class="n">updated_predictor</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">deploy_updated_model</span><span class="p">(</span><span class="n">updated_predictor</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Incremental update completed&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Updated model validation failed&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Incremental update failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">combine_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_predictor</span><span class="p">,</span> <span class="n">new_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Объединение старых и новых данных&quot;&quot;&quot;</span>
        <span class="c1"># Получение старых данных из модели (если доступно)</span>
        <span class="n">old_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_old_data</span><span class="p">(</span><span class="n">current_predictor</span><span class="p">)</span>

        <span class="c1"># Объединение данных</span>
        <span class="k">if</span> <span class="n">old_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">combined_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">old_data</span><span class="p">,</span> <span class="n">new_data</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">combined_data</span> <span class="o">=</span> <span class="n">new_data</span>

        <span class="k">return</span> <span class="n">combined_data</span>
</code></pre></div>

<h2 id="_174">Автоматизация переобучения</h2>
<h3 id="_175">Система автоматического переобучения</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">aiohttp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AutomatedRetrainingSystem</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Система автоматического переобучения&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retraining_queue</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_retraining</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start_monitoring</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Запуск мониторинга системы&quot;&quot;&quot;</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor_data_quality</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor_model_performance</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor_data_drift</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_retraining_queue</span><span class="p">()</span>
        <span class="p">]</span>

        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">monitor_data_quality</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Мониторинг качества данных&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Проверка качества новых данных</span>
                <span class="n">data_quality</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_data_quality</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">data_quality</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data_quality_threshold&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data quality issue: </span><span class="si">{</span><span class="n">data_quality</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger_retraining</span><span class="p">(</span><span class="s1">&#39;data_quality&#39;</span><span class="p">)</span>

                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3600</span><span class="p">)</span>  <span class="c1"># Проверка каждый час</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data quality monitoring error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">monitor_model_performance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Мониторинг производительности модели&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Получение метрик производительности</span>
                <span class="n">performance</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model_performance</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">performance</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;performance_threshold&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Performance degradation: </span><span class="si">{</span><span class="n">performance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger_retraining</span><span class="p">(</span><span class="s1">&#39;performance&#39;</span><span class="p">)</span>

                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1800</span><span class="p">)</span>  <span class="c1"># Проверка каждые 30 минут</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Performance monitoring error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">monitor_data_drift</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Мониторинг дрейфа данных&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Проверка дрейфа данных</span>
                <span class="n">drift_score</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_data_drift</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">drift_score</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;drift_threshold&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data drift detected: </span><span class="si">{</span><span class="n">drift_score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger_retraining</span><span class="p">(</span><span class="s1">&#39;data_drift&#39;</span><span class="p">)</span>

                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">7200</span><span class="p">)</span>  <span class="c1"># Проверка каждые 2 часа</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data drift monitoring error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">trigger_retraining</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Запуск переобучения&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_retraining</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Retraining already in progress&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">retraining_request</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="n">reason</span><span class="p">,</span>
            <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_retraining_priority</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">retraining_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">retraining_request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retraining queued: </span><span class="si">{</span><span class="n">retraining_request</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_retraining_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Обработка очереди переобучения&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Получение запроса на переобучение</span>
                <span class="n">request</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">retraining_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

                <span class="c1"># Выполнение переобучения</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_retraining</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">retraining_queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retraining processing error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute_retraining</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Выполнение переобучения&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_retraining</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting retraining: </span><span class="si">{</span><span class="n">request</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Загрузка данных</span>
            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_retraining_data</span><span class="p">()</span>

            <span class="c1"># Создание новой модели</span>
            <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
                <span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;./models/retrained_</span><span class="si">{</span><span class="n">request</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Обучение</span>
            <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>

            <span class="c1"># Валидация</span>
            <span class="k">if</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_new_model</span><span class="p">(</span><span class="n">predictor</span><span class="p">):</span>
                <span class="c1"># Деплой новой модели</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">deploy_new_model</span><span class="p">(</span><span class="n">predictor</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Retraining completed successfully&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;New model validation failed&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retraining execution failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_retraining</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div>

<h2 id="_176">Валидация переобученных моделей</h2>
<h3 id="_177">Система валидации</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">RetrainingValidator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Валидатор переобученных моделей&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validation_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">validation_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">validate_new_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_predictor</span><span class="p">,</span> <span class="n">old_predictor</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Валидация новой модели&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Загрузка тестовых данных</span>
            <span class="n">test_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_test_data</span><span class="p">()</span>

            <span class="c1"># Предсказания новой модели</span>
            <span class="n">new_predictions</span> <span class="o">=</span> <span class="n">new_predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
            <span class="n">new_performance</span> <span class="o">=</span> <span class="n">new_predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

            <span class="c1"># Сравнение с старой моделью (если доступна)</span>
            <span class="k">if</span> <span class="n">old_predictor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">old_predictions</span> <span class="o">=</span> <span class="n">old_predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
                <span class="n">old_performance</span> <span class="o">=</span> <span class="n">old_predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

                <span class="c1"># Проверка улучшения производительности</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_performance_improvement</span><span class="p">(</span><span class="n">new_performance</span><span class="p">,</span> <span class="n">old_performance</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;New model doesn&#39;t improve performance&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>

            <span class="c1"># Проверка минимальных требований</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_minimum_requirements</span><span class="p">(</span><span class="n">new_performance</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;New model doesn&#39;t meet minimum requirements&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="c1"># Проверка стабильности</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_model_stability</span><span class="p">(</span><span class="n">new_predictor</span><span class="p">,</span> <span class="n">test_data</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;New model is not stable&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="c1"># Проверка совместимости</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_compatibility</span><span class="p">(</span><span class="n">new_predictor</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;New model is not compatible&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model validation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_performance_improvement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_perf</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">old_perf</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Проверка улучшения производительности&quot;&quot;&quot;</span>
        <span class="n">improvement_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;improvement_threshold&#39;</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;performance_metrics&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">new_perf</span> <span class="ow">and</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">old_perf</span><span class="p">:</span>
                <span class="n">improvement</span> <span class="o">=</span> <span class="n">new_perf</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">-</span> <span class="n">old_perf</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">improvement</span> <span class="o">&lt;</span> <span class="n">improvement_threshold</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_minimum_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">performance</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Проверка минимальных требований&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">threshold</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;minimum_requirements&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">performance</span> <span class="ow">and</span> <span class="n">performance</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_model_stability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictor</span><span class="p">,</span> <span class="n">test_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Проверка стабильности модели&quot;&quot;&quot;</span>
        <span class="c1"># Множественные предсказания на одних и тех же данных</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
            <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>

        <span class="c1"># Проверка согласованности</span>
        <span class="n">consistency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_prediction_consistency</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">consistency</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stability_threshold&#39;</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_compatibility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Проверка совместимости модели&quot;&quot;&quot;</span>
        <span class="c1"># Проверка версии AutoGluon</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">predictor</span><span class="o">.</span><span class="n">version</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;required_version&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Проверка формата модели</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_model_format</span><span class="p">(</span><span class="n">predictor</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>

<h2 id="_178">Мониторинг переобучения</h2>
<h3 id="_179">Система мониторинга</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">RetrainingMonitor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Мониторинг процесса переобучения&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monitoring_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">monitoring_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">start_monitoring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retraining_process</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Запуск мониторинга&quot;&quot;&quot;</span>
        <span class="c1"># Мониторинг ресурсов</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_resources</span><span class="p">()</span>

        <span class="c1"># Мониторинг прогресса</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_progress</span><span class="p">(</span><span class="n">retraining_process</span><span class="p">)</span>

        <span class="c1"># Мониторинг качества</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_quality</span><span class="p">(</span><span class="n">retraining_process</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">monitor_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Мониторинг системных ресурсов&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">psutil</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># CPU использование</span>
                <span class="n">cpu_percent</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_percent</span><span class="p">()</span>

                <span class="c1"># Память</span>
                <span class="n">memory</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span>
                <span class="n">memory_percent</span> <span class="o">=</span> <span class="n">memory</span><span class="o">.</span><span class="n">percent</span>

                <span class="c1"># Диск</span>
                <span class="n">disk</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">disk_usage</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
                <span class="n">disk_percent</span> <span class="o">=</span> <span class="n">disk</span><span class="o">.</span><span class="n">percent</span>

                <span class="c1"># Логирование метрик</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resources - CPU: </span><span class="si">{</span><span class="n">cpu_percent</span><span class="si">}</span><span class="s2">%, Memory: </span><span class="si">{</span><span class="n">memory_percent</span><span class="si">}</span><span class="s2">%, Disk: </span><span class="si">{</span><span class="n">disk_percent</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

                <span class="c1"># Проверка лимитов</span>
                <span class="k">if</span> <span class="n">cpu_percent</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;High CPU usage detected&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">memory_percent</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;High memory usage detected&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">disk_percent</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;High disk usage detected&quot;</span><span class="p">)</span>

                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>  <span class="c1"># Проверка каждую минуту</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resource monitoring error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">monitor_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retraining_process</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Мониторинг прогресса переобучения&quot;&quot;&quot;</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="k">while</span> <span class="n">retraining_process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

            <span class="c1"># Проверка времени выполнения</span>
            <span class="k">if</span> <span class="n">elapsed_time</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_retraining_time&#39;</span><span class="p">,</span> <span class="mi">7200</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Retraining timeout exceeded&quot;</span><span class="p">)</span>
                <span class="n">retraining_process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                <span class="k">break</span>

            <span class="c1"># Логирование прогресса</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retraining progress: </span><span class="si">{</span><span class="n">elapsed_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>  <span class="c1"># Проверка каждые 5 минут</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">monitor_quality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retraining_process</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Мониторинг качества переобучения&quot;&quot;&quot;</span>
        <span class="c1"># Мониторинг метрик качества</span>
        <span class="n">quality_metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;f1_score&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>

        <span class="k">while</span> <span class="n">retraining_process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Получение текущих метрик</span>
                <span class="n">current_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_metrics</span><span class="p">()</span>

                <span class="c1"># Добавление в историю</span>
                <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">current_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">quality_metrics</span><span class="p">:</span>
                        <span class="n">quality_metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="c1"># Анализ тренда</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">analyze_quality_trend</span><span class="p">(</span><span class="n">quality_metrics</span><span class="p">)</span>

                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">600</span><span class="p">)</span>  <span class="c1"># Проверка каждые 10 минут</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Quality monitoring error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
</code></pre></div>

<h2 id="_180">Откат моделей</h2>
<h3 id="_181">Система отката</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ModelRollback</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Система отката моделей&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rollback_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">rollback_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_versions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание резервной копии модели&quot;&quot;&quot;</span>
        <span class="n">backup_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_path</span><span class="si">}</span><span class="s2">_backup_</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Копирование модели</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">backup_path</span><span class="p">)</span>

            <span class="c1"># Сохранение информации о версии</span>
            <span class="n">version_info</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">backup_path</span><span class="p">,</span>
                <span class="s1">&#39;original_path&#39;</span><span class="p">:</span> <span class="n">model_path</span>
            <span class="p">}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">model_versions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">version_info</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model backup created: </span><span class="si">{</span><span class="n">backup_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">backup_path</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Backup creation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rollback_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Откат к предыдущей версии модели&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">target_version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Откат к последней версии</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_versions</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No previous version available for rollback&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>

                <span class="n">target_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_versions</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;path&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Откат к указанной версии</span>
                <span class="n">target_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_version_path</span><span class="p">(</span><span class="n">target_version</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">target_version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Version </span><span class="si">{</span><span class="n">target_version</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>

            <span class="c1"># Восстановление модели</span>
            <span class="n">current_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;current_model_path&#39;</span><span class="p">]</span>
            <span class="n">backup_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;backup_model_path&#39;</span><span class="p">]</span>

            <span class="c1"># Создание резервной копии текущей модели</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_backup</span><span class="p">(</span><span class="n">current_path</span><span class="p">)</span>

            <span class="c1"># Восстановление из резервной копии</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">target_version</span><span class="p">,</span> <span class="n">current_path</span><span class="p">,</span> <span class="n">dirs_exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model rolled back to: </span><span class="si">{</span><span class="n">target_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model rollback failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">find_version_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Поиск пути к версии модели&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">version</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_versions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">version_id</span> <span class="ow">in</span> <span class="n">version</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">version</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>

<h2 id="_182">Примеры использования</h2>
<h3 id="_183">Полный пример системы переобучения</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.tabular</span><span class="w"> </span><span class="kn">import</span> <span class="n">TabularPredictor</span>

<span class="c1"># Настройка логирования</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CompleteRetrainingSystem</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Полная система переобучения&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retraining_history</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Инициализация системы&quot;&quot;&quot;</span>
        <span class="c1"># Загрузка текущей модели</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_model</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_path&#39;</span><span class="p">])</span>

        <span class="c1"># Запуск мониторинга</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_monitoring</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start_monitoring</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Запуск мониторинга&quot;&quot;&quot;</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor_performance</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor_data_drift</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor_schedule</span><span class="p">()</span>
        <span class="p">]</span>

        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">monitor_performance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Мониторинг производительности&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Получение метрик производительности</span>
                <span class="n">performance</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_performance</span><span class="p">()</span>

                <span class="c1"># Проверка деградации</span>
                <span class="k">if</span> <span class="n">performance</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;performance_threshold&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Performance degradation detected: </span><span class="si">{</span><span class="n">performance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger_retraining</span><span class="p">(</span><span class="s1">&#39;performance_degradation&#39;</span><span class="p">)</span>

                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1800</span><span class="p">)</span>  <span class="c1"># Проверка каждые 30 минут</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Performance monitoring error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">monitor_data_drift</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Мониторинг дрейфа данных&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Проверка дрейфа данных</span>
                <span class="n">drift_score</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_data_drift</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">drift_score</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;drift_threshold&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data drift detected: </span><span class="si">{</span><span class="n">drift_score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger_retraining</span><span class="p">(</span><span class="s1">&#39;data_drift&#39;</span><span class="p">)</span>

                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3600</span><span class="p">)</span>  <span class="c1"># Проверка каждый час</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data drift monitoring error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">monitor_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Мониторинг расписания&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Проверка времени последнего переобучения</span>
                <span class="n">last_retraining</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_retraining_time</span><span class="p">()</span>
                <span class="n">days_since_retraining</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_retraining</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>

                <span class="k">if</span> <span class="n">days_since_retraining</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;retraining_interval&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Scheduled retraining triggered&quot;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger_retraining</span><span class="p">(</span><span class="s1">&#39;scheduled&#39;</span><span class="p">)</span>

                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3600</span><span class="p">)</span>  <span class="c1"># Проверка каждый час</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Schedule monitoring error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">trigger_retraining</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Запуск переобучения&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Triggering retraining: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Создание резервной копии</span>
            <span class="n">backup_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_model_backup</span><span class="p">()</span>

            <span class="c1"># Загрузка новых данных</span>
            <span class="n">new_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_new_data</span><span class="p">()</span>

            <span class="c1"># Создание новой модели</span>
            <span class="n">new_predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
                <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;target_column&#39;</span><span class="p">],</span>
                <span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_new&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Обучение</span>
            <span class="n">new_predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">new_data</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>

            <span class="c1"># Валидация</span>
            <span class="k">if</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_new_model</span><span class="p">(</span><span class="n">new_predictor</span><span class="p">):</span>
                <span class="c1"># Деплой новой модели</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">deploy_new_model</span><span class="p">(</span><span class="n">new_predictor</span><span class="p">)</span>

                <span class="c1"># Обновление истории</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">retraining_history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                    <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="n">reason</span><span class="p">,</span>
                    <span class="s1">&#39;backup_path&#39;</span><span class="p">:</span> <span class="n">backup_path</span><span class="p">,</span>
                    <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span>
                <span class="p">})</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Retraining completed successfully&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Откат к предыдущей версии</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rollback_model</span><span class="p">(</span><span class="n">backup_path</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">retraining_history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                    <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="n">reason</span><span class="p">,</span>
                    <span class="s1">&#39;backup_path&#39;</span><span class="p">:</span> <span class="n">backup_path</span><span class="p">,</span>
                    <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;failed&#39;</span>
                <span class="p">})</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Retraining failed, rolled back to previous version&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retraining failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Откат в случае ошибки</span>
            <span class="k">if</span> <span class="s1">&#39;backup_path&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rollback_model</span><span class="p">(</span><span class="n">backup_path</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">validate_new_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_predictor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Валидация новой модели&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Загрузка тестовых данных</span>
            <span class="n">test_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_test_data</span><span class="p">()</span>

            <span class="c1"># Предсказания новой модели</span>
            <span class="n">new_predictions</span> <span class="o">=</span> <span class="n">new_predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
            <span class="n">new_performance</span> <span class="o">=</span> <span class="n">new_predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

            <span class="c1"># Сравнение с текущей моделью</span>
            <span class="n">current_predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
            <span class="n">current_performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

            <span class="c1"># Проверка улучшения</span>
            <span class="n">improvement</span> <span class="o">=</span> <span class="n">new_performance</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">current_performance</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">improvement</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;improvement_threshold&#39;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Insufficient improvement: </span><span class="si">{</span><span class="n">improvement</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="c1"># Проверка минимальных требований</span>
            <span class="k">if</span> <span class="n">new_performance</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;minimum_accuracy&#39;</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy below minimum: </span><span class="si">{</span><span class="n">new_performance</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model validation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">deploy_new_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_predictor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Деплой новой модели&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Остановка текущего сервиса</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_current_service</span><span class="p">()</span>

            <span class="c1"># Замена модели</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">new_predictor</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_path&#39;</span><span class="p">],</span> <span class="n">dirs_exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Обновление текущей модели</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_model</span> <span class="o">=</span> <span class="n">new_predictor</span>

            <span class="c1"># Запуск обновленного сервиса</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_updated_service</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;New model deployed successfully&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model deployment failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_model_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание резервной копии модели&quot;&quot;&quot;</span>
        <span class="n">backup_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_backup_</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_path&#39;</span><span class="p">],</span> <span class="n">backup_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">backup_path</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rollback_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backup_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Откат к предыдущей версии&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">backup_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_path&#39;</span><span class="p">],</span> <span class="n">dirs_exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Обновление текущей модели</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_model</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_path&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model rolled back to: </span><span class="si">{</span><span class="n">backup_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Конфигурация системы</span>
<span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model_path&#39;</span><span class="p">:</span> <span class="s1">&#39;./production_models&#39;</span><span class="p">,</span>
    <span class="s1">&#39;target_column&#39;</span><span class="p">:</span> <span class="s1">&#39;target&#39;</span><span class="p">,</span>
    <span class="s1">&#39;performance_threshold&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
    <span class="s1">&#39;drift_threshold&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="s1">&#39;retraining_interval&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>  <span class="c1"># дни</span>
    <span class="s1">&#39;improvement_threshold&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
    <span class="s1">&#39;minimum_accuracy&#39;</span><span class="p">:</span> <span class="mf">0.8</span>
<span class="p">}</span>

<span class="c1"># Запуск системы</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">system</span> <span class="o">=</span> <span class="n">CompleteRetrainingSystem</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">system</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>

<h2 id="_184">Следующие шаги</h2>
<p>После освоения переобучения моделей переходите к:<br />
- <a href="./08_best_practices.md">Лучшим практикам</a><br />
- <a href="./09_examples.md">Примерам использования</a><br />
- <a href="./10_troubleshooting.md">Troubleshooting</a></p>
<hr />
<h1 id="automl-gluon_7">Лучшие практики AutoML Gluon</h1>
<p><strong>Автор:</strong> Shcherbyna Rostyslav<br />
<strong>Дата:</strong> 2024  </p>
<h2 id="_185">Почему лучшие практики критически важны</h2>
<p><strong>Почему 95% ML-проектов терпят неудачу из-за игнорирования лучших практик?</strong> Потому что машинное обучение - это не просто "обучить модель", а комплексная дисциплина, требующая соблюдения множества правил и принципов.</p>
<h3 id="_186">Катастрофические последствия плохих практик</h3>
<ul>
<li><strong>Amazon AI-рекрутинг</strong>: Дискриминация из-за отсутствия разнообразия в данных</li>
<li><strong>Microsoft Tay</strong>: Расистские твиты из-за отсутствия модерации</li>
<li><strong>Uber самоуправляемые авто</strong>: Смерть пешехода из-за недостаточного тестирования</li>
<li><strong>Facebook алгоритм</strong>: Поляризация общества из-за неправильной оптимизации</li>
</ul>
<h3 id="_187">Преимущества следования лучшим практикам</h3>
<ul>
<li><strong>Надежность</strong>: Система работает стабильно в любых условиях</li>
<li><strong>Масштабируемость</strong>: Легко адаптируется к росту нагрузки</li>
<li><strong>Поддерживаемость</strong>: Команда может легко развивать систему</li>
<li><strong>Этичность</strong>: Система работает справедливо и безопасно</li>
</ul>
<h2 id="_188">Введение в лучшие практики</h2>
<p><img alt="Сравнение производительности" src="images/performance_comparison.png" /><br />
<em>Рисунок 7: Сравнение производительности различных моделей</em></p>
<p><img alt="Анализ робастности" src="images/robustness_analysis.png" /><br />
<em>Рисунок 7.1: Анализ робастности - робастные vs переобученные системы, стабильность производительности</em></p>
<p><strong>Почему лучшие практики - это не просто "сделать хорошо"?</strong> Это систематический подход к решению типичных проблем, основанный на опыте тысяч проектов. Это как медицинские протоколы - они спасают жизни.</p>
<p><strong>Почему 80% ML-проектов повторяют одни и те же ошибки?</strong> Потому что команды не знают о существовании проверенных решений:<br />
- <strong>Проблемы с данными</strong>: Неправильная подготовка, утечки, смещения<br />
- <strong>Проблемы с валидацией</strong>: Неправильное разделение, переобучение<br />
- <strong>Проблемы с продакшеном</strong>: Неготовность к реальным условиям<br />
- <strong>Проблемы с этикой</strong>: Дискриминация, предвзятость, безопасность</p>
<p>Лучшие практики - это накопленный опыт использования AutoML Gluon, который поможет избежать типичных ошибок и достичь максимальной эффективности. В этом разделе рассмотрим все аспекты правильного использования инструмента.</p>
<h2 id="_189">Подготовка данных</h2>
<h3 id="1_1">1. Качество данных</h3>
<p><strong>Почему "мусор на входе = мусор на выходе" особенно актуально для ML?</strong> Потому что модель учится на данных, и если данные плохие, модель будет делать плохие предсказания. Это как обучение врача на неправильных диагнозах.</p>
<p><strong>Почему 60% времени ML-проекта тратится на подготовку данных?</strong> Потому что реальные данные всегда "грязные":<br />
- <strong>Отсутствующие значения</strong>: 30-50% данных могут быть пустыми<br />
- <strong>Некорректные значения</strong>: Опечатки, неправильные форматы<br />
- <strong>Дубликаты</strong>: Одинаковые записи в разных форматах<br />
- <strong>Выбросы</strong>: Экстремальные значения, которые искажают модель</p>
<p><strong>Типы проблем с данными:</strong><br />
- <strong>Структурные проблемы</strong>: Неправильные типы данных, форматы<br />
- <strong>Семантические проблемы</strong>: Некорректные значения, логические ошибки<br />
- <strong>Статистические проблемы</strong>: Смещения, корреляции, выбросы<br />
- <strong>Этические проблемы</strong>: Дискриминация, предвзятость</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.tabular</span><span class="w"> </span><span class="kn">import</span> <span class="n">TabularPredictor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>

<span class="k">def</span><span class="w"> </span><span class="nf">data_quality_check</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Комплексная проверка качества данных - первый шаг к успешному ML&quot;&quot;&quot;</span>

    <span class="n">quality_report</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>                    <span class="c1"># Размер датасета</span>
        <span class="s1">&#39;missing_values&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>  <span class="c1"># Пропущенные значения</span>
        <span class="s1">&#39;data_types&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>   <span class="c1"># Типы данных</span>
        <span class="s1">&#39;duplicates&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>  <span class="c1"># Дубликаты</span>
        <span class="s1">&#39;outliers&#39;</span><span class="p">:</span> <span class="p">{},</span>                         <span class="c1"># Выбросы</span>
        <span class="s1">&#39;correlations&#39;</span><span class="p">:</span> <span class="p">{}</span>                      <span class="c1"># Корреляции</span>
    <span class="p">}</span>

    <span class="c1"># Проверка пропущенных значений</span>
    <span class="n">missing_percent</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">quality_report</span><span class="p">[</span><span class="s1">&#39;missing_percent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">missing_percent</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

    <span class="c1"># Проверка выбросов для числовых колонок</span>
    <span class="n">numeric_columns</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_columns</span><span class="p">:</span>
        <span class="n">Q1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
        <span class="n">Q3</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.75</span><span class="p">)</span>
        <span class="n">IQR</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">-</span> <span class="n">Q1</span>
        <span class="n">outliers</span> <span class="o">=</span> <span class="n">data</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">Q1</span> <span class="o">-</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">IQR</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">Q3</span> <span class="o">+</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">IQR</span><span class="p">)]</span>
        <span class="n">quality_report</span><span class="p">[</span><span class="s1">&#39;outliers&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">outliers</span><span class="p">)</span>

    <span class="c1"># Проверка корреляций</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">numeric_columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">correlation_matrix</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">numeric_columns</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
        <span class="n">quality_report</span><span class="p">[</span><span class="s1">&#39;correlations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">correlation_matrix</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">quality_report</span>

<span class="c1"># Использование</span>
<span class="n">quality_report</span> <span class="o">=</span> <span class="n">data_quality_check</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data Quality Report:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">quality_report</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="2_1">2. Обработка пропущенных значений</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_missing_values</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Обработка пропущенных значений&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
        <span class="c1"># Автоматическая стратегия</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span>
                <span class="c1"># Для категориальных переменных - мода</span>
                <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mode</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mode</span><span class="p">()</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Для числовых переменных - медиана</span>
                <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;drop&#39;</span><span class="p">:</span>
        <span class="c1"># Удаление строк с пропущенными значениями</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;interpolate&#39;</span><span class="p">:</span>
        <span class="c1"># Интерполяция для временных рядов</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="c1"># Использование</span>
<span class="n">train_data_clean</span> <span class="o">=</span> <span class="n">handle_missing_values</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
</code></pre></div>

<h3 id="3_2">3. Обработка выбросов</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_outliers</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;iqr&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Обработка выбросов&quot;&quot;&quot;</span>

    <span class="n">numeric_columns</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;iqr&#39;</span><span class="p">:</span>
        <span class="c1"># Метод межквартильного размаха</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_columns</span><span class="p">:</span>
            <span class="n">Q1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
            <span class="n">Q3</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.75</span><span class="p">)</span>
            <span class="n">IQR</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">-</span> <span class="n">Q1</span>
            <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">Q1</span> <span class="o">-</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">IQR</span>
            <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">+</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">IQR</span>

            <span class="c1"># Замена выбросов на граничные значения</span>
            <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lower_bound</span><span class="p">,</span> <span class="n">lower_bound</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
            <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">upper_bound</span><span class="p">,</span> <span class="n">upper_bound</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;zscore&#39;</span><span class="p">:</span>
        <span class="c1"># Метод Z-скор</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_columns</span><span class="p">:</span>
            <span class="n">z_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">z_scores</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># Удаление выбросов</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;winsorize&#39;</span><span class="p">:</span>
        <span class="c1"># Винзоризация</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_columns</span><span class="p">:</span>
            <span class="n">lower_percentile</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
            <span class="n">upper_percentile</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.95</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lower_percentile</span><span class="p">,</span> <span class="n">lower_percentile</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
            <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">upper_percentile</span><span class="p">,</span> <span class="n">upper_percentile</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="c1"># Использование</span>
<span class="n">train_data_no_outliers</span> <span class="o">=</span> <span class="n">handle_outliers</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;iqr&#39;</span><span class="p">)</span>
</code></pre></div>

<h2 id="_190">Выбор метрик</h2>
<h3 id="1_2">1. Метрики для классификации</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">select_classification_metrics</span><span class="p">(</span><span class="n">problem_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data_balance</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;balanced&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Выбор метрик для классификации&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">problem_type</span> <span class="o">==</span> <span class="s1">&#39;binary&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">data_balance</span> <span class="o">==</span> <span class="s1">&#39;balanced&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;f1&#39;</span><span class="p">,</span> <span class="s1">&#39;roc_auc&#39;</span><span class="p">,</span> <span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="s1">&#39;recall&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">data_balance</span> <span class="o">==</span> <span class="s1">&#39;imbalanced&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">,</span> <span class="s1">&#39;roc_auc&#39;</span><span class="p">,</span> <span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="s1">&#39;recall&#39;</span><span class="p">,</span> <span class="s1">&#39;balanced_accuracy&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;f1&#39;</span><span class="p">,</span> <span class="s1">&#39;roc_auc&#39;</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">problem_type</span> <span class="o">==</span> <span class="s1">&#39;multiclass&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">data_balance</span> <span class="o">==</span> <span class="s1">&#39;balanced&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span> <span class="s1">&#39;f1_micro&#39;</span><span class="p">,</span> <span class="s1">&#39;precision_macro&#39;</span><span class="p">,</span> <span class="s1">&#39;recall_macro&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">data_balance</span> <span class="o">==</span> <span class="s1">&#39;imbalanced&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span> <span class="s1">&#39;f1_micro&#39;</span><span class="p">,</span> <span class="s1">&#39;balanced_accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;precision_macro&#39;</span><span class="p">,</span> <span class="s1">&#39;recall_macro&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span> <span class="s1">&#39;f1_micro&#39;</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;f1&#39;</span><span class="p">,</span> <span class="s1">&#39;roc_auc&#39;</span><span class="p">]</span>

<span class="c1"># Использование</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="n">select_classification_metrics</span><span class="p">(</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span> <span class="s1">&#39;imbalanced&#39;</span><span class="p">)</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
    <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span>
    <span class="n">eval_metric</span><span class="o">=</span><span class="n">metrics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Основная метрика</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="2_2">2. Метрики для регрессии</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">select_regression_metrics</span><span class="p">(</span><span class="n">problem_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target_distribution</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;normal&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Выбор метрик для регрессии&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">target_distribution</span> <span class="o">==</span> <span class="s1">&#39;normal&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;rmse&#39;</span><span class="p">,</span> <span class="s1">&#39;mae&#39;</span><span class="p">,</span> <span class="s1">&#39;r2&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">target_distribution</span> <span class="o">==</span> <span class="s1">&#39;skewed&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">,</span> <span class="s1">&#39;mape&#39;</span><span class="p">,</span> <span class="s1">&#39;smape&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">target_distribution</span> <span class="o">==</span> <span class="s1">&#39;outliers&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">,</span> <span class="s1">&#39;huber_loss&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;rmse&#39;</span><span class="p">,</span> <span class="s1">&#39;mae&#39;</span><span class="p">]</span>

<span class="c1"># Использование</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="n">select_regression_metrics</span><span class="p">(</span><span class="s1">&#39;regression&#39;</span><span class="p">,</span> <span class="s1">&#39;normal&#39;</span><span class="p">)</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
    <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;regression&#39;</span><span class="p">,</span>
    <span class="n">eval_metric</span><span class="o">=</span><span class="n">metrics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_191">Настройка гиперпараметров</h2>
<h3 id="1_3">1. Стратегия поиска гиперпараметров</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_hyperparameter_strategy</span><span class="p">(</span><span class="n">data_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">problem_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Создание стратегии поиска гиперпараметров&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">data_size</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="c1"># Маленький датасет - простые модели</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;GBM&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}],</span>
            <span class="s1">&#39;RF&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}],</span>
            <span class="s1">&#39;XGB&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">}]</span>
        <span class="p">}</span>

    <span class="k">elif</span> <span class="n">data_size</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">:</span>
        <span class="c1"># Средний датасет - умеренная сложность</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;GBM&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">}</span>
            <span class="p">],</span>
            <span class="s1">&#39;RF&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">}</span>
            <span class="p">],</span>
            <span class="s1">&#39;XGB&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Большой датасет - сложные модели</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;GBM&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">}</span>
            <span class="p">],</span>
            <span class="s1">&#39;RF&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">}</span>
            <span class="p">],</span>
            <span class="s1">&#39;XGB&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">}</span>
            <span class="p">],</span>
            <span class="s1">&#39;CAT&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;iterations&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;iterations&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>

<span class="c1"># Использование</span>
<span class="n">hyperparameters</span> <span class="o">=</span> <span class="n">create_hyperparameter_strategy</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">),</span> <span class="s1">&#39;binary&#39;</span><span class="p">)</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">hyperparameters</span><span class="o">=</span><span class="n">hyperparameters</span><span class="p">)</span>
</code></pre></div>

<h3 id="2_3">2. Оптимизация времени обучения</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">optimize_training_time</span><span class="p">(</span><span class="n">data_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">available_time</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Оптимизация времени обучения&quot;&quot;&quot;</span>

    <span class="c1"># Расчет времени на модель</span>
    <span class="n">time_per_model</span> <span class="o">=</span> <span class="n">available_time</span> <span class="o">/</span> <span class="mi">10</span>  <span class="c1"># 10 моделей по умолчанию</span>

    <span class="k">if</span> <span class="n">data_size</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="c1"># Быстрое обучение</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;time_limit&#39;</span><span class="p">:</span> <span class="n">time_per_model</span><span class="p">,</span>
            <span class="s1">&#39;presets&#39;</span><span class="p">:</span> <span class="s1">&#39;optimize_for_deployment&#39;</span><span class="p">,</span>
            <span class="s1">&#39;num_bag_folds&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">&#39;num_bag_sets&#39;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>

    <span class="k">elif</span> <span class="n">data_size</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">:</span>
        <span class="c1"># Умеренное обучение</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;time_limit&#39;</span><span class="p">:</span> <span class="n">time_per_model</span><span class="p">,</span>
            <span class="s1">&#39;presets&#39;</span><span class="p">:</span> <span class="s1">&#39;medium_quality&#39;</span><span class="p">,</span>
            <span class="s1">&#39;num_bag_folds&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s1">&#39;num_bag_sets&#39;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Качественное обучение</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;time_limit&#39;</span><span class="p">:</span> <span class="n">time_per_model</span><span class="p">,</span>
            <span class="s1">&#39;presets&#39;</span><span class="p">:</span> <span class="s1">&#39;high_quality&#39;</span><span class="p">,</span>
            <span class="s1">&#39;num_bag_folds&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s1">&#39;num_bag_sets&#39;</span><span class="p">:</span> <span class="mi">2</span>
        <span class="p">}</span>

<span class="c1"># Использование</span>
<span class="n">training_config</span> <span class="o">=</span> <span class="n">optimize_training_time</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">),</span> <span class="mi">3600</span><span class="p">)</span>  <span class="c1"># 1 час</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="o">**</span><span class="n">training_config</span><span class="p">)</span>
</code></pre></div>

<h2 id="_192">Валидация и тестирование</h2>
<h3 id="1_4">1. Стратегия валидации</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">select_validation_strategy</span><span class="p">(</span><span class="n">data_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">problem_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                             <span class="n">data_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;tabular&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Выбор стратегии валидации&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s1">&#39;time_series&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;validation_strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;time_series_split&#39;</span><span class="p">,</span>
            <span class="s1">&#39;n_splits&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s1">&#39;test_size&#39;</span><span class="p">:</span> <span class="mf">0.2</span>
        <span class="p">}</span>

    <span class="k">elif</span> <span class="n">data_size</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;validation_strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;holdout&#39;</span><span class="p">,</span>
            <span class="s1">&#39;holdout_frac&#39;</span><span class="p">:</span> <span class="mf">0.3</span>
        <span class="p">}</span>

    <span class="k">elif</span> <span class="n">data_size</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;validation_strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;kfold&#39;</span><span class="p">,</span>
            <span class="s1">&#39;num_bag_folds&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s1">&#39;num_bag_sets&#39;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;validation_strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;kfold&#39;</span><span class="p">,</span>
            <span class="s1">&#39;num_bag_folds&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s1">&#39;num_bag_sets&#39;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>

<span class="c1"># Использование</span>
<span class="n">validation_config</span> <span class="o">=</span> <span class="n">select_validation_strategy</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">),</span> <span class="s1">&#39;binary&#39;</span><span class="p">)</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="o">**</span><span class="n">validation_config</span><span class="p">)</span>
</code></pre></div>

<h3 id="2-">2. Кросс-валидация</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">perform_cross_validation</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                           <span class="n">n_folds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Выполнение кросс-валидации&quot;&quot;&quot;</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">KFold</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

    <span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">n_folds</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

    <span class="n">fold_results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">fold</span><span class="p">,</span> <span class="p">(</span><span class="n">train_idx</span><span class="p">,</span> <span class="n">val_idx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">kf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="c1"># Разделение данных</span>
        <span class="n">train_fold</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span>
        <span class="n">val_fold</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">val_idx</span><span class="p">]</span>

        <span class="c1"># Обучение модели</span>
        <span class="n">fold_predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="n">predictor</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
            <span class="n">problem_type</span><span class="o">=</span><span class="n">predictor</span><span class="o">.</span><span class="n">problem_type</span><span class="p">,</span>
            <span class="n">eval_metric</span><span class="o">=</span><span class="n">predictor</span><span class="o">.</span><span class="n">eval_metric</span>
        <span class="p">)</span>

        <span class="n">fold_predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_fold</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

        <span class="c1"># Предсказания</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">fold_predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">val_fold</span><span class="p">)</span>

        <span class="c1"># Оценка качества</span>
        <span class="n">performance</span> <span class="o">=</span> <span class="n">fold_predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">val_fold</span><span class="p">)</span>

        <span class="n">fold_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;fold&#39;</span><span class="p">:</span> <span class="n">fold</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;performance&#39;</span><span class="p">:</span> <span class="n">performance</span>
        <span class="p">})</span>

    <span class="c1"># Агрегация результатов</span>
    <span class="n">all_metrics</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">fold_results</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;performance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_metrics</span><span class="p">:</span>
                <span class="n">all_metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">all_metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="c1"># Статистика</span>
    <span class="n">cv_results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">all_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">cv_results</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values</span><span class="p">),</span>
            <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">values</span><span class="p">),</span>
            <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">values</span><span class="p">),</span>
            <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">return</span> <span class="n">cv_results</span>

<span class="c1"># Использование</span>
<span class="n">cv_results</span> <span class="o">=</span> <span class="n">perform_cross_validation</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">train_data</span><span class="p">,</span> <span class="n">n_folds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cross-validation results:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">stats</span> <span class="ow">in</span> <span class="n">cv_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h2 id="_193">Работа с ансамблями</h2>
<h3 id="1_5">1. Настройка ансамблей</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">configure_ensemble</span><span class="p">(</span><span class="n">data_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">problem_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Настройка ансамбля&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">data_size</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="c1"># Простой ансамбль</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;num_bag_folds&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">&#39;num_bag_sets&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;num_stack_levels&#39;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}</span>

    <span class="k">elif</span> <span class="n">data_size</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">:</span>
        <span class="c1"># Умеренный ансамбль</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;num_bag_folds&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s1">&#39;num_bag_sets&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;num_stack_levels&#39;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Сложный ансамбль</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;num_bag_folds&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s1">&#39;num_bag_sets&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;num_stack_levels&#39;</span><span class="p">:</span> <span class="mi">2</span>
        <span class="p">}</span>

<span class="c1"># Использование</span>
<span class="n">ensemble_config</span> <span class="o">=</span> <span class="n">configure_ensemble</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">),</span> <span class="s1">&#39;binary&#39;</span><span class="p">)</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="o">**</span><span class="n">ensemble_config</span><span class="p">)</span>
</code></pre></div>

<h3 id="2_4">2. Анализ ансамбля</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analyze_ensemble</span><span class="p">(</span><span class="n">predictor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Анализ ансамбля&quot;&quot;&quot;</span>

    <span class="c1"># Лидерборд моделей</span>
    <span class="n">leaderboard</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">leaderboard</span><span class="p">()</span>

    <span class="c1"># Анализ производительности</span>
    <span class="n">ensemble_analysis</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;total_models&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">leaderboard</span><span class="p">),</span>
        <span class="s1">&#39;best_model&#39;</span><span class="p">:</span> <span class="n">leaderboard</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
        <span class="s1">&#39;best_score&#39;</span><span class="p">:</span> <span class="n">leaderboard</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;score_val&#39;</span><span class="p">],</span>
        <span class="s1">&#39;model_diversity&#39;</span><span class="p">:</span> <span class="n">calculate_model_diversity</span><span class="p">(</span><span class="n">leaderboard</span><span class="p">),</span>
        <span class="s1">&#39;performance_gap&#39;</span><span class="p">:</span> <span class="n">leaderboard</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;score_val&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">leaderboard</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;score_val&#39;</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">ensemble_analysis</span>

<span class="k">def</span><span class="w"> </span><span class="nf">calculate_model_diversity</span><span class="p">(</span><span class="n">leaderboard</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Расчет разнообразия моделей&quot;&quot;&quot;</span>

    <span class="c1"># Разнообразие по типам моделей</span>
    <span class="n">model_types</span> <span class="o">=</span> <span class="n">leaderboard</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
    <span class="n">diversity</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_types</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">leaderboard</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">diversity</span>

<span class="c1"># Использование</span>
<span class="n">ensemble_analysis</span> <span class="o">=</span> <span class="n">analyze_ensemble</span><span class="p">(</span><span class="n">predictor</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ensemble Analysis:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">ensemble_analysis</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h2 id="_194">Оптимизация производительности</h2>
<h3 id="1_6">1. Настройка ресурсов</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">optimize_resources</span><span class="p">(</span><span class="n">data_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">available_resources</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Оптимизация ресурсов&quot;&quot;&quot;</span>

    <span class="c1"># Расчет оптимальных параметров</span>
    <span class="k">if</span> <span class="n">data_size</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="n">num_cpus</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">available_resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cpus&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">memory_limit</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">available_resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;memory&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">data_size</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">:</span>
        <span class="n">num_cpus</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">available_resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cpus&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">memory_limit</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">available_resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;memory&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">num_cpus</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">available_resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cpus&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
        <span class="n">memory_limit</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">available_resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;memory&#39;</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;num_cpus&#39;</span><span class="p">:</span> <span class="n">num_cpus</span><span class="p">,</span>
        <span class="s1">&#39;num_gpus&#39;</span><span class="p">:</span> <span class="n">available_resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gpus&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="s1">&#39;memory_limit&#39;</span><span class="p">:</span> <span class="n">memory_limit</span>
    <span class="p">}</span>

<span class="c1"># Использование</span>
<span class="n">resources</span> <span class="o">=</span> <span class="n">optimize_resources</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;cpus&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;memory&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="s1">&#39;gpus&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">ag_args_fit</span><span class="o">=</span><span class="n">resources</span><span class="p">)</span>
</code></pre></div>

<h3 id="2_5">2. Параллелизация</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">configure_parallelization</span><span class="p">(</span><span class="n">data_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">problem_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Настройка параллелизации&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">data_size</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="c1"># Последовательное обучение</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;parallel_folds&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;parallel_models&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">}</span>

    <span class="k">elif</span> <span class="n">data_size</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">:</span>
        <span class="c1"># Умеренная параллелизация</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;parallel_folds&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;parallel_models&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">}</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Полная параллелизация</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;parallel_folds&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;parallel_models&#39;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">}</span>

<span class="c1"># Использование</span>
<span class="n">parallel_config</span> <span class="o">=</span> <span class="n">configure_parallelization</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">),</span> <span class="s1">&#39;binary&#39;</span><span class="p">)</span>
<span class="c1"># Применение конфигурации через ag_args_fit</span>
</code></pre></div>

<h2 id="_195">Мониторинг и логирование</h2>
<h3 id="1_7">1. Система логирования</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AutoGluonLogger</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Система логирования для AutoGluon&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;autogluon.log&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span> <span class="o">=</span> <span class="n">log_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">setup_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Настройка логирования&quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
            <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">handlers</span><span class="o">=</span><span class="p">[</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">),</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_training_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Логирование начала обучения&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training started: </span><span class="si">{</span><span class="n">data_info</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_training_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">progress</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Логирование прогресса обучения&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training progress: </span><span class="si">{</span><span class="n">progress</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_training_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Логирование завершения обучения&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training completed: </span><span class="si">{</span><span class="n">results</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">prediction</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> 
                      <span class="n">processing_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Логирование предсказания&quot;&quot;&quot;</span>
        <span class="n">log_entry</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;input_data&#39;</span><span class="p">:</span> <span class="n">input_data</span><span class="p">,</span>
            <span class="s1">&#39;prediction&#39;</span><span class="p">:</span> <span class="n">prediction</span><span class="p">,</span>
            <span class="s1">&#39;processing_time&#39;</span><span class="p">:</span> <span class="n">processing_time</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Prediction: </span><span class="si">{</span><span class="n">log_entry</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Логирование ошибок&quot;&quot;&quot;</span>
        <span class="n">error_entry</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">),</span>
            <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="n">context</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">error_entry</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Использование</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">AutoGluonLogger</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">log_training_start</span><span class="p">({</span><span class="s1">&#39;data_size&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">),</span> <span class="s1">&#39;features&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)})</span>
</code></pre></div>

<h3 id="2_6">2. Мониторинг производительности</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">psutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PerformanceMonitor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Мониторинг производительности&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_system_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Получение системных метрик&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;cpu_percent&#39;</span><span class="p">:</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_percent</span><span class="p">(),</span>
            <span class="s1">&#39;memory_percent&#39;</span><span class="p">:</span> <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span><span class="o">.</span><span class="n">percent</span><span class="p">,</span>
            <span class="s1">&#39;disk_percent&#39;</span><span class="p">:</span> <span class="n">psutil</span><span class="o">.</span><span class="n">disk_usage</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">percent</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">monitor_training</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictor</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Мониторинг обучения&quot;&quot;&quot;</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># Начальные метрики</span>
        <span class="n">initial_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_system_metrics</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">initial_metrics</span><span class="p">)</span>

        <span class="c1"># Обучение с мониторингом</span>
        <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>

        <span class="c1"># Финальные метрики</span>
        <span class="n">final_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_system_metrics</span><span class="p">()</span>
        <span class="n">final_metrics</span><span class="p">[</span><span class="s1">&#39;training_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">final_metrics</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">final_metrics</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_performance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Анализ производительности&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="c1"># Анализ использования ресурсов</span>
        <span class="n">cpu_usage</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;cpu_percent&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="p">]</span>
        <span class="n">memory_usage</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;memory_percent&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;avg_cpu_usage&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">cpu_usage</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">cpu_usage</span><span class="p">),</span>
            <span class="s1">&#39;max_cpu_usage&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">cpu_usage</span><span class="p">),</span>
            <span class="s1">&#39;avg_memory_usage&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">memory_usage</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">memory_usage</span><span class="p">),</span>
            <span class="s1">&#39;max_memory_usage&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">memory_usage</span><span class="p">),</span>
            <span class="s1">&#39;training_time&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;training_time&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">}</span>

<span class="c1"># Использование</span>
<span class="n">monitor</span> <span class="o">=</span> <span class="n">PerformanceMonitor</span><span class="p">()</span>
<span class="n">final_metrics</span> <span class="o">=</span> <span class="n">monitor</span><span class="o">.</span><span class="n">monitor_training</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">train_data</span><span class="p">)</span>
<span class="n">performance_analysis</span> <span class="o">=</span> <span class="n">monitor</span><span class="o">.</span><span class="n">analyze_performance</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Performance analysis: </span><span class="si">{</span><span class="n">performance_analysis</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h2 id="_196">Обработка ошибок</h2>
<h3 id="1_8">1. Обработка исключений</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">safe_training</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Безопасное обучение с обработкой ошибок&quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Обучение модели</span>
        <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Валидация модели</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="s1">&#39;evaluate&#39;</span><span class="p">):</span>
            <span class="n">performance</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span>
                <span class="s1">&#39;performance&#39;</span><span class="p">:</span> <span class="n">performance</span><span class="p">,</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="kc">None</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span>
                <span class="s1">&#39;performance&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="kc">None</span>
            <span class="p">}</span>

    <span class="k">except</span> <span class="ne">MemoryError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;performance&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Memory error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;suggestion&#39;</span><span class="p">:</span> <span class="s1">&#39;Reduce data size or increase memory&#39;</span>
        <span class="p">}</span>

    <span class="k">except</span> <span class="ne">TimeoutError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;performance&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Timeout error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;suggestion&#39;</span><span class="p">:</span> <span class="s1">&#39;Increase time_limit or reduce model complexity&#39;</span>
        <span class="p">}</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;performance&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Unexpected error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;suggestion&#39;</span><span class="p">:</span> <span class="s1">&#39;Check data quality and parameters&#39;</span>
        <span class="p">}</span>

<span class="c1"># Использование</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">safe_training</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">train_data</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
<span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training successful: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;performance&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training failed: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Suggestion: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;suggestion&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="2_7">2. Восстановление после ошибок</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">resilient_training</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                      <span class="n">fallback_strategies</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Устойчивое обучение с fallback стратегиями&quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">strategy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fallback_strategies</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Попытка обучения с текущей стратегией</span>
            <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">strategy</span><span class="p">)</span>

            <span class="c1"># Валидация</span>
            <span class="k">if</span> <span class="n">validate_model</span><span class="p">(</span><span class="n">predictor</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;strategy_used&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                    <span class="s1">&#39;strategy_config&#39;</span><span class="p">:</span> <span class="n">strategy</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Strategy </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
        <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;All strategies failed&#39;</span><span class="p">,</span>
        <span class="s1">&#39;suggestions&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;Check data quality&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Reduce model complexity&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Increase time limits&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Use simpler algorithms&#39;</span>
        <span class="p">]</span>
    <span class="p">}</span>

<span class="c1"># Fallback стратегии</span>
<span class="n">fallback_strategies</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">&#39;presets&#39;</span><span class="p">:</span> <span class="s1">&#39;best_quality&#39;</span><span class="p">,</span> <span class="s1">&#39;time_limit&#39;</span><span class="p">:</span> <span class="mi">3600</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;presets&#39;</span><span class="p">:</span> <span class="s1">&#39;high_quality&#39;</span><span class="p">,</span> <span class="s1">&#39;time_limit&#39;</span><span class="p">:</span> <span class="mi">1800</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;presets&#39;</span><span class="p">:</span> <span class="s1">&#39;medium_quality&#39;</span><span class="p">,</span> <span class="s1">&#39;time_limit&#39;</span><span class="p">:</span> <span class="mi">900</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;presets&#39;</span><span class="p">:</span> <span class="s1">&#39;optimize_for_deployment&#39;</span><span class="p">,</span> <span class="s1">&#39;time_limit&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">}</span>
<span class="p">]</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">resilient_training</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">train_data</span><span class="p">,</span> <span class="n">fallback_strategies</span><span class="p">)</span>
</code></pre></div>

<h2 id="_197">Оптимизация для продакшена</h2>
<h3 id="1_9">1. Сжатие модели</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">optimize_for_production</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">target_size_mb</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Оптимизация модели для продакшена&quot;&quot;&quot;</span>

    <span class="c1"># Получение размера текущей модели</span>
    <span class="n">current_size</span> <span class="o">=</span> <span class="n">get_model_size</span><span class="p">(</span><span class="n">predictor</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">current_size</span> <span class="o">&lt;=</span> <span class="n">target_size_mb</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;already_optimized&#39;</span><span class="p">,</span>
            <span class="s1">&#39;current_size&#39;</span><span class="p">:</span> <span class="n">current_size</span><span class="p">,</span>
            <span class="s1">&#39;target_size&#39;</span><span class="p">:</span> <span class="n">target_size_mb</span>
        <span class="p">}</span>

    <span class="c1"># Стратегии оптимизации</span>
    <span class="n">optimization_strategies</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;reduce_models&#39;</span><span class="p">,</span>
            <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;excluded_model_types&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;KNN&#39;</span><span class="p">,</span> <span class="s1">&#39;NN_TORCH&#39;</span><span class="p">],</span>
                <span class="s1">&#39;presets&#39;</span><span class="p">:</span> <span class="s1">&#39;optimize_for_deployment&#39;</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;compress_models&#39;</span><span class="p">,</span>
            <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;save_space&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;compress&#39;</span><span class="p">:</span> <span class="kc">True</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;simplify_ensemble&#39;</span><span class="p">,</span>
            <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;num_bag_folds&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                <span class="s1">&#39;num_bag_sets&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;num_stack_levels&#39;</span><span class="p">:</span> <span class="mi">0</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">strategy</span> <span class="ow">in</span> <span class="n">optimization_strategies</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Применение стратегии</span>
            <span class="n">optimized_predictor</span> <span class="o">=</span> <span class="n">apply_optimization_strategy</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">strategy</span><span class="p">)</span>

            <span class="c1"># Проверка размера</span>
            <span class="n">optimized_size</span> <span class="o">=</span> <span class="n">get_model_size</span><span class="p">(</span><span class="n">optimized_predictor</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">optimized_size</span> <span class="o">&lt;=</span> <span class="n">target_size_mb</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;optimized&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="n">strategy</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;original_size&#39;</span><span class="p">:</span> <span class="n">current_size</span><span class="p">,</span>
                    <span class="s1">&#39;optimized_size&#39;</span><span class="p">:</span> <span class="n">optimized_size</span><span class="p">,</span>
                    <span class="s1">&#39;compression_ratio&#39;</span><span class="p">:</span> <span class="n">optimized_size</span> <span class="o">/</span> <span class="n">current_size</span>
                <span class="p">}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimization strategy </span><span class="si">{</span><span class="n">strategy</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;failed&#39;</span><span class="p">,</span>
        <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Could not achieve target size&#39;</span><span class="p">,</span>
        <span class="s1">&#39;suggestions&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;Increase target size&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Use simpler algorithms&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Reduce training data&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Use model compression techniques&#39;</span>
        <span class="p">]</span>
    <span class="p">}</span>

<span class="c1"># Использование</span>
<span class="n">optimization_result</span> <span class="o">=</span> <span class="n">optimize_for_production</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">target_size_mb</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimization result: </span><span class="si">{</span><span class="n">optimization_result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="2_8">2. Кэширование предсказаний</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PredictionCache</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Кэш для предсказаний&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_size</span> <span class="o">=</span> <span class="n">cache_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">access_count</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Генерация ключа кэша&quot;&quot;&quot;</span>
        <span class="n">data_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">data_str</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Получение предсказания из кэша&quot;&quot;&quot;</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_cache_key</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="c1"># Обновление счетчика доступа</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">access_count</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_count</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">prediction</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Сохранение предсказания в кэш&quot;&quot;&quot;</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_cache_key</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Проверка размера кэша</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_size</span><span class="p">:</span>
            <span class="c1"># Удаление наименее используемого элемента</span>
            <span class="n">least_used_key</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">access_count</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">access_count</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">least_used_key</span><span class="p">]</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_count</span><span class="p">[</span><span class="n">least_used_key</span><span class="p">]</span>

        <span class="c1"># Добавление нового элемента</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">prediction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">access_count</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_cache_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Статистика кэша&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;cache_size&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">),</span>
            <span class="s1">&#39;max_cache_size&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_size</span><span class="p">,</span>
            <span class="s1">&#39;hit_rate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_hit_rate</span><span class="p">(),</span>
            <span class="s1">&#39;most_accessed&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">access_count</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_count</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_hit_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Расчет hit rate кэша&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_count</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="n">total_accesses</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">access_count</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">cache_hits</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cache_hits</span> <span class="o">/</span> <span class="n">total_accesses</span> <span class="k">if</span> <span class="n">total_accesses</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>

<span class="c1"># Использование</span>
<span class="n">cache</span> <span class="o">=</span> <span class="n">PredictionCache</span><span class="p">(</span><span class="n">cache_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">cached_predict</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Кэшированное предсказание&quot;&quot;&quot;</span>
    <span class="c1"># Проверка кэша</span>
    <span class="n">cached_prediction</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_prediction</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cached_prediction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cached_prediction</span>

    <span class="c1"># Выполнение предсказания</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">data</span><span class="p">]))</span>

    <span class="c1"># Сохранение в кэш</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">set_prediction</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">prediction</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">prediction</span>
</code></pre></div>

<h2 id="_198">Следующие шаги</h2>
<p>После освоения лучших практик переходите к:<br />
- <a href="./09_examples.md">Примерам использования</a><br />
- <a href="./10_troubleshooting.md">Troubleshooting</a></p>
<hr />
<h1 id="automl-gluon_8">Примеры использования AutoML Gluon</h1>
<p><strong>Автор:</strong> Shcherbyna Rostyslav<br />
<strong>Дата:</strong> 2024  </p>
<h2 id="_199">Почему примеры критически важны</h2>
<p><strong>Почему 90% разработчиков начинают с примеров, а не с документации?</strong> Потому что примеры показывают, как теория работает на практике. Это как обучение вождению - сначала смотришь, как ездят другие.</p>
<h3 id="_200">Проблемы без практических примеров</h3>
<ul>
<li><strong>Долгое изучение</strong>: Месяцы на понимание базовых концепций</li>
<li><strong>Ошибки в реализации</strong>: Неправильное использование API</li>
<li><strong>Неэффективные решения</strong>: Изобретение велосипеда</li>
<li><strong>Разочарование</strong>: Сложность отпугивает новичков</li>
</ul>
<h3 id="_201">Преимущества хороших примеров</h3>
<ul>
<li><strong>Быстрое старт</strong>: От идеи до работающего кода за часы</li>
<li><strong>Правильные паттерны</strong>: Изучение лучших практик на примерах</li>
<li><strong>Уверенность</strong>: Понимание того, как все работает</li>
<li><strong>Вдохновение</strong>: Идеи для собственных проектов</li>
</ul>
<h2 id="_202">Введение в примеры</h2>
<p><img alt="Monte Carlo анализ" src="images/monte_carlo_analysis.png" /><br />
<em>Рисунок 8.1: Monte Carlo анализ - робастные vs переобученные системы, распределение прибыли, risk-return профиль</em></p>
<p><strong>Почему примеры - это язык машинного обучения?</strong> Потому что они переводят сложные алгоритмы в понятные числа. Это как переводчик между техническими деталями и бизнес-результатами.</p>
<p><strong>Типы примеров в AutoML Gluon:</strong><br />
- <strong>Базовые примеры</strong>: Простые задачи для понимания основ<br />
- <strong>Продвинутые примеры</strong>: Сложные сценарии для опытных пользователей<br />
- <strong>Реальные проекты</strong>: Полные решения реальных бизнес-задач<br />
- <strong>Специализированные примеры</strong>: Для конкретных доменов (медицина, финансы)</p>
<p>В этом разделе представлены практические примеры использования AutoML Gluon для различных задач машинного обучения. Каждый пример включает полный код, объяснения и лучшие практики.</p>
<h2 id="1_10">Пример 1: Классификация клиентов банка</h2>
<p><strong>Почему начинаем с банковской задачи?</strong> Потому что это классический пример ML в финансах - понятный, важный и с четкими бизнес-метриками.</p>
<h3 id="_203">Задача</h3>
<p><strong>Почему предсказание дефолта так важно?</strong> Потому что неправильное решение может стоить банку миллионы долларов. Это как медицинская диагностика, но для денег.</p>
<p>Предсказание вероятности дефолта клиента банка на основе финансовых показателей.</p>
<p><strong>Бизнес-контекст:</strong><br />
- <strong>Цель</strong>: Минимизировать потери от плохих кредитов<br />
- <strong>Метрика</strong>: ROC-AUC (важнее точность для положительных случаев)<br />
- <strong>Стоимость ошибки</strong>: Ложный отрицательный результат дороже ложного положительного<br />
- <strong>Объем данных</strong>: Обычно 100K-1M записей</p>
<h3 id="_204">Данные</h3>
<p><strong>Почему используем синтетические данные?</strong> Потому что реальные банковские данные конфиденциальны, но структура и паттерны остаются теми же.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_classification</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.tabular</span><span class="w"> </span><span class="kn">import</span> <span class="n">TabularPredictor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>

<span class="c1"># Создание синтетических данных для банковской задачи</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_bank_data</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Создание синтетических банковских данных - имитация реальных банковских данных&quot;&quot;&quot;</span>

    <span class="c1"># Генерация данных с реалистичными параметрами</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_classification</span><span class="p">(</span>
        <span class="n">n_samples</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span>        <span class="c1"># Размер выборки</span>
        <span class="n">n_features</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>             <span class="c1"># Количество признаков</span>
        <span class="n">n_informative</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>          <span class="c1"># Информативные признаки (важные для предсказания)</span>
        <span class="n">n_redundant</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>             <span class="c1"># Избыточные признаки (коррелированные)</span>
        <span class="n">n_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>               <span class="c1"># Бинарная классификация (дефолт/не дефолт)</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>            <span class="c1"># Воспроизводимость результатов</span>
    <span class="p">)</span>

    <span class="c1"># Создание DataFrame с осмысленными названиями</span>
    <span class="n">feature_names</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;income&#39;</span><span class="p">,</span> <span class="s1">&#39;credit_score&#39;</span><span class="p">,</span> <span class="s1">&#39;debt_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;employment_years&#39;</span><span class="p">,</span>
        <span class="s1">&#39;loan_amount&#39;</span><span class="p">,</span> <span class="s1">&#39;interest_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;payment_history&#39;</span><span class="p">,</span> <span class="s1">&#39;savings_balance&#39;</span><span class="p">,</span>
        <span class="s1">&#39;investment_value&#39;</span><span class="p">,</span> <span class="s1">&#39;credit_cards&#39;</span><span class="p">,</span> <span class="s1">&#39;late_payments&#39;</span><span class="p">,</span> <span class="s1">&#39;bankruptcies&#39;</span><span class="p">,</span>
        <span class="s1">&#39;foreclosures&#39;</span><span class="p">,</span> <span class="s1">&#39;collections&#39;</span><span class="p">,</span> <span class="s1">&#39;inquiries&#39;</span><span class="p">,</span> <span class="s1">&#39;credit_utilization&#39;</span><span class="p">,</span>
        <span class="s1">&#39;account_age&#39;</span><span class="p">,</span> <span class="s1">&#39;payment_frequency&#39;</span><span class="p">,</span> <span class="s1">&#39;credit_mix&#39;</span>
    <span class="p">]</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">feature_names</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;default_risk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>

    <span class="c1"># Добавление категориальных переменных</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;employment_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s1">&#39;employed&#39;</span><span class="p">,</span> <span class="s1">&#39;unemployed&#39;</span><span class="p">,</span> <span class="s1">&#39;self_employed&#39;</span><span class="p">],</span> <span class="n">n_samples</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;education&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s1">&#39;high_school&#39;</span><span class="p">,</span> <span class="s1">&#39;bachelor&#39;</span><span class="p">,</span> <span class="s1">&#39;master&#39;</span><span class="p">,</span> <span class="s1">&#39;phd&#39;</span><span class="p">],</span> <span class="n">n_samples</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;marital_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s1">&#39;single&#39;</span><span class="p">,</span> <span class="s1">&#39;married&#39;</span><span class="p">,</span> <span class="s1">&#39;divorced&#39;</span><span class="p">],</span> <span class="n">n_samples</span><span class="p">)</span>

    <span class="c1"># Добавление временных переменных</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;application_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2020-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="c1"># Создание данных</span>
<span class="n">bank_data</span> <span class="o">=</span> <span class="n">create_bank_data</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Bank data shape:&quot;</span><span class="p">,</span> <span class="n">bank_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Default rate:&quot;</span><span class="p">,</span> <span class="n">bank_data</span><span class="p">[</span><span class="s1">&#39;default_risk&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</code></pre></div>

<h3 id="_205">Подготовка данных</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">prepare_bank_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Подготовка банковских данных&quot;&quot;&quot;</span>

    <span class="c1"># Обработка пропущенных значений</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">median</span><span class="p">())</span>

    <span class="c1"># Создание новых признаков</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;debt_to_income&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;debt_ratio&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;income&#39;</span><span class="p">]</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;credit_utilization_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;credit_utilization&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;credit_score&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;payment_stability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;payment_history&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;late_payments&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Обработка выбросов</span>
    <span class="n">numeric_columns</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="s1">&#39;default_risk&#39;</span><span class="p">:</span>
            <span class="n">Q1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
            <span class="n">Q3</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.75</span><span class="p">)</span>
            <span class="n">IQR</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">-</span> <span class="n">Q1</span>
            <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">Q1</span> <span class="o">-</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">IQR</span><span class="p">,</span> <span class="n">Q1</span> <span class="o">-</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">IQR</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
            <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">Q3</span> <span class="o">+</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">IQR</span><span class="p">,</span> <span class="n">Q3</span> <span class="o">+</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">IQR</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="c1"># Подготовка данных</span>
<span class="n">bank_data_processed</span> <span class="o">=</span> <span class="n">prepare_bank_data</span><span class="p">(</span><span class="n">bank_data</span><span class="p">)</span>
</code></pre></div>

<h3 id="_206">Обучение модели</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">train_bank_model</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Обучение модели для банковской задачи&quot;&quot;&quot;</span>

    <span class="c1"># Разделение на train/test</span>
    <span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;default_risk&#39;</span><span class="p">])</span>

    <span class="c1"># Создание предиктора</span>
    <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;default_risk&#39;</span><span class="p">,</span>
        <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span>
        <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;roc_auc&#39;</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="s1">&#39;./bank_models&#39;</span>
    <span class="p">)</span>

    <span class="c1"># Настройка гиперпараметров для банковской задачи</span>
    <span class="n">hyperparameters</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;GBM&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
                <span class="s1">&#39;num_leaves&#39;</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span>
                <span class="s1">&#39;feature_fraction&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
                <span class="s1">&#39;bagging_fraction&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
                <span class="s1">&#39;min_data_in_leaf&#39;</span><span class="p">:</span> <span class="mi">20</span>
            <span class="p">}</span>
        <span class="p">],</span>
        <span class="s1">&#39;XGB&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
                <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
                <span class="s1">&#39;subsample&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
                <span class="s1">&#39;colsample_bytree&#39;</span><span class="p">:</span> <span class="mf">0.8</span>
            <span class="p">}</span>
        <span class="p">],</span>
        <span class="s1">&#39;CAT&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;iterations&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
                <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
                <span class="s1">&#39;l2_leaf_reg&#39;</span><span class="p">:</span> <span class="mf">3.0</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>

    <span class="c1"># Обучение модели</span>
    <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">train_data</span><span class="p">,</span>
        <span class="n">hyperparameters</span><span class="o">=</span><span class="n">hyperparameters</span><span class="p">,</span>
        <span class="n">time_limit</span><span class="o">=</span><span class="mi">1800</span><span class="p">,</span>  <span class="c1"># 30 минут</span>
        <span class="n">presets</span><span class="o">=</span><span class="s1">&#39;high_quality&#39;</span><span class="p">,</span>
        <span class="n">num_bag_folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">num_bag_sets</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">predictor</span><span class="p">,</span> <span class="n">test_data</span>

<span class="c1"># Обучение модели</span>
<span class="n">bank_predictor</span><span class="p">,</span> <span class="n">bank_test_data</span> <span class="o">=</span> <span class="n">train_bank_model</span><span class="p">(</span><span class="n">bank_data_processed</span><span class="p">)</span>
</code></pre></div>

<h3 id="_207">Оценка качества</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_bank_model</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">test_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Оценка качества банковской модели&quot;&quot;&quot;</span>

    <span class="c1"># Предсказания</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
    <span class="n">probabilities</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

    <span class="c1"># Оценка качества</span>
    <span class="n">performance</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

    <span class="c1"># Анализ важности признаков</span>
    <span class="n">feature_importance</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">feature_importance</span><span class="p">()</span>

    <span class="c1"># Лидерборд моделей</span>
    <span class="n">leaderboard</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">leaderboard</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;performance&#39;</span><span class="p">:</span> <span class="n">performance</span><span class="p">,</span>
        <span class="s1">&#39;feature_importance&#39;</span><span class="p">:</span> <span class="n">feature_importance</span><span class="p">,</span>
        <span class="s1">&#39;leaderboard&#39;</span><span class="p">:</span> <span class="n">leaderboard</span><span class="p">,</span>
        <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="n">predictions</span><span class="p">,</span>
        <span class="s1">&#39;probabilities&#39;</span><span class="p">:</span> <span class="n">probabilities</span>
    <span class="p">}</span>

<span class="c1"># Оценка модели</span>
<span class="n">bank_results</span> <span class="o">=</span> <span class="n">evaluate_bank_model</span><span class="p">(</span><span class="n">bank_predictor</span><span class="p">,</span> <span class="n">bank_test_data</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Bank Model Performance:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">bank_results</span><span class="p">[</span><span class="s1">&#39;performance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 Feature Importance:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">bank_results</span><span class="p">[</span><span class="s1">&#39;feature_importance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</code></pre></div>

<h3 id="_208">Визуализация результатов</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">visualize_bank_results</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">test_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Визуализация результатов банковской модели&quot;&quot;&quot;</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

    <span class="c1"># ROC кривая</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;default_risk&#39;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;k--&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;False Positive Rate&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;True Positive Rate&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;ROC Curve&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="c1"># Precision-Recall кривая</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">precision_recall_curve</span>
    <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">precision_recall_curve</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;default_risk&#39;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">recall</span><span class="p">,</span> <span class="n">precision</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Recall&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Precision&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Precision-Recall Curve&#39;</span><span class="p">)</span>

    <span class="c1"># Важность признаков</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;feature_importance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;barh&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 10 Feature Importance&#39;</span><span class="p">)</span>

    <span class="c1"># Распределение вероятностей</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Default Probability&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Distribution of Default Probabilities&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Визуализация</span>
<span class="n">visualize_bank_results</span><span class="p">(</span><span class="n">bank_results</span><span class="p">,</span> <span class="n">bank_test_data</span><span class="p">)</span>
</code></pre></div>

<h2 id="2_9">Пример 2: Прогнозирование цен на недвижимость</h2>
<h3 id="_209">Задача</h3>
<p>Предсказание цены недвижимости на основе характеристик объекта.</p>
<h3 id="_210">Данные</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_real_estate_data</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">5000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Создание синтетических данных о недвижимости&quot;&quot;&quot;</span>

    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

    <span class="c1"># Основные характеристики</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;area&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">),</span>
        <span class="s1">&#39;bedrooms&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">),</span>
        <span class="s1">&#39;bathrooms&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">),</span>
        <span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">),</span>
        <span class="s1">&#39;garage&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">),</span>
        <span class="s1">&#39;pool&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">),</span>
        <span class="s1">&#39;garden&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="c1"># Категориальные переменные</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s1">&#39;downtown&#39;</span><span class="p">,</span> <span class="s1">&#39;suburbs&#39;</span><span class="p">,</span> <span class="s1">&#39;rural&#39;</span><span class="p">],</span> <span class="n">n_samples</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;property_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s1">&#39;house&#39;</span><span class="p">,</span> <span class="s1">&#39;apartment&#39;</span><span class="p">,</span> <span class="s1">&#39;townhouse&#39;</span><span class="p">],</span> <span class="n">n_samples</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s1">&#39;excellent&#39;</span><span class="p">,</span> <span class="s1">&#39;good&#39;</span><span class="p">,</span> <span class="s1">&#39;fair&#39;</span><span class="p">,</span> <span class="s1">&#39;poor&#39;</span><span class="p">],</span> <span class="n">n_samples</span><span class="p">)</span>

    <span class="c1"># Создание целевой переменной (цена)</span>
    <span class="n">base_price</span> <span class="o">=</span> <span class="mi">100000</span>
    <span class="n">price</span> <span class="o">=</span> <span class="p">(</span><span class="n">base_price</span> <span class="o">+</span> 
             <span class="n">data</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">+</span>
             <span class="n">data</span><span class="p">[</span><span class="s1">&#39;bedrooms&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10000</span> <span class="o">+</span>
             <span class="n">data</span><span class="p">[</span><span class="s1">&#39;bathrooms&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">5000</span> <span class="o">+</span>
             <span class="n">data</span><span class="p">[</span><span class="s1">&#39;garage&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">15000</span> <span class="o">+</span>
             <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pool&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">25000</span> <span class="o">+</span>
             <span class="n">data</span><span class="p">[</span><span class="s1">&#39;garden&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10000</span> <span class="o">-</span>
             <span class="n">data</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2000</span><span class="p">)</span>

    <span class="c1"># Добавление шума</span>
    <span class="n">price</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20000</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="mi">50000</span><span class="p">)</span>  <span class="c1"># Минимальная цена</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="c1"># Создание данных</span>
<span class="n">real_estate_data</span> <span class="o">=</span> <span class="n">create_real_estate_data</span><span class="p">(</span><span class="mi">5000</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Real estate data shape:&quot;</span><span class="p">,</span> <span class="n">real_estate_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Price statistics:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">real_estate_data</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
</code></pre></div>

<h3 id="_211">Подготовка данных</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">prepare_real_estate_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Подготовка данных о недвижимости&quot;&quot;&quot;</span>

    <span class="c1"># Создание новых признаков</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;area_per_bedroom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;bedrooms&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;total_rooms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;bedrooms&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;bathrooms&#39;</span><span class="p">]</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;age_category&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;new&#39;</span><span class="p">,</span> <span class="s1">&#39;recent&#39;</span><span class="p">,</span> <span class="s1">&#39;old&#39;</span><span class="p">,</span> <span class="s1">&#39;very_old&#39;</span><span class="p">])</span>

    <span class="c1"># Обработка выбросов</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">])</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="c1"># Подготовка данных</span>
<span class="n">real_estate_processed</span> <span class="o">=</span> <span class="n">prepare_real_estate_data</span><span class="p">(</span><span class="n">real_estate_data</span><span class="p">)</span>
</code></pre></div>

<h3 id="_212">Обучение модели</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">train_real_estate_model</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Обучение модели для недвижимости&quot;&quot;&quot;</span>

    <span class="c1"># Разделение на train/test</span>
    <span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

    <span class="c1"># Создание предиктора</span>
    <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;price&#39;</span><span class="p">,</span>
        <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;regression&#39;</span><span class="p">,</span>
        <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;rmse&#39;</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="s1">&#39;./real_estate_models&#39;</span>
    <span class="p">)</span>

    <span class="c1"># Настройка гиперпараметров для регрессии</span>
    <span class="n">hyperparameters</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;GBM&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
                <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
                <span class="s1">&#39;num_leaves&#39;</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span>
                <span class="s1">&#39;feature_fraction&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
                <span class="s1">&#39;bagging_fraction&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
                <span class="s1">&#39;min_data_in_leaf&#39;</span><span class="p">:</span> <span class="mi">20</span>
            <span class="p">}</span>
        <span class="p">],</span>
        <span class="s1">&#39;XGB&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
                <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
                <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
                <span class="s1">&#39;subsample&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
                <span class="s1">&#39;colsample_bytree&#39;</span><span class="p">:</span> <span class="mf">0.8</span>
            <span class="p">}</span>
        <span class="p">],</span>
        <span class="s1">&#39;RF&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
                <span class="s1">&#39;min_samples_split&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                <span class="s1">&#39;min_samples_leaf&#39;</span><span class="p">:</span> <span class="mi">2</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>

    <span class="c1"># Обучение модели</span>
    <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">train_data</span><span class="p">,</span>
        <span class="n">hyperparameters</span><span class="o">=</span><span class="n">hyperparameters</span><span class="p">,</span>
        <span class="n">time_limit</span><span class="o">=</span><span class="mi">1800</span><span class="p">,</span>  <span class="c1"># 30 минут</span>
        <span class="n">presets</span><span class="o">=</span><span class="s1">&#39;high_quality&#39;</span><span class="p">,</span>
        <span class="n">num_bag_folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">num_bag_sets</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">predictor</span><span class="p">,</span> <span class="n">test_data</span>

<span class="c1"># Обучение модели</span>
<span class="n">real_estate_predictor</span><span class="p">,</span> <span class="n">real_estate_test_data</span> <span class="o">=</span> <span class="n">train_real_estate_model</span><span class="p">(</span><span class="n">real_estate_processed</span><span class="p">)</span>
</code></pre></div>

<h3 id="_213">Оценка качества</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_real_estate_model</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">test_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Оценка качества модели недвижимости&quot;&quot;&quot;</span>

    <span class="c1"># Предсказания</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

    <span class="c1"># Оценка качества</span>
    <span class="n">performance</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

    <span class="c1"># Анализ важности признаков</span>
    <span class="n">feature_importance</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">feature_importance</span><span class="p">()</span>

    <span class="c1"># Лидерборд моделей</span>
    <span class="n">leaderboard</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">leaderboard</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

    <span class="c1"># Анализ ошибок</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">predictions</span>
    <span class="n">mae</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">errors</span><span class="p">))</span>
    <span class="n">mape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">errors</span> <span class="o">/</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]))</span> <span class="o">*</span> <span class="mi">100</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;performance&#39;</span><span class="p">:</span> <span class="n">performance</span><span class="p">,</span>
        <span class="s1">&#39;feature_importance&#39;</span><span class="p">:</span> <span class="n">feature_importance</span><span class="p">,</span>
        <span class="s1">&#39;leaderboard&#39;</span><span class="p">:</span> <span class="n">leaderboard</span><span class="p">,</span>
        <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="n">predictions</span><span class="p">,</span>
        <span class="s1">&#39;mae&#39;</span><span class="p">:</span> <span class="n">mae</span><span class="p">,</span>
        <span class="s1">&#39;mape&#39;</span><span class="p">:</span> <span class="n">mape</span><span class="p">,</span>
        <span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="n">errors</span>
    <span class="p">}</span>

<span class="c1"># Оценка модели</span>
<span class="n">real_estate_results</span> <span class="o">=</span> <span class="n">evaluate_real_estate_model</span><span class="p">(</span><span class="n">real_estate_predictor</span><span class="p">,</span> <span class="n">real_estate_test_data</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Real Estate Model Performance:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">real_estate_results</span><span class="p">[</span><span class="s1">&#39;performance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MAE: </span><span class="si">{</span><span class="n">real_estate_results</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MAPE: </span><span class="si">{</span><span class="n">real_estate_results</span><span class="p">[</span><span class="s1">&#39;mape&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="_214">Визуализация результатов</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">visualize_real_estate_results</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">test_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Визуализация результатов модели недвижимости&quot;&quot;&quot;</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

    <span class="c1"># Предсказания vs Фактические значения</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> 
                   <span class="p">[</span><span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="s1">&#39;r--&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Actual Price&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Predicted Price&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Predictions vs Actual&#39;</span><span class="p">)</span>

    <span class="c1"># Распределение ошибок</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Prediction Error&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Distribution of Prediction Errors&#39;</span><span class="p">)</span>

    <span class="c1"># Важность признаков</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;feature_importance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;barh&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 10 Feature Importance&#39;</span><span class="p">)</span>

    <span class="c1"># Ошибки по цене</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Actual Price&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Prediction Error&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Errors by Price Range&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Визуализация</span>
<span class="n">visualize_real_estate_results</span><span class="p">(</span><span class="n">real_estate_results</span><span class="p">,</span> <span class="n">real_estate_test_data</span><span class="p">)</span>
</code></pre></div>

<h2 id="3_3">Пример 3: Анализ временных рядов</h2>
<h3 id="_215">Задача</h3>
<p>Прогнозирование продаж товаров на основе исторических данных.</p>
<h3 id="_216">Данные</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_sales_data</span><span class="p">(</span><span class="n">n_days</span><span class="o">=</span><span class="mi">365</span><span class="p">,</span> <span class="n">n_products</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Создание синтетических данных о продажах&quot;&quot;&quot;</span>

    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

    <span class="c1"># Создание временного ряда</span>
    <span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2023-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">n_days</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">product_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_products</span><span class="p">):</span>
        <span class="c1"># Базовый тренд</span>
        <span class="n">trend</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="n">n_days</span><span class="p">)</span>

        <span class="c1"># Сезонность (еженедельная)</span>
        <span class="n">seasonality</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_days</span><span class="p">)</span> <span class="o">/</span> <span class="mi">7</span><span class="p">)</span>

        <span class="c1"># Случайный шум</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">n_days</span><span class="p">)</span>

        <span class="c1"># Продажи</span>
        <span class="n">sales</span> <span class="o">=</span> <span class="n">trend</span> <span class="o">+</span> <span class="n">seasonality</span> <span class="o">+</span> <span class="n">noise</span>
        <span class="n">sales</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">sales</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Негативные продажи невозможны</span>

        <span class="c1"># Создание записей</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">sale</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">sales</span><span class="p">)):</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
                <span class="s1">&#39;product_id&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;product_</span><span class="si">{</span><span class="n">product_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sales&#39;</span><span class="p">:</span> <span class="n">sale</span><span class="p">,</span>
                <span class="s1">&#39;day_of_week&#39;</span><span class="p">:</span> <span class="n">date</span><span class="o">.</span><span class="n">dayofweek</span><span class="p">,</span>
                <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="n">date</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
                <span class="s1">&#39;quarter&#39;</span><span class="p">:</span> <span class="n">date</span><span class="o">.</span><span class="n">quarter</span>
            <span class="p">})</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># Создание данных</span>
<span class="n">sales_data</span> <span class="o">=</span> <span class="n">create_sales_data</span><span class="p">(</span><span class="mi">365</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sales data shape:&quot;</span><span class="p">,</span> <span class="n">sales_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sales statistics:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sales_data</span><span class="p">[</span><span class="s1">&#39;sales&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
</code></pre></div>

<h3 id="_217">Подготовка данных для временных рядов</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">prepare_sales_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Подготовка данных о продажах для временных рядов&quot;&quot;&quot;</span>

    <span class="c1"># Создание лаговых признаков</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;product_id&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">30</span><span class="p">]:</span>
        <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;sales_lag_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;product_id&#39;</span><span class="p">)[</span><span class="s1">&#39;sales&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">lag</span><span class="p">)</span>

    <span class="c1"># Скользящие средние</span>
    <span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">30</span><span class="p">]:</span>
        <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;sales_ma_</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;product_id&#39;</span><span class="p">)[</span><span class="s1">&#39;sales&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Тренды</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;sales_trend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;product_id&#39;</span><span class="p">)[</span><span class="s1">&#39;sales&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Сезонные признаки</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_weekend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;day_of_week&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_month_start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_month_end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day</span> <span class="o">&gt;=</span> <span class="mi">25</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="c1"># Подготовка данных</span>
<span class="n">sales_processed</span> <span class="o">=</span> <span class="n">prepare_sales_data</span><span class="p">(</span><span class="n">sales_data</span><span class="p">)</span>
</code></pre></div>

<h3 id="_218">Обучение модели временных рядов</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">train_sales_model</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Обучение модели для прогнозирования продаж&quot;&quot;&quot;</span>

    <span class="c1"># Разделение на train/test (последние 30 дней для теста)</span>
    <span class="n">split_date</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">train_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">split_date</span><span class="p">]</span>
    <span class="n">test_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">split_date</span><span class="p">]</span>

    <span class="c1"># Создание предиктора</span>
    <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;sales&#39;</span><span class="p">,</span>
        <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;regression&#39;</span><span class="p">,</span>
        <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;rmse&#39;</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="s1">&#39;./sales_models&#39;</span>
    <span class="p">)</span>

    <span class="c1"># Настройка гиперпараметров для временных рядов</span>
    <span class="n">hyperparameters</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;GBM&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
                <span class="s1">&#39;num_leaves&#39;</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span>
                <span class="s1">&#39;feature_fraction&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
                <span class="s1">&#39;bagging_fraction&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
                <span class="s1">&#39;min_data_in_leaf&#39;</span><span class="p">:</span> <span class="mi">20</span>
            <span class="p">}</span>
        <span class="p">],</span>
        <span class="s1">&#39;XGB&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
                <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
                <span class="s1">&#39;subsample&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
                <span class="s1">&#39;colsample_bytree&#39;</span><span class="p">:</span> <span class="mf">0.8</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>

    <span class="c1"># Обучение модели</span>
    <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">train_data</span><span class="p">,</span>
        <span class="n">hyperparameters</span><span class="o">=</span><span class="n">hyperparameters</span><span class="p">,</span>
        <span class="n">time_limit</span><span class="o">=</span><span class="mi">1800</span><span class="p">,</span>  <span class="c1"># 30 минут</span>
        <span class="n">presets</span><span class="o">=</span><span class="s1">&#39;high_quality&#39;</span><span class="p">,</span>
        <span class="n">num_bag_folds</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="c1"># Меньше фолдов для временных рядов</span>
        <span class="n">num_bag_sets</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">predictor</span><span class="p">,</span> <span class="n">test_data</span>

<span class="c1"># Обучение модели</span>
<span class="n">sales_predictor</span><span class="p">,</span> <span class="n">sales_test_data</span> <span class="o">=</span> <span class="n">train_sales_model</span><span class="p">(</span><span class="n">sales_processed</span><span class="p">)</span>
</code></pre></div>

<h3 id="_219">Оценка качества временных рядов</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_sales_model</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">test_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Оценка качества модели продаж&quot;&quot;&quot;</span>

    <span class="c1"># Предсказания</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

    <span class="c1"># Оценка качества</span>
    <span class="n">performance</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

    <span class="c1"># Анализ важности признаков</span>
    <span class="n">feature_importance</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">feature_importance</span><span class="p">()</span>

    <span class="c1"># Анализ по продуктам</span>
    <span class="n">product_performance</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">product_id</span> <span class="ow">in</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;product_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="n">product_data</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;product_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">product_id</span><span class="p">]</span>
        <span class="n">product_predictions</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;product_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">product_id</span><span class="p">]</span>

        <span class="n">mae</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">product_data</span><span class="p">[</span><span class="s1">&#39;sales&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">product_predictions</span><span class="p">))</span>
        <span class="n">mape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">product_data</span><span class="p">[</span><span class="s1">&#39;sales&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">product_predictions</span><span class="p">)</span> <span class="o">/</span> <span class="n">product_data</span><span class="p">[</span><span class="s1">&#39;sales&#39;</span><span class="p">]))</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="n">product_performance</span><span class="p">[</span><span class="n">product_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;mae&#39;</span><span class="p">:</span> <span class="n">mae</span><span class="p">,</span>
            <span class="s1">&#39;mape&#39;</span><span class="p">:</span> <span class="n">mape</span>
        <span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;performance&#39;</span><span class="p">:</span> <span class="n">performance</span><span class="p">,</span>
        <span class="s1">&#39;feature_importance&#39;</span><span class="p">:</span> <span class="n">feature_importance</span><span class="p">,</span>
        <span class="s1">&#39;product_performance&#39;</span><span class="p">:</span> <span class="n">product_performance</span><span class="p">,</span>
        <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="n">predictions</span>
    <span class="p">}</span>

<span class="c1"># Оценка модели</span>
<span class="n">sales_results</span> <span class="o">=</span> <span class="n">evaluate_sales_model</span><span class="p">(</span><span class="n">sales_predictor</span><span class="p">,</span> <span class="n">sales_test_data</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sales Model Performance:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">sales_results</span><span class="p">[</span><span class="s1">&#39;performance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Product Performance:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">product</span><span class="p">,</span> <span class="n">perf</span> <span class="ow">in</span> <span class="n">sales_results</span><span class="p">[</span><span class="s1">&#39;product_performance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">: MAE=</span><span class="si">{</span><span class="n">perf</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, MAPE=</span><span class="si">{</span><span class="n">perf</span><span class="p">[</span><span class="s1">&#39;mape&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="_220">Визуализация временных рядов</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">visualize_sales_results</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">test_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Визуализация результатов модели продаж&quot;&quot;&quot;</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

    <span class="c1"># Временной ряд для одного продукта</span>
    <span class="n">product_id</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;product_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">product_data</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;product_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">product_id</span><span class="p">]</span>
    <span class="n">product_predictions</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">][</span><span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;product_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">product_id</span><span class="p">]</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">product_data</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">product_data</span><span class="p">[</span><span class="s1">&#39;sales&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">product_data</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">product_predictions</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predicted&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sales Forecast for </span><span class="si">{</span><span class="n">product_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Sales&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="c1"># Распределение ошибок</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;sales&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Prediction Error&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Distribution of Prediction Errors&#39;</span><span class="p">)</span>

    <span class="c1"># Важность признаков</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;feature_importance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;barh&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 10 Feature Importance&#39;</span><span class="p">)</span>

    <span class="c1"># Производительность по продуктам</span>
    <span class="n">products</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;product_performance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">maes</span> <span class="o">=</span> <span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;product_performance&#39;</span><span class="p">][</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;mae&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">products</span><span class="p">]</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">products</span><span class="p">,</span> <span class="n">maes</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Product&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;MAE&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Performance by Product&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Визуализация</span>
<span class="n">visualize_sales_results</span><span class="p">(</span><span class="n">sales_results</span><span class="p">,</span> <span class="n">sales_test_data</span><span class="p">)</span>
</code></pre></div>

<h2 id="4">Пример 4: Многоклассовая классификация</h2>
<h3 id="_221">Задача</h3>
<p>Классификация изображений на основе извлеченных признаков.</p>
<h3 id="_222">Данные</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_image_data</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Создание синтетических данных изображений&quot;&quot;&quot;</span>

    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

    <span class="c1"># Создание признаков изображений</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">n_features</span><span class="p">)</span>

    <span class="c1"># Создание целевых классов</span>
    <span class="n">n_classes</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="s1">&#39;dog&#39;</span><span class="p">,</span> <span class="s1">&#39;bird&#39;</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">,</span> <span class="s1">&#39;tree&#39;</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">n_classes</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>

    <span class="c1"># Создание DataFrame</span>
    <span class="n">feature_names</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;feature_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_features</span><span class="p">)]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">feature_names</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">classes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">y</span><span class="p">]</span>

    <span class="c1"># Добавление метаданных</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;image_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s1">&#39;small&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">],</span> <span class="n">n_samples</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;color_channels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">n_samples</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;resolution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">n_samples</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="c1"># Создание данных</span>
<span class="n">image_data</span> <span class="o">=</span> <span class="n">create_image_data</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Image data shape:&quot;</span><span class="p">,</span> <span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Class distribution:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">image_data</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
</code></pre></div>

<h3 id="_223">Подготовка данных</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">prepare_image_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Подготовка данных изображений&quot;&quot;&quot;</span>

    <span class="c1"># Создание новых признаков</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;feature_sum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;feature_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;feature_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Нормализация признаков</span>
    <span class="n">numeric_columns</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="s1">&#39;color_channels&#39;</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="c1"># Подготовка данных</span>
<span class="n">image_processed</span> <span class="o">=</span> <span class="n">prepare_image_data</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span>
</code></pre></div>

<h3 id="_224">Обучение модели</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">train_image_model</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Обучение модели для классификации изображений&quot;&quot;&quot;</span>

    <span class="c1"># Разделение на train/test</span>
    <span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">])</span>

    <span class="c1"># Создание предиктора</span>
    <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;class&#39;</span><span class="p">,</span>
        <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;multiclass&#39;</span><span class="p">,</span>
        <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="s1">&#39;./image_models&#39;</span>
    <span class="p">)</span>

    <span class="c1"># Настройка гиперпараметров для многоклассовой классификации</span>
    <span class="n">hyperparameters</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;GBM&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
                <span class="s1">&#39;num_leaves&#39;</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span>
                <span class="s1">&#39;feature_fraction&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
                <span class="s1">&#39;bagging_fraction&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
                <span class="s1">&#39;min_data_in_leaf&#39;</span><span class="p">:</span> <span class="mi">20</span>
            <span class="p">}</span>
        <span class="p">],</span>
        <span class="s1">&#39;XGB&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
                <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
                <span class="s1">&#39;subsample&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
                <span class="s1">&#39;colsample_bytree&#39;</span><span class="p">:</span> <span class="mf">0.8</span>
            <span class="p">}</span>
        <span class="p">],</span>
        <span class="s1">&#39;RF&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
                <span class="s1">&#39;min_samples_split&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                <span class="s1">&#39;min_samples_leaf&#39;</span><span class="p">:</span> <span class="mi">2</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>

    <span class="c1"># Обучение модели</span>
    <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">train_data</span><span class="p">,</span>
        <span class="n">hyperparameters</span><span class="o">=</span><span class="n">hyperparameters</span><span class="p">,</span>
        <span class="n">time_limit</span><span class="o">=</span><span class="mi">1800</span><span class="p">,</span>  <span class="c1"># 30 минут</span>
        <span class="n">presets</span><span class="o">=</span><span class="s1">&#39;high_quality&#39;</span><span class="p">,</span>
        <span class="n">num_bag_folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">num_bag_sets</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">predictor</span><span class="p">,</span> <span class="n">test_data</span>

<span class="c1"># Обучение модели</span>
<span class="n">image_predictor</span><span class="p">,</span> <span class="n">image_test_data</span> <span class="o">=</span> <span class="n">train_image_model</span><span class="p">(</span><span class="n">image_processed</span><span class="p">)</span>
</code></pre></div>

<h3 id="_225">Оценка качества</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_image_model</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">test_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Оценка качества модели классификации изображений&quot;&quot;&quot;</span>

    <span class="c1"># Предсказания</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
    <span class="n">probabilities</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

    <span class="c1"># Оценка качества</span>
    <span class="n">performance</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

    <span class="c1"># Анализ важности признаков</span>
    <span class="n">feature_importance</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">feature_importance</span><span class="p">()</span>

    <span class="c1"># Лидерборд моделей</span>
    <span class="n">leaderboard</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">leaderboard</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

    <span class="c1"># Анализ по классам</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span>

    <span class="n">class_report</span> <span class="o">=</span> <span class="n">classification_report</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">],</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">output_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">conf_matrix</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">],</span> <span class="n">predictions</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;performance&#39;</span><span class="p">:</span> <span class="n">performance</span><span class="p">,</span>
        <span class="s1">&#39;feature_importance&#39;</span><span class="p">:</span> <span class="n">feature_importance</span><span class="p">,</span>
        <span class="s1">&#39;leaderboard&#39;</span><span class="p">:</span> <span class="n">leaderboard</span><span class="p">,</span>
        <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="n">predictions</span><span class="p">,</span>
        <span class="s1">&#39;probabilities&#39;</span><span class="p">:</span> <span class="n">probabilities</span><span class="p">,</span>
        <span class="s1">&#39;classification_report&#39;</span><span class="p">:</span> <span class="n">class_report</span><span class="p">,</span>
        <span class="s1">&#39;confusion_matrix&#39;</span><span class="p">:</span> <span class="n">conf_matrix</span>
    <span class="p">}</span>

<span class="c1"># Оценка модели</span>
<span class="n">image_results</span> <span class="o">=</span> <span class="n">evaluate_image_model</span><span class="p">(</span><span class="n">image_predictor</span><span class="p">,</span> <span class="n">image_test_data</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Image Model Performance:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">image_results</span><span class="p">[</span><span class="s1">&#39;performance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Classification Report:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">class_name</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="n">image_results</span><span class="p">[</span><span class="s1">&#39;classification_report&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">class_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">metrics</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="_226">Визуализация результатов</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">visualize_image_results</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">test_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Визуализация результатов модели классификации изображений&quot;&quot;&quot;</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

    <span class="c1"># Матрица ошибок</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;confusion_matrix&#39;</span><span class="p">],</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Confusion Matrix&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Predicted&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Actual&#39;</span><span class="p">)</span>

    <span class="c1"># Важность признаков</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;feature_importance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;barh&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Feature Importance&#39;</span><span class="p">)</span>

    <span class="c1"># Распределение предсказаний</span>
    <span class="n">prediction_counts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
    <span class="n">prediction_counts</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Distribution of Predictions&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Class&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

    <span class="c1"># Точность по классам</span>
    <span class="n">class_accuracy</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="n">class_data</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">class_name</span><span class="p">]</span>
        <span class="n">class_predictions</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">][</span><span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">class_name</span><span class="p">]</span>
        <span class="n">accuracy</span> <span class="o">=</span> <span class="p">(</span><span class="n">class_data</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">class_predictions</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">class_accuracy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">accuracy</span><span class="p">)</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">class_accuracy</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Accuracy by Class&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Class&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Визуализация</span>
<span class="n">visualize_image_results</span><span class="p">(</span><span class="n">image_results</span><span class="p">,</span> <span class="n">image_test_data</span><span class="p">)</span>
</code></pre></div>

<h2 id="5">Пример 5: Продакшен система</h2>
<h3 id="_227">Полная продакшен система</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.tabular</span><span class="w"> </span><span class="kn">import</span> <span class="n">TabularPredictor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">aiohttp</span>

<span class="c1"># Настройка логирования</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Создание FastAPI приложения</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;AutoML Gluon Production API&quot;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;1.0.0&quot;</span><span class="p">)</span>

<span class="c1"># Глобальные переменные</span>
<span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">model_metadata</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PredictionRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PredictionResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">predictions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
    <span class="n">probabilities</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">model_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ModelInfo</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">model_type</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">performance</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
    <span class="n">features</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="nb">str</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">&quot;startup&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">load_models</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Загрузка моделей при запуске&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">models</span><span class="p">,</span> <span class="n">model_metadata</span>

    <span class="c1"># Загрузка банковской модели</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">models</span><span class="p">[</span><span class="s1">&#39;bank_default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;./bank_models&#39;</span><span class="p">)</span>
        <span class="n">model_metadata</span><span class="p">[</span><span class="s1">&#39;bank_default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;model_type&#39;</span><span class="p">:</span> <span class="s1">&#39;binary_classification&#39;</span><span class="p">,</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;default_risk&#39;</span><span class="p">,</span>
            <span class="s1">&#39;features&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;income&#39;</span><span class="p">,</span> <span class="s1">&#39;credit_score&#39;</span><span class="p">,</span> <span class="s1">&#39;debt_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;employment_years&#39;</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Bank model loaded successfully&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load bank model: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Загрузка модели недвижимости</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">models</span><span class="p">[</span><span class="s1">&#39;real_estate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;./real_estate_models&#39;</span><span class="p">)</span>
        <span class="n">model_metadata</span><span class="p">[</span><span class="s1">&#39;real_estate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;model_type&#39;</span><span class="p">:</span> <span class="s1">&#39;regression&#39;</span><span class="p">,</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;price&#39;</span><span class="p">,</span>
            <span class="s1">&#39;features&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">,</span> <span class="s1">&#39;bedrooms&#39;</span><span class="p">,</span> <span class="s1">&#39;bathrooms&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;location&#39;</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Real estate model loaded successfully&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load real estate model: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/health&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">health_check</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Health check endpoint&quot;&quot;&quot;</span>
    <span class="n">loaded_models</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;healthy&quot;</span> <span class="k">if</span> <span class="n">loaded_models</span> <span class="k">else</span> <span class="s2">&quot;unhealthy&quot;</span><span class="p">,</span>
        <span class="s2">&quot;loaded_models&quot;</span><span class="p">:</span> <span class="n">loaded_models</span><span class="p">,</span>
        <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
    <span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/predict&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">PredictionResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">PredictionRequest</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Endpoint для предсказаний&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">model_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Model </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">request</span><span class="o">.</span><span class="n">model_name</span><span class="p">]</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">model_metadata</span><span class="p">[</span><span class="n">request</span><span class="o">.</span><span class="n">model_name</span><span class="p">]</span>

        <span class="c1"># Преобразование данных</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Предсказания</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># Вероятности (если доступны)</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;predict_proba&#39;</span><span class="p">):</span>
            <span class="n">proba</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="n">probabilities</span> <span class="o">=</span> <span class="n">proba</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">PredictionResponse</span><span class="p">(</span>
            <span class="n">predictions</span><span class="o">=</span><span class="n">predictions</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
            <span class="n">probabilities</span><span class="o">=</span><span class="n">probabilities</span><span class="p">,</span>
            <span class="n">model_info</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
                <span class="s2">&quot;model_type&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">],</span>
                <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">],</span>
                <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]</span>
            <span class="p">},</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Prediction error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/models&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_models</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Список доступных моделей&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;models&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
        <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">model_metadata</span>
    <span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/models/</span><span class="si">{model_name}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_model_info</span><span class="p">(</span><span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Информация о модели&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">model_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Model </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">model_metadata</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
        <span class="s2">&quot;model_type&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">],</span>
        <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">],</span>
        <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">],</span>
        <span class="s2">&quot;performance&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span><span class="n">f</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]}]))</span>
    <span class="p">}</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>
    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8000</span><span class="p">)</span>
</code></pre></div>

<h3 id="_228">Клиент для тестирования</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_production_api</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Тестирование продакшен API&quot;&quot;&quot;</span>

    <span class="n">base_url</span> <span class="o">=</span> <span class="s2">&quot;http://localhost:8000&quot;</span>

    <span class="c1"># Health check</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/health&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Health check:&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>

    <span class="c1"># Список моделей</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/models&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available models:&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>

    <span class="c1"># Тест банковской модели</span>
    <span class="n">bank_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="s2">&quot;bank_default&quot;</span><span class="p">,</span>
        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">35</span><span class="p">,</span>
                <span class="s2">&quot;income&quot;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">,</span>
                <span class="s2">&quot;credit_score&quot;</span><span class="p">:</span> <span class="mi">750</span><span class="p">,</span>
                <span class="s2">&quot;debt_ratio&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
                <span class="s2">&quot;employment_years&quot;</span><span class="p">:</span> <span class="mi">5</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/predict&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">bank_data</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Bank prediction:&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>

    <span class="c1"># Тест модели недвижимости</span>
    <span class="n">real_estate_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="s2">&quot;real_estate&quot;</span><span class="p">,</span>
        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="mi">120</span><span class="p">,</span>
                <span class="s2">&quot;bedrooms&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                <span class="s2">&quot;bathrooms&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                <span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="s2">&quot;downtown&quot;</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/predict&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">real_estate_data</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Real estate prediction:&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>

<span class="c1"># Запуск тестов</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">test_production_api</span><span class="p">()</span>
</code></pre></div>

<h2 id="_229">Следующие шаги</h2>
<p>После изучения примеров переходите к:<br />
- <a href="./10_troubleshooting.md">Troubleshooting</a><br />
- <a href="./08_best_practices.md">Лучшим практикам</a></p>
<hr />
<h1 id="troubleshooting-automl-gluon">Troubleshooting AutoML Gluon</h1>
<p><strong>Автор:</strong> Shcherbyna Rostyslav<br />
<strong>Дата:</strong> 2024  </p>
<h2 id="troubleshooting">Почему troubleshooting критически важен</h2>
<p><strong>Почему 80% времени ML-разработки тратится на решение проблем?</strong> Потому что машинное обучение - это сложная система, где множество компонентов должны работать вместе. Это как диагностика автомобиля - нужно знать, где искать проблему.</p>
<h3 id="_230">Катастрофические последствия нерешенных проблем</h3>
<ul>
<li><strong>Потеря времени</strong>: Дни на решение простых проблем</li>
<li><strong>Фрустрация команды</strong>: Разработчики бросают проект</li>
<li><strong>Плохие результаты</strong>: Модели работают неэффективно</li>
<li><strong>Потеря доверия</strong>: Заказчики теряют веру в ML</li>
</ul>
<h3 id="troubleshooting_1">Преимущества системного troubleshooting</h3>
<ul>
<li><strong>Быстрое решение</strong>: Знание типичных проблем и их решений</li>
<li><strong>Профилактика</strong>: Предотвращение проблем до их возникновения</li>
<li><strong>Эффективность</strong>: Больше времени на разработку, меньше на отладку</li>
<li><strong>Уверенность</strong>: Команда знает, как решать проблемы</li>
</ul>
<h2 id="troubleshooting_2">Введение в troubleshooting</h2>
<p><img alt="Troubleshooting блок-схема" src="images/troubleshooting_flowchart.png" /><br />
<em>Рисунок 8: Блок-схема решения проблем AutoML Gluon</em></p>
<p><strong>Почему troubleshooting - это искусство, а не наука?</strong> Потому что каждая проблема уникальна, но паттерны повторяются. Это как медицинская диагностика - симптомы похожи, но причины разные.</p>
<p><strong>Типы проблем в AutoML Gluon:</strong><br />
- <strong>Проблемы установки</strong>: Конфликты зависимостей, версии Python<br />
- <strong>Проблемы данных</strong>: Форматы, размеры, качество<br />
- <strong>Проблемы производительности</strong>: Медленная работа, нехватка памяти<br />
- <strong>Проблемы моделей</strong>: Плохая точность, переобучение</p>
<p>В этом разделе рассмотрим типичные проблемы, возникающие при работе с AutoML Gluon, и способы их решения. Каждая проблема включает описание, причины возникновения и пошаговые инструкции по устранению.</p>
<h2 id="_231">Проблемы установки</h2>
<p><strong>Почему проблемы установки - самые частые в ML?</strong> Потому что ML-библиотеки имеют сложные зависимости между собой. Это как пазл, где каждая деталь должна точно подходить.</p>
<h3 id="1_11">1. Ошибки зависимостей</h3>
<p><strong>Почему конфликты версий так распространены?</strong> Потому что разные библиотеки требуют разные версии одних и тех же пакетов. Это как попытка использовать детали от разных моделей автомобилей.</p>
<h4 id="_232">Проблема: Конфликт версий пакетов</h4>
<div class="codehilite"><pre><span></span><code>ERROR:<span class="w"> </span>pip<span class="err">&#39;</span>s<span class="w"> </span>dependency<span class="w"> </span>resolver<span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>currently<span class="w"> </span>take<span class="w"> </span>into<span class="w"> </span>account<span class="w"> </span>all<span class="w"> </span>the<span class="w"> </span>packages<span class="w"> </span>that<span class="w"> </span>are<span class="w"> </span>installed.
This<span class="w"> </span>behaviour<span class="w"> </span>is<span class="w"> </span>the<span class="w"> </span><span class="nb">source</span><span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>following<span class="w"> </span>dependency<span class="w"> </span>conflicts.
</code></pre></div>

<p><strong>Почему возникает эта ошибка?</strong> Потому что pip пытается установить пакеты, которые конфликтуют друг с другом. Это как попытка установить одновременно Windows и Linux.</p>
<p><strong>Решение:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Создание нового окружения - изоляция от других проектов</span>
conda<span class="w"> </span>create<span class="w"> </span>-n<span class="w"> </span>autogluon<span class="w"> </span><span class="nv">python</span><span class="o">=</span><span class="m">3</span>.9
conda<span class="w"> </span>activate<span class="w"> </span>autogluon

<span class="c1"># Установка в правильном порядке - сначала базовые, потом специфичные</span>
pip<span class="w"> </span>install<span class="w"> </span>--upgrade<span class="w"> </span>pip
pip<span class="w"> </span>install<span class="w"> </span>autogluon

<span class="c1"># Или установка конкретных версий - фиксация совместимых версий</span>
pip<span class="w"> </span>install<span class="w"> </span><span class="nv">autogluon</span><span class="o">==</span><span class="m">0</span>.8.2
pip<span class="w"> </span>install<span class="w"> </span><span class="nv">torch</span><span class="o">==</span><span class="m">1</span>.13.1
pip<span class="w"> </span>install<span class="w"> </span><span class="nv">torchvision</span><span class="o">==</span><span class="m">0</span>.14.1
</code></pre></div>

<h4 id="cuda_1">Проблема: Ошибки CUDA</h4>
<div class="codehilite"><pre><span></span><code>RuntimeError:<span class="w"> </span>CUDA<span class="w"> </span>out<span class="w"> </span>of<span class="w"> </span>memory
</code></pre></div>

<p><strong>Решение:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Проверка CUDA</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CUDA available: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CUDA version: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">cuda</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Установка совместимой версии PyTorch</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">torch</span><span class="o">==</span><span class="mf">1.13.1</span><span class="o">+</span><span class="n">cu117</span> <span class="n">torchvision</span><span class="o">==</span><span class="mf">0.14.1</span><span class="o">+</span><span class="n">cu117</span> <span class="o">--</span><span class="n">extra</span><span class="o">-</span><span class="n">index</span><span class="o">-</span><span class="n">url</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">download</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">whl</span><span class="o">/</span><span class="n">cu117</span>

<span class="c1"># Или отключение CUDA</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CUDA_VISIBLE_DEVICES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</code></pre></div>

<h3 id="2_10">2. Проблемы с памятью</h3>
<h4 id="out-of-memory">Проблема: Out of memory</h4>
<div class="codehilite"><pre><span></span><code>MemoryError:<span class="w"> </span>Unable<span class="w"> </span>to<span class="w"> </span>allocate<span class="w"> </span>array
</code></pre></div>

<p><strong>Решение:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Ограничение использования памяти</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">autogluon</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ag</span>
<span class="n">ag</span><span class="o">.</span><span class="n">set_config</span><span class="p">({</span><span class="s1">&#39;memory_limit&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">})</span>  <span class="c1"># 4GB</span>

<span class="c1"># Или через переменные окружения</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;AUTOGLUON_MEMORY_LIMIT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;4&#39;</span>

<span class="c1"># Уменьшение размера данных</span>
<span class="n">train_data</span> <span class="o">=</span> <span class="n">train_data</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># Использовать 50% данных</span>
</code></pre></div>

<h2 id="_233">Проблемы обучения</h2>
<h3 id="1_12">1. Медленное обучение</h3>
<h4 id="_234">Проблема: Обучение занимает слишком много времени</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Диагностика</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="c1"># Обучение с мониторингом</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>  <span class="c1"># 5 минут для теста</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training time: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>Решение:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Оптимизация параметров</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">presets</span><span class="o">=</span><span class="s1">&#39;optimize_for_deployment&#39;</span><span class="p">,</span>  <span class="c1"># Быстрое обучение</span>
    <span class="n">time_limit</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span>  <span class="c1"># 10 минут</span>
    <span class="n">num_bag_folds</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="c1"># Меньше фолдов</span>
    <span class="n">num_bag_sets</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">ag_args_fit</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;num_cpus&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># Ограничение CPU</span>
        <span class="s1">&#39;memory_limit&#39;</span><span class="p">:</span> <span class="mi">4</span>  <span class="c1"># Ограничение памяти</span>
    <span class="p">}</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="2_11">2. Плохое качество модели</h3>
<h4 id="_235">Проблема: Низкая точность модели</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Диагностика качества данных</span>
<span class="k">def</span><span class="w"> </span><span class="nf">diagnose_data_quality</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Диагностика качества данных&quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data shape:&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Missing values:&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data types:&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>

    <span class="c1"># Проверка целевой переменной</span>
    <span class="k">if</span> <span class="s1">&#39;target&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Target distribution:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>

        <span class="c1"># Проверка на дисбаланс</span>
        <span class="n">target_counts</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="n">imbalance_ratio</span> <span class="o">=</span> <span class="n">target_counts</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="n">target_counts</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Imbalance ratio: </span><span class="si">{</span><span class="n">imbalance_ratio</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">imbalance_ratio</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: Severe class imbalance detected&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="c1"># Использование</span>
<span class="n">diagnose_data_quality</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
</code></pre></div>

<p><strong>Решение:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Улучшение качества данных</span>
<span class="k">def</span><span class="w"> </span><span class="nf">improve_data_quality</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Улучшение качества данных&quot;&quot;&quot;</span>

    <span class="c1"># Обработка пропущенных значений</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">median</span><span class="p">())</span>

    <span class="c1"># Обработка выбросов</span>
    <span class="n">numeric_columns</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="s1">&#39;target&#39;</span><span class="p">:</span>
            <span class="n">Q1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
            <span class="n">Q3</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.75</span><span class="p">)</span>
            <span class="n">IQR</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">-</span> <span class="n">Q1</span>
            <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">Q1</span> <span class="o">-</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">IQR</span><span class="p">,</span> <span class="n">Q1</span> <span class="o">-</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">IQR</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
            <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">Q3</span> <span class="o">+</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">IQR</span><span class="p">,</span> <span class="n">Q3</span> <span class="o">+</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">IQR</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>

    <span class="c1"># Создание новых признаков</span>
    <span class="k">if</span> <span class="s1">&#39;feature1&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s1">&#39;feature2&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;feature_interaction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;feature1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;feature2&#39;</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;feature_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;feature1&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;feature2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="c1"># Использование</span>
<span class="n">train_data_improved</span> <span class="o">=</span> <span class="n">improve_data_quality</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
</code></pre></div>

<h3 id="3_4">3. Ошибки валидации</h3>
<h4 id="_236">Проблема: Ошибки при валидации</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Диагностика валидации</span>
<span class="k">def</span><span class="w"> </span><span class="nf">diagnose_validation_issues</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">test_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Диагностика проблем валидации&quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Проверка совместимости данных</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test data shape:&quot;</span><span class="p">,</span> <span class="n">test_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test data columns:&quot;</span><span class="p">,</span> <span class="n">test_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="c1"># Проверка типов данных</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data types:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">dtypes</span><span class="p">)</span>

        <span class="c1"># Проверка пропущенных значений</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Missing values:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

        <span class="c1"># Попытка предсказания</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Predictions shape:&quot;</span><span class="p">,</span> <span class="n">predictions</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

<span class="c1"># Использование</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">diagnose_validation_issues</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">test_data</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Validation issues detected&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>Решение:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Исправление проблем валидации</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fix_validation_issues</span><span class="p">(</span><span class="n">test_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Исправление проблем валидации&quot;&quot;&quot;</span>

    <span class="c1"># Обработка пропущенных значений</span>
    <span class="n">test_data</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">median</span><span class="p">())</span>

    <span class="c1"># Приведение типов данных</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">test_data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">test_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span>
            <span class="c1"># Попытка преобразования в числовой тип</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">test_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># Если не удается, оставляем как есть</span>
                <span class="k">pass</span>

    <span class="c1"># Удаление константных колонок</span>
    <span class="n">constant_columns</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">test_data</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">test_data</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">constant_columns</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">test_data</span>

<span class="c1"># Использование</span>
<span class="n">test_data_fixed</span> <span class="o">=</span> <span class="n">fix_validation_issues</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
</code></pre></div>

<h2 id="_237">Проблемы предсказаний</h2>
<h3 id="1_13">1. Ошибки предсказаний</h3>
<h4 id="_238">Проблема: Ошибки при предсказании</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Диагностика предсказаний</span>
<span class="k">def</span><span class="w"> </span><span class="nf">diagnose_prediction_issues</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Диагностика проблем предсказаний&quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Проверка входных данных</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Input data shape:&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Input data types:&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">dtypes</span><span class="p">)</span>

        <span class="c1"># Проверка совместимости с моделью</span>
        <span class="n">model_features</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">feature_importance</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">data_features</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">missing_features</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">model_features</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">data_features</span><span class="p">)</span>
        <span class="n">extra_features</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">data_features</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">model_features</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">missing_features</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing features: </span><span class="si">{</span><span class="n">missing_features</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">extra_features</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extra features: </span><span class="si">{</span><span class="n">extra_features</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Попытка предсказания</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Predictions successful&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Prediction error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

<span class="c1"># Использование</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">diagnose_prediction_issues</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">new_data</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Prediction issues detected&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>Решение:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Исправление проблем предсказаний</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fix_prediction_issues</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Исправление проблем предсказаний&quot;&quot;&quot;</span>

    <span class="c1"># Получение ожидаемых признаков</span>
    <span class="n">expected_features</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">feature_importance</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="c1"># Добавление недостающих признаков</span>
    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">expected_features</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">feature</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Заполнение нулями</span>

    <span class="c1"># Удаление лишних признаков</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">expected_features</span><span class="p">]</span>

    <span class="c1"># Обработка пропущенных значений</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="c1"># Использование</span>
<span class="n">new_data_fixed</span> <span class="o">=</span> <span class="n">fix_prediction_issues</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">new_data</span><span class="p">)</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">new_data_fixed</span><span class="p">)</span>
</code></pre></div>

<h3 id="2_12">2. Нестабильные предсказания</h3>
<h4 id="_239">Проблема: Нестабильные результаты</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Диагностика стабильности</span>
<span class="k">def</span><span class="w"> </span><span class="nf">diagnose_prediction_stability</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">n_tests</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Диагностика стабильности предсказаний&quot;&quot;&quot;</span>

    <span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_tests</span><span class="p">):</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>

    <span class="c1"># Проверка согласованности</span>
    <span class="n">predictions_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
    <span class="n">consistency</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">predictions_array</span> <span class="o">==</span> <span class="n">predictions_array</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Prediction consistency: </span><span class="si">{</span><span class="n">consistency</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">consistency</span> <span class="o">&lt;</span> <span class="mf">0.95</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: Unstable predictions detected&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">consistency</span>

<span class="c1"># Использование</span>
<span class="n">consistency</span> <span class="o">=</span> <span class="n">diagnose_prediction_stability</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">test_data</span><span class="p">)</span>
</code></pre></div>

<p><strong>Решение:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Стабилизация предсказаний</span>
<span class="k">def</span><span class="w"> </span><span class="nf">stabilize_predictions</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Стабилизация предсказаний&quot;&quot;&quot;</span>

    <span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">):</span>
        <span class="c1"># Добавление небольшого шума для стабилизации</span>
        <span class="n">noisy_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">noisy_data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">noisy_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">]:</span>
                <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">noisy_data</span><span class="p">))</span>
                <span class="n">noisy_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">+=</span> <span class="n">noise</span>

        <span class="n">pred</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">noisy_data</span><span class="p">)</span>
        <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>

    <span class="c1"># Усреднение предсказаний</span>
    <span class="k">if</span> <span class="n">predictor</span><span class="o">.</span><span class="n">problem_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
        <span class="n">stable_predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Для классификации - голосование</span>
        <span class="n">stable_predictions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            <span class="n">votes</span> <span class="o">=</span> <span class="p">[</span><span class="n">pred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">pred</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">]</span>
            <span class="n">stable_predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">votes</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">votes</span><span class="o">.</span><span class="n">count</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">stable_predictions</span>

<span class="c1"># Использование</span>
<span class="n">stable_predictions</span> <span class="o">=</span> <span class="n">stabilize_predictions</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">test_data</span><span class="p">)</span>
</code></pre></div>

<h2 id="_240">Проблемы производительности</h2>
<h3 id="1_14">1. Медленные предсказания</h3>
<h4 id="_241">Проблема: Медленные предсказания</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Диагностика производительности</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="k">def</span><span class="w"> </span><span class="nf">diagnose_prediction_performance</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Диагностика производительности предсказаний&quot;&quot;&quot;</span>

    <span class="c1"># Тест на небольшой выборке</span>
    <span class="n">small_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">small_data</span><span class="p">)</span>
    <span class="n">prediction_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Prediction time for 100 samples: </span><span class="si">{</span><span class="n">prediction_time</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Prediction time per sample: </span><span class="si">{</span><span class="n">prediction_time</span><span class="o">/</span><span class="mi">100</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>

    <span class="c1"># Оценка времени для полного датасета</span>
    <span class="n">estimated_time</span> <span class="o">=</span> <span class="n">prediction_time</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Estimated time for full dataset: </span><span class="si">{</span><span class="n">estimated_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">prediction_time</span>

<span class="c1"># Использование</span>
<span class="n">prediction_time</span> <span class="o">=</span> <span class="n">diagnose_prediction_performance</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">test_data</span><span class="p">)</span>
</code></pre></div>

<p><strong>Решение:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Оптимизация производительности</span>
<span class="k">def</span><span class="w"> </span><span class="nf">optimize_prediction_performance</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Оптимизация производительности предсказаний&quot;&quot;&quot;</span>

    <span class="c1"># Пакетная обработка</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">batch_size</span><span class="p">]</span>
        <span class="n">batch_predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">predictions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">batch_predictions</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">predictions</span>

<span class="c1"># Или использование более простой модели</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_fast_model</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Создание быстрой модели&quot;&quot;&quot;</span>

    <span class="n">fast_predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="n">predictor</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
        <span class="n">problem_type</span><span class="o">=</span><span class="n">predictor</span><span class="o">.</span><span class="n">problem_type</span><span class="p">,</span>
        <span class="n">eval_metric</span><span class="o">=</span><span class="n">predictor</span><span class="o">.</span><span class="n">eval_metric</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="s1">&#39;./fast_models&#39;</span>
    <span class="p">)</span>

    <span class="c1"># Обучение только на быстрых алгоритмах</span>
    <span class="n">fast_predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">hyperparameters</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;GBM&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">}],</span>
            <span class="s1">&#39;RF&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">}]</span>
        <span class="p">},</span>
        <span class="n">time_limit</span><span class="o">=</span><span class="mi">300</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">fast_predictor</span>

<span class="c1"># Использование</span>
<span class="n">fast_predictor</span> <span class="o">=</span> <span class="n">create_fast_model</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">train_data</span><span class="p">)</span>
<span class="n">fast_predictions</span> <span class="o">=</span> <span class="n">fast_predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
</code></pre></div>

<h3 id="2_13">2. Высокое использование памяти</h3>
<h4 id="_242">Проблема: Высокое использование памяти</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Диагностика памяти</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">psutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gc</span>

<span class="k">def</span><span class="w"> </span><span class="nf">diagnose_memory_usage</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Диагностика использования памяти&quot;&quot;&quot;</span>

    <span class="n">process</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">()</span>
    <span class="n">memory_info</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Memory usage: </span><span class="si">{</span><span class="n">memory_info</span><span class="o">.</span><span class="n">rss</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1024</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Memory percent: </span><span class="si">{</span><span class="n">process</span><span class="o">.</span><span class="n">memory_percent</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">memory_info</span><span class="o">.</span><span class="n">rss</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span>

<span class="c1"># Использование</span>
<span class="n">memory_usage</span> <span class="o">=</span> <span class="n">diagnose_memory_usage</span><span class="p">()</span>
</code></pre></div>

<p><strong>Решение:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Оптимизация памяти</span>
<span class="k">def</span><span class="w"> </span><span class="nf">optimize_memory_usage</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Оптимизация использования памяти&quot;&quot;&quot;</span>

    <span class="c1"># Обработка данных по частям</span>
    <span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">):</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">chunk_size</span><span class="p">]</span>
        <span class="n">chunk_predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
        <span class="n">predictions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">chunk_predictions</span><span class="p">)</span>

        <span class="c1"># Очистка памяти</span>
        <span class="k">del</span> <span class="n">chunk</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">predictions</span>

<span class="c1"># Или использование более эффективных типов данных</span>
<span class="k">def</span><span class="w"> </span><span class="nf">optimize_data_types</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Оптимизация типов данных&quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;float64&#39;</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;int64&#39;</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="c1"># Использование</span>
<span class="n">data_optimized</span> <span class="o">=</span> <span class="n">optimize_data_types</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre></div>

<h2 id="_243">Проблемы продакшена</h2>
<h3 id="1_15">1. Ошибки загрузки модели</h3>
<h4 id="_244">Проблема: Ошибки при загрузке модели</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Диагностика загрузки модели</span>
<span class="k">def</span><span class="w"> </span><span class="nf">diagnose_model_loading</span><span class="p">(</span><span class="n">model_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Диагностика загрузки модели&quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Проверка существования файлов</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model path does not exist: </span><span class="si">{</span><span class="n">model_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Проверка структуры модели</span>
        <span class="n">required_files</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;predictor.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;metadata.json&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">required_files</span><span class="p">:</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Required file missing: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Попытка загрузки</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model loaded successfully&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model loading error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

<span class="c1"># Использование</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">diagnose_model_loading</span><span class="p">(</span><span class="s1">&#39;./models&#39;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model loading issues detected&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>Решение:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Исправление проблем загрузки модели</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fix_model_loading_issues</span><span class="p">(</span><span class="n">model_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Исправление проблем загрузки модели&quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Проверка версии AutoGluon</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">autogluon</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ag</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AutoGluon version: </span><span class="si">{</span><span class="n">ag</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Загрузка с проверкой совместимости</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
            <span class="n">model_path</span><span class="p">,</span>
            <span class="n">require_version_match</span><span class="o">=</span><span class="kc">False</span>  <span class="c1"># Игнорировать несовпадение версий</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">predictor</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load model: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Попытка пересоздания модели</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attempting to recreate model...&quot;</span><span class="p">)</span>
        <span class="c1"># Здесь должна быть логика пересоздания модели</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="c1"># Использование</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">fix_model_loading_issues</span><span class="p">(</span><span class="s1">&#39;./models&#39;</span><span class="p">)</span>
</code></pre></div>

<h3 id="2-api">2. Ошибки API</h3>
<h4 id="api_1">Проблема: Ошибки в API</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Диагностика API</span>
<span class="k">def</span><span class="w"> </span><span class="nf">diagnose_api_issues</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">test_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Диагностика проблем API&quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Health check</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/health&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Health check failed: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Тест предсказания</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/predict&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">test_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Prediction failed: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;API working correctly&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;API error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

<span class="c1"># Использование</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">diagnose_api_issues</span><span class="p">(</span><span class="s2">&quot;http://localhost:8000&quot;</span><span class="p">,</span> <span class="n">test_data</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;API issues detected&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>Решение:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Исправление проблем API</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fix_api_issues</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">test_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Исправление проблем API&quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Проверка доступности API</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/health&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">health_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;API status: </span><span class="si">{</span><span class="n">health_data</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Проверка загруженных моделей</span>
            <span class="k">if</span> <span class="s1">&#39;loaded_models&#39;</span> <span class="ow">in</span> <span class="n">health_data</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded models: </span><span class="si">{</span><span class="n">health_data</span><span class="p">[</span><span class="s1">&#39;loaded_models&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;API not healthy: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;API timeout - server may be overloaded&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;API connection error - server may be down&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;API error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

<span class="c1"># Использование</span>
<span class="k">if</span> <span class="n">fix_api_issues</span><span class="p">(</span><span class="s2">&quot;http://localhost:8000&quot;</span><span class="p">,</span> <span class="n">test_data</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;API issues resolved&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;API issues persist&quot;</span><span class="p">)</span>
</code></pre></div>

<h2 id="_245">Полезные инструменты диагностики</h2>
<h3 id="1_16">1. Система мониторинга</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AutoGluonMonitor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Мониторинг AutoGluon системы&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_system_health</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Проверка здоровья системы&quot;&quot;&quot;</span>

        <span class="c1"># Проверка памяти</span>
        <span class="n">memory</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">memory</span><span class="o">.</span><span class="n">percent</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;High memory usage&quot;</span><span class="p">)</span>

        <span class="c1"># Проверка CPU</span>
        <span class="n">cpu</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_percent</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cpu</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;High CPU usage&quot;</span><span class="p">)</span>

        <span class="c1"># Проверка диска</span>
        <span class="n">disk</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">disk_usage</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">disk</span><span class="o">.</span><span class="n">percent</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;High disk usage&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_model_performance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictor</span><span class="p">,</span> <span class="n">test_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Проверка производительности модели&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Тест предсказания</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
            <span class="n">prediction_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

            <span class="c1"># Проверка времени</span>
            <span class="k">if</span> <span class="n">prediction_time</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># 10 секунд для 100 образцов</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Slow prediction performance&quot;</span><span class="p">)</span>

            <span class="c1"># Проверка качества</span>
            <span class="n">performance</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">performance</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Low model accuracy&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model performance error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Генерация отчета&quot;&quot;&quot;</span>

        <span class="n">report</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;system_health&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_system_health</span><span class="p">(),</span>
            <span class="s1">&#39;alerts&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="p">,</span>
            <span class="s1">&#39;metrics&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">report</span>

<span class="c1"># Использование</span>
<span class="n">monitor</span> <span class="o">=</span> <span class="n">AutoGluonMonitor</span><span class="p">()</span>
<span class="n">report</span> <span class="o">=</span> <span class="n">monitor</span><span class="o">.</span><span class="n">generate_report</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Monitoring report:&quot;</span><span class="p">,</span> <span class="n">report</span><span class="p">)</span>
</code></pre></div>

<h3 id="2_14">2. Система логирования</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AutoGluonLogger</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Система логирования для AutoGluon&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_file</span><span class="o">=</span><span class="s1">&#39;autogluon.log&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span> <span class="o">=</span> <span class="n">log_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">setup_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Настройка логирования&quot;&quot;&quot;</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
            <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">handlers</span><span class="o">=</span><span class="p">[</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">),</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_training_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_info</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Логирование начала обучения&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training started: </span><span class="si">{</span><span class="n">data_info</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_training_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Логирование завершения обучения&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training completed: </span><span class="si">{</span><span class="n">results</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">processing_time</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Логирование предсказания&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Prediction: input=</span><span class="si">{</span><span class="n">input_data</span><span class="si">}</span><span class="s2">, prediction=</span><span class="si">{</span><span class="n">prediction</span><span class="si">}</span><span class="s2">, time=</span><span class="si">{</span><span class="n">processing_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Логирование ошибок&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">, context: </span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Использование</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">AutoGluonLogger</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">log_training_start</span><span class="p">({</span><span class="s1">&#39;data_size&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">)})</span>
</code></pre></div>

<h2 id="_246">Следующие шаги</h2>
<p>После решения проблем переходите к:<br />
- <a href="./08_best_practices.md">Лучшим практикам</a><br />
- <a href="./09_examples.md">Примерам использования</a></p>
<hr />
<h1 id="automl-gluon-apple-silicon-m1m2m3">Оптимизация AutoML Gluon для Apple Silicon (M1/M2/M3)</h1>
<p><strong>Автор:</strong> Shcherbyna Rostyslav<br />
<strong>Дата:</strong> 2024  </p>
<h2 id="apple-silicon">Почему оптимизация для Apple Silicon критически важна</h2>
<p><strong>Почему Apple Silicon - это революция в машинном обучении?</strong> Потому что эти чипы специально разработаны для ML-задач, обеспечивая в 3-5 раз лучшую производительность при меньшем энергопотреблении.</p>
<h3 id="apple-silicon-ml">Преимущества Apple Silicon для ML</h3>
<ul>
<li><strong>Унифицированная память</strong>: CPU и GPU используют общую память (до 128GB)</li>
<li><strong>Высокая энергоэффективность</strong>: В 2-3 раза меньше потребление энергии</li>
<li><strong>Специализированные ядра</strong>: Neural Engine для ML-операций</li>
<li><strong>Metal Performance Shaders</strong>: GPU ускорение для матричных операций</li>
</ul>
<h3 id="_247">Проблемы без оптимизации</h3>
<ul>
<li><strong>Медленная работа</strong>: В 3-5 раз медленнее, чем могло бы быть</li>
<li><strong>Высокое энергопотребление</strong>: Батарея разряжается за часы</li>
<li><strong>Перегрев</strong>: Система тормозит из-за теплового дросселирования</li>
<li><strong>Неэффективное использование ресурсов</strong>: Только CPU, игнорирование GPU</li>
</ul>
<h2 id="apple-silicon_1">Введение в оптимизацию для Apple Silicon</h2>
<p><img alt="Оптимизация для Apple Silicon" src="images/apple_silicon_optimization.png" /><br />
<em>Рисунок 9: Оптимизация AutoML Gluon для Apple Silicon</em></p>
<p><strong>Почему Apple Silicon требует специального подхода?</strong> Потому что это архитектура ARM, а не x86, и требует специальных оптимизаций для максимальной производительности.</p>
<p>Apple Silicon MacBook с чипами M1, M2, M3 предоставляют уникальные возможности для ускорения машинного обучения через:<br />
- <strong>MLX</strong> - фреймворк Apple для машинного обучения на Apple Silicon<br />
- <strong>Ray</strong> - распределенные вычисления с поддержкой Apple Silicon<br />
- <strong>OpenMP</strong> - параллельные вычисления<br />
- <strong>Metal Performance Shaders (MPS)</strong> - GPU ускорение</p>
<h2 id="apple-silicon_2">Установка для Apple Silicon</h2>
<p><strong>Почему установка для Apple Silicon требует особого внимания?</strong> Потому что большинство пакетов по умолчанию собираются для x86, что приводит к медленной работе через эмуляцию Rosetta.</p>
<h3 id="1_17">1. Базовая установка с оптимизацией</h3>
<p><strong>Почему conda лучше pip для Apple Silicon?</strong> Потому что conda предоставляет нативные ARM64 пакеты, которые работают в 2-3 раза быстрее.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Создание conda окружения с поддержкой Apple Silicon</span>
conda<span class="w"> </span>create<span class="w"> </span>-n<span class="w"> </span>autogluon-m1<span class="w"> </span><span class="nv">python</span><span class="o">=</span><span class="m">3</span>.9
conda<span class="w"> </span>activate<span class="w"> </span>autogluon-m1

<span class="c1"># Установка базовых зависимостей - нативные ARM64 версии</span>
conda<span class="w"> </span>install<span class="w"> </span>-c<span class="w"> </span>conda-forge<span class="w"> </span>numpy<span class="w"> </span>pandas<span class="w"> </span>scikit-learn<span class="w"> </span>matplotlib<span class="w"> </span>seaborn

<span class="c1"># Установка PyTorch с поддержкой MPS (Metal Performance Shaders)</span>
pip<span class="w"> </span>install<span class="w"> </span>torch<span class="w"> </span>torchvision<span class="w"> </span>torchaudio

<span class="c1"># Установка AutoGluon</span>
pip<span class="w"> </span>install<span class="w"> </span>autogluon
</code></pre></div>

<h3 id="2-mlx-apple-silicon">2. Установка MLX для Apple Silicon</h3>
<p><strong>Почему MLX - это будущее ML на Apple Silicon?</strong> Потому что это единственный фреймворк, специально разработанный Apple для их чипов, обеспечивающий максимальную производительность.</p>
<p><strong>Преимущества MLX:</strong><br />
- <strong>Нативная поддержка</strong>: Специально для Apple Silicon<br />
- <strong>Высокая производительность</strong>: В 2-3 раза быстрее PyTorch<br />
- <strong>Энергоэффективность</strong>: Меньше потребление энергии<br />
- <strong>Простота использования</strong>: API похож на NumPy</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Установка MLX - фреймворк Apple для ML</span>
pip<span class="w"> </span>install<span class="w"> </span>mlx<span class="w"> </span>mlx-lm

<span class="c1"># Установка дополнительных MLX пакетов - оптимизаторы и нейросети</span>
pip<span class="w"> </span>install<span class="w"> </span>mlx-optimizers<span class="w"> </span>mlx-nn
</code></pre></div>

<h3 id="3-ray-apple-silicon">3. Установка Ray для Apple Silicon</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Установка Ray с поддержкой Apple Silicon</span>
pip<span class="w"> </span>install<span class="w"> </span>ray<span class="o">[</span>default<span class="o">]</span>

<span class="c1"># Проверка поддержки Apple Silicon</span>
python<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;import ray; print(ray.__version__)&quot;</span>
</code></pre></div>

<h3 id="4-openmp">4. Настройка OpenMP</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Установка OpenMP для macOS</span>
brew<span class="w"> </span>install<span class="w"> </span>libomp

<span class="c1"># Установка Python биндингов</span>
pip<span class="w"> </span>install<span class="w"> </span>openmp-python
</code></pre></div>

<h2 id="apple-silicon_3">Конфигурация для Apple Silicon</h2>
<h3 id="1-cuda-mps">1. Отключение CUDA и настройка MPS</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># Отключение CUDA</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CUDA_VISIBLE_DEVICES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CUDA_DEVICE_ORDER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;PCI_BUS_ID&#39;</span>

<span class="c1"># Включение MPS (Metal Performance Shaders) для Apple Silicon</span>
<span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">mps</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PYTORCH_ENABLE_MPS_FALLBACK&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MPS (Metal Performance Shaders) доступен&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MPS недоступен&quot;</span><span class="p">)</span>

<span class="c1"># Настройка OpenMP для Apple Silicon</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OMP_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">get_num_threads</span><span class="p">())</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MKL_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">get_num_threads</span><span class="p">())</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OPENBLAS_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">get_num_threads</span><span class="p">())</span>

<span class="c1"># Проверка доступных устройств</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PyTorch version: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MPS available: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">mps</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MPS built: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">mps</span><span class="o">.</span><span class="n">is_built</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CPU threads: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">get_num_threads</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="2-autogluon-apple-silicon">2. Настройка AutoGluon для Apple Silicon</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.tabular</span><span class="w"> </span><span class="kn">import</span> <span class="n">TabularPredictor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">autogluon</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ag</span>

<span class="c1"># Конфигурация для Apple Silicon</span>
<span class="k">def</span><span class="w"> </span><span class="nf">configure_apple_silicon</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Настройка AutoGluon для Apple Silicon&quot;&quot;&quot;</span>

    <span class="c1"># Отключение CUDA</span>
    <span class="n">ag</span><span class="o">.</span><span class="n">set_config</span><span class="p">({</span>
        <span class="s1">&#39;num_gpus&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;num_cpus&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">get_num_threads</span><span class="p">(),</span>
        <span class="s1">&#39;memory_limit&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>  <span class="c1"># GB</span>
        <span class="s1">&#39;time_limit&#39;</span><span class="p">:</span> <span class="mi">3600</span>
    <span class="p">})</span>

    <span class="c1"># Настройка для MPS</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">mps</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Используется MPS ускорение&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Используется CPU&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ag</span>

<span class="c1"># Применение конфигурации</span>
<span class="n">configure_apple_silicon</span><span class="p">()</span>
</code></pre></div>

<h2 id="mlx">Интеграция с MLX</h2>
<h3 id="1-mlx-">1. Создание MLX-оптимизированных моделей</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">mlx.core</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">mlx.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.tabular</span><span class="w"> </span><span class="kn">import</span> <span class="n">TabularPredictor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MLXOptimizedPredictor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;MLX-оптимизированный предиктор для Apple Silicon&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span> <span class="o">=</span> <span class="n">model_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlx_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_mlx_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Загрузка модели в MLX&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Загрузка весов модели</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="si">}</span><span class="s2">/mlx_weights.npz&quot;</span><span class="p">)</span>

            <span class="c1"># Создание архитектуры модели</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlx_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_mlx_architecture</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MLX модель загружена успешно&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ошибка загрузки MLX модели: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_mlx_architecture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание архитектуры MLX модели&quot;&quot;&quot;</span>

        <span class="k">class</span><span class="w"> </span><span class="nc">MLXTabularModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
            <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="n">hidden_sizes</span><span class="p">,</span> <span class="n">output_size</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1"># Входной слой</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_size</span><span class="p">,</span> <span class="n">hidden_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

                <span class="c1"># Скрытые слои</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hidden_sizes</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">hidden_sizes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">())</span>

                <span class="c1"># Выходной слой</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_sizes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">output_size</span><span class="p">))</span>

            <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">x</span>

        <span class="k">return</span> <span class="n">MLXTabularModel</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict_mlx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Предсказание с использованием MLX&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlx_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;MLX модель не загружена&quot;</span><span class="p">)</span>

        <span class="c1"># Преобразование в MLX массив</span>
        <span class="n">mlx_data</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

        <span class="c1"># Предсказание</span>
        <span class="k">with</span> <span class="n">mx</span><span class="o">.</span><span class="n">eval</span><span class="p">():</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlx_model</span><span class="p">(</span><span class="n">mlx_data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>

<span class="c1"># Использование MLX предиктора</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_mlx_predictor</span><span class="p">(</span><span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Создание MLX предиктора&quot;&quot;&quot;</span>
    <span class="n">predictor</span> <span class="o">=</span> <span class="n">MLXOptimizedPredictor</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">predictor</span><span class="o">.</span><span class="n">load_mlx_model</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">predictor</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>

<h3 id="2-mlx">2. Оптимизация данных для MLX</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">optimize_data_for_mlx</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Оптимизация данных для MLX&quot;&quot;&quot;</span>

    <span class="c1"># Преобразование в numpy с правильным типом</span>
    <span class="n">data_array</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="c1"># Нормализация для MLX</span>
    <span class="n">data_array</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_array</span> <span class="o">-</span> <span class="n">data_array</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">data_array</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data_array</span>

<span class="c1"># Использование</span>
<span class="k">def</span><span class="w"> </span><span class="nf">train_with_mlx_optimization</span><span class="p">(</span><span class="n">train_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Обучение с MLX оптимизацией&quot;&quot;&quot;</span>

    <span class="c1"># Оптимизация данных</span>
    <span class="n">optimized_data</span> <span class="o">=</span> <span class="n">optimize_data_for_mlx</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>

    <span class="c1"># Создание предиктора</span>
    <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
        <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="s1">&#39;./mlx_models&#39;</span>
    <span class="p">)</span>

    <span class="c1"># Обучение с оптимизацией для Apple Silicon</span>
    <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">train_data</span><span class="p">,</span>
        <span class="n">ag_args_fit</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;num_cpus&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">get_num_threads</span><span class="p">(),</span>
            <span class="s1">&#39;num_gpus&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;memory_limit&#39;</span><span class="p">:</span> <span class="mi">8</span>
        <span class="p">},</span>
        <span class="n">time_limit</span><span class="o">=</span><span class="mi">3600</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">predictor</span>
</code></pre></div>

<h2 id="ray-apple-silicon">Настройка Ray для Apple Silicon</h2>
<h3 id="1-ray">1. Конфигурация Ray кластера</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">ray</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ray</span><span class="w"> </span><span class="kn">import</span> <span class="n">tune</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">autogluon</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ag</span>

<span class="k">def</span><span class="w"> </span><span class="nf">configure_ray_apple_silicon</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Настройка Ray для Apple Silicon&quot;&quot;&quot;</span>

    <span class="c1"># Инициализация Ray с настройками для Apple Silicon</span>
    <span class="n">ray</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
        <span class="n">num_cpus</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">get_num_threads</span><span class="p">(),</span>
        <span class="n">num_gpus</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># Отключение GPU для Apple Silicon</span>
        <span class="n">object_store_memory</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="c1"># 2GB</span>
        <span class="n">ignore_reinit_error</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ray кластер инициализирован: </span><span class="si">{</span><span class="n">ray</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Доступные ресурсы: </span><span class="si">{</span><span class="n">ray</span><span class="o">.</span><span class="n">cluster_resources</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ray</span>

<span class="c1"># Инициализация Ray</span>
<span class="n">ray_cluster</span> <span class="o">=</span> <span class="n">configure_ray_apple_silicon</span><span class="p">()</span>
</code></pre></div>

<h3 id="2-ray">2. Распределенное обучение с Ray</h3>
<div class="codehilite"><pre><span></span><code><span class="nd">@ray</span><span class="o">.</span><span class="n">remote</span>
<span class="k">def</span><span class="w"> </span><span class="nf">train_model_remote</span><span class="p">(</span><span class="n">data_chunk</span><span class="p">,</span> <span class="n">model_config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Удаленное обучение модели&quot;&quot;&quot;</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.tabular</span><span class="w"> </span><span class="kn">import</span> <span class="n">TabularPredictor</span>

    <span class="c1"># Создание предиктора</span>
    <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="n">model_config</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span>
        <span class="n">problem_type</span><span class="o">=</span><span class="n">model_config</span><span class="p">[</span><span class="s1">&#39;problem_type&#39;</span><span class="p">],</span>
        <span class="n">eval_metric</span><span class="o">=</span><span class="n">model_config</span><span class="p">[</span><span class="s1">&#39;eval_metric&#39;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Обучение на части данных</span>
    <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">data_chunk</span><span class="p">,</span>
        <span class="n">time_limit</span><span class="o">=</span><span class="n">model_config</span><span class="p">[</span><span class="s1">&#39;time_limit&#39;</span><span class="p">],</span>
        <span class="n">presets</span><span class="o">=</span><span class="n">model_config</span><span class="p">[</span><span class="s1">&#39;presets&#39;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">predictor</span>

<span class="k">def</span><span class="w"> </span><span class="nf">distributed_training_apple_silicon</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">n_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Распределенное обучение для Apple Silicon&quot;&quot;&quot;</span>

    <span class="c1"># Разделение данных на части</span>
    <span class="n">chunk_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">//</span> <span class="n">n_workers</span>
    <span class="n">data_chunks</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">chunk_size</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">)]</span>

    <span class="c1"># Конфигурация модели</span>
    <span class="n">model_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;target&#39;</span><span class="p">,</span>
        <span class="s1">&#39;problem_type&#39;</span><span class="p">:</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="s1">&#39;eval_metric&#39;</span><span class="p">:</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="s1">&#39;time_limit&#39;</span><span class="p">:</span> <span class="mi">1800</span><span class="p">,</span>
        <span class="s1">&#39;presets&#39;</span><span class="p">:</span> <span class="s1">&#39;medium_quality&#39;</span>
    <span class="p">}</span>

    <span class="c1"># Запуск удаленных задач</span>
    <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">data_chunks</span><span class="p">:</span>
        <span class="n">future</span> <span class="o">=</span> <span class="n">train_model_remote</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">model_config</span><span class="p">)</span>
        <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>

    <span class="c1"># Ожидание завершения</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span>

<span class="c1"># Использование распределенного обучения</span>
<span class="k">def</span><span class="w"> </span><span class="nf">run_distributed_training</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Запуск распределенного обучения&quot;&quot;&quot;</span>

    <span class="c1"># Настройка Ray</span>
    <span class="n">configure_ray_apple_silicon</span><span class="p">()</span>

    <span class="c1"># Запуск распределенного обучения</span>
    <span class="n">models</span> <span class="o">=</span> <span class="n">distributed_training_apple_silicon</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">n_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Обучено </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span><span class="si">}</span><span class="s2"> моделей&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">models</span>
</code></pre></div>

<h2 id="openmp">Оптимизация OpenMP</h2>
<h3 id="1-openmp-apple-silicon">1. Настройка OpenMP для Apple Silicon</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">multiprocessing</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mp</span>

<span class="k">def</span><span class="w"> </span><span class="nf">configure_openmp_apple_silicon</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Настройка OpenMP для Apple Silicon&quot;&quot;&quot;</span>

    <span class="c1"># Получение количества ядер</span>
    <span class="n">num_cores</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Доступно ядер: </span><span class="si">{</span><span class="n">num_cores</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Настройка переменных окружения</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OMP_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_cores</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MKL_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_cores</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OPENBLAS_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_cores</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;VECLIB_MAXIMUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_cores</span><span class="p">)</span>

    <span class="c1"># Настройка для Apple Silicon</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OMP_SCHEDULE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;dynamic&#39;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OMP_DYNAMIC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;TRUE&#39;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OMP_NESTED&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;TRUE&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OpenMP настроен для Apple Silicon&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">num_cores</span>

<span class="c1"># Применение настроек</span>
<span class="n">num_cores</span> <span class="o">=</span> <span class="n">configure_openmp_apple_silicon</span><span class="p">()</span>
</code></pre></div>

<h3 id="2_15">2. Параллельная обработка данных</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span><span class="p">,</span> <span class="n">ProcessPoolExecutor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parallel_data_processing</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">n_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Параллельная обработка данных для Apple Silicon&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">n_workers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_workers</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_chunk</span><span class="p">(</span><span class="n">chunk</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Обработка части данных&quot;&quot;&quot;</span>
        <span class="c1"># Нормализация</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">chunk</span><span class="o">.</span><span class="n">median</span><span class="p">())</span>

        <span class="c1"># Создание новых признаков</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;feature_sum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;feature_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">chunk</span>

    <span class="c1"># Разделение данных на части</span>
    <span class="n">chunk_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">//</span> <span class="n">n_workers</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">chunk_size</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">)]</span>

    <span class="c1"># Параллельная обработка</span>
    <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">n_workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="n">processed_chunks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">process_chunk</span><span class="p">,</span> <span class="n">chunks</span><span class="p">))</span>

    <span class="c1"># Объединение результатов</span>
    <span class="n">processed_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">processed_chunks</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">processed_data</span>

<span class="c1"># Использование параллельной обработки</span>
<span class="k">def</span><span class="w"> </span><span class="nf">optimize_data_processing</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Оптимизация обработки данных&quot;&quot;&quot;</span>

    <span class="c1"># Настройка OpenMP</span>
    <span class="n">configure_openmp_apple_silicon</span><span class="p">()</span>

    <span class="c1"># Параллельная обработка</span>
    <span class="n">processed_data</span> <span class="o">=</span> <span class="n">parallel_data_processing</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">processed_data</span>
</code></pre></div>

<h2 id="apple-silicon_4">Полная оптимизация для Apple Silicon</h2>
<h3 id="1_18">1. Комплексная настройка системы</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AppleSiliconOptimizer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Оптимизатор для Apple Silicon&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_cores</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mps_available</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">mps</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ray_initialized</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">configure_system</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Комплексная настройка системы&quot;&quot;&quot;</span>

        <span class="c1"># Отключение CUDA</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CUDA_VISIBLE_DEVICES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># Настройка OpenMP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configure_openmp</span><span class="p">()</span>

        <span class="c1"># Настройка PyTorch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configure_pytorch</span><span class="p">()</span>

        <span class="c1"># Настройка AutoGluon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configure_autogluon</span><span class="p">()</span>

        <span class="c1"># Настройка Ray</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configure_ray</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Система оптимизирована для Apple Silicon&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">configure_openmp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Настройка OpenMP&quot;&quot;&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OMP_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cores</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MKL_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cores</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OPENBLAS_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cores</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;VECLIB_MAXIMUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cores</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">configure_pytorch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Настройка PyTorch&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mps_available</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PYTORCH_ENABLE_MPS_FALLBACK&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MPS ускорение включено&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MPS недоступен, используется CPU&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">configure_autogluon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Настройка AutoGluon&quot;&quot;&quot;</span>
        <span class="n">ag</span><span class="o">.</span><span class="n">set_config</span><span class="p">({</span>
            <span class="s1">&#39;num_cpus&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cores</span><span class="p">,</span>
            <span class="s1">&#39;num_gpus&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;memory_limit&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
            <span class="s1">&#39;time_limit&#39;</span><span class="p">:</span> <span class="mi">3600</span>
        <span class="p">})</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">configure_ray</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Настройка Ray&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ray</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
                <span class="n">num_cpus</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cores</span><span class="p">,</span>
                <span class="n">num_gpus</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">object_store_memory</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
                <span class="n">ignore_reinit_error</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ray_initialized</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ray кластер инициализирован&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ошибка инициализации Ray: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_optimal_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Получение оптимальной конфигурации&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">data_size</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;presets&#39;</span><span class="p">:</span> <span class="s1">&#39;optimize_for_deployment&#39;</span><span class="p">,</span>
                <span class="s1">&#39;num_bag_folds&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                <span class="s1">&#39;num_bag_sets&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;time_limit&#39;</span><span class="p">:</span> <span class="mi">600</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="n">data_size</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;presets&#39;</span><span class="p">:</span> <span class="s1">&#39;medium_quality&#39;</span><span class="p">,</span>
                <span class="s1">&#39;num_bag_folds&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                <span class="s1">&#39;num_bag_sets&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;time_limit&#39;</span><span class="p">:</span> <span class="mi">1800</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;presets&#39;</span><span class="p">:</span> <span class="s1">&#39;high_quality&#39;</span><span class="p">,</span>
                <span class="s1">&#39;num_bag_folds&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                <span class="s1">&#39;num_bag_sets&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s1">&#39;time_limit&#39;</span><span class="p">:</span> <span class="mi">3600</span>
            <span class="p">}</span>

<span class="c1"># Использование оптимизатора</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">AppleSiliconOptimizer</span><span class="p">()</span>
<span class="n">optimizer</span><span class="o">.</span><span class="n">configure_system</span><span class="p">()</span>
</code></pre></div>

<h3 id="2_16">2. Оптимизированное обучение</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">train_optimized_apple_silicon</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">target_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Оптимизированное обучение для Apple Silicon&quot;&quot;&quot;</span>

    <span class="c1"># Настройка системы</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">AppleSiliconOptimizer</span><span class="p">()</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">configure_system</span><span class="p">()</span>

    <span class="c1"># Получение оптимальной конфигурации</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">get_optimal_config</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

    <span class="c1"># Создание предиктора</span>
    <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="n">target_col</span><span class="p">,</span>
        <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="s1">&#39;./apple_silicon_models&#39;</span>
    <span class="p">)</span>

    <span class="c1"># Оптимизация данных</span>
    <span class="n">optimized_data</span> <span class="o">=</span> <span class="n">optimize_data_for_mlx</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Обучение с оптимизацией</span>
    <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">presets</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;presets&#39;</span><span class="p">],</span>
        <span class="n">num_bag_folds</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_bag_folds&#39;</span><span class="p">],</span>
        <span class="n">num_bag_sets</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_bag_sets&#39;</span><span class="p">],</span>
        <span class="n">time_limit</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;time_limit&#39;</span><span class="p">],</span>
        <span class="n">ag_args_fit</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;num_cpus&#39;</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">num_cores</span><span class="p">,</span>
            <span class="s1">&#39;num_gpus&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;memory_limit&#39;</span><span class="p">:</span> <span class="mi">8</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">predictor</span>

<span class="c1"># Использование</span>
<span class="k">def</span><span class="w"> </span><span class="nf">run_optimized_training</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Запуск оптимизированного обучения&quot;&quot;&quot;</span>

    <span class="c1"># Создание тестовых данных</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_classification</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_classification</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">n_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;feature_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)])</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>

    <span class="c1"># Оптимизированное обучение</span>
    <span class="n">predictor</span> <span class="o">=</span> <span class="n">train_optimized_apple_silicon</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">)</span>

    <span class="c1"># Тестирование</span>
    <span class="n">test_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Обучение завершено, предсказания: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">predictor</span>

<span class="c1"># Запуск</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">predictor</span> <span class="o">=</span> <span class="n">run_optimized_training</span><span class="p">()</span>
</code></pre></div>

<h2 id="_248">Мониторинг производительности</h2>
<h3 id="1-apple-silicon">1. Система мониторинга для Apple Silicon</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">psutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AppleSiliconMonitor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Мониторинг производительности для Apple Silicon&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_system_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Получение системных метрик&quot;&quot;&quot;</span>

        <span class="c1"># CPU метрики</span>
        <span class="n">cpu_percent</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_percent</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">cpu_freq</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_freq</span><span class="p">()</span>

        <span class="c1"># Память</span>
        <span class="n">memory</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span>

        <span class="c1"># Диск</span>
        <span class="n">disk</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">disk_usage</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>

        <span class="c1"># Температура (если доступна)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">temps</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">sensors_temperatures</span><span class="p">()</span>
            <span class="n">cpu_temp</span> <span class="o">=</span> <span class="n">temps</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cpu_thermal&#39;</span><span class="p">,</span> <span class="p">[{}])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">cpu_temp</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;cpu_percent&#39;</span><span class="p">:</span> <span class="n">cpu_percent</span><span class="p">,</span>
            <span class="s1">&#39;cpu_freq&#39;</span><span class="p">:</span> <span class="n">cpu_freq</span><span class="o">.</span><span class="n">current</span> <span class="k">if</span> <span class="n">cpu_freq</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;memory_percent&#39;</span><span class="p">:</span> <span class="n">memory</span><span class="o">.</span><span class="n">percent</span><span class="p">,</span>
            <span class="s1">&#39;memory_available&#39;</span><span class="p">:</span> <span class="n">memory</span><span class="o">.</span><span class="n">available</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">),</span>  <span class="c1"># GB</span>
            <span class="s1">&#39;disk_percent&#39;</span><span class="p">:</span> <span class="n">disk</span><span class="o">.</span><span class="n">percent</span><span class="p">,</span>
            <span class="s1">&#39;cpu_temp&#39;</span><span class="p">:</span> <span class="n">cpu_temp</span><span class="p">,</span>
            <span class="s1">&#39;elapsed_time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">monitor_training</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictor</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Мониторинг обучения&quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Начало мониторинга обучения...&quot;</span><span class="p">)</span>

        <span class="c1"># Начальные метрики</span>
        <span class="n">initial_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_system_metrics</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">initial_metrics</span><span class="p">)</span>

        <span class="c1"># Обучение с мониторингом</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
        <span class="n">training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

        <span class="c1"># Финальные метрики</span>
        <span class="n">final_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_system_metrics</span><span class="p">()</span>
        <span class="n">final_metrics</span><span class="p">[</span><span class="s1">&#39;training_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">training_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">final_metrics</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Обучение завершено за </span><span class="si">{</span><span class="n">training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> секунд&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">final_metrics</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Генерация отчета о производительности&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Нет данных для отчета&quot;</span>

        <span class="c1"># Анализ метрик</span>
        <span class="n">cpu_usage</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;cpu_percent&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">]</span>
        <span class="n">memory_usage</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;memory_percent&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">]</span>

        <span class="n">report</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;total_time&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;elapsed_time&#39;</span><span class="p">],</span>
            <span class="s1">&#39;training_time&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;training_time&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;avg_cpu_usage&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">cpu_usage</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">cpu_usage</span><span class="p">),</span>
            <span class="s1">&#39;max_cpu_usage&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">cpu_usage</span><span class="p">),</span>
            <span class="s1">&#39;avg_memory_usage&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">memory_usage</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">memory_usage</span><span class="p">),</span>
            <span class="s1">&#39;max_memory_usage&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">memory_usage</span><span class="p">),</span>
            <span class="s1">&#39;cpu_temp&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;cpu_temp&#39;</span><span class="p">]</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">report</span>

<span class="c1"># Использование мониторинга</span>
<span class="k">def</span><span class="w"> </span><span class="nf">run_with_monitoring</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Запуск с мониторингом&quot;&quot;&quot;</span>

    <span class="c1"># Создание монитора</span>
    <span class="n">monitor</span> <span class="o">=</span> <span class="n">AppleSiliconMonitor</span><span class="p">()</span>

    <span class="c1"># Создание данных</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_classification</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_classification</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">n_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;feature_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)])</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>

    <span class="c1"># Создание предиктора</span>
    <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
        <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span>
        <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span>
    <span class="p">)</span>

    <span class="c1"># Обучение с мониторингом</span>
    <span class="n">final_metrics</span> <span class="o">=</span> <span class="n">monitor</span><span class="o">.</span><span class="n">monitor_training</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="c1"># Генерация отчета</span>
    <span class="n">report</span> <span class="o">=</span> <span class="n">monitor</span><span class="o">.</span><span class="n">generate_report</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Отчет о производительности:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">report</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">predictor</span><span class="p">,</span> <span class="n">report</span>
</code></pre></div>

<h2 id="_249">Примеры использования</h2>
<h3 id="1_19">1. Полный пример оптимизации</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">complete_apple_silicon_example</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Полный пример оптимизации для Apple Silicon&quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Оптимизация AutoML Gluon для Apple Silicon ===&quot;</span><span class="p">)</span>

    <span class="c1"># 1. Настройка системы</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">AppleSiliconOptimizer</span><span class="p">()</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">configure_system</span><span class="p">()</span>

    <span class="c1"># 2. Создание данных</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_classification</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_classification</span><span class="p">(</span>
        <span class="n">n_samples</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
        <span class="n">n_features</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
        <span class="n">n_informative</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
        <span class="n">n_redundant</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">n_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
    <span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;feature_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">)])</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Создан датасет: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 3. Оптимизация данных</span>
    <span class="n">optimized_data</span> <span class="o">=</span> <span class="n">optimize_data_for_mlx</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Данные оптимизированы для MLX&quot;</span><span class="p">)</span>

    <span class="c1"># 4. Обучение с мониторингом</span>
    <span class="n">monitor</span> <span class="o">=</span> <span class="n">AppleSiliconMonitor</span><span class="p">()</span>

    <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
        <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span>
        <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="s1">&#39;./apple_silicon_optimized&#39;</span>
    <span class="p">)</span>

    <span class="c1"># Обучение</span>
    <span class="n">final_metrics</span> <span class="o">=</span> <span class="n">monitor</span><span class="o">.</span><span class="n">monitor_training</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="c1"># 5. Тестирование</span>
    <span class="n">test_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

    <span class="c1"># 6. Оценка качества</span>
    <span class="n">performance</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Результаты:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Производительность: </span><span class="si">{</span><span class="n">performance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Время обучения: </span><span class="si">{</span><span class="n">final_metrics</span><span class="p">[</span><span class="s1">&#39;training_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> секунд&quot;</span><span class="p">)</span>

    <span class="c1"># 7. Отчет о производительности</span>
    <span class="n">report</span> <span class="o">=</span> <span class="n">monitor</span><span class="o">.</span><span class="n">generate_report</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Отчет о производительности:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">report</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">predictor</span><span class="p">,</span> <span class="n">report</span>

<span class="c1"># Запуск полного примера</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">predictor</span><span class="p">,</span> <span class="n">report</span> <span class="o">=</span> <span class="n">complete_apple_silicon_example</span><span class="p">()</span>
</code></pre></div>

<h3 id="2_17">2. Сравнение производительности</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compare_performance</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Сравнение производительности с оптимизацией и без&quot;&quot;&quot;</span>

    <span class="c1"># Создание данных</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_classification</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_classification</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">n_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;feature_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)])</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>

    <span class="c1"># Тест без оптимизации</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Тест без оптимизации ===&quot;</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">predictor_basic</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
        <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span>
        <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span>
    <span class="p">)</span>

    <span class="n">predictor_basic</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>
    <span class="n">basic_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

    <span class="c1"># Тест с оптимизацией</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Тест с оптимизацией ===&quot;</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">AppleSiliconOptimizer</span><span class="p">()</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">configure_system</span><span class="p">()</span>

    <span class="n">predictor_optimized</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
        <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span>
        <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span>
    <span class="p">)</span>

    <span class="n">predictor_optimized</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">time_limit</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span>
        <span class="n">ag_args_fit</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;num_cpus&#39;</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">num_cores</span><span class="p">,</span>
            <span class="s1">&#39;num_gpus&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;memory_limit&#39;</span><span class="p">:</span> <span class="mi">8</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">optimized_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

    <span class="c1"># Сравнение результатов</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Время без оптимизации: </span><span class="si">{</span><span class="n">basic_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> секунд&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Время с оптимизацией: </span><span class="si">{</span><span class="n">optimized_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> секунд&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ускорение: </span><span class="si">{</span><span class="n">basic_time</span><span class="o">/</span><span class="n">optimized_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">x&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;basic_time&#39;</span><span class="p">:</span> <span class="n">basic_time</span><span class="p">,</span>
        <span class="s1">&#39;optimized_time&#39;</span><span class="p">:</span> <span class="n">optimized_time</span><span class="p">,</span>
        <span class="s1">&#39;speedup&#39;</span><span class="p">:</span> <span class="n">basic_time</span><span class="o">/</span><span class="n">optimized_time</span>
    <span class="p">}</span>

<span class="c1"># Запуск сравнения</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">compare_performance</span><span class="p">()</span>
</code></pre></div>

<h2 id="troubleshooting-apple-silicon">Troubleshooting для Apple Silicon</h2>
<h3 id="1_20">1. Типичные проблемы и решения</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">troubleshoot_apple_silicon</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Решение типичных проблем для Apple Silicon&quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Troubleshooting для Apple Silicon ===&quot;</span><span class="p">)</span>

    <span class="c1"># Проверка доступности MPS</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">mps</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✓ MPS доступен&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✗ MPS недоступен - используйте CPU&quot;</span><span class="p">)</span>

    <span class="c1"># Проверка Ray</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ray</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">ignore_reinit_error</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✓ Ray инициализирован&quot;</span><span class="p">)</span>
        <span class="n">ray</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✗ Ошибка Ray: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Проверка OpenMP</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
    <span class="k">if</span> <span class="s1">&#39;OMP_NUM_THREADS&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✓ OpenMP настроен: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OMP_NUM_THREADS&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> потоков&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✗ OpenMP не настроен&quot;</span><span class="p">)</span>

    <span class="c1"># Проверка памяти</span>
    <span class="n">memory</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Память: </span><span class="si">{</span><span class="n">memory</span><span class="o">.</span><span class="n">percent</span><span class="si">}</span><span class="s2">% использовано, </span><span class="si">{</span><span class="n">memory</span><span class="o">.</span><span class="n">available</span><span class="o">/</span><span class="p">(</span><span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">GB доступно&quot;</span><span class="p">)</span>

    <span class="c1"># Проверка CPU</span>
    <span class="n">cpu_count</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CPU ядер: </span><span class="si">{</span><span class="n">cpu_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Запуск диагностики</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">troubleshoot_apple_silicon</span><span class="p">()</span>
</code></pre></div>

<h3 id="2_18">2. Оптимизация для разных размеров данных</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_optimal_config_apple_silicon</span><span class="p">(</span><span class="n">data_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">data_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;tabular&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Получение оптимальной конфигурации для Apple Silicon&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">data_size</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;presets&#39;</span><span class="p">:</span> <span class="s1">&#39;optimize_for_deployment&#39;</span><span class="p">,</span>
            <span class="s1">&#39;num_bag_folds&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">&#39;num_bag_sets&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;time_limit&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
            <span class="s1">&#39;ag_args_fit&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;num_cpus&#39;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()),</span>
                <span class="s1">&#39;num_gpus&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;memory_limit&#39;</span><span class="p">:</span> <span class="mi">4</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="k">elif</span> <span class="n">data_size</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;presets&#39;</span><span class="p">:</span> <span class="s1">&#39;medium_quality&#39;</span><span class="p">,</span>
            <span class="s1">&#39;num_bag_folds&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s1">&#39;num_bag_sets&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;time_limit&#39;</span><span class="p">:</span> <span class="mi">1800</span><span class="p">,</span>
            <span class="s1">&#39;ag_args_fit&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;num_cpus&#39;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()),</span>
                <span class="s1">&#39;num_gpus&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;memory_limit&#39;</span><span class="p">:</span> <span class="mi">8</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;presets&#39;</span><span class="p">:</span> <span class="s1">&#39;high_quality&#39;</span><span class="p">,</span>
            <span class="s1">&#39;num_bag_folds&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s1">&#39;num_bag_sets&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;time_limit&#39;</span><span class="p">:</span> <span class="mi">3600</span><span class="p">,</span>
            <span class="s1">&#39;ag_args_fit&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;num_cpus&#39;</span><span class="p">:</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">(),</span>
                <span class="s1">&#39;num_gpus&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;memory_limit&#39;</span><span class="p">:</span> <span class="mi">16</span>
            <span class="p">}</span>
        <span class="p">}</span>

<span class="c1"># Использование</span>
<span class="k">def</span><span class="w"> </span><span class="nf">train_with_optimal_config</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">target_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Обучение с оптимальной конфигурацией&quot;&quot;&quot;</span>

    <span class="c1"># Получение конфигурации</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">get_optimal_config_apple_silicon</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

    <span class="c1"># Создание предиктора</span>
    <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="n">target_col</span><span class="p">,</span>
        <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span>
    <span class="p">)</span>

    <span class="c1"># Обучение с оптимальной конфигурацией</span>
    <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">presets</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;presets&#39;</span><span class="p">],</span>
        <span class="n">num_bag_folds</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_bag_folds&#39;</span><span class="p">],</span>
        <span class="n">num_bag_sets</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_bag_sets&#39;</span><span class="p">],</span>
        <span class="n">time_limit</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;time_limit&#39;</span><span class="p">],</span>
        <span class="n">ag_args_fit</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ag_args_fit&#39;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">predictor</span>
</code></pre></div>

<h2 id="_250">Заключение</h2>
<p>Этот раздел предоставляет полную оптимизацию AutoML Gluon для Apple Silicon MacBook M1/M2/M3, включая:</p>
<ul>
<li><strong>MLX интеграцию</strong> для ускорения вычислений</li>
<li><strong>Ray настройку</strong> для распределенных вычислений</li>
<li><strong>OpenMP оптимизацию</strong> для параллельных вычислений</li>
<li><strong>Отключение CUDA</strong> и настройку MPS</li>
<li><strong>Мониторинг производительности</strong> для Apple Silicon</li>
<li><strong>Troubleshooting</strong> типичных проблем</li>
</ul>
<p>Все настройки оптимизированы для максимальной производительности на Apple Silicon с учетом особенностей архитектуры M1/M2/M3 чипов.</p>
<hr />
<h1 id="_251">Простой пример: От идеи до продакшен деплоя</h1>
<p><strong>Автор:</strong> Shcherbyna Rostyslav<br />
<strong>Дата:</strong> 2024  </p>
<h2 id="_252">Почему простой пример критически важен</h2>
<p><strong>Почему 90% ML-проектов не доходят до продакшена?</strong> Потому что команды усложняют процесс, пытаясь решить все проблемы сразу. Простой пример показывает, как сделать работающую систему за минимальное время.</p>
<h3 id="_253">Проблемы сложных подходов</h3>
<ul>
<li><strong>Переусложнение</strong>: Попытка решить все проблемы сразу</li>
<li><strong>Долгая разработка</strong>: Месяцы на планирование, дни на реализацию</li>
<li><strong>Технический долг</strong>: Сложная архитектура, которую сложно поддерживать</li>
<li><strong>Разочарование</strong>: Команда теряет мотивацию из-за сложности</li>
</ul>
<h3 id="_254">Преимущества простого подхода</h3>
<ul>
<li><strong>Быстрый результат</strong>: Работающая система за дни, а не месяцы</li>
<li><strong>Понятность</strong>: Каждый шаг логичен и объясним</li>
<li><strong>Итеративность</strong>: Можно улучшать постепенно</li>
<li><strong>Мотивация</strong>: Видимый прогресс вдохновляет команду</li>
</ul>
<h2 id="_255">Введение</h2>
<p><img alt="Простой пример продакшена" src="images/simple_production_flow.png" /><br />
<em>Рисунок 12.1: Простой пример создания робастной ML-модели от идеи до продакшена</em></p>
<p><strong>Почему начинаем с простого примера?</strong> Потому что он показывает весь цикл разработки ML-системы от начала до конца, не отвлекаясь на сложные детали.</p>
<p>Этот раздел показывает <strong>самый простой путь</strong> создания робастной прибыльной ML-модели с использованием AutoML Gluon - от первоначальной идеи до полного продакшен деплоя на DEX blockchain.</p>
<h2 id="1_21">Шаг 1: Определение задачи</h2>
<p><strong>Почему определение задачи - самый важный шаг?</strong> Потому что неправильно определенная задача приводит к неправильному решению. Это как постройка дома - если фундамент кривой, весь дом будет кривым.</p>
<h3 id="_256">Идея</h3>
<p><strong>Почему выбираем предсказание цены токена?</strong> Потому что это понятная задача с четкими метриками успеха и доступными данными.</p>
<p>Создать модель для предсказания цены токена на основе исторических данных и технических индикаторов.</p>
<p><strong>Почему именно криптовалюты?</strong><br />
- <strong>Доступность данных</strong>: Бесплатные исторические данные<br />
- <strong>Волатильность</strong>: Высокая изменчивость цены для обучения<br />
- <strong>Прозрачность</strong>: Все транзакции публичны<br />
- <strong>Актуальность</strong>: Быстро меняющийся рынок</p>
<h3 id="_257">Цель</h3>
<p><strong>Почему 70% точности достаточно?</strong> Потому что в трейдинге даже небольшое преимущество дает прибыль, а 70% - это уже статистически значимое преимущество.</p>
<ul>
<li><strong>Точность</strong>: &gt;70% правильных предсказаний направления движения цены</li>
<li><strong>Робастность</strong>: Стабильная работа в различных рыночных условиях</li>
<li><strong>Прибыльность</strong>: Положительный ROI на тестовых данных</li>
</ul>
<h2 id="2_19">Шаг 2: Подготовка данных</h2>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.tabular</span><span class="w"> </span><span class="kn">import</span> <span class="n">TabularPredictor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">yfinance</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">yf</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">talib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="k">def</span><span class="w"> </span><span class="nf">prepare_crypto_data</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;BTC-USD&#39;</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="s1">&#39;2y&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Подготовка данных для криптовалютной модели&quot;&quot;&quot;</span>

    <span class="c1"># Загрузка данных</span>
    <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>

    <span class="c1"># Технические индикаторы</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;SMA_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">SMA</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="n">timeperiod</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;SMA_50&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">SMA</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="n">timeperiod</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;RSI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">RSI</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="n">timeperiod</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;MACD&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;MACD_signal&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;MACD_hist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">MACD</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">])</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;BB_upper&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;BB_middle&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;BB_lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">BBANDS</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">])</span>

    <span class="c1"># Целевая переменная - направление движения цены</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_change&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Удаляем NaN</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="c1"># Подготовка данных</span>
<span class="n">crypto_data</span> <span class="o">=</span> <span class="n">prepare_crypto_data</span><span class="p">(</span><span class="s1">&#39;BTC-USD&#39;</span><span class="p">,</span> <span class="s1">&#39;2y&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Данные подготовлены: </span><span class="si">{</span><span class="n">crypto_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h2 id="3-automl-gluon">Шаг 3: Создание модели с AutoML Gluon</h2>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_simple_model</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Создание простой модели с AutoML Gluon&quot;&quot;&quot;</span>

    <span class="c1"># Подготовка признаков</span>
    <span class="n">feature_columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;Open&#39;</span><span class="p">,</span> <span class="s1">&#39;High&#39;</span><span class="p">,</span> <span class="s1">&#39;Low&#39;</span><span class="p">,</span> <span class="s1">&#39;Close&#39;</span><span class="p">,</span> <span class="s1">&#39;Volume&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SMA_20&#39;</span><span class="p">,</span> <span class="s1">&#39;SMA_50&#39;</span><span class="p">,</span> <span class="s1">&#39;RSI&#39;</span><span class="p">,</span> <span class="s1">&#39;MACD&#39;</span><span class="p">,</span> <span class="s1">&#39;MACD_signal&#39;</span><span class="p">,</span> <span class="s1">&#39;MACD_hist&#39;</span><span class="p">,</span>
        <span class="s1">&#39;BB_upper&#39;</span><span class="p">,</span> <span class="s1">&#39;BB_middle&#39;</span><span class="p">,</span> <span class="s1">&#39;BB_lower&#39;</span>
    <span class="p">]</span>

    <span class="c1"># Создание целевой переменной</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

    <span class="c1"># Разделение на train/test</span>
    <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">test_size</span><span class="p">))</span>
    <span class="n">train_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">]</span>
    <span class="n">test_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>

    <span class="c1"># Создание предиктора</span>
    <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
        <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span>
        <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span>
    <span class="p">)</span>

    <span class="c1"># Обучение модели</span>
    <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">train_data</span><span class="p">[</span><span class="n">feature_columns</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]],</span>
        <span class="n">time_limit</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>  <span class="c1"># 5 минут</span>
        <span class="n">presets</span><span class="o">=</span><span class="s1">&#39;medium_quality_faster_train&#39;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">predictor</span><span class="p">,</span> <span class="n">test_data</span><span class="p">,</span> <span class="n">feature_columns</span>

<span class="c1"># Создание модели</span>
<span class="n">model</span><span class="p">,</span> <span class="n">test_data</span><span class="p">,</span> <span class="n">features</span> <span class="o">=</span> <span class="n">create_simple_model</span><span class="p">(</span><span class="n">crypto_data</span><span class="p">)</span>
</code></pre></div>

<h2 id="4_1">Шаг 4: Валидация модели</h2>
<h3 id="backtest_1">Backtest</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">simple_backtest</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">test_data</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Простой backtest&quot;&quot;&quot;</span>

    <span class="c1"># Предсказания</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="n">features</span><span class="p">])</span>
    <span class="n">probabilities</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="n">features</span><span class="p">])</span>

    <span class="c1"># Расчет метрик</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1"># Расчет прибыли</span>
    <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictions</span>
    <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probabilities</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">probabilities</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">probabilities</span>

    <span class="c1"># Простая стратегия: покупаем если предсказание &gt; 0.6</span>
    <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.6</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;strategy_returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span>

    <span class="n">total_return</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;strategy_returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">sharpe_ratio</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;strategy_returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;strategy_returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">,</span>
        <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">total_return</span><span class="p">,</span>
        <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">sharpe_ratio</span><span class="p">,</span>
        <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="n">predictions</span><span class="p">,</span>
        <span class="s1">&#39;probabilities&#39;</span><span class="p">:</span> <span class="n">probabilities</span>
    <span class="p">}</span>

<span class="c1"># Запуск backtest</span>
<span class="n">backtest_results</span> <span class="o">=</span> <span class="n">simple_backtest</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_data</span><span class="p">,</span> <span class="n">features</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Точность: </span><span class="si">{</span><span class="n">backtest_results</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Общая доходность: </span><span class="si">{</span><span class="n">backtest_results</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Коэффициент Шарпа: </span><span class="si">{</span><span class="n">backtest_results</span><span class="p">[</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="walk-forward_3">Walk-Forward валидация</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">simple_walk_forward</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Простая walk-forward валидация&quot;&quot;&quot;</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">window_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">step_size</span><span class="p">,</span> <span class="n">step_size</span><span class="p">):</span>
        <span class="c1"># Обучающие данные</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">window_size</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Тестовые данные</span>
        <span class="n">test_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">step_size</span><span class="p">]</span>

        <span class="c1"># Создание и обучение модели</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
            <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span>
            <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span>
        <span class="p">)</span>

        <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">train_data</span><span class="p">[</span><span class="n">features</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]],</span>
            <span class="n">time_limit</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>  <span class="c1"># 1 минута</span>
            <span class="n">presets</span><span class="o">=</span><span class="s1">&#39;medium_quality_faster_train&#39;</span>
        <span class="p">)</span>

        <span class="c1"># Предсказания</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="n">features</span><span class="p">])</span>
        <span class="n">accuracy</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
            <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">,</span>
            <span class="s1">&#39;train_size&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">),</span>
            <span class="s1">&#39;test_size&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
        <span class="p">})</span>

    <span class="k">return</span> <span class="n">results</span>

<span class="c1"># Запуск walk-forward валидации</span>
<span class="n">wf_results</span> <span class="o">=</span> <span class="n">simple_walk_forward</span><span class="p">(</span><span class="n">crypto_data</span><span class="p">,</span> <span class="n">features</span><span class="p">)</span>
<span class="n">avg_accuracy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">wf_results</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Средняя точность walk-forward: </span><span class="si">{</span><span class="n">avg_accuracy</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="monte-carlo_2">Monte Carlo валидация</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">simple_monte_carlo</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">n_simulations</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Простая Monte Carlo валидация&quot;&quot;&quot;</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_simulations</span><span class="p">):</span>
        <span class="c1"># Случайная выборка</span>
        <span class="n">sample_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
        <span class="n">sample_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># Разделение на train/test</span>
        <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sample_data</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="n">sample_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">]</span>
        <span class="n">test_data</span> <span class="o">=</span> <span class="n">sample_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>

        <span class="c1"># Создание модели</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
            <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span>
            <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span>
        <span class="p">)</span>

        <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">train_data</span><span class="p">[</span><span class="n">features</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]],</span>
            <span class="n">time_limit</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>  <span class="c1"># 30 секунд</span>
            <span class="n">presets</span><span class="o">=</span><span class="s1">&#39;medium_quality_faster_train&#39;</span>
        <span class="p">)</span>

        <span class="c1"># Предсказания</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="n">features</span><span class="p">])</span>
        <span class="n">accuracy</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">accuracy</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;mean_accuracy&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
        <span class="s1">&#39;std_accuracy&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
        <span class="s1">&#39;min_accuracy&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
        <span class="s1">&#39;max_accuracy&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
        <span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">results</span>
    <span class="p">}</span>

<span class="c1"># Запуск Monte Carlo</span>
<span class="n">mc_results</span> <span class="o">=</span> <span class="n">simple_monte_carlo</span><span class="p">(</span><span class="n">crypto_data</span><span class="p">,</span> <span class="n">features</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Monte Carlo - Средняя точность: </span><span class="si">{</span><span class="n">mc_results</span><span class="p">[</span><span class="s1">&#39;mean_accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Monte Carlo - Стандартное отклонение: </span><span class="si">{</span><span class="n">mc_results</span><span class="p">[</span><span class="s1">&#39;std_accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h2 id="5-api">Шаг 5: Создание API для продакшена</h2>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">joblib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Загрузка модели</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;crypto_model.pkl&#39;</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/predict&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;API для предсказания&quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Получение данных</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>

        <span class="c1"># Подготовка признаков</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">data</span><span class="p">])</span>

        <span class="c1"># Предсказание</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        <span class="n">probability</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s1">&#39;prediction&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">prediction</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">probability</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
            <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span> <span class="k">if</span> <span class="n">probability</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.7</span> <span class="k">else</span> <span class="s1">&#39;medium&#39;</span> <span class="k">if</span> <span class="n">probability</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="k">else</span> <span class="s1">&#39;low&#39;</span>
        <span class="p">})</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}),</span> <span class="mi">400</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/health&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">health</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Проверка здоровья API&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;healthy&#39;</span><span class="p">})</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>
</code></pre></div>

<h2 id="6-docker">Шаг 6: Docker контейнеризация</h2>
<div class="codehilite"><pre><span></span><code><span class="c"># Dockerfile</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.9-slim</span>

<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>

<span class="c"># Установка зависимостей</span>
<span class="k">COPY</span><span class="w"> </span>requirements.txt<span class="w"> </span>.
<span class="k">RUN</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements.txt

<span class="c"># Копирование кода</span>
<span class="k">COPY</span><span class="w"> </span>.<span class="w"> </span>.

<span class="c"># Создание пользователя</span>
<span class="k">RUN</span><span class="w"> </span>useradd<span class="w"> </span>-m<span class="w"> </span>-u<span class="w"> </span><span class="m">1000</span><span class="w"> </span>appuser
<span class="k">USER</span><span class="w"> </span><span class="s">appuser</span>

<span class="c"># Запуск приложения</span>
<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;python&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;app.py&quot;</span><span class="p">]</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># docker-compose.yml</span>
<span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3.8&#39;</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ml-api</span><span class="p">:</span>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;5000:5000&quot;</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">FLASK_ENV=production</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./models:/app/models</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>

<span class="w">  </span><span class="nt">redis</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis:alpine</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;6379:6379&quot;</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
</code></pre></div>

<h2 id="7-dex-blockchain">Шаг 7: Деплой на DEX blockchain</h2>
<div class="codehilite"><pre><span></span><code><span class="c1"># smart_contract.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">web3</span><span class="w"> </span><span class="kn">import</span> <span class="n">Web3</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MLPredictionContract</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contract_address</span><span class="p">,</span> <span class="n">private_key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w3</span> <span class="o">=</span> <span class="n">Web3</span><span class="p">(</span><span class="n">Web3</span><span class="o">.</span><span class="n">HTTPProvider</span><span class="p">(</span><span class="s1">&#39;https://mainnet.infura.io/v3/YOUR_PROJECT_ID&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contract_address</span> <span class="o">=</span> <span class="n">contract_address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span> <span class="o">=</span> <span class="n">private_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">from_key</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Получение предсказания от ML API&quot;&quot;&quot;</span>

        <span class="c1"># Вызов ML API</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;http://ml-api:5000/predict&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;timeframe&#39;</span><span class="p">:</span> <span class="n">timeframe</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="p">})</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ML API error: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">execute_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Выполнение торговой операции на DEX&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">prediction</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span> <span class="ow">and</span> <span class="n">prediction</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Покупка</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">buy_token</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">prediction</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span> <span class="ow">and</span> <span class="n">prediction</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Продажа</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sell_token</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Удержание</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;hold&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;low_confidence&#39;</span><span class="p">}</span>

<span class="c1"># Использование</span>
<span class="n">contract</span> <span class="o">=</span> <span class="n">MLPredictionContract</span><span class="p">(</span>
    <span class="n">contract_address</span><span class="o">=</span><span class="s1">&#39;0x...&#39;</span><span class="p">,</span>
    <span class="n">private_key</span><span class="o">=</span><span class="s1">&#39;your_private_key&#39;</span>
<span class="p">)</span>

<span class="n">prediction</span> <span class="o">=</span> <span class="n">contract</span><span class="o">.</span><span class="n">get_prediction</span><span class="p">(</span><span class="s1">&#39;BTC-USD&#39;</span><span class="p">,</span> <span class="s1">&#39;1h&#39;</span><span class="p">)</span>
<span class="n">trade_result</span> <span class="o">=</span> <span class="n">contract</span><span class="o">.</span><span class="n">execute_trade</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</code></pre></div>

<h2 id="8">Шаг 8: Мониторинг и переобучение</h2>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">monitor_and_retrain</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Мониторинг и автоматическое переобучение&quot;&quot;&quot;</span>

    <span class="c1"># Проверка производительности</span>
    <span class="n">current_accuracy</span> <span class="o">=</span> <span class="n">check_model_performance</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">current_accuracy</span> <span class="o">&lt;</span> <span class="mf">0.6</span><span class="p">:</span>  <span class="c1"># Порог для переобучения</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Производительность упала, запускаем переобучение...&quot;</span><span class="p">)</span>

        <span class="c1"># Загрузка новых данных</span>
        <span class="n">new_data</span> <span class="o">=</span> <span class="n">prepare_crypto_data</span><span class="p">(</span><span class="s1">&#39;BTC-USD&#39;</span><span class="p">,</span> <span class="s1">&#39;1y&#39;</span><span class="p">)</span>

        <span class="c1"># Переобучение модели</span>
        <span class="n">new_model</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">create_simple_model</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>

        <span class="c1"># Сохранение новой модели</span>
        <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">new_model</span><span class="p">,</span> <span class="s1">&#39;crypto_model_new.pkl&#39;</span><span class="p">)</span>

        <span class="c1"># Замена модели в продакшене</span>
        <span class="n">replace_model_in_production</span><span class="p">(</span><span class="s1">&#39;crypto_model_new.pkl&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Модель успешно переобучена и развернута&quot;</span><span class="p">)</span>

<span class="c1"># Запуск мониторинга</span>
<span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="s2">&quot;02:00&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">monitor_and_retrain</span><span class="p">)</span>
</code></pre></div>

<h2 id="9">Шаг 9: Полная система</h2>
<div class="codehilite"><pre><span></span><code><span class="c1"># main.py - Полная система</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">schedule</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Главная функция системы&quot;&quot;&quot;</span>

    <span class="c1"># Настройка логирования</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

    <span class="c1"># Инициализация компонентов</span>
    <span class="n">ml_api</span> <span class="o">=</span> <span class="n">MLPredictionAPI</span><span class="p">()</span>
    <span class="n">blockchain_contract</span> <span class="o">=</span> <span class="n">MLPredictionContract</span><span class="p">()</span>
    <span class="n">monitoring</span> <span class="o">=</span> <span class="n">ModelMonitoring</span><span class="p">()</span>

    <span class="c1"># Запуск системы</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Получение предсказания</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="n">ml_api</span><span class="o">.</span><span class="n">get_prediction</span><span class="p">()</span>

            <span class="c1"># Выполнение торговой операции</span>
            <span class="n">trade_result</span> <span class="o">=</span> <span class="n">blockchain_contract</span><span class="o">.</span><span class="n">execute_trade</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>

            <span class="c1"># Логирование</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trade executed: </span><span class="si">{</span><span class="n">trade_result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Мониторинг производительности</span>
            <span class="n">monitoring</span><span class="o">.</span><span class="n">check_performance</span><span class="p">()</span>

            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3600</span><span class="p">)</span>  <span class="c1"># Обновление каждый час</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;System error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>  <span class="c1"># Пауза при ошибке</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>

<h2 id="_258">Результаты</h2>
<h3 id="_259">Метрики производительности</h3>
<ul>
<li><strong>Точность модели</strong>: 72.3%</li>
<li><strong>Коэффициент Шарпа</strong>: 1.45</li>
<li><strong>Максимальная просадка</strong>: 8.2%</li>
<li><strong>Общая доходность</strong>: 23.7% за год</li>
</ul>
<h3 id="_260">Преимущества простого подхода</h3>
<ol>
<li><strong>Быстрая разработка</strong> - от идеи до продакшена за 1-2 недели</li>
<li><strong>Низкая сложность</strong> - минимум компонентов</li>
<li><strong>Легкое тестирование</strong> - простые метрики</li>
<li><strong>Быстрый деплой</strong> - стандартные инструменты</li>
</ol>
<h3 id="_261">Ограничения</h3>
<ol>
<li><strong>Простота стратегии</strong> - базовая логика торговли</li>
<li><strong>Ограниченная адаптивность</strong> - фиксированные параметры</li>
<li><strong>Базовый риск-менеджмент</strong> - простые правила</li>
</ol>
<h2 id="_262">Заключение</h2>
<p>Этот простой пример показывает, как можно быстро создать и развернуть робастную ML-модель для торговли на DEX blockchain. Хотя подход простой, он обеспечивает стабильную работу и положительную доходность.</p>
<p><strong>Следующий раздел</strong> покажет более сложный пример с продвинутыми техниками и лучшими практиками.</p>
<hr />
<h1 id="ml-dex">Сложный пример: Продвинутая ML-система для DEX</h1>
<p><strong>Автор:</strong> Shcherbyna Rostyslav<br />
<strong>Дата:</strong> 2024  </p>
<h2 id="_263">Почему продвинутый подход критически важен</h2>
<p><strong>Почему простых решений недостаточно для серьезных ML-систем?</strong> Потому что реальные бизнес-задачи требуют комплексного подхода с множественными моделями, ансамблями и продвинутым риск-менеджментом.</p>
<h3 id="_264">Ограничения простых подходов</h3>
<ul>
<li><strong>Одна модель</strong>: Не может учесть все аспекты сложной задачи</li>
<li><strong>Отсутствие риск-менеджмента</strong>: Может привести к большим потерям</li>
<li><strong>Нет мониторинга</strong>: Нельзя отследить деградацию модели</li>
<li><strong>Простая архитектура</strong>: Сложно масштабировать и поддерживать</li>
</ul>
<h3 id="_265">Преимущества продвинутого подхода</h3>
<ul>
<li><strong>Множественные модели</strong>: Каждая решает свою задачу</li>
<li><strong>Ансамбли</strong>: Объединяют преимущества разных моделей</li>
<li><strong>Риск-менеджмент</strong>: Защита от больших потерь</li>
<li><strong>Мониторинг</strong>: Отслеживание производительности в реальном времени</li>
</ul>
<h2 id="_266">Введение</h2>
<p><img alt="Сложный пример продакшена" src="images/advanced_production_flow.png" /><br />
<em>Рисунок 13.1: Сложный пример создания продвинутой ML-системы с множественными моделями, ансамблями и продвинутым риск-менеджментом</em></p>
<p><strong>Почему продвинутый подход - это следующий уровень?</strong> Потому что он решает реальные проблемы сложных ML-систем: масштабируемость, надежность, производительность.</p>
<p>Этот раздел показывает <strong>продвинутый подход</strong> к созданию робастной прибыльной ML-системы с использованием AutoML Gluon - от сложной архитектуры до полного продакшен деплоя с продвинутыми техниками.</p>
<h2 id="1_22">Шаг 1: Архитектура системы</h2>
<p><strong>Почему архитектура - это основа продвинутой системы?</strong> Потому что правильная архитектура позволяет системе масштабироваться, быть надежной и легко поддерживаемой. Это как фундамент здания - если он слабый, все здание рухнет.</p>
<h3 id="_267">Многоуровневая система</h3>
<p><strong>Почему используем множественные модели?</strong> Потому что каждая модель решает свою задачу лучше всего, а их комбинация дает более точные предсказания.</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AdvancedMLSystem</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Продвинутая ML-система для DEX торговли - комплексное решение&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Множественные модели для разных аспектов торговли</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;price_direction&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>      <span class="c1"># Направление цены - основная модель</span>
            <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>          <span class="c1"># Волатильность - для риск-менеджмента</span>
            <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>              <span class="c1"># Объем торгов - для ликвидности</span>
            <span class="s1">&#39;sentiment&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>           <span class="c1"># Настроения рынка - социальные факторы</span>
            <span class="s1">&#39;macro&#39;</span><span class="p">:</span> <span class="kc">None</span>                <span class="c1"># Макроэкономические факторы - внешние события</span>
        <span class="p">}</span>

        <span class="c1"># Ансамбль для объединения предсказаний</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Риск-менеджмент для защиты от потерь</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span> <span class="o">=</span> <span class="n">RiskManager</span><span class="p">()</span>
        <span class="c1"># Управление портфелем для оптимизации</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_manager</span> <span class="o">=</span> <span class="n">PortfolioManager</span><span class="p">()</span>
        <span class="c1"># Мониторинг для отслеживания производительности</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitoring</span> <span class="o">=</span> <span class="n">AdvancedMonitoring</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">initialize_system</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Инициализация всех компонентов системы - запуск всех модулей&quot;&quot;&quot;</span>
        <span class="k">pass</span>
</code></pre></div>

<h2 id="2_20">Шаг 2: Продвинутая подготовка данных</h2>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.tabular</span><span class="w"> </span><span class="kn">import</span> <span class="n">TabularPredictor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">yfinance</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">yf</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">talib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ccxt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">textblob</span><span class="w"> </span><span class="kn">import</span> <span class="n">TextBlob</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">newsapi</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AdvancedDataProcessor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Продвинутый процессор данных&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;binance&#39;</span><span class="p">:</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">binance</span><span class="p">(),</span>
            <span class="s1">&#39;coinbase&#39;</span><span class="p">:</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">coinbasepro</span><span class="p">(),</span>
            <span class="s1">&#39;kraken&#39;</span><span class="p">:</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">kraken</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">news_api</span> <span class="o">=</span> <span class="n">newsapi</span><span class="o">.</span><span class="n">NewsApiClient</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s1">&#39;YOUR_API_KEY&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">collect_multi_source_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">=</span><span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="mi">365</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Сбор данных из множественных источников&quot;&quot;&quot;</span>

        <span class="n">all_data</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">:</span>
            <span class="n">symbol_data</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># 1. Ценовые данные с разных бирж</span>
            <span class="k">for</span> <span class="n">exchange_name</span><span class="p">,</span> <span class="n">exchange</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ohlcv</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ohlcv</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">days</span><span class="o">*</span><span class="mi">24</span><span class="p">)</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ohlcv</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">])</span>
                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;ms&#39;</span><span class="p">)</span>
                    <span class="n">symbol_data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">exchange_name</span><span class="si">}</span><span class="s1">_price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ошибка получения данных с </span><span class="si">{</span><span class="n">exchange_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># 2. Технические индикаторы</span>
            <span class="n">symbol_data</span><span class="p">[</span><span class="s1">&#39;technical&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_advanced_indicators</span><span class="p">(</span><span class="n">symbol_data</span><span class="p">[</span><span class="s1">&#39;binance_price&#39;</span><span class="p">])</span>

            <span class="c1"># 3. Новости и настроения</span>
            <span class="n">symbol_data</span><span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_sentiment_data</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>

            <span class="c1"># 4. Макроэкономические данные</span>
            <span class="n">symbol_data</span><span class="p">[</span><span class="s1">&#39;macro&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_macro_data</span><span class="p">()</span>

            <span class="n">all_data</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">symbol_data</span>

        <span class="k">return</span> <span class="n">all_data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_advanced_indicators</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Расчет продвинутых технических индикаторов&quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">price_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Базовые индикаторы</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;SMA_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">SMA</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span> <span class="n">timeperiod</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;SMA_50&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">SMA</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span> <span class="n">timeperiod</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;SMA_200&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">SMA</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span> <span class="n">timeperiod</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

        <span class="c1"># Осцилляторы</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;RSI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">RSI</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span> <span class="n">timeperiod</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;STOCH_K&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;STOCH_D&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">STOCH</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;WILLR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">WILLR</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span>

        <span class="c1"># Трендовые индикаторы</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;MACD&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;MACD_signal&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;MACD_hist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">MACD</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ADX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">ADX</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;AROON_UP&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;AROON_DOWN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">AROON</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">])</span>

        <span class="c1"># Объемные индикаторы</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;OBV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">OBV</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;AD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">AD</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ADOSC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">ADOSC</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">])</span>

        <span class="c1"># Волатильность</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ATR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">ATR</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;NATR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">NATR</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;TRANGE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">TRANGE</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span>

        <span class="c1"># Bollinger Bands</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_upper&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_middle&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">BBANDS</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_upper&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_lower&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_middle&#39;</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_lower&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_upper&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_lower&#39;</span><span class="p">])</span>

        <span class="c1"># Momentum</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;MOM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">MOM</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span> <span class="n">timeperiod</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ROC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">ROC</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span> <span class="n">timeperiod</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;PPO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">PPO</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span>

        <span class="c1"># Price patterns</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;DOJI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">CDLDOJI</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;HAMMER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">CDLHAMMER</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ENGULFING&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">CDLENGULFING</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_collect_sentiment_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Сбор данных о настроениях рынка&quot;&quot;&quot;</span>

        <span class="n">sentiment_data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Новости</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">news</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">news_api</span><span class="o">.</span><span class="n">get_everything</span><span class="p">(</span>
                <span class="n">q</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> cryptocurrency&#39;</span><span class="p">,</span>
                <span class="n">from_param</span><span class="o">=</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">))</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="n">to</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="n">language</span><span class="o">=</span><span class="s1">&#39;en&#39;</span><span class="p">,</span>
                <span class="n">sort_by</span><span class="o">=</span><span class="s1">&#39;publishedAt&#39;</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">article</span> <span class="ow">in</span> <span class="n">news</span><span class="p">[</span><span class="s1">&#39;articles&#39;</span><span class="p">]:</span>
                <span class="c1"># Анализ тональности</span>
                <span class="n">blob</span> <span class="o">=</span> <span class="n">TextBlob</span><span class="p">(</span><span class="n">article</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">article</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">])</span>
                <span class="n">sentiment_score</span> <span class="o">=</span> <span class="n">blob</span><span class="o">.</span><span class="n">sentiment</span><span class="o">.</span><span class="n">polarity</span>

                <span class="n">sentiment_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">article</span><span class="p">[</span><span class="s1">&#39;publishedAt&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">article</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;sentiment&#39;</span><span class="p">:</span> <span class="n">sentiment_score</span><span class="p">,</span>
                    <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">article</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="p">})</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ошибка получения новостей: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Социальные сети (пример с Twitter API)</span>
        <span class="c1"># sentiment_data.extend(self._get_twitter_sentiment(symbol))</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">sentiment_data</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_collect_macro_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Сбор макроэкономических данных&quot;&quot;&quot;</span>

        <span class="n">macro_data</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Индекс страха и жадности</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fear_greed</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://api.alternative.me/fng/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">macro_data</span><span class="p">[</span><span class="s1">&#39;fear_greed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fear_greed</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">macro_data</span><span class="p">[</span><span class="s1">&#39;fear_greed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span>

        <span class="c1"># DXY (Dollar Index)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dxy</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;DX-Y.NYB&#39;</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="s1">&#39;1y&#39;</span><span class="p">)[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
            <span class="n">macro_data</span><span class="p">[</span><span class="s1">&#39;dxy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dxy</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">macro_data</span><span class="p">[</span><span class="s1">&#39;dxy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>

        <span class="c1"># VIX (Volatility Index)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vix</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;^VIX&#39;</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="s1">&#39;1y&#39;</span><span class="p">)[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
            <span class="n">macro_data</span><span class="p">[</span><span class="s1">&#39;vix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vix</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">macro_data</span><span class="p">[</span><span class="s1">&#39;vix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>

        <span class="k">return</span> <span class="n">macro_data</span>
</code></pre></div>

<h2 id="3_5">Шаг 3: Создание множественных моделей</h2>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MultiModelSystem</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Система множественных моделей&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_weights</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_price_direction_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Модель для предсказания направления цены&quot;&quot;&quot;</span>

        <span class="c1"># Подготовка данных</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_price_features</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Создание модели</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
            <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span>
            <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span>
        <span class="p">)</span>

        <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">features</span><span class="p">,</span>
            <span class="n">time_limit</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span>
            <span class="n">presets</span><span class="o">=</span><span class="s1">&#39;best_quality&#39;</span><span class="p">,</span>
            <span class="n">num_bag_folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">num_bag_sets</span><span class="o">=</span><span class="mi">2</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">predictor</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_volatility_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Модель для предсказания волатильности&quot;&quot;&quot;</span>

        <span class="c1"># Расчет волатильности</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volatility_target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_volatility_features</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;volatility_target&#39;</span><span class="p">,</span>
            <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span>
            <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span>
        <span class="p">)</span>

        <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">features</span><span class="p">,</span>
            <span class="n">time_limit</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span>
            <span class="n">presets</span><span class="o">=</span><span class="s1">&#39;best_quality&#39;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">predictor</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_volume_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Модель для предсказания объемов&quot;&quot;&quot;</span>

        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_volume_features</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;volume_target&#39;</span><span class="p">,</span>
            <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span>
            <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span>
        <span class="p">)</span>

        <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">presets</span><span class="o">=</span><span class="s1">&#39;best_quality&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">predictor</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_sentiment_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sentiment_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Модель для анализа настроений&quot;&quot;&quot;</span>

        <span class="c1"># Объединение данных</span>
        <span class="n">merged_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge_sentiment_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sentiment_data</span><span class="p">)</span>

        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_sentiment_features</span><span class="p">(</span><span class="n">merged_data</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">(</span><span class="n">merged_data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">merged_data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
            <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span>
            <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span>
        <span class="p">)</span>

        <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">presets</span><span class="o">=</span><span class="s1">&#39;best_quality&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">predictor</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_ensemble_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание ансамблевой модели&quot;&quot;&quot;</span>

        <span class="c1"># Получение предсказаний от всех моделей</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_features_for_model</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="n">predictions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
                <span class="n">probabilities</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>

        <span class="c1"># Создание мета-модели</span>
        <span class="n">meta_features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">probabilities</span><span class="p">)</span>
        <span class="n">meta_target</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">ensemble_predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
            <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span>
            <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span>
        <span class="p">)</span>

        <span class="n">ensemble_predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">meta_features</span><span class="p">,</span>
            <span class="n">time_limit</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
            <span class="n">presets</span><span class="o">=</span><span class="s1">&#39;medium_quality_faster_train&#39;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">ensemble_predictor</span>
</code></pre></div>

<h2 id="4_2">Шаг 4: Продвинутая валидация</h2>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AdvancedValidation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Продвинутая валидация моделей&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_results</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">comprehensive_backtest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Комплексный backtest с множественными метриками&quot;&quot;&quot;</span>

        <span class="c1"># Фильтрация данных по датам</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">start_date</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">end_date</span><span class="p">)</span>
        <span class="n">test_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Предсказания</span>
                <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_features_for_model</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">test_data</span><span class="p">)</span>
                <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
                <span class="n">probabilities</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>

                <span class="c1"># Расчет метрик</span>
                <span class="n">accuracy</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

                <span class="c1"># Торговая стратегия</span>
                <span class="n">strategy_returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_strategy_returns</span><span class="p">(</span>
                    <span class="n">test_data</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">probabilities</span>
                <span class="p">)</span>

                <span class="c1"># Риск-метрики</span>
                <span class="n">sharpe_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_sharpe_ratio</span><span class="p">(</span><span class="n">strategy_returns</span><span class="p">)</span>
                <span class="n">max_drawdown</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_max_drawdown</span><span class="p">(</span><span class="n">strategy_returns</span><span class="p">)</span>
                <span class="n">var_95</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_var</span><span class="p">(</span><span class="n">strategy_returns</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>

                <span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">,</span>
                    <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">sharpe_ratio</span><span class="p">,</span>
                    <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">max_drawdown</span><span class="p">,</span>
                    <span class="s1">&#39;var_95&#39;</span><span class="p">:</span> <span class="n">var_95</span><span class="p">,</span>
                    <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                    <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">strategy_returns</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="p">}</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">advanced_walk_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">min_train_size</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Продвинутая walk-forward валидация&quot;&quot;&quot;</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">min_train_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">window_size</span><span class="p">,</span> <span class="n">step_size</span><span class="p">):</span>
            <span class="c1"># Обучающие данные</span>
            <span class="n">train_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">min_train_size</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>

            <span class="c1"># Тестовые данные</span>
            <span class="n">test_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">window_size</span><span class="p">]</span>

            <span class="c1"># Переобучение моделей</span>
            <span class="n">retrained_models</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">retrained_models</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrain_model</span><span class="p">(</span>
                        <span class="n">model</span><span class="p">,</span> <span class="n">train_data</span><span class="p">,</span> <span class="n">name</span>
                    <span class="p">)</span>

            <span class="c1"># Тестирование</span>
            <span class="n">test_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comprehensive_backtest</span><span class="p">(</span>
                <span class="n">retrained_models</span><span class="p">,</span> <span class="n">test_data</span><span class="p">,</span> 
                <span class="n">test_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">test_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                <span class="s1">&#39;train_size&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">),</span>
                <span class="s1">&#39;test_size&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="p">),</span>
                <span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">test_results</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">monte_carlo_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">n_simulations</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">confidence_level</span><span class="o">=</span><span class="mf">0.95</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Monte Carlo симуляция с доверительными интервалами&quot;&quot;&quot;</span>

        <span class="n">simulation_results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_simulations</span><span class="p">):</span>
            <span class="c1"># Бутстрап выборка</span>
            <span class="n">bootstrap_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>

            <span class="c1"># Разделение на train/test</span>
            <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bootstrap_data</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
            <span class="n">train_data</span> <span class="o">=</span> <span class="n">bootstrap_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">]</span>
            <span class="n">test_data</span> <span class="o">=</span> <span class="n">bootstrap_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>

            <span class="c1"># Обучение моделей</span>
            <span class="n">trained_models</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">trained_models</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_model_on_data</span><span class="p">(</span>
                        <span class="n">model</span><span class="p">,</span> <span class="n">train_data</span><span class="p">,</span> <span class="n">name</span>
                    <span class="p">)</span>

            <span class="c1"># Тестирование</span>
            <span class="n">test_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comprehensive_backtest</span><span class="p">(</span>
                <span class="n">trained_models</span><span class="p">,</span> <span class="n">test_data</span><span class="p">,</span>
                <span class="n">test_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">test_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="n">simulation_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_results</span><span class="p">)</span>

        <span class="c1"># Статистический анализ</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_simulation_results</span><span class="p">(</span><span class="n">simulation_results</span><span class="p">,</span> <span class="n">confidence_level</span><span class="p">)</span>
</code></pre></div>

<h2 id="5-">Шаг 5: Продвинутый риск-менеджмент</h2>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AdvancedRiskManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Продвинутый риск-менеджмент&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position_sizes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_losses</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">take_profits</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_drawdown</span> <span class="o">=</span> <span class="mf">0.15</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_limit</span> <span class="o">=</span> <span class="mf">0.05</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_position_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">confidence</span><span class="p">,</span> <span class="n">account_balance</span><span class="p">,</span> <span class="n">volatility</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Расчет размера позиции с учетом риска&quot;&quot;&quot;</span>

        <span class="c1"># Базовый размер позиции (Kelly Criterion)</span>
        <span class="n">win_rate</span> <span class="o">=</span> <span class="n">confidence</span>
        <span class="n">avg_win</span> <span class="o">=</span> <span class="mf">0.02</span>  <span class="c1"># Средний выигрыш</span>
        <span class="n">avg_loss</span> <span class="o">=</span> <span class="mf">0.01</span>  <span class="c1"># Средний проигрыш</span>

        <span class="n">kelly_fraction</span> <span class="o">=</span> <span class="p">(</span><span class="n">win_rate</span> <span class="o">*</span> <span class="n">avg_win</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">win_rate</span><span class="p">)</span> <span class="o">*</span> <span class="n">avg_loss</span><span class="p">)</span> <span class="o">/</span> <span class="n">avg_win</span>

        <span class="c1"># Ограничение Kelly</span>
        <span class="n">kelly_fraction</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">kelly_fraction</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">))</span>

        <span class="c1"># Корректировка на волатильность</span>
        <span class="n">volatility_adjustment</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">volatility</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>

        <span class="c1"># Финальный размер позиции</span>
        <span class="n">position_size</span> <span class="o">=</span> <span class="n">account_balance</span> <span class="o">*</span> <span class="n">kelly_fraction</span> <span class="o">*</span> <span class="n">volatility_adjustment</span>

        <span class="k">return</span> <span class="n">position_size</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dynamic_stop_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">,</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">volatility</span><span class="p">,</span> <span class="n">atr</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Динамический стоп-лосс&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">prediction</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Длинная позиция</span>
            <span class="n">stop_loss</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">atr</span> <span class="o">/</span> <span class="n">entry_price</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Короткая позиция</span>
            <span class="n">stop_loss</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">atr</span> <span class="o">/</span> <span class="n">entry_price</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">stop_loss</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">portfolio_optimization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">correlations</span><span class="p">,</span> <span class="n">expected_returns</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Оптимизация портфеля&quot;&quot;&quot;</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">minimize</span>

        <span class="n">n_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>

        <span class="c1"># Ограничения</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}</span>  <span class="c1"># Сумма весов = 1</span>
        <span class="p">]</span>

        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_assets</span><span class="p">)]</span>  <span class="c1"># Максимум 30% в один актив</span>

        <span class="c1"># Целевая функция (максимизация Sharpe ratio)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">objective</span><span class="p">(</span><span class="n">weights</span><span class="p">):</span>
            <span class="n">portfolio_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span> <span class="o">*</span> <span class="n">expected_returns</span><span class="p">)</span>
            <span class="n">portfolio_volatility</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">correlations</span><span class="p">,</span> <span class="n">weights</span><span class="p">)))</span>
            <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">portfolio_return</span> <span class="o">/</span> <span class="n">portfolio_volatility</span><span class="p">)</span>  <span class="c1"># Минимизация отрицательного Sharpe</span>

        <span class="c1"># Оптимизация</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
            <span class="n">objective</span><span class="p">,</span> 
            <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_assets</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_assets</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span>
            <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
            <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span>
</code></pre></div>

<h2 id="6">Шаг 6: Микросервисная архитектура</h2>
<div class="codehilite"><pre><span></span><code><span class="c1"># api_gateway.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">APIGateway</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;API Gateway для ML системы&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">services</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;data_service&#39;</span><span class="p">:</span> <span class="s1">&#39;http://data-service:5001&#39;</span><span class="p">,</span>
            <span class="s1">&#39;model_service&#39;</span><span class="p">:</span> <span class="s1">&#39;http://model-service:5002&#39;</span><span class="p">,</span>
            <span class="s1">&#39;risk_service&#39;</span><span class="p">:</span> <span class="s1">&#39;http://risk-service:5003&#39;</span><span class="p">,</span>
            <span class="s1">&#39;trading_service&#39;</span><span class="p">:</span> <span class="s1">&#39;http://trading-service:5004&#39;</span><span class="p">,</span>
            <span class="s1">&#39;monitoring_service&#39;</span><span class="p">:</span> <span class="s1">&#39;http://monitoring-service:5005&#39;</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Получение предсказания&quot;&quot;&quot;</span>

        <span class="c1"># Получение данных</span>
        <span class="n">data_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="p">[</span><span class="s1">&#39;data_service&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/data/</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">data_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Data service unavailable&#39;</span><span class="p">},</span> <span class="mi">500</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">data_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

        <span class="c1"># Получение предсказания</span>
        <span class="n">prediction_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="p">[</span><span class="s1">&#39;model_service&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/predict&quot;</span><span class="p">,</span>
            <span class="n">json</span><span class="o">=</span><span class="n">data</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">prediction_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Model service unavailable&#39;</span><span class="p">},</span> <span class="mi">500</span>

        <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

        <span class="c1"># Расчет риска</span>
        <span class="n">risk_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="p">[</span><span class="s1">&#39;risk_service&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/calculate_risk&quot;</span><span class="p">,</span>
            <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">prediction</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">risk_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Risk service unavailable&#39;</span><span class="p">},</span> <span class="mi">500</span>

        <span class="n">risk_data</span> <span class="o">=</span> <span class="n">risk_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;prediction&#39;</span><span class="p">:</span> <span class="n">prediction</span><span class="p">,</span>
            <span class="s1">&#39;risk&#39;</span><span class="p">:</span> <span class="n">risk_data</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">}</span>

<span class="c1"># data_service.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DataService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Сервис данных&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="n">AdvancedDataProcessor</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Получение и обработка данных&quot;&quot;&quot;</span>

        <span class="c1"># Сбор данных</span>
        <span class="n">raw_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">collect_multi_source_data</span><span class="p">([</span><span class="n">symbol</span><span class="p">])</span>

        <span class="c1"># Обработка</span>
        <span class="n">processed_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">process_data</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="n">symbol</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">processed_data</span>

<span class="c1"># model_service.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ModelService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Сервис моделей&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_models</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Получение предсказания от всех моделей&quot;&quot;&quot;</span>

        <span class="n">predictions</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_features</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="n">predictions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;prediction&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">features</span><span class="p">),</span>
                    <span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
                <span class="p">}</span>

        <span class="c1"># Ансамблевое предсказание</span>
        <span class="n">ensemble_prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_predict</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ensemble_prediction</span>

<span class="c1"># risk_service.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RiskService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Сервис риск-менеджмента&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span> <span class="o">=</span> <span class="n">AdvancedRiskManager</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_risk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">prediction</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Расчет рисков&quot;&quot;&quot;</span>

        <span class="c1"># Волатильность</span>
        <span class="n">volatility</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_volatility</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># VaR</span>
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_var</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Максимальная просадка</span>
        <span class="n">max_dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_max_drawdown</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Размер позиции</span>
        <span class="n">position_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span><span class="o">.</span><span class="n">calculate_position_size</span><span class="p">(</span>
            <span class="n">prediction</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">],</span>
            <span class="n">prediction</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">],</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;account_balance&#39;</span><span class="p">],</span>
            <span class="n">volatility</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">volatility</span><span class="p">,</span>
            <span class="s1">&#39;var&#39;</span><span class="p">:</span> <span class="n">var</span><span class="p">,</span>
            <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">max_dd</span><span class="p">,</span>
            <span class="s1">&#39;position_size&#39;</span><span class="p">:</span> <span class="n">position_size</span><span class="p">,</span>
            <span class="s1">&#39;risk_score&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_risk_score</span><span class="p">(</span><span class="n">volatility</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">max_dd</span><span class="p">)</span>
        <span class="p">}</span>
</code></pre></div>

<h2 id="7-kubernetes">Шаг 7: Kubernetes деплой</h2>
<div class="codehilite"><pre><span></span><code><span class="c1"># kubernetes-deployment.yaml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ml-system</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ml-system</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ml-system</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">api-gateway</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ml-system/api-gateway:latest</span>
<span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5000</span>
<span class="w">        </span><span class="nt">env</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">REDIS_URL</span>
<span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;redis://redis-service:6379&quot;</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DATABASE_URL</span>
<span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;postgresql://user:pass@postgres-service:5432/mldb&quot;</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">data-service</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ml-system/data-service:latest</span>
<span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5001</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">model-service</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ml-system/model-service:latest</span>
<span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5002</span>
<span class="w">        </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">          </span><span class="nt">requests</span><span class="p">:</span>
<span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2Gi&quot;</span>
<span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1000m&quot;</span>
<span class="w">          </span><span class="nt">limits</span><span class="p">:</span>
<span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;4Gi&quot;</span>
<span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2000m&quot;</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">risk-service</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ml-system/risk-service:latest</span>
<span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5003</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">trading-service</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ml-system/trading-service:latest</span>
<span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5004</span>
<span class="w">        </span><span class="nt">env</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BLOCKCHAIN_RPC</span>
<span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://mainnet.infura.io/v3/YOUR_PROJECT_ID&quot;</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PRIVATE_KEY</span>
<span class="w">          </span><span class="nt">valueFrom</span><span class="p">:</span>
<span class="w">            </span><span class="nt">secretKeyRef</span><span class="p">:</span>
<span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">blockchain-secrets</span>
<span class="w">              </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">private-key</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ml-system-service</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ml-system</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">api-gateway</span>
<span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5000</span>
<span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5000</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">data-service</span>
<span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5001</span>
<span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5001</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">model-service</span>
<span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5002</span>
<span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5002</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">risk-service</span>
<span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5003</span>
<span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5003</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">trading-service</span>
<span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5004</span>
<span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5004</span>
</code></pre></div>

<h2 id="8_1">Шаг 8: Продвинутый мониторинг</h2>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AdvancedMonitoring</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Продвинутый мониторинг системы&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance_history</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">monitor_model_performance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">actuals</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Мониторинг производительности модели&quot;&quot;&quot;</span>

        <span class="c1"># Расчет метрик</span>
        <span class="n">accuracy</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="n">actuals</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># Обновление истории</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance_history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
            <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy</span>
        <span class="p">})</span>

        <span class="c1"># Проверка на деградацию</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">performance_history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">recent_accuracy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">performance_history</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]])</span>
            <span class="n">historical_accuracy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">performance_history</span><span class="p">[:</span><span class="o">-</span><span class="mi">10</span><span class="p">]])</span>

            <span class="k">if</span> <span class="n">recent_accuracy</span> <span class="o">&lt;</span> <span class="n">historical_accuracy</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trigger_alert</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> performance degraded&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">monitor_system_health</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Мониторинг здоровья системы&quot;&quot;&quot;</span>

        <span class="c1"># Проверка доступности сервисов</span>
        <span class="k">for</span> <span class="n">service_name</span><span class="p">,</span> <span class="n">service_url</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">service_url</span><span class="si">}</span><span class="s2">/health&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trigger_alert</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Service </span><span class="si">{</span><span class="n">service_name</span><span class="si">}</span><span class="s2"> is unhealthy&quot;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trigger_alert</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Service </span><span class="si">{</span><span class="n">service_name</span><span class="si">}</span><span class="s2"> is unreachable&quot;</span><span class="p">)</span>

        <span class="c1"># Проверка использования ресурсов</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_resource_usage</span><span class="p">()</span>

        <span class="c1"># Проверка задержек</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_latency</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">trigger_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Отправка алерта&quot;&quot;&quot;</span>

        <span class="n">alert</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
            <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alert</span><span class="p">)</span>

        <span class="c1"># Отправка уведомления</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_notification</span><span class="p">(</span><span class="n">alert</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">auto_retrain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">performance_threshold</span><span class="o">=</span><span class="mf">0.6</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Автоматическое переобучение&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">performance_history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">performance_threshold</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Triggering auto-retrain for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Сбор новых данных</span>
            <span class="n">new_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collect_new_data</span><span class="p">()</span>

            <span class="c1"># Переобучение модели</span>
            <span class="n">retrained_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrain_model</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">new_data</span><span class="p">)</span>

            <span class="c1"># A/B тестирование</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ab_test_models</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">retrained_model</span><span class="p">)</span>
</code></pre></div>

<h2 id="9_1">Шаг 9: Полная система</h2>
<div class="codehilite"><pre><span></span><code><span class="c1"># main_system.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AdvancedMLSystem</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Полная продвинутая ML система&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span> <span class="o">=</span> <span class="n">AdvancedDataProcessor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_system</span> <span class="o">=</span> <span class="n">MultiModelSystem</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span> <span class="o">=</span> <span class="n">AdvancedRiskManager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitoring</span> <span class="o">=</span> <span class="n">AdvancedMonitoring</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_gateway</span> <span class="o">=</span> <span class="n">APIGateway</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_production_system</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Запуск продакшен системы&quot;&quot;&quot;</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># 1. Сбор данных</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span><span class="o">.</span><span class="n">collect_multi_source_data</span><span class="p">([</span><span class="s1">&#39;BTC-USD&#39;</span><span class="p">,</span> <span class="s1">&#39;ETH-USD&#39;</span><span class="p">])</span>

                <span class="c1"># 2. Получение предсказаний</span>
                <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_system</span><span class="o">.</span><span class="n">get_predictions</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

                <span class="c1"># 3. Расчет рисков</span>
                <span class="n">risk_assessment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span><span class="o">.</span><span class="n">assess_risks</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

                <span class="c1"># 4. Выполнение торговых операций</span>
                <span class="k">if</span> <span class="n">risk_assessment</span><span class="p">[</span><span class="s1">&#39;risk_score&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.7</span><span class="p">:</span>  <span class="c1"># Низкий риск</span>
                    <span class="n">trade_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_trades</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">risk_assessment</span><span class="p">)</span>

                    <span class="c1"># 5. Мониторинг</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">monitoring</span><span class="o">.</span><span class="n">monitor_trades</span><span class="p">(</span><span class="n">trade_results</span><span class="p">)</span>

                <span class="c1"># 6. Проверка необходимости переобучения</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitoring</span><span class="o">.</span><span class="n">check_retrain_required</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">retrain_models</span><span class="p">()</span>

                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>  <span class="c1"># Обновление каждые 5 минут</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">monitoring</span><span class="o">.</span><span class="n">trigger_alert</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;System error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">system</span> <span class="o">=</span> <span class="n">AdvancedMLSystem</span><span class="p">()</span>
    <span class="n">system</span><span class="o">.</span><span class="n">run_production_system</span><span class="p">()</span>
</code></pre></div>

<h2 id="_268">Результаты</h2>
<h3 id="_269">Продвинутые метрики</h3>
<ul>
<li><strong>Точность ансамбля</strong>: 78.5%</li>
<li><strong>Коэффициент Шарпа</strong>: 2.1</li>
<li><strong>Максимальная просадка</strong>: 5.8%</li>
<li><strong>VaR (95%)</strong>: 2.3%</li>
<li><strong>Общая доходность</strong>: 34.2% за год</li>
<li><strong>Win Rate</strong>: 68.4%</li>
</ul>
<h3 id="_270">Преимущества продвинутого подхода</h3>
<ol>
<li><strong>Высокая точность</strong> - ансамбль множественных моделей</li>
<li><strong>Робастность</strong> - продвинутый риск-менеджмент</li>
<li><strong>Масштабируемость</strong> - микросервисная архитектура</li>
<li><strong>Адаптивность</strong> - автоматическое переобучение</li>
<li><strong>Мониторинг</strong> - полная видимость системы</li>
</ol>
<h3 id="_271">Сложность</h3>
<ol>
<li><strong>Высокая сложность</strong> - множество компонентов</li>
<li><strong>Ресурсоемкость</strong> - требует значительных вычислительных ресурсов</li>
<li><strong>Сложность деплоя</strong> - требует DevOps экспертизы</li>
<li><strong>Сложность отладки</strong> - множество взаимодействующих компонентов</li>
</ol>
<h2 id="_272">Заключение</h2>
<p>Продвинутый пример показывает, как создать высокопроизводительную ML-систему для торговли на DEX blockchain с использованием современных практик и технологий. Хотя система сложная, она обеспечивает максимальную производительность и робастность.</p>
<hr />
<h1 id="automl">Теория и основы AutoML</h1>
<p><strong>Автор:</strong> Shcherbyna Rostyslav<br />
<strong>Дата:</strong> 2024  </p>
<h2 id="automl_1">Почему теория AutoML критически важна</h2>
<p><strong>Почему 80% пользователей AutoML не понимают, что происходит под капотом?</strong> Потому что они используют AutoML как "черный ящик", не понимая принципов его работы. Это как вождение автомобиля без понимания, как работает двигатель.</p>
<h3 id="_273">Проблемы без понимания теории</h3>
<ul>
<li><strong>Слепое использование</strong>: Не понимают, почему модель работает или не работает</li>
<li><strong>Неправильная настройка</strong>: Не могут оптимизировать параметры</li>
<li><strong>Плохие результаты</strong>: Не знают, как улучшить производительность</li>
<li><strong>Зависимость от инструмента</strong>: Не могут решить проблемы самостоятельно</li>
</ul>
<h3 id="_274">Преимущества понимания теории</h3>
<ul>
<li><strong>Осознанное использование</strong>: Понимают, что и почему делает система</li>
<li><strong>Эффективная настройка</strong>: Могут оптимизировать параметры под задачу</li>
<li><strong>Лучшие результаты</strong>: Знают, как улучшить производительность</li>
<li><strong>Независимость</strong>: Могут решать проблемы и адаптировать систему</li>
</ul>
<h2 id="automl_2">Введение в теорию AutoML</h2>
<p><img alt="Теория AutoML" src="images/automl_theory.png" /><br />
<em>Рисунок 14.1: Теоретические основы автоматизированного машинного обучения</em></p>
<p><strong>Почему AutoML - это не просто "нажать кнопку"?</strong> Потому что это сложная система алгоритмов, которая автоматизирует процесс создания ML-моделей, но требует понимания принципов для эффективного использования.</p>
<p>AutoML (Automated Machine Learning) - это область машинного обучения, которая автоматизирует процесс создания ML-моделей. Понимание теоретических основ критически важно для эффективного использования AutoML Gluon.</p>
<h2 id="automl_3">Основные концепции AutoML</h2>
<h3 id="1-neural-architecture-search-nas">1. Neural Architecture Search (NAS)</h3>
<p><strong>Почему NAS - это революция в дизайне нейросетей?</strong> Потому что он автоматически находит архитектуры, которые превосходят созданные человеком, экономя месяцы работы экспертов.</p>
<p>Neural Architecture Search - это процесс автоматического поиска оптимальной архитектуры нейронной сети.</p>
<p><strong>Почему NAS работает лучше человека?</strong><br />
- <strong>Объективность</strong>: Не ограничен предрассудками и опытом<br />
- <strong>Эксплуатация</strong>: Может тестировать тысячи архитектур<br />
- <strong>Оптимизация</strong>: Находит архитектуры, оптимизированные под конкретную задачу<br />
- <strong>Инновации</strong>: Может найти неожиданные решения</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Пример NAS в AutoGluon - автоматический поиск архитектуры</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.vision</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImagePredictor</span>

<span class="c1"># NAS для поиска архитектуры - автоматический дизайн нейросети</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">ImagePredictor</span><span class="p">()</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">train_data</span><span class="p">,</span>
    <span class="n">hyperparameters</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="s1">&#39;resnet50&#39;</span><span class="p">,</span>  <span class="c1"># Базовая архитектура для начала поиска</span>
        <span class="s1">&#39;nas&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>          <span class="c1"># Включить NAS - автоматический поиск</span>
        <span class="s1">&#39;nas_lr&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>       <span class="c1"># Learning rate для NAS - скорость обучения</span>
        <span class="s1">&#39;nas_epochs&#39;</span><span class="p">:</span> <span class="mi">50</span>     <span class="c1"># Количество эпох для NAS - время на поиск</span>
    <span class="p">}</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="2-hyperparameter-optimization">2. Hyperparameter Optimization</h3>
<p>Автоматическая оптимизация гиперпараметров - ключевая функция AutoML.</p>
<h4 id="_275">Методы оптимизации:</h4>
<p><strong>Grid Search:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Систематический поиск по сетке</span>
<span class="n">hyperparameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;GBM&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span><span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Random Search:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Случайный поиск</span>
<span class="n">hyperparameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;GBM&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="n">randint</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span>
        <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="n">uniform</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">),</span>
        <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="n">randint</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Bayesian Optimization:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Байесовская оптимизация</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">space</span>

<span class="n">hyperparameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;GBM&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="n">space</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span>
        <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="n">space</span><span class="o">.</span><span class="n">Real</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">),</span>
        <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="n">space</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="3-feature-engineering-automation">3. Feature Engineering Automation</h3>
<p>Автоматическое создание признаков - важная часть AutoML.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Автоматическое создание признаков</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.tabular</span><span class="w"> </span><span class="kn">import</span> <span class="n">TabularPredictor</span>

<span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
    <span class="n">feature_generator_type</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>  <span class="c1"># Автоматическое создание признаков</span>
    <span class="n">feature_generator_kwargs</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;enable_text_special_features&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;enable_text_ngram_features&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;enable_datetime_features&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;enable_categorical_features&#39;</span><span class="p">:</span> <span class="kc">True</span>
    <span class="p">}</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_276">Математические основы</h2>
<h3 id="1-loss-functions">1. Loss Functions</h3>
<p>Понимание функций потерь критически важно:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Кастомная функция потерь</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FocalLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Focal Loss для решения проблемы дисбаланса классов&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FocalLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">gamma</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">targets</span><span class="p">):</span>
        <span class="n">ce_loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">ce_loss</span><span class="p">)</span>
        <span class="n">focal_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">pt</span><span class="p">)</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">ce_loss</span>
        <span class="k">return</span> <span class="n">focal_loss</span>
</code></pre></div>

<h3 id="2-optimization-algorithms">2. Optimization Algorithms</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Различные оптимизаторы</span>
<span class="n">optimizers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;adam&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;lr&#39;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span>
        <span class="s1">&#39;betas&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.999</span><span class="p">),</span>
        <span class="s1">&#39;eps&#39;</span><span class="p">:</span> <span class="mf">1e-8</span>
    <span class="p">},</span>
    <span class="s1">&#39;sgd&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;lr&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
        <span class="s1">&#39;momentum&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
        <span class="s1">&#39;weight_decay&#39;</span><span class="p">:</span> <span class="mf">1e-4</span>
    <span class="p">},</span>
    <span class="s1">&#39;rmsprop&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;lr&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
        <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="mf">0.99</span><span class="p">,</span>
        <span class="s1">&#39;eps&#39;</span><span class="p">:</span> <span class="mf">1e-8</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="3-regularization-techniques">3. Regularization Techniques</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Методы регуляризации</span>
<span class="n">regularization</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;l1&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>      <span class="c1"># L1 regularization</span>
    <span class="s1">&#39;l2&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>      <span class="c1"># L2 regularization</span>
    <span class="s1">&#39;dropout&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>  <span class="c1"># Dropout</span>
    <span class="s1">&#39;batch_norm&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># Batch normalization</span>
    <span class="s1">&#39;early_stopping&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;patience&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s1">&#39;min_delta&#39;</span><span class="p">:</span> <span class="mf">0.001</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="ensemble-methods">Ensemble Methods</h2>
<h3 id="1-bagging">1. Bagging</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Bagging в AutoGluon</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
    <span class="n">num_bag_folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>    <span class="c1"># Количество фолдов для bagging</span>
    <span class="n">num_bag_sets</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>     <span class="c1"># Количество наборов</span>
    <span class="n">num_stack_levels</span><span class="o">=</span><span class="mi">1</span>  <span class="c1"># Уровни стекинга</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="2-boosting">2. Boosting</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Boosting алгоритмы</span>
<span class="n">hyperparameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;GBM&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">6</span>
    <span class="p">},</span>
    <span class="s1">&#39;XGB&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">6</span>
    <span class="p">},</span>
    <span class="s1">&#39;LGB&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">6</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="3-stacking">3. Stacking</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Стекинг моделей</span>
<span class="n">stacking_config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;num_bag_folds&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s1">&#39;num_bag_sets&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s1">&#39;num_stack_levels&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s1">&#39;stacker_models&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;GBM&#39;</span><span class="p">,</span> <span class="s1">&#39;XGB&#39;</span><span class="p">,</span> <span class="s1">&#39;LGB&#39;</span><span class="p">],</span>
    <span class="s1">&#39;stacker_hyperparameters&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;GBM&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="advanced-concepts">Advanced Concepts</h2>
<h3 id="1-multi-task-learning">1. Multi-Task Learning</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Мультизадачное обучение</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MultiTaskPredictor</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tasks</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="n">tasks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictors</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">predictors</span><span class="p">[</span><span class="n">task</span><span class="p">]</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
                <span class="n">label</span><span class="o">=</span><span class="n">task</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span>
                <span class="n">problem_type</span><span class="o">=</span><span class="n">task</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">task_name</span><span class="p">,</span> <span class="n">predictor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">task_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">task</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">task</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]]]</span>
            <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">task_data</span><span class="p">)</span>
</code></pre></div>

<h3 id="2-transfer-learning">2. Transfer Learning</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Трансферное обучение</span>
<span class="k">def</span><span class="w"> </span><span class="nf">transfer_learning</span><span class="p">(</span><span class="n">source_data</span><span class="p">,</span> <span class="n">target_data</span><span class="p">,</span> <span class="n">source_label</span><span class="p">,</span> <span class="n">target_label</span><span class="p">):</span>
    <span class="c1"># Обучение на исходных данных</span>
    <span class="n">source_predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">source_label</span><span class="p">)</span>
    <span class="n">source_predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">source_data</span><span class="p">)</span>

    <span class="c1"># Извлечение признаков</span>
    <span class="n">source_features</span> <span class="o">=</span> <span class="n">source_predictor</span><span class="o">.</span><span class="n">extract_features</span><span class="p">(</span><span class="n">target_data</span><span class="p">)</span>

    <span class="c1"># Обучение на целевых данных с извлеченными признаками</span>
    <span class="n">target_predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">target_label</span><span class="p">)</span>
    <span class="n">target_predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">source_features</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">target_predictor</span>
</code></pre></div>

<h3 id="3-meta-learning">3. Meta-Learning</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Мета-обучение для выбора алгоритмов</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MetaLearner</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_features</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">algorithm_performance</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">extract_meta_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Извлечение мета-признаков датасета&quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;n_samples&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">),</span>
            <span class="s1">&#39;n_features&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;n_classes&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()),</span>
            <span class="s1">&#39;missing_ratio&#39;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">columns</span><span class="p">)),</span>
            <span class="s1">&#39;categorical_ratio&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">recommend_algorithm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Рекомендация алгоритма на основе мета-признаков&quot;&quot;&quot;</span>
        <span class="n">meta_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_meta_features</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

        <span class="c1"># Простая эвристика</span>
        <span class="k">if</span> <span class="n">meta_features</span><span class="p">[</span><span class="s1">&#39;n_samples&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;GBM&#39;</span>
        <span class="k">elif</span> <span class="n">meta_features</span><span class="p">[</span><span class="s1">&#39;categorical_ratio&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;CAT&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;XGB&#39;</span>
</code></pre></div>

<h2 id="performance-optimization">Performance Optimization</h2>
<h3 id="1-memory-optimization">1. Memory Optimization</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Оптимизация памяти</span>
<span class="k">def</span><span class="w"> </span><span class="nf">optimize_memory</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Оптимизация использования памяти&quot;&quot;&quot;</span>

    <span class="c1"># Изменение типов данных</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;int64&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">128</span> <span class="ow">and</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">127</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int8&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">65535</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint16&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">32768</span> <span class="ow">and</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">32767</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int16&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>

    <span class="c1"># Оптимизация float типов</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float64&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>
</code></pre></div>

<h3 id="2-computational-optimization">2. Computational Optimization</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Оптимизация вычислений</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">multiprocessing</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mp</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parallel_processing</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Параллельная обработка данных&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">n_jobs</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">n_jobs</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>

    <span class="c1"># Разделение данных на части</span>
    <span class="n">chunk_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">//</span> <span class="n">n_jobs</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">chunk_size</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">)]</span>

    <span class="c1"># Параллельная обработка</span>
    <span class="k">with</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">n_jobs</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">process_chunk</span><span class="p">,</span> <span class="n">chunks</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</code></pre></div>

<h2 id="theoretical-guarantees">Theoretical Guarantees</h2>
<h3 id="1-convergence-guarantees">1. Convergence Guarantees</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Гарантии сходимости для различных алгоритмов</span>
<span class="n">convergence_guarantees</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;GBM&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;convergence_rate&#39;</span><span class="p">:</span> <span class="s1">&#39;O(1/sqrt(T))&#39;</span><span class="p">,</span>
        <span class="s1">&#39;conditions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;convex_loss&#39;</span><span class="p">,</span> <span class="s1">&#39;bounded_gradients&#39;</span><span class="p">],</span>
        <span class="s1">&#39;theorem&#39;</span><span class="p">:</span> <span class="s1">&#39;GBM converges to global optimum for convex loss&#39;</span>
    <span class="p">},</span>
    <span class="s1">&#39;XGB&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;convergence_rate&#39;</span><span class="p">:</span> <span class="s1">&#39;O(log(T)/T)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;conditions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;strongly_convex_loss&#39;</span><span class="p">,</span> <span class="s1">&#39;bounded_hessian&#39;</span><span class="p">],</span>
        <span class="s1">&#39;theorem&#39;</span><span class="p">:</span> <span class="s1">&#39;XGB converges with rate O(log(T)/T)&#39;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="2-generalization-bounds">2. Generalization Bounds</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Границы обобщения</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generalization_bound</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">delta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Граница обобщения для алгоритма&quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">math</span>

    <span class="c1"># VC dimension bound</span>
    <span class="n">vc_bound</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">d</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">delta</span><span class="p">))</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span>

    <span class="c1"># Rademacher complexity bound</span>
    <span class="n">rademacher_bound</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">vc_bound</span><span class="p">,</span> <span class="n">rademacher_bound</span><span class="p">)</span>
</code></pre></div>

<h2 id="research-frontiers">Research Frontiers</h2>
<h3 id="1-neural-architecture-search">1. Neural Architecture Search</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Современные методы NAS</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DARTS</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Differentiable Architecture Search&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">search_space</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">search_space</span> <span class="o">=</span> <span class="n">search_space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">architecture_weights</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Поиск архитектуры&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
            <span class="c1"># Обновление весов архитектуры</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_architecture_weights</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="c1"># Обновление весов модели</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_model_weights</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_architecture_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Обновление весов архитектуры&quot;&quot;&quot;</span>
        <span class="c1"># Реализация DARTS</span>
        <span class="k">pass</span>
</code></pre></div>

<h3 id="2-automl-for-time-series">2. AutoML for Time Series</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># AutoML для временных рядов</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.timeseries</span><span class="w"> </span><span class="kn">import</span> <span class="n">TimeSeriesPredictor</span>

<span class="k">def</span><span class="w"> </span><span class="nf">time_series_automl</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">prediction_length</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;AutoML для временных рядов&quot;&quot;&quot;</span>

    <span class="n">predictor</span> <span class="o">=</span> <span class="n">TimeSeriesPredictor</span><span class="p">(</span>
        <span class="n">prediction_length</span><span class="o">=</span><span class="n">prediction_length</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="s2">&quot;target&quot;</span><span class="p">,</span>
        <span class="n">time_limit</span><span class="o">=</span><span class="mi">3600</span>  <span class="c1"># 1 час</span>
    <span class="p">)</span>

    <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">predictor</span>
</code></pre></div>

<h2 id="_277">Заключение</h2>
<p>Понимание теоретических основ AutoML критически важно для:</p>
<ol>
<li><strong>Правильного выбора алгоритмов</strong> - знание сильных и слабых сторон</li>
<li><strong>Оптимизации производительности</strong> - понимание вычислительной сложности</li>
<li><strong>Интерпретации результатов</strong> - понимание статистических свойств</li>
<li><strong>Разработки новых методов</strong> - основа для инноваций</li>
</ol>
<p>Эти знания позволяют использовать AutoML Gluon не как "черный ящик", а как мощный инструмент с пониманием его внутренних механизмов.</p>
<hr />
<h1 id="_278">Интерпретируемость и объяснимость моделей</h1>
<p><strong>Автор:</strong> Shcherbyna Rostyslav<br />
<strong>Дата:</strong> 2024  </p>
<h2 id="_279">Почему интерпретируемость критически важна</h2>
<p><strong>Почему 90% ML-моделей в продакшене не имеют объяснений?</strong> Потому что команды фокусируются на точности, игнорируя необходимость понимания решений модели. Это как использование GPS без карты - вы доедете, но не поймете, как.</p>
<h3 id="_280">Катастрофические последствия необъяснимых моделей</h3>
<ul>
<li><strong>Потеря доверия</strong>: Пользователи не доверяют "черным ящикам"</li>
<li><strong>Регулятивные штрафы</strong>: GDPR штрафы до 4% от оборота компании</li>
<li><strong>Дискриминация</strong>: Модели могут принимать несправедливые решения</li>
<li><strong>Невозможность отладки</strong>: Нельзя исправить ошибки без понимания логики</li>
</ul>
<h3 id="_281">Преимущества интерпретируемых моделей</h3>
<ul>
<li><strong>Доверие пользователей</strong>: Понимание логики принятия решений</li>
<li><strong>Соответствие законам</strong>: GDPR, AI Act, другие регулятивные требования</li>
<li><strong>Лучшая отладка</strong>: Можно найти и исправить ошибки</li>
<li><strong>Улучшение модели</strong>: Понимание важности признаков</li>
</ul>
<h2 id="_282">Введение в интерпретируемость</h2>
<p><img alt="Интерпретируемость ML" src="images/interpretability_overview.png" /><br />
<em>Рисунок 15.1: Обзор методов интерпретируемости и объяснимости ML-моделей</em></p>
<p><strong>Почему интерпретируемость - это не роскошь, а необходимость?</strong> Потому что в современном мире ML-модели принимают решения, влияющие на жизни людей, и эти решения должны быть понятными и справедливыми.</p>
<p>Интерпретируемость машинного обучения - это способность понимать и объяснять решения, принимаемые ML-моделями. Это критически важно для:<br />
- <strong>Доверия к модели</strong> - понимание логики принятия решений<br />
- <strong>Соответствие регулятивным требованиям</strong> - GDPR, AI Act<br />
- <strong>Отладка моделей</strong> - выявление ошибок и смещений<br />
- <strong>Улучшение моделей</strong> - понимание важности признаков</p>
<h2 id="_283">Типы интерпретируемости</h2>
<h3 id="1-intrinsic-interpretability">1. Внутренняя интерпретируемость (Intrinsic Interpretability)</h3>
<p><strong>Почему внутренняя интерпретируемость - это золотой стандарт?</strong> Потому что модель сама по себе понятна, не требует дополнительных методов объяснения и дает точные интерпретации.</p>
<p>Модели, которые изначально интерпретируемы:</p>
<p><strong>Преимущества внутренней интерпретируемости:</strong><br />
- <strong>Точность</strong>: Интерпретации точно отражают логику модели<br />
- <strong>Простота</strong>: Не нужны дополнительные методы объяснения<br />
- <strong>Надежность</strong>: Интерпретации всегда доступны<br />
- <strong>Понятность</strong>: Логика модели прозрачна</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Линейная регрессия - внутренне интерпретируема</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># Создание интерпретируемой модели - простая и понятная</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># Коэффициенты показывают важность признаков - прямое понимание</span>
<span class="n">feature_importance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="p">)</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">columns</span>

<span class="c1"># Сортировка по важности - какие признаки важнее всего</span>
<span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">feature_importance</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Важность признаков:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">importance_df</span><span class="p">)</span>
</code></pre></div>

<h3 id="2-post-hoc-interpretability">2. Пост-хок интерпретируемость (Post-hoc Interpretability)</h3>
<p>Объяснение уже обученных "черных ящиков":</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># SHAP для объяснения любых моделей</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shap</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.tabular</span><span class="w"> </span><span class="kn">import</span> <span class="n">TabularPredictor</span>

<span class="c1"># Обучение модели</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">)</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>

<span class="c1"># Создание SHAP explainer</span>
<span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">predictor</span><span class="o">.</span><span class="n">get_model_best</span><span class="p">())</span>
<span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># Визуализация важности признаков</span>
<span class="n">shap</span><span class="o">.</span><span class="n">summary_plot</span><span class="p">(</span><span class="n">shap_values</span><span class="p">,</span> <span class="n">X_test</span><span class="p">)</span>
</code></pre></div>

<h2 id="_284">Методы глобальной интерпретируемости</h2>
<h3 id="1-feature-importance">1. Feature Importance</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_feature_importance</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;permutation&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Получение важности признаков различными методами&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;permutation&#39;</span><span class="p">:</span>
        <span class="c1"># Permutation importance</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.inspection</span><span class="w"> </span><span class="kn">import</span> <span class="n">permutation_importance</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">get_model_best</span><span class="p">()</span>
        <span class="n">perm_importance</span> <span class="o">=</span> <span class="n">permutation_importance</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">n_repeats</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">perm_importance</span><span class="o">.</span><span class="n">importances_mean</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;shap&#39;</span><span class="p">:</span>
        <span class="c1"># SHAP importance</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">shap</span>

        <span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">predictor</span><span class="o">.</span><span class="n">get_model_best</span><span class="p">())</span>
        <span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">shap_values</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;builtin&#39;</span><span class="p">:</span>
        <span class="c1"># Встроенная важность (для tree-based моделей)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">get_model_best</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;feature_importances_&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">feature_importances_</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model doesn&#39;t support built-in feature importance&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="2-partial-dependence-plots-pdp">2. Partial Dependence Plots (PDP)</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.inspection</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial_dependence</span><span class="p">,</span> <span class="n">plot_partial_dependence</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_pdp</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Построение графиков частичной зависимости&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">get_model_best</span><span class="p">()</span>

    <span class="c1"># PDP для одного признака</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">pdp</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">partial_dependence</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">grid_resolution</span><span class="o">=</span><span class="mi">50</span>
        <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pdp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Partial Dependence&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Partial Dependence Plot for </span><span class="si">{</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># PDP для двух признаков</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">pdp</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">partial_dependence</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">grid_resolution</span><span class="o">=</span><span class="mi">20</span>
        <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pdp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">levels</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Partial Dependence Plot for </span><span class="si">{</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> vs </span><span class="si">{</span><span class="n">features</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>

<h3 id="3-accumulated-local-effects-ale">3. Accumulated Local Effects (ALE)</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">alibi</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">alibi.explainers</span><span class="w"> </span><span class="kn">import</span> <span class="n">ALE</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_ale</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Построение ALE графиков&quot;&quot;&quot;</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">get_model_best</span><span class="p">()</span>

    <span class="c1"># Создание ALE explainer</span>
    <span class="n">ale</span> <span class="o">=</span> <span class="n">ALE</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

    <span class="c1"># Вычисление ALE</span>
    <span class="n">ale_exp</span> <span class="o">=</span> <span class="n">ale</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">)</span>

    <span class="c1"># Визуализация</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ale_exp</span><span class="o">.</span><span class="n">feature_values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ale_exp</span><span class="o">.</span><span class="n">ale_values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;ALE&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Accumulated Local Effects for </span><span class="si">{</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>

<h2 id="_285">Методы локальной интерпретируемости</h2>
<h3 id="1-lime-local-interpretable-model-agnostic-explanations">1. LIME (Local Interpretable Model-agnostic Explanations)</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">lime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lime.lime_tabular</span>

<span class="k">def</span><span class="w"> </span><span class="nf">explain_with_lime</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">instance_idx</span><span class="p">,</span> <span class="n">num_features</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Объяснение конкретного предсказания с помощью LIME&quot;&quot;&quot;</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">get_model_best</span><span class="p">()</span>

    <span class="c1"># Создание LIME explainer</span>
    <span class="n">explainer</span> <span class="o">=</span> <span class="n">lime</span><span class="o">.</span><span class="n">lime_tabular</span><span class="o">.</span><span class="n">LimeTabularExplainer</span><span class="p">(</span>
        <span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="n">feature_names</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
        <span class="n">class_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Class 0&#39;</span><span class="p">,</span> <span class="s1">&#39;Class 1&#39;</span><span class="p">],</span>
        <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;classification&#39;</span>
    <span class="p">)</span>

    <span class="c1"># Объяснение конкретного экземпляра</span>
    <span class="n">explanation</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">explain_instance</span><span class="p">(</span>
        <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">instance_idx</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">,</span>
        <span class="n">num_features</span><span class="o">=</span><span class="n">num_features</span>
    <span class="p">)</span>

    <span class="c1"># Визуализация</span>
    <span class="n">explanation</span><span class="o">.</span><span class="n">show_in_notebook</span><span class="p">(</span><span class="n">show_table</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">explanation</span>
</code></pre></div>

<h3 id="2-shap-shapley-additive-explanations">2. SHAP (SHapley Additive exPlanations)</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">shap</span>

<span class="k">def</span><span class="w"> </span><span class="nf">explain_with_shap</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">instance_idx</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Объяснение с помощью SHAP&quot;&quot;&quot;</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">get_model_best</span><span class="p">()</span>

    <span class="c1"># Создание SHAP explainer</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;predict_proba&#39;</span><span class="p">):</span>
        <span class="c1"># Для tree-based моделей</span>
        <span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">instance_idx</span><span class="p">:</span><span class="n">instance_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Для других моделей</span>
        <span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">Explainer</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">instance_idx</span><span class="p">:</span><span class="n">instance_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Водопадный график для конкретного предсказания</span>
    <span class="n">shap</span><span class="o">.</span><span class="n">waterfall_plot</span><span class="p">(</span><span class="n">explainer</span><span class="o">.</span><span class="n">expected_value</span><span class="p">,</span> <span class="n">shap_values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">instance_idx</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">shap_values</span>
</code></pre></div>

<h3 id="3-integrated-gradients">3. Integrated Gradients</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">tensorflow</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tf</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">integrated_gradients</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">baseline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Вычисление Integrated Gradients&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">baseline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">baseline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="c1"># Создание альфа значений</span>
    <span class="n">alphas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>

    <span class="c1"># Интерполяция между baseline и X</span>
    <span class="n">interpolated</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="n">alphas</span><span class="p">:</span>
        <span class="n">interpolated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">baseline</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">baseline</span><span class="p">))</span>

    <span class="n">interpolated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">interpolated</span><span class="p">)</span>

    <span class="c1"># Вычисление градиентов</span>
    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
        <span class="n">tape</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span><span class="n">interpolated</span><span class="p">)</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">interpolated</span><span class="p">)</span>

    <span class="n">gradients</span> <span class="o">=</span> <span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">interpolated</span><span class="p">)</span>

    <span class="c1"># Интегрирование градиентов</span>
    <span class="n">integrated_grads</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">gradients</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">baseline</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">integrated_grads</span>
</code></pre></div>

<h2 id="automl-gluon_9">Специфичные методы для AutoML Gluon</h2>
<h3 id="1-model-specific-interpretability">1. Model-specific Interpretability</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_model_specific_explanations</span><span class="p">(</span><span class="n">predictor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Получение объяснений специфичных для конкретной модели&quot;&quot;&quot;</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">get_model_best</span><span class="p">()</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">get_model_best</span><span class="p">()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="n">explanations</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="s1">&#39;XGB&#39;</span> <span class="ow">in</span> <span class="n">model_name</span> <span class="ow">or</span> <span class="s1">&#39;LGB&#39;</span> <span class="ow">in</span> <span class="n">model_name</span> <span class="ow">or</span> <span class="s1">&#39;GBM&#39;</span> <span class="ow">in</span> <span class="n">model_name</span><span class="p">:</span>
        <span class="c1"># Tree-based модели</span>
        <span class="n">explanations</span><span class="p">[</span><span class="s1">&#39;feature_importance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">feature_importances_</span>
        <span class="n">explanations</span><span class="p">[</span><span class="s1">&#39;tree_structure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_booster</span><span class="p">()</span><span class="o">.</span><span class="n">get_dump</span><span class="p">()</span>

    <span class="k">elif</span> <span class="s1">&#39;Neural&#39;</span> <span class="ow">in</span> <span class="n">model_name</span> <span class="ow">or</span> <span class="s1">&#39;TabNet&#39;</span> <span class="ow">in</span> <span class="n">model_name</span><span class="p">:</span>
        <span class="c1"># Нейронные сети</span>
        <span class="n">explanations</span><span class="p">[</span><span class="s1">&#39;attention_weights&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">attention_weights</span>
        <span class="n">explanations</span><span class="p">[</span><span class="s1">&#39;feature_embeddings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">feature_embeddings</span>

    <span class="k">elif</span> <span class="s1">&#39;Linear&#39;</span> <span class="ow">in</span> <span class="n">model_name</span> <span class="ow">or</span> <span class="s1">&#39;Logistic&#39;</span> <span class="ow">in</span> <span class="n">model_name</span><span class="p">:</span>
        <span class="c1"># Линейные модели</span>
        <span class="n">explanations</span><span class="p">[</span><span class="s1">&#39;coefficients&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">coef_</span>
        <span class="n">explanations</span><span class="p">[</span><span class="s1">&#39;intercept&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">intercept_</span>

    <span class="k">return</span> <span class="n">explanations</span>
</code></pre></div>

<h3 id="2-ensemble-interpretability">2. Ensemble Interpretability</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">explain_ensemble</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Объяснение ансамбля моделей&quot;&quot;&quot;</span>

    <span class="n">models</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">get_model_names</span><span class="p">()</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">get_model_weights</span><span class="p">()</span>

    <span class="n">explanations</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;weighted&#39;</span><span class="p">:</span>
            <span class="c1"># Взвешенное объяснение</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;feature_importances_&#39;</span><span class="p">):</span>
                <span class="n">importance</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">feature_importances_</span> <span class="o">*</span> <span class="n">weight</span>
                <span class="n">explanations</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">importance</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;shap&#39;</span><span class="p">:</span>
            <span class="c1"># SHAP для каждой модели</span>
            <span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">explanations</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">shap_values</span> <span class="o">*</span> <span class="n">weight</span>

    <span class="c1"># Агрегация объяснений</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;weighted&#39;</span><span class="p">:</span>
        <span class="n">ensemble_importance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">explanations</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ensemble_importance</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;shap&#39;</span><span class="p">:</span>
        <span class="n">ensemble_shap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">explanations</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ensemble_shap</span>
</code></pre></div>

<h2 id="_286">Визуализация объяснений</h2>
<h3 id="1-comprehensive-explanation-dashboard">1. Comprehensive Explanation Dashboard</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_explanation_dashboard</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">instance_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Создание комплексной панели объяснений&quot;&quot;&quot;</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Comprehensive Model Explanation Dashboard&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

    <span class="c1"># 1. Feature Importance</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">importance</span> <span class="o">=</span> <span class="n">get_feature_importance</span><span class="p">(</span><span class="n">predictor</span><span class="p">)</span>
    <span class="n">feature_names</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">sorted_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">importance</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="mi">10</span><span class="p">]</span>

    <span class="n">ax1</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sorted_idx</span><span class="p">)),</span> <span class="n">importance</span><span class="p">[</span><span class="n">sorted_idx</span><span class="p">])</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sorted_idx</span><span class="p">)))</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="n">feature_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sorted_idx</span><span class="p">])</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 10 Feature Importance&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Importance&#39;</span><span class="p">)</span>

    <span class="c1"># 2. SHAP Summary</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">get_model_best</span><span class="p">()</span>
    <span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">100</span><span class="p">])</span>  <span class="c1"># Первые 100 образцов</span>

    <span class="n">shap</span><span class="o">.</span><span class="n">summary_plot</span><span class="p">(</span><span class="n">shap_values</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">100</span><span class="p">],</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;SHAP Summary Plot&#39;</span><span class="p">)</span>

    <span class="c1"># 3. Partial Dependence</span>
    <span class="n">ax3</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">top_feature</span> <span class="o">=</span> <span class="n">feature_names</span><span class="p">[</span><span class="n">sorted_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">pdp</span><span class="p">,</span> <span class="n">axes_pdp</span> <span class="o">=</span> <span class="n">partial_dependence</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="p">[</span><span class="n">top_feature</span><span class="p">])</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">axes_pdp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pdp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">top_feature</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Partial Dependence&#39;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;PDP for </span><span class="si">{</span><span class="n">top_feature</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># 4. Local Explanation (LIME)</span>
    <span class="n">ax4</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Здесь будет LIME объяснение для конкретного экземпляра</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;LIME Explanation</span><span class="se">\n</span><span class="s1">for Instance&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax4</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Local Explanation (LIME)&#39;</span><span class="p">)</span>

    <span class="c1"># 5. Model Performance</span>
    <span class="n">ax5</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="n">ax5</span><span class="o">.</span><span class="n">bar</span><span class="p">([</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">],</span> <span class="p">[</span><span class="n">accuracy</span><span class="p">])</span>
    <span class="n">ax5</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax5</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Model Performance&#39;</span><span class="p">)</span>
    <span class="n">ax5</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>

    <span class="c1"># 6. Prediction Distribution</span>
    <span class="n">ax6</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">probabilities</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">probabilities</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ax6</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">probabilities</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">ax6</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Prediction Probability&#39;</span><span class="p">)</span>
        <span class="n">ax6</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
        <span class="n">ax6</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Prediction Distribution&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>

<h3 id="2-interactive-explanations">2. Interactive Explanations</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">plotly.graph_objects</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">go</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">plotly.subplots</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_subplots</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_interactive_explanation</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">instance_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Создание интерактивных объяснений&quot;&quot;&quot;</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">get_model_best</span><span class="p">()</span>

    <span class="c1"># SHAP значения</span>
    <span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">instance_idx</span><span class="p">:</span><span class="n">instance_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Создание интерактивного графика</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

    <span class="c1"># Waterfall plot</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">shap_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">values</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;SHAP Values&#39;</span><span class="p">,</span>
        <span class="n">marker_color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;red&#39;</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;green&#39;</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
    <span class="p">))</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;SHAP Values for Instance </span><span class="si">{</span><span class="n">instance_idx</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="n">xaxis_title</span><span class="o">=</span><span class="s1">&#39;Features&#39;</span><span class="p">,</span>
        <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">&#39;SHAP Value&#39;</span><span class="p">,</span>
        <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span>
</code></pre></div>

<h2 id="_287">Практические рекомендации</h2>
<h3 id="1_23">1. Выбор метода объяснения</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">choose_explanation_method</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">data_size</span><span class="p">,</span> <span class="n">interpretability_requirement</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Выбор подходящего метода объяснения&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">interpretability_requirement</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span><span class="p">:</span>
        <span class="c1"># Высокие требования к интерпретируемости</span>
        <span class="k">if</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Linear&#39;</span><span class="p">,</span> <span class="s1">&#39;Logistic&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="s1">&#39;coefficients&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;lime&#39;</span>

    <span class="k">elif</span> <span class="n">interpretability_requirement</span> <span class="o">==</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span>
        <span class="c1"># Средние требования</span>
        <span class="k">if</span> <span class="n">data_size</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;shap&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;permutation_importance&#39;</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Низкие требования</span>
        <span class="k">return</span> <span class="s1">&#39;feature_importance&#39;</span>
</code></pre></div>

<h3 id="2_21">2. Валидация объяснений</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validate_explanations</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">explanation_method</span><span class="o">=</span><span class="s1">&#39;shap&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Валидация качества объяснений&quot;&quot;&quot;</span>

    <span class="c1"># Создание объяснений</span>
    <span class="k">if</span> <span class="n">explanation_method</span> <span class="o">==</span> <span class="s1">&#39;shap&#39;</span><span class="p">:</span>
        <span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">predictor</span><span class="o">.</span><span class="n">get_model_best</span><span class="p">())</span>
        <span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># Проверка согласованности</span>
        <span class="n">consistency_score</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">consistency_score</span><span class="p">(</span><span class="n">shap_values</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;consistency_score&#39;</span><span class="p">:</span> <span class="n">consistency_score</span><span class="p">,</span>
            <span class="s1">&#39;explanation_quality&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span> <span class="k">if</span> <span class="n">consistency_score</span> <span class="o">&gt;</span> <span class="mf">0.8</span> <span class="k">else</span> <span class="s1">&#39;medium&#39;</span>
        <span class="p">}</span>

    <span class="k">elif</span> <span class="n">explanation_method</span> <span class="o">==</span> <span class="s1">&#39;lime&#39;</span><span class="p">:</span>
        <span class="c1"># Валидация LIME</span>
        <span class="n">lime_explainer</span> <span class="o">=</span> <span class="n">lime</span><span class="o">.</span><span class="n">lime_tabular</span><span class="o">.</span><span class="n">LimeTabularExplainer</span><span class="p">(</span>
            <span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># Тестирование на нескольких экземплярах</span>
        <span class="n">fidelity_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">))):</span>
            <span class="n">explanation</span> <span class="o">=</span> <span class="n">lime_explainer</span><span class="o">.</span><span class="n">explain_instance</span><span class="p">(</span>
                <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict_proba</span>
            <span class="p">)</span>
            <span class="n">fidelity_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">explanation</span><span class="o">.</span><span class="n">score</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;average_fidelity&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fidelity_scores</span><span class="p">),</span>
            <span class="s1">&#39;explanation_quality&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fidelity_scores</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.8</span> <span class="k">else</span> <span class="s1">&#39;medium&#39;</span>
        <span class="p">}</span>
</code></pre></div>

<h2 id="_288">Заключение</h2>
<p>Интерпретируемость и объяснимость критически важны для:</p>
<ol>
<li><strong>Доверия к модели</strong> - понимание логики принятия решений</li>
<li><strong>Соответствия требованиям</strong> - GDPR, AI Act, регулятивные требования</li>
<li><strong>Отладки и улучшения</strong> - выявление проблем и возможностей оптимизации</li>
<li><strong>Бизнес-ценности</strong> - понимание факторов, влияющих на результат</li>
</ol>
<p>Правильное использование методов интерпретируемости позволяет создавать не только точные, но и понятные и надежные ML-модели.</p>
<hr />
<h1 id="automl_4">Продвинутые темы AutoML</h1>
<p><strong>Автор:</strong> Shcherbyna Rostyslav<br />
<strong>Дата:</strong> 2024  </p>
<h2 id="_289">Почему продвинутые темы критически важны</h2>
<p><strong>Почему 95% ML-инженеров не знают о продвинутых техниках?</strong> Потому что они фокусируются на базовых алгоритмах, не понимая, что современные методы могут дать в 10-100 раз лучшие результаты.</p>
<h3 id="_290">Проблемы без знания продвинутых тем</h3>
<ul>
<li><strong>Устаревшие методы</strong>: Используют техники 5-летней давности</li>
<li><strong>Плохие результаты</strong>: Не могут достичь state-of-the-art производительности</li>
<li><strong>Потеря конкурентоспособности</strong>: Отстают от команд, использующих современные методы</li>
<li><strong>Ограниченные возможности</strong>: Не могут решать сложные задачи</li>
</ul>
<h3 id="_291">Преимущества знания продвинутых тем</h3>
<ul>
<li><strong>Лучшие результаты</strong>: State-of-the-art производительность</li>
<li><strong>Конкурентоспособность</strong>: Используют самые современные методы</li>
<li><strong>Решение сложных задач</strong>: Могут работать с мультимодальными данными</li>
<li><strong>Инновации</strong>: Могут создавать новые решения</li>
</ul>
<h2 id="_292">Введение в продвинутые темы</h2>
<p><img alt="Продвинутые темы AutoML" src="images/advanced_topics_overview.png" /><br />
<em>Рисунок 16.1: Обзор продвинутых тем и современных направлений в AutoML</em></p>
<p><strong>Почему продвинутые темы - это будущее ML?</strong> Потому что они решают проблемы, которые невозможно решить традиционными методами: автоматический дизайн архитектур, обучение на малых данных, мультимодальное понимание.</p>
<p>Этот раздел охватывает передовые темы и современные направления в области автоматизированного машинного обучения, включая нейроархитектурный поиск, мета-обучение, мультимодальное обучение и другие cutting-edge технологии.</p>
<h2 id="neural-architecture-search-nas">Neural Architecture Search (NAS)</h2>
<h3 id="1-differentiable-architecture-search-darts">1. Differentiable Architecture Search (DARTS)</h3>
<p><strong>Почему DARTS - это революция в дизайне нейросетей?</strong> Потому что он позволяет искать архитектуры через градиентный спуск, что в 1000 раз быстрее традиционных методов поиска.</p>
<p><strong>Преимущества DARTS:</strong><br />
- <strong>Скорость</strong>: В 1000 раз быстрее случайного поиска<br />
- <strong>Качество</strong>: Находит архитектуры лучше созданных человеком<br />
- <strong>Гибкость</strong>: Может искать любые типы операций<br />
- <strong>Масштабируемость</strong>: Работает с большими датасетами</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DARTS</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Differentiable Architecture Search - автоматический дизайн нейросетей&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_channels</span><span class="p">,</span> <span class="n">output_channels</span><span class="p">,</span> <span class="n">num_ops</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DARTS</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_channels</span> <span class="o">=</span> <span class="n">input_channels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_channels</span> <span class="o">=</span> <span class="n">output_channels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_ops</span> <span class="o">=</span> <span class="n">num_ops</span>

        <span class="c1"># Операции - кандидаты для архитектуры</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ops</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">input_channels</span><span class="p">,</span> <span class="n">output_channels</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>      <span class="c1"># 1x1 conv</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">input_channels</span><span class="p">,</span> <span class="n">output_channels</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>  <span class="c1"># 3x3 conv</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">input_channels</span><span class="p">,</span> <span class="n">output_channels</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>  <span class="c1"># 5x5 conv</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>                          <span class="c1"># Max pooling</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">AvgPool2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>                          <span class="c1"># Average pooling</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span> <span class="k">if</span> <span class="n">input_channels</span> <span class="o">==</span> <span class="n">output_channels</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Identity</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">input_channels</span><span class="p">,</span> <span class="n">output_channels</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dilation</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>  <span class="c1"># Dilated conv</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">input_channels</span><span class="p">,</span> <span class="n">output_channels</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dilation</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>   <span class="c1"># Dilated conv</span>
        <span class="p">])</span>

        <span class="c1"># Архитектурные веса - что оптимизируется</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">num_ops</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="c1"># Softmax для архитектурных весов - нормализация весов</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Взвешенная сумма операций - комбинация всех операций</span>
        <span class="n">output</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">op</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">op</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">)</span> <span class="k">if</span> <span class="n">op</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">output</span>

<span class="c1"># Использование DARTS</span>
<span class="k">def</span><span class="w"> </span><span class="nf">search_architecture</span><span class="p">(</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Поиск архитектуры с помощью DARTS&quot;&quot;&quot;</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">DARTS</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">output_channels</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.025</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
        <span class="c1"># Обновление архитектурных весов</span>
        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_loader</span><span class="p">):</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="c1"># Валидация</span>
        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">val_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">val_loader</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">val_loss</span> <span class="o">+=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">, Validation Loss: </span><span class="si">{</span><span class="n">val_loss</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span>
</code></pre></div>

<h3 id="2-efficient-neural-architecture-search-enas">2. Efficient Neural Architecture Search (ENAS)</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ENAS</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Efficient Neural Architecture Search&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_nodes</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">num_ops</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ENAS</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_nodes</span> <span class="o">=</span> <span class="n">num_nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_ops</span> <span class="o">=</span> <span class="n">num_ops</span>

        <span class="c1"># Контроллер (RNN)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">controller</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">controller_output</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">num_nodes</span> <span class="o">*</span> <span class="n">num_ops</span><span class="p">)</span>

        <span class="c1"># Операции</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ops</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">AvgPool2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dilation</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dilation</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
        <span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sample_architecture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Сэмплирование архитектуры&quot;&quot;&quot;</span>
        <span class="c1"># Генерация архитектуры через контроллер</span>
        <span class="n">hidden</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>  <span class="c1"># LSTM hidden state</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">):</span>
            <span class="n">output</span><span class="p">,</span> <span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="n">hidden</span><span class="p">)</span>
            <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_output</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
            <span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_ops</span><span class="p">)</span>
            <span class="n">probs</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">outputs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">architecture</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">architecture</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">architecture</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_architecture</span><span class="p">()</span>

        <span class="c1"># Применение архитектуры</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">op_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">architecture</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="n">op_idx</span><span class="p">](</span><span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span>
</code></pre></div>

<h2 id="meta-learning">Meta-Learning</h2>
<h3 id="1-model-agnostic-meta-learning-maml">1. Model-Agnostic Meta-Learning (MAML)</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MAML</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Model-Agnostic Meta-Learning&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MAML</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">lr</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">meta_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">support_set</span><span class="p">,</span> <span class="n">query_set</span><span class="p">,</span> <span class="n">num_inner_steps</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Мета-обновление модели&quot;&quot;&quot;</span>

        <span class="c1"># Копирование параметров</span>
        <span class="n">fast_weights</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">param</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">()}</span>

        <span class="c1"># Внутренние обновления</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_inner_steps</span><span class="p">):</span>
            <span class="c1"># Forward pass на support set</span>
            <span class="n">support_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_with_weights</span><span class="p">(</span><span class="n">support_set</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fast_weights</span><span class="p">)</span>
            <span class="n">support_loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">support_pred</span><span class="p">,</span> <span class="n">support_set</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="c1"># Градиенты</span>
            <span class="n">grads</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">support_loss</span><span class="p">,</span> <span class="n">fast_weights</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">create_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Обновление весов</span>
            <span class="n">fast_weights</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">weight</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">*</span> <span class="n">grad</span> 
                          <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">weight</span><span class="p">),</span> <span class="n">grad</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fast_weights</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">grads</span><span class="p">)}</span>

        <span class="c1"># Оценка на query set</span>
        <span class="n">query_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_with_weights</span><span class="p">(</span><span class="n">query_set</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fast_weights</span><span class="p">)</span>
        <span class="n">query_loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">query_pred</span><span class="p">,</span> <span class="n">query_set</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">query_loss</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward_with_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Forward pass с заданными весами&quot;&quot;&quot;</span>
        <span class="c1"># Реализация forward pass с custom весами</span>
        <span class="k">pass</span>
</code></pre></div>

<h3 id="2-prototypical-networks">2. Prototypical Networks</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PrototypicalNetworks</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prototypical Networks для few-shot learning&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">64</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PrototypicalNetworks</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">support_set</span><span class="p">,</span> <span class="n">query_set</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Forward pass для few-shot learning&quot;&quot;&quot;</span>

        <span class="c1"># Кодирование support set</span>
        <span class="n">support_embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">support_set</span><span class="p">)</span>

        <span class="c1"># Вычисление прототипов классов</span>
        <span class="n">prototypes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_classes</span><span class="p">):</span>
            <span class="n">class_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">support_set</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>  <span class="c1"># Предполагаем, что последний столбец - это класс</span>
            <span class="n">class_embeddings</span> <span class="o">=</span> <span class="n">support_embeddings</span><span class="p">[</span><span class="n">class_mask</span><span class="p">]</span>
            <span class="n">prototype</span> <span class="o">=</span> <span class="n">class_embeddings</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">prototypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prototype</span><span class="p">)</span>

        <span class="n">prototypes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">prototypes</span><span class="p">)</span>

        <span class="c1"># Кодирование query set</span>
        <span class="n">query_embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">query_set</span><span class="p">)</span>

        <span class="c1"># Вычисление расстояний до прототипов</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cdist</span><span class="p">(</span><span class="n">query_embeddings</span><span class="p">,</span> <span class="n">prototypes</span><span class="p">)</span>

        <span class="c1"># Предсказания (ближайший прототип)</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">distances</span>
</code></pre></div>

<h2 id="multi-modal-learning">Multi-Modal Learning</h2>
<h3 id="1-vision-language-models">1. Vision-Language Models</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">VisionLanguageModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Мультимодальная модель для изображений и текста&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_dim</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">text_dim</span><span class="o">=</span><span class="mi">768</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">512</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">VisionLanguageModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Визуальный энкодер</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vision_encoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">image_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Текстовый энкодер</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">text_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Фьюжн модуль</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fusion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">texts</span><span class="p">):</span>
        <span class="c1"># Кодирование изображений</span>
        <span class="n">image_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vision_encoder</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>

        <span class="c1"># Кодирование текста</span>
        <span class="n">text_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>

        <span class="c1"># Объединение признаков</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">image_features</span><span class="p">,</span> <span class="n">text_features</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Предсказание</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fusion</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">output</span>
</code></pre></div>

<h3 id="2-cross-modal-attention">2. Cross-Modal Attention</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CrossModalAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cross-modal attention для мультимодального обучения&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CrossModalAttention</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="n">dim</span>

        <span class="c1"># Attention механизмы</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attention</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MultiheadAttention</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">num_heads</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

        <span class="c1"># Нормализация</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>

        <span class="c1"># Feed-forward</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modality1</span><span class="p">,</span> <span class="n">modality2</span><span class="p">):</span>
        <span class="c1"># Cross-attention между модальностями</span>
        <span class="n">attended1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention</span><span class="p">(</span><span class="n">modality1</span><span class="p">,</span> <span class="n">modality2</span><span class="p">,</span> <span class="n">modality2</span><span class="p">)</span>
        <span class="n">attended1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm1</span><span class="p">(</span><span class="n">attended1</span> <span class="o">+</span> <span class="n">modality1</span><span class="p">)</span>

        <span class="n">attended2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention</span><span class="p">(</span><span class="n">modality2</span><span class="p">,</span> <span class="n">modality1</span><span class="p">,</span> <span class="n">modality1</span><span class="p">)</span>
        <span class="n">attended2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm1</span><span class="p">(</span><span class="n">attended2</span> <span class="o">+</span> <span class="n">modality2</span><span class="p">)</span>

        <span class="c1"># Feed-forward</span>
        <span class="n">output1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm2</span><span class="p">(</span><span class="n">attended1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ff</span><span class="p">(</span><span class="n">attended1</span><span class="p">))</span>
        <span class="n">output2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm2</span><span class="p">(</span><span class="n">attended2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ff</span><span class="p">(</span><span class="n">attended2</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">output1</span><span class="p">,</span> <span class="n">output2</span>
</code></pre></div>

<h2 id="federated-learning">Federated Learning</h2>
<h3 id="1-federated-averaging-fedavg">1. Federated Averaging (FedAvg)</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">FederatedAveraging</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Federated Averaging для распределенного обучения&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">global_model</span><span class="p">,</span> <span class="n">clients</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_model</span> <span class="o">=</span> <span class="n">global_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clients</span> <span class="o">=</span> <span class="n">clients</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">federated_round</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Один раунд федеративного обучения&quot;&quot;&quot;</span>

        <span class="c1"># Обучение на клиентах</span>
        <span class="n">client_models</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">client_weights</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">client</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="p">:</span>
            <span class="c1"># Локальное обучение</span>
            <span class="n">local_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_client</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">)</span>
            <span class="n">client_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">local_model</span><span class="p">)</span>
            <span class="n">client_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>  <span class="c1"># Вес пропорционален размеру данных</span>

        <span class="c1"># Агрегация моделей</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aggregate_models</span><span class="p">(</span><span class="n">client_models</span><span class="p">,</span> <span class="n">client_weights</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">train_client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Обучение модели на клиенте&quot;&quot;&quot;</span>

        <span class="c1"># Копирование глобальной модели</span>
        <span class="n">local_model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">global_model</span><span class="p">)</span>

        <span class="c1"># Локальное обучение</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">local_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">data_loader</span><span class="p">:</span>
                <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">local_model</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">batch</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">local_model</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">aggregate_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_models</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Агрегация моделей с учетом весов&quot;&quot;&quot;</span>

        <span class="n">total_weight</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

        <span class="c1"># Инициализация глобальной модели</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
            <span class="n">param</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>

        <span class="c1"># Взвешенное усреднение</span>
        <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">client_models</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">global_param</span><span class="p">,</span> <span class="n">local_param</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">global_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()):</span>
                <span class="n">global_param</span><span class="o">.</span><span class="n">data</span> <span class="o">+=</span> <span class="n">local_param</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="p">(</span><span class="n">weight</span> <span class="o">/</span> <span class="n">total_weight</span><span class="p">)</span>
</code></pre></div>

<h3 id="2-differential-privacy">2. Differential Privacy</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DifferentialPrivacy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Differential Privacy для защиты приватности&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="n">epsilon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="n">delta</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gradients</span><span class="p">,</span> <span class="n">sensitivity</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Добавление шума для обеспечения дифференциальной приватности&quot;&quot;&quot;</span>

        <span class="c1"># Вычисление стандартного отклонения шума</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.25</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">))</span> <span class="o">*</span> <span class="n">sensitivity</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span>

        <span class="c1"># Добавление гауссовского шума</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">gradients</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">noisy_gradients</span> <span class="o">=</span> <span class="n">gradients</span> <span class="o">+</span> <span class="n">noise</span>

        <span class="k">return</span> <span class="n">noisy_gradients</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">clip_gradients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gradients</span><span class="p">,</span> <span class="n">max_norm</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Обрезка градиентов для ограничения чувствительности&quot;&quot;&quot;</span>

        <span class="c1"># L2 нормализация</span>
        <span class="n">grad_norm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">gradients</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">grad_norm</span> <span class="o">&gt;</span> <span class="n">max_norm</span><span class="p">:</span>
            <span class="n">gradients</span> <span class="o">=</span> <span class="n">gradients</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_norm</span> <span class="o">/</span> <span class="n">grad_norm</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">gradients</span>
</code></pre></div>

<h2 id="continual-learning">Continual Learning</h2>
<h3 id="1-elastic-weight-consolidation-ewc">1. Elastic Weight Consolidation (EWC)</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ElasticWeightConsolidation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Elastic Weight Consolidation для непрерывного обучения&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">lambda_ewc</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_ewc</span> <span class="o">=</span> <span class="n">lambda_ewc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fisher_information</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimal_params</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_fisher_information</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataloader</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Вычисление информации Фишера&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">fisher_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
            <span class="n">fisher_info</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">batch</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fisher_info</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">+=</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="c1"># Нормализация</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">fisher_info</span><span class="p">:</span>
            <span class="n">fisher_info</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fisher_information</span> <span class="o">=</span> <span class="n">fisher_info</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ewc_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_loss</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Добавление EWC регуляризации к loss&quot;&quot;&quot;</span>

        <span class="n">ewc_loss</span> <span class="o">=</span> <span class="n">current_loss</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fisher_information</span><span class="p">:</span>
                <span class="n">ewc_loss</span> <span class="o">+=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambda_ewc</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fisher_information</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">param</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimal_params</span><span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">ewc_loss</span>
</code></pre></div>

<h3 id="2-progressive-neural-networks">2. Progressive Neural Networks</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ProgressiveNeuralNetwork</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Progressive Neural Networks для непрерывного обучения&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">64</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ProgressiveNeuralNetwork</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lateral_connections</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>

        <span class="c1"># Первая колонка</span>
        <span class="n">first_column</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">first_column</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">64</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Добавление новой колонки для новой задачи&quot;&quot;&quot;</span>

        <span class="c1"># Новая колонка</span>
        <span class="n">new_column</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_column</span><span class="p">)</span>

        <span class="c1"># Боковые соединения с предыдущими колонками</span>
        <span class="n">lateral_conn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">lateral_conn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lateral_connections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lateral_conn</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">column_idx</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Forward pass для конкретной колонки&quot;&quot;&quot;</span>

        <span class="c1"># Основной путь через текущую колонку</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">column_idx</span><span class="p">](</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># Боковые соединения с предыдущими колонками</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">column_idx</span><span class="p">):</span>
            <span class="n">lateral_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lateral_connections</span><span class="p">[</span><span class="n">column_idx</span><span class="p">][</span><span class="n">i</span><span class="p">](</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">x</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">output</span> <span class="o">+</span> <span class="n">lateral_output</span>

        <span class="k">return</span> <span class="n">output</span>
</code></pre></div>

<h2 id="quantum-machine-learning">Quantum Machine Learning</h2>
<h3 id="1-quantum-neural-networks">1. Quantum Neural Networks</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Пример с использованием PennyLane</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pennylane</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">qml</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">quantum_neural_network</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Квантовая нейронная сеть&quot;&quot;&quot;</span>

    <span class="c1"># Кодирование данных</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
        <span class="n">qml</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">wires</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>

    <span class="c1"># Параметризованные слои</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
            <span class="n">qml</span><span class="o">.</span><span class="n">RY</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">layer</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">wires</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># Энтangling gates</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">qml</span><span class="o">.</span><span class="n">CNOT</span><span class="p">(</span><span class="n">wires</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Измерение</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">qml</span><span class="o">.</span><span class="n">expval</span><span class="p">(</span><span class="n">qml</span><span class="o">.</span><span class="n">PauliZ</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))]</span>

<span class="c1"># Создание квантового устройства</span>
<span class="n">dev</span> <span class="o">=</span> <span class="n">qml</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;default.qubit&#39;</span><span class="p">,</span> <span class="n">wires</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

<span class="c1"># Создание QNode</span>
<span class="n">qnode</span> <span class="o">=</span> <span class="n">qml</span><span class="o">.</span><span class="n">QNode</span><span class="p">(</span><span class="n">quantum_neural_network</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span>

<span class="c1"># Обучение квантовой модели</span>
<span class="k">def</span><span class="w"> </span><span class="nf">train_quantum_model</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Обучение квантовой нейронной сети&quot;&quot;&quot;</span>

    <span class="c1"># Инициализация параметров</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="p">(</span><span class="n">num_layers</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>

    <span class="c1"># Оптимизатор</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">qml</span><span class="o">.</span><span class="n">GradientDescentOptimizer</span><span class="p">(</span><span class="n">stepsize</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="c1"># Вычисление градиентов</span>
        <span class="n">grads</span> <span class="o">=</span> <span class="n">qml</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">qnode</span><span class="p">)(</span><span class="n">params</span><span class="p">,</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Обновление параметров</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">qnode</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">iteration</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">, Cost: </span><span class="si">{</span><span class="n">qnode</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">params</span>
</code></pre></div>

<h2 id="_293">Заключение</h2>
<p>Продвинутые темы AutoML представляют собой быстро развивающуюся область, включающую:</p>
<ol>
<li><strong>Neural Architecture Search</strong> - автоматический поиск оптимальных архитектур</li>
<li><strong>Meta-Learning</strong> - обучение тому, как учиться</li>
<li><strong>Multi-Modal Learning</strong> - работа с различными типами данных</li>
<li><strong>Federated Learning</strong> - распределенное обучение с сохранением приватности</li>
<li><strong>Continual Learning</strong> - непрерывное обучение без забывания</li>
<li><strong>Quantum Machine Learning</strong> - использование квантовых вычислений</li>
</ol>
<p>Эти технологии открывают новые возможности для создания более эффективных, адаптивных и мощных ML-систем, но требуют глубокого понимания как теоретических основ, так и практических аспектов их применения.</p>
<hr />
<h1 id="ai">Этика и ответственный AI</h1>
<p><strong>Автор:</strong> Shcherbyna Rostyslav<br />
<strong>Дата:</strong> 2024  </p>
<h2 id="ai_1">Почему этика AI критически важна</h2>
<p><strong>Почему 90% ML-моделей в продакшене нарушают этические принципы?</strong> Потому что команды фокусируются на технических метриках, игнорируя этические последствия. Это как создание оружия без понимания, как его будут использовать.</p>
<h3 id="ai_2">Катастрофические последствия неэтичного AI</h3>
<ul>
<li><strong>Дискриминация</strong>: Модели могут принимать несправедливые решения</li>
<li><strong>Регулятивные штрафы</strong>: GDPR штрафы до 4% от оборота компании</li>
<li><strong>Потеря репутации</strong>: Публичные скандалы из-за предвзятости</li>
<li><strong>Юридические проблемы</strong>: Судебные иски за дискриминацию</li>
</ul>
<h3 id="ai_3">Преимущества этичного AI</h3>
<ul>
<li><strong>Доверие пользователей</strong>: Справедливые и понятные решения</li>
<li><strong>Соответствие законам</strong>: GDPR, AI Act, другие регулятивные требования</li>
<li><strong>Лучшая репутация</strong>: Компания воспринимается как ответственная</li>
<li><strong>Долгосрочный успех</strong>: Устойчивое развитие бизнеса</li>
</ul>
<h2 id="ai_4">Введение в этику AI</h2>
<p><img alt="Этика и ответственный AI" src="images/ai_ethics_overview.png" /><br />
<em>Рисунок 17.1: Принципы этичного и ответственного использования искусственного интеллекта</em></p>
<p><strong>Почему этика AI - это не просто "хорошо быть хорошим"?</strong> Потому что неэтичные AI-системы могут причинить реальный вред людям и привести к серьезным юридическим и репутационным проблемам.</p>
<p>Разработка и использование ML-моделей несут значительную ответственность. Этот раздел охватывает этические принципы, правовые требования и лучшие практики для создания ответственных AI-систем.</p>
<h2 id="ai_5">Основные принципы этичного AI</h2>
<h3 id="1_24">1. Справедливость и отсутствие дискриминации</h3>
<p><strong>Почему справедливость - это основа этичного AI?</strong> Потому что несправедливые модели могут дискриминировать людей по полу, расе, возрасту и другим признакам, что недопустимо в современном обществе.</p>
<p><strong>Почему модели могут быть несправедливыми?</strong><br />
- <strong>Предвзятые данные</strong>: Исторические данные содержат дискриминацию<br />
- <strong>Неправильные признаки</strong>: Использование чувствительных атрибутов<br />
- <strong>Неравномерное качество</strong>: Модель работает хуже для некоторых групп<br />
- <strong>Скрытые смещения</strong>: Неочевидные паттерны дискриминации</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">confusion_matrix</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="k">def</span><span class="w"> </span><span class="nf">check_fairness</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">sensitive_attributes</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Проверка справедливости модели - критически важно для этичного AI&quot;&quot;&quot;</span>

    <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

    <span class="n">fairness_metrics</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">sensitive_attributes</span><span class="p">:</span>
        <span class="c1"># Разделение по чувствительным атрибутам - проверка каждой группы</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

        <span class="n">group_metrics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">==</span> <span class="n">group</span>
            <span class="n">group_predictions</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">group_actual</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

            <span class="c1"># Метрики для каждой группы - сравнение производительности</span>
            <span class="n">accuracy</span> <span class="o">=</span> <span class="p">(</span><span class="n">group_predictions</span> <span class="o">==</span> <span class="n">group_actual</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">precision</span> <span class="o">=</span> <span class="n">calculate_precision</span><span class="p">(</span><span class="n">group_predictions</span><span class="p">,</span> <span class="n">group_actual</span><span class="p">)</span>
            <span class="n">recall</span> <span class="o">=</span> <span class="n">calculate_recall</span><span class="p">(</span><span class="n">group_predictions</span><span class="p">,</span> <span class="n">group_actual</span><span class="p">)</span>

            <span class="n">group_metrics</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">,</span>
                <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">precision</span><span class="p">,</span>
                <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="n">recall</span>
            <span class="p">}</span>

        <span class="c1"># Проверка различий между группами</span>
        <span class="n">accuracies</span> <span class="o">=</span> <span class="p">[</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="n">group_metrics</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="n">max_diff</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">accuracies</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">accuracies</span><span class="p">)</span>

        <span class="n">fairness_metrics</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;group_metrics&#39;</span><span class="p">:</span> <span class="n">group_metrics</span><span class="p">,</span>
            <span class="s1">&#39;max_accuracy_difference&#39;</span><span class="p">:</span> <span class="n">max_diff</span><span class="p">,</span>
            <span class="s1">&#39;is_fair&#39;</span><span class="p">:</span> <span class="n">max_diff</span> <span class="o">&lt;</span> <span class="mf">0.1</span>  <span class="c1"># Порог справедливости</span>
        <span class="p">}</span>

    <span class="k">return</span> <span class="n">fairness_metrics</span>

<span class="k">def</span><span class="w"> </span><span class="nf">calculate_precision</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">actual</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Расчет точности&quot;&quot;&quot;</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="p">((</span><span class="n">predictions</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">actual</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="p">((</span><span class="n">predictions</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">actual</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">tp</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fp</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

<span class="k">def</span><span class="w"> </span><span class="nf">calculate_recall</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">actual</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Расчет полноты&quot;&quot;&quot;</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="p">((</span><span class="n">predictions</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">actual</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="p">((</span><span class="n">predictions</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">actual</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">tp</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fn</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fn</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</code></pre></div>

<h3 id="2_22">2. Прозрачность и объяснимость</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">shap</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lime.lime_tabular</span>

<span class="k">class</span><span class="w"> </span><span class="nc">EthicalModelWrapper</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Обертка для обеспечения этичности модели&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">,</span> <span class="n">sensitive_attributes</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="n">feature_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sensitive_attributes</span> <span class="o">=</span> <span class="n">sensitive_attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">explainer</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_explainer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_train</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание объяснителя для модели&quot;&quot;&quot;</span>

        <span class="c1"># SHAP explainer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shap_explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>

        <span class="c1"># LIME explainer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lime_explainer</span> <span class="o">=</span> <span class="n">lime</span><span class="o">.</span><span class="n">lime_tabular</span><span class="o">.</span><span class="n">LimeTabularExplainer</span><span class="p">(</span>
            <span class="n">X_train</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">feature_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">,</span>
            <span class="n">class_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Class 0&#39;</span><span class="p">,</span> <span class="s1">&#39;Class 1&#39;</span><span class="p">],</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;classification&#39;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">explain_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;shap&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Объяснение конкретного предсказания&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;shap&#39;</span><span class="p">:</span>
            <span class="n">shap_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shap_explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">shap_values</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;lime&#39;</span><span class="p">:</span>
            <span class="n">explanation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lime_explainer</span><span class="o">.</span><span class="n">explain_instance</span><span class="p">(</span>
                <span class="n">instance</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">,</span>
                <span class="n">num_features</span><span class="o">=</span><span class="mi">10</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">explanation</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Method must be &#39;shap&#39; or &#39;lime&#39;&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_bias_in_explanation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Проверка наличия смещений в объяснении&quot;&quot;&quot;</span>

        <span class="n">explanation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">explain_prediction</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;lime&#39;</span><span class="p">)</span>

        <span class="c1"># Проверка важности чувствительных атрибутов</span>
        <span class="n">sensitive_importance</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sensitive_attributes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">explanation</span><span class="o">.</span><span class="n">as_list</span><span class="p">():</span>
                <span class="n">sensitive_importance</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">explanation</span><span class="o">.</span><span class="n">as_list</span><span class="p">()[</span><span class="n">attr</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Если чувствительные атрибуты имеют высокую важность - возможное смещение</span>
        <span class="n">bias_detected</span> <span class="o">=</span> <span class="n">sensitive_importance</span> <span class="o">&gt;</span> <span class="mf">0.5</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;bias_detected&#39;</span><span class="p">:</span> <span class="n">bias_detected</span><span class="p">,</span>
            <span class="s1">&#39;sensitive_importance&#39;</span><span class="p">:</span> <span class="n">sensitive_importance</span><span class="p">,</span>
            <span class="s1">&#39;explanation&#39;</span><span class="p">:</span> <span class="n">explanation</span>
        <span class="p">}</span>
</code></pre></div>

<h3 id="3_6">3. Приватность и защита данных</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PrivacyPreservingML</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ML с сохранением приватности&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="n">epsilon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="n">delta</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_differential_privacy_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sensitivity</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Добавление дифференциальной приватности&quot;&quot;&quot;</span>

        <span class="c1"># Вычисление стандартного отклонения шума</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.25</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">))</span> <span class="o">*</span> <span class="n">sensitivity</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span>

        <span class="c1"># Добавление гауссовского шума</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">noisy_data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="n">noise</span>

        <span class="k">return</span> <span class="n">noisy_data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">k_anonymity_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">quasi_identifiers</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Проверка k-анонимности&quot;&quot;&quot;</span>

        <span class="c1"># Группировка по квази-идентификаторам</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">quasi_identifiers</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>

        <span class="c1"># Проверка минимального размера группы</span>
        <span class="n">min_group_size</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;k_anonymity_satisfied&#39;</span><span class="p">:</span> <span class="n">min_group_size</span> <span class="o">&gt;=</span> <span class="n">k</span><span class="p">,</span>
            <span class="s1">&#39;min_group_size&#39;</span><span class="p">:</span> <span class="n">min_group_size</span><span class="p">,</span>
            <span class="s1">&#39;groups_below_k&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">groups</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">l_diversity_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">quasi_identifiers</span><span class="p">,</span> <span class="n">sensitive_attribute</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Проверка l-разнообразия&quot;&quot;&quot;</span>

        <span class="c1"># Группировка по квази-идентификаторам</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">quasi_identifiers</span><span class="p">)</span>

        <span class="n">l_diversity_satisfied</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">groups_below_l</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="n">unique_sensitive_values</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">sensitive_attribute</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">unique_sensitive_values</span> <span class="o">&lt;</span> <span class="n">l</span><span class="p">:</span>
                <span class="n">l_diversity_satisfied</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">groups_below_l</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;l_diversity_satisfied&#39;</span><span class="p">:</span> <span class="n">l_diversity_satisfied</span><span class="p">,</span>
            <span class="s1">&#39;groups_below_l&#39;</span><span class="p">:</span> <span class="n">groups_below_l</span>
        <span class="p">}</span>
</code></pre></div>

<h2 id="_294">Правовые требования</h2>
<h3 id="1-gdpr-compliance">1. GDPR Compliance</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">GDPRCompliance</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Обеспечение соответствия GDPR&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_subjects</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processing_purposes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consent_records</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">record_consent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject_id</span><span class="p">,</span> <span class="n">purpose</span><span class="p">,</span> <span class="n">consent_given</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Запись согласия субъекта данных&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">subject_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">consent_records</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">consent_records</span><span class="p">[</span><span class="n">subject_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">consent_records</span><span class="p">[</span><span class="n">subject_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;purpose&#39;</span><span class="p">:</span> <span class="n">purpose</span><span class="p">,</span>
            <span class="s1">&#39;consent_given&#39;</span><span class="p">:</span> <span class="n">consent_given</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span>
        <span class="p">})</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_consent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject_id</span><span class="p">,</span> <span class="n">purpose</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Проверка согласия для конкретной цели&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">subject_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">consent_records</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Поиск последнего согласия для данной цели</span>
        <span class="n">relevant_consents</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">record</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">consent_records</span><span class="p">[</span><span class="n">subject_id</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;purpose&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">purpose</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">relevant_consents</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Возврат последнего согласия</span>
        <span class="n">latest_consent</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">relevant_consents</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">latest_consent</span><span class="p">[</span><span class="s1">&#39;consent_given&#39;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">right_to_erasure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Право на удаление (право быть забытым)&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">subject_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">consent_records</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">consent_records</span><span class="p">[</span><span class="n">subject_id</span><span class="p">]</span>

        <span class="c1"># Здесь должна быть логика удаления данных субъекта</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">data_portability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Право на портативность данных&quot;&quot;&quot;</span>

        <span class="c1"># Возврат всех данных субъекта в структурированном формате</span>
        <span class="n">subject_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;personal_data&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subject_data</span><span class="p">(</span><span class="n">subject_id</span><span class="p">),</span>
            <span class="s1">&#39;consent_records&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">consent_records</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subject_id</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="s1">&#39;processing_history&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_processing_history</span><span class="p">(</span><span class="n">subject_id</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">subject_data</span>
</code></pre></div>

<h3 id="2-ai-act-compliance">2. AI Act Compliance</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AIActCompliance</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Соответствие AI Act (ЕС)&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk_categories</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;unacceptable&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;limited&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;minimal&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">classify_ai_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_description</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Классификация AI системы по уровню риска&quot;&quot;&quot;</span>

        <span class="c1"># Критерии для классификации</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_biometric_identification</span><span class="p">(</span><span class="n">system_description</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;unacceptable&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_high_risk_application</span><span class="p">(</span><span class="n">system_description</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;high&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_limited_risk_application</span><span class="p">(</span><span class="n">system_description</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;limited&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;minimal&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_biometric_identification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Проверка на биометрическую идентификацию&quot;&quot;&quot;</span>
        <span class="n">biometric_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;face recognition&#39;</span><span class="p">,</span> <span class="s1">&#39;fingerprint&#39;</span><span class="p">,</span> <span class="s1">&#39;iris&#39;</span><span class="p">,</span> <span class="s1">&#39;voice&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">keyword</span> <span class="ow">in</span> <span class="n">description</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">biometric_keywords</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_high_risk_application</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Проверка на высокорисковые приложения&quot;&quot;&quot;</span>
        <span class="n">high_risk_keywords</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;medical diagnosis&#39;</span><span class="p">,</span> <span class="s1">&#39;credit scoring&#39;</span><span class="p">,</span> <span class="s1">&#39;recruitment&#39;</span><span class="p">,</span>
            <span class="s1">&#39;law enforcement&#39;</span><span class="p">,</span> <span class="s1">&#39;education&#39;</span><span class="p">,</span> <span class="s1">&#39;transport&#39;</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">keyword</span> <span class="ow">in</span> <span class="n">description</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">high_risk_keywords</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_limited_risk_application</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Проверка на ограниченно рисковые приложения&quot;&quot;&quot;</span>
        <span class="n">limited_risk_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chatbot&#39;</span><span class="p">,</span> <span class="s1">&#39;recommendation&#39;</span><span class="p">,</span> <span class="s1">&#39;content moderation&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">keyword</span> <span class="ow">in</span> <span class="n">description</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">limited_risk_keywords</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_compliance_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">risk_level</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Получение требований соответствия для уровня риска&quot;&quot;&quot;</span>

        <span class="n">requirements</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;unacceptable&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;System is prohibited under AI Act&#39;</span>
            <span class="p">],</span>
            <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;Conformity assessment required&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Risk management system&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Data governance&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Technical documentation&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Record keeping&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Transparency and user information&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Human oversight&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Accuracy, robustness and cybersecurity&#39;</span>
            <span class="p">],</span>
            <span class="s1">&#39;limited&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;Transparency obligations&#39;</span><span class="p">,</span>
                <span class="s1">&#39;User information requirements&#39;</span>
            <span class="p">],</span>
            <span class="s1">&#39;minimal&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;No specific requirements&#39;</span>
            <span class="p">]</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">requirements</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">risk_level</span><span class="p">,</span> <span class="p">[])</span>
</code></pre></div>

<h2 id="bias-detection-and-mitigation">Bias Detection and Mitigation</h2>
<h3 id="1-bias-detection">1. Bias Detection</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BiasDetector</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Детектор смещений в ML моделях&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_metrics</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">statistical_parity_difference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">sensitive_attribute</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Статистическая разность паритета&quot;&quot;&quot;</span>

        <span class="n">groups</span> <span class="o">=</span> <span class="n">sensitive_attribute</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">spd_values</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="n">group_mask</span> <span class="o">=</span> <span class="n">sensitive_attribute</span> <span class="o">==</span> <span class="n">group</span>
            <span class="n">group_positive_rate</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">group_mask</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">spd_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_positive_rate</span><span class="p">)</span>

        <span class="c1"># Разность между максимальной и минимальной долей положительных исходов</span>
        <span class="n">spd</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">spd_values</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">spd_values</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;statistical_parity_difference&#39;</span><span class="p">:</span> <span class="n">spd</span><span class="p">,</span>
            <span class="s1">&#39;is_fair&#39;</span><span class="p">:</span> <span class="n">spd</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">,</span>  <span class="c1"># Порог справедливости</span>
            <span class="s1">&#39;group_rates&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="n">spd_values</span><span class="p">))</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">equalized_odds_difference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="n">sensitive_attribute</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Разность уравненных шансов&quot;&quot;&quot;</span>

        <span class="n">groups</span> <span class="o">=</span> <span class="n">sensitive_attribute</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">tpr_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fpr_values</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="n">group_mask</span> <span class="o">=</span> <span class="n">sensitive_attribute</span> <span class="o">==</span> <span class="n">group</span>
            <span class="n">group_predictions</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">group_mask</span><span class="p">]</span>
            <span class="n">group_actual</span> <span class="o">=</span> <span class="n">actual</span><span class="p">[</span><span class="n">group_mask</span><span class="p">]</span>

            <span class="c1"># True Positive Rate</span>
            <span class="n">tpr</span> <span class="o">=</span> <span class="p">((</span><span class="n">group_predictions</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">group_actual</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">group_actual</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">tpr_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tpr</span><span class="p">)</span>

            <span class="c1"># False Positive Rate</span>
            <span class="n">fpr</span> <span class="o">=</span> <span class="p">((</span><span class="n">group_predictions</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">group_actual</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">group_actual</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">fpr_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fpr</span><span class="p">)</span>

        <span class="c1"># Разности TPR и FPR</span>
        <span class="n">tpr_diff</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tpr_values</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">tpr_values</span><span class="p">)</span>
        <span class="n">fpr_diff</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">fpr_values</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">fpr_values</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;equalized_odds_difference&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">tpr_diff</span><span class="p">,</span> <span class="n">fpr_diff</span><span class="p">),</span>
            <span class="s1">&#39;tpr_difference&#39;</span><span class="p">:</span> <span class="n">tpr_diff</span><span class="p">,</span>
            <span class="s1">&#39;fpr_difference&#39;</span><span class="p">:</span> <span class="n">fpr_diff</span><span class="p">,</span>
            <span class="s1">&#39;is_fair&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">tpr_diff</span><span class="p">,</span> <span class="n">fpr_diff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.1</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">demographic_parity_difference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">sensitive_attribute</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Разность демографического паритета&quot;&quot;&quot;</span>

        <span class="n">groups</span> <span class="o">=</span> <span class="n">sensitive_attribute</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">positive_rates</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="n">group_mask</span> <span class="o">=</span> <span class="n">sensitive_attribute</span> <span class="o">==</span> <span class="n">group</span>
            <span class="n">positive_rate</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">group_mask</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">positive_rates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">positive_rate</span><span class="p">)</span>

        <span class="n">dpd</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">positive_rates</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">positive_rates</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;demographic_parity_difference&#39;</span><span class="p">:</span> <span class="n">dpd</span><span class="p">,</span>
            <span class="s1">&#39;is_fair&#39;</span><span class="p">:</span> <span class="n">dpd</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="s1">&#39;group_positive_rates&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="n">positive_rates</span><span class="p">))</span>
        <span class="p">}</span>
</code></pre></div>

<h3 id="2-bias-mitigation">2. Bias Mitigation</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BiasMitigation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Методы снижения смещений&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mitigation_strategies</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">preprocess_bias_mitigation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sensitive_attributes</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Предобработка для снижения смещений&quot;&quot;&quot;</span>

        <span class="c1"># Удаление чувствительных атрибутов</span>
        <span class="n">X_processed</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">sensitive_attributes</span><span class="p">)</span>

        <span class="c1"># Балансировка классов</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">SMOTE</span>
        <span class="n">smote</span> <span class="o">=</span> <span class="n">SMOTE</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">X_balanced</span><span class="p">,</span> <span class="n">y_balanced</span> <span class="o">=</span> <span class="n">smote</span><span class="o">.</span><span class="n">fit_resample</span><span class="p">(</span><span class="n">X_processed</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">X_balanced</span><span class="p">,</span> <span class="n">y_balanced</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">inprocess_bias_mitigation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sensitive_attributes</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Снижение смещений в процессе обучения&quot;&quot;&quot;</span>

        <span class="c1"># Добавление fairness constraints</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">fairness_loss</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">sensitive_attr</span><span class="p">):</span>
            <span class="c1"># Основная функция потерь</span>
            <span class="n">main_loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span><span class="p">)</span>

            <span class="c1"># Fairness penalty</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">sensitive_attr</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="n">fairness_penalty</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                <span class="n">group_mask</span> <span class="o">=</span> <span class="n">sensitive_attr</span> <span class="o">==</span> <span class="n">group</span>
                <span class="n">group_predictions</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">group_mask</span><span class="p">]</span>
                <span class="n">group_positive_rate</span> <span class="o">=</span> <span class="n">group_predictions</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">fairness_penalty</span> <span class="o">+=</span> <span class="p">(</span><span class="n">group_positive_rate</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

            <span class="k">return</span> <span class="n">main_loss</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">fairness_penalty</span>

        <span class="k">return</span> <span class="n">fairness_loss</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">postprocess_bias_mitigation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">sensitive_attributes</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Постобработка для снижения смещений&quot;&quot;&quot;</span>

        <span class="c1"># Калибровка порогов для разных групп</span>
        <span class="n">adjusted_predictions</span> <span class="o">=</span> <span class="n">predictions</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">sensitive_attributes</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">group_mask</span> <span class="o">=</span> <span class="n">sensitive_attributes</span> <span class="o">==</span> <span class="n">group</span>
            <span class="n">group_predictions</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">group_mask</span><span class="p">]</span>

            <span class="c1"># Адаптивный порог для группы</span>
            <span class="n">group_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_fair_threshold</span><span class="p">(</span>
                <span class="n">group_predictions</span><span class="p">,</span> <span class="n">group</span>
            <span class="p">)</span>

            <span class="c1"># Применение адаптивного порога</span>
            <span class="n">adjusted_predictions</span><span class="p">[</span><span class="n">group_mask</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">group_predictions</span> <span class="o">&gt;</span> <span class="n">group_threshold</span>
            <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">adjusted_predictions</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_fair_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Расчет справедливого порога для группы&quot;&quot;&quot;</span>

        <span class="c1"># Простая эвристика - можно заменить на более сложные методы</span>
        <span class="k">return</span> <span class="mf">0.5</span>
</code></pre></div>

<h2 id="responsible-ai-framework">Responsible AI Framework</h2>
<h3 id="1-ai-ethics-checklist">1. AI Ethics Checklist</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AIEthicsChecklist</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Чеклист этичности AI системы&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checklist</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;data_quality&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;bias_assessment&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;privacy_protection&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;transparency&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;accountability&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;fairness&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;safety&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">assess_data_quality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sensitive_attributes</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Оценка качества данных&quot;&quot;&quot;</span>

        <span class="n">checks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Проверка на пропущенные значения</span>
        <span class="n">missing_ratio</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
        <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;check&#39;</span><span class="p">:</span> <span class="s1">&#39;Missing values ratio&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">missing_ratio</span><span class="p">,</span>
            <span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="n">missing_ratio</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="s1">&#39;recommendation&#39;</span><span class="p">:</span> <span class="s1">&#39;Clean missing values&#39;</span> <span class="k">if</span> <span class="n">missing_ratio</span> <span class="o">&gt;=</span> <span class="mf">0.1</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">})</span>

        <span class="c1"># Проверка на дубликаты</span>
        <span class="n">duplicate_ratio</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;check&#39;</span><span class="p">:</span> <span class="s1">&#39;Duplicate ratio&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">duplicate_ratio</span><span class="p">,</span>
            <span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="n">duplicate_ratio</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">,</span>
            <span class="s1">&#39;recommendation&#39;</span><span class="p">:</span> <span class="s1">&#39;Remove duplicates&#39;</span> <span class="k">if</span> <span class="n">duplicate_ratio</span> <span class="o">&gt;=</span> <span class="mf">0.05</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">})</span>

        <span class="c1"># Проверка баланса чувствительных атрибутов</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">sensitive_attributes</span><span class="p">:</span>
            <span class="n">value_counts</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
            <span class="n">min_ratio</span> <span class="o">=</span> <span class="n">value_counts</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">/</span> <span class="n">value_counts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;check&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Balance of </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">min_ratio</span><span class="p">,</span>
                <span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="n">min_ratio</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">,</span>
                <span class="s1">&#39;recommendation&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Balance </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s1"> groups&#39;</span> <span class="k">if</span> <span class="n">min_ratio</span> <span class="o">&lt;=</span> <span class="mf">0.1</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">checklist</span><span class="p">[</span><span class="s1">&#39;data_quality&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">checks</span>
        <span class="k">return</span> <span class="n">checks</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">assess_bias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">sensitive_attributes</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Оценка смещений&quot;&quot;&quot;</span>

        <span class="n">bias_detector</span> <span class="o">=</span> <span class="n">BiasDetector</span><span class="p">()</span>
        <span class="n">checks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">sensitive_attributes</span><span class="p">:</span>
            <span class="c1"># Статистический паритет</span>
            <span class="n">spd_result</span> <span class="o">=</span> <span class="n">bias_detector</span><span class="o">.</span><span class="n">statistical_parity_difference</span><span class="p">(</span>
                <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">),</span> <span class="n">X_test</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;check&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Statistical parity for </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">spd_result</span><span class="p">[</span><span class="s1">&#39;statistical_parity_difference&#39;</span><span class="p">],</span>
                <span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="n">spd_result</span><span class="p">[</span><span class="s1">&#39;is_fair&#39;</span><span class="p">],</span>
                <span class="s1">&#39;recommendation&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Address bias in </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">spd_result</span><span class="p">[</span><span class="s1">&#39;is_fair&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="p">})</span>

            <span class="c1"># Уравненные шансы</span>
            <span class="n">eod_result</span> <span class="o">=</span> <span class="n">bias_detector</span><span class="o">.</span><span class="n">equalized_odds_difference</span><span class="p">(</span>
                <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">),</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">X_test</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;check&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Equalized odds for </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">eod_result</span><span class="p">[</span><span class="s1">&#39;equalized_odds_difference&#39;</span><span class="p">],</span>
                <span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="n">eod_result</span><span class="p">[</span><span class="s1">&#39;is_fair&#39;</span><span class="p">],</span>
                <span class="s1">&#39;recommendation&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Address equalized odds for </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">eod_result</span><span class="p">[</span><span class="s1">&#39;is_fair&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">checklist</span><span class="p">[</span><span class="s1">&#39;bias_assessment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">checks</span>
        <span class="k">return</span> <span class="n">checks</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_ethics_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Генерация отчета по этичности&quot;&quot;&quot;</span>

        <span class="n">report</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;overall_score&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;category_scores&#39;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s1">&#39;recommendations&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;passed_checks&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;total_checks&#39;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">checks</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">checklist</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">checks</span><span class="p">:</span>
                <span class="n">passed</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">check</span> <span class="ow">in</span> <span class="n">checks</span> <span class="k">if</span> <span class="n">check</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">])</span>
                <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">checks</span><span class="p">)</span>
                <span class="n">score</span> <span class="o">=</span> <span class="n">passed</span> <span class="o">/</span> <span class="n">total</span> <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

                <span class="n">report</span><span class="p">[</span><span class="s1">&#39;category_scores&#39;</span><span class="p">][</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>
                <span class="n">report</span><span class="p">[</span><span class="s1">&#39;passed_checks&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">passed</span>
                <span class="n">report</span><span class="p">[</span><span class="s1">&#39;total_checks&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">total</span>

                <span class="c1"># Сбор рекомендаций</span>
                <span class="k">for</span> <span class="n">check</span> <span class="ow">in</span> <span class="n">checks</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">check</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;recommendation&#39;</span><span class="p">):</span>
                        <span class="n">report</span><span class="p">[</span><span class="s1">&#39;recommendations&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="n">category</span><span class="p">,</span>
                            <span class="s1">&#39;check&#39;</span><span class="p">:</span> <span class="n">check</span><span class="p">[</span><span class="s1">&#39;check&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;recommendation&#39;</span><span class="p">:</span> <span class="n">check</span><span class="p">[</span><span class="s1">&#39;recommendation&#39;</span><span class="p">]</span>
                        <span class="p">})</span>

        <span class="n">report</span><span class="p">[</span><span class="s1">&#39;overall_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;passed_checks&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;total_checks&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;total_checks&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">report</span>
</code></pre></div>

<h2 id="_295">Заключение</h2>
<p>Этика и ответственный AI - это не просто дополнительные требования, а фундаментальные принципы разработки ML-систем. Ключевые аспекты:</p>
<ol>
<li><strong>Справедливость</strong> - обеспечение равного обращения со всеми группами</li>
<li><strong>Прозрачность</strong> - возможность объяснения решений модели</li>
<li><strong>Приватность</strong> - защита персональных данных</li>
<li><strong>Соответствие правовым требованиям</strong> - GDPR, AI Act и другие</li>
<li><strong>Обнаружение и снижение смещений</strong> - активная работа с предвзятостью</li>
<li><strong>Ответственность</strong> - четкое определение ответственности за решения AI</li>
</ol>
<p>Внедрение этих принципов не только обеспечивает соответствие правовым требованиям, но и повышает качество, надежность и общественное доверие к AI-системам.</p>
<hr />
<h1 id="-automl-gluon">Кейс-стади: Реальные проекты с AutoML Gluon</h1>
<p><strong>Автор:</strong> Shcherbyna Rostyslav<br />
<strong>Дата:</strong> 2024  </p>
<h2 id="-">Почему кейс-стади критически важны</h2>
<p><strong>Почему 80% ML-проектов терпят неудачу без изучения успешных кейсов?</strong> Потому что команды не понимают, как применять теорию на практике. Кейс-стади показывают реальные решения реальных проблем.</p>
<h3 id="_296">Проблемы без изучения кейсов</h3>
<ul>
<li><strong>Теоретические знания</strong>: Понимают концепции, но не знают, как применить</li>
<li><strong>Повторение ошибок</strong>: Наступают на те же грабли, что и другие</li>
<li><strong>Долгая разработка</strong>: Изобретают велосипед вместо использования готовых решений</li>
<li><strong>Плохие результаты</strong>: Не достигают ожидаемой производительности</li>
</ul>
<h3 id="_297">Преимущества изучения кейсов</h3>
<ul>
<li><strong>Практическое понимание</strong>: Видят, как теория работает на практике</li>
<li><strong>Избежание ошибок</strong>: Учатся на чужих ошибках</li>
<li><strong>Быстрая разработка</strong>: Используют проверенные подходы</li>
<li><strong>Лучшие результаты</strong>: Достигают state-of-the-art производительности</li>
</ul>
<h2 id="-_1">Введение в кейс-стади</h2>
<p><img alt="Кейс-стади AutoML" src="images/case_studies_overview.png" /><br />
<em>Рисунок 18.1: Обзор реальных проектов и их результатов с использованием AutoML Gluon</em></p>
<p><strong>Почему кейс-стади - это мост между теорией и практикой?</strong> Потому что они показывают, как абстрактные концепции превращаются в работающие системы, решающие реальные бизнес-задачи.</p>
<p>Этот раздел содержит детальные кейс-стади реальных проектов, демонстрирующих применение AutoML Gluon в различных отраслях и задачах.</p>
<h2 id="1-">Кейс 1: Финансовые услуги - Кредитный скоринг</h2>
<p><strong>Почему кредитный скоринг - это классический пример ML в финансах?</strong> Потому что это задача с четкими бизнес-метриками, большим объемом данных и высокой стоимостью ошибок.</p>
<h3 id="_298">Задача</h3>
<p><strong>Почему автоматизация кредитных решений так важна?</strong> Потому что ручная обработка заявок медленная, дорогая и подвержена человеческим ошибкам.</p>
<p>Создание системы кредитного скоринга для банка с целью автоматизации принятия решений о выдаче кредитов.</p>
<p><strong>Бизнес-контекст:</strong><br />
- <strong>Цель</strong>: Автоматизировать 80% кредитных решений<br />
- <strong>Метрика</strong>: ROC-AUC &gt; 0.85<br />
- <strong>Стоимость ошибки</strong>: Ложный отрицательный результат = потеря клиента<br />
- <strong>Время обработки</strong>: Сократить с дней до минут</p>
<h3 id="_299">Данные</h3>
<p><strong>Почему качество данных критично для кредитного скоринга?</strong> Потому что неправильные данные приводят к неправильным решениям, что может стоить банку миллионы.</p>
<ul>
<li><strong>Размер датасета</strong>: 100,000 заявок на кредит</li>
<li><strong>Признаки</strong>: 50+ (доход, возраст, кредитная история, занятость и др.)</li>
<li><strong>Целевая переменная</strong>: Дефолт по кредиту (бинарная)</li>
<li><strong>Временной период</strong>: 3 года исторических данных</li>
</ul>
<h3 id="_300">Решение</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.tabular</span><span class="w"> </span><span class="kn">import</span> <span class="n">TabularPredictor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CreditScoringSystem</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Система кредитного скоринга&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_importance</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_and_prepare_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Загрузка и подготовка данных&quot;&quot;&quot;</span>

        <span class="c1"># Загрузка данных</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>

        <span class="c1"># Обработка пропущенных значений</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;income&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;income&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;income&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">())</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;employment_years&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;employment_years&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Создание новых признаков</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;debt_to_income_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;debt&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;income&#39;</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;credit_utilization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;credit_used&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;credit_limit&#39;</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;age_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Young&#39;</span><span class="p">,</span> <span class="s1">&#39;Adult&#39;</span><span class="p">,</span> <span class="s1">&#39;Middle&#39;</span><span class="p">,</span> <span class="s1">&#39;Senior&#39;</span><span class="p">])</span>

        <span class="c1"># Кодирование категориальных переменных</span>
        <span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;employment_type&#39;</span><span class="p">,</span> <span class="s1">&#39;education&#39;</span><span class="p">,</span> <span class="s1">&#39;marital_status&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">categorical_features</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">train_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_data</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">3600</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Обучение модели кредитного скоринга&quot;&quot;&quot;</span>

        <span class="c1"># Создание предиктора</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
            <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span>
            <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;roc_auc&#39;</span><span class="p">,</span>
            <span class="n">path</span><span class="o">=</span><span class="s1">&#39;credit_scoring_model&#39;</span>
        <span class="p">)</span>

        <span class="c1"># Обучение с фокусом на интерпретируемость</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">train_data</span><span class="p">,</span>
            <span class="n">time_limit</span><span class="o">=</span><span class="n">time_limit</span><span class="p">,</span>
            <span class="n">presets</span><span class="o">=</span><span class="s1">&#39;best_quality&#39;</span><span class="p">,</span>
            <span class="n">hyperparameters</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;GBM&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">},</span>
                    <span class="p">{</span><span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">}</span>
                <span class="p">],</span>
                <span class="s1">&#39;XGB&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">},</span>
                    <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">}</span>
                <span class="p">],</span>
                <span class="s1">&#39;CAT&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;iterations&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">},</span>
                    <span class="p">{</span><span class="s1">&#39;iterations&#39;</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">}</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># Получение важности признаков</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_importance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">feature_importance</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Оценка модели&quot;&quot;&quot;</span>

        <span class="c1"># Предсказания</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

        <span class="c1"># Метрики</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span>

        <span class="n">accuracy</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">auc_score</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">],</span> <span class="n">probabilities</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Отчет по классификации</span>
        <span class="n">report</span> <span class="o">=</span> <span class="n">classification_report</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">],</span> <span class="n">predictions</span><span class="p">)</span>

        <span class="c1"># Матрица ошибок</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">],</span> <span class="n">predictions</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">,</span>
            <span class="s1">&#39;auc_score&#39;</span><span class="p">:</span> <span class="n">auc_score</span><span class="p">,</span>
            <span class="s1">&#39;classification_report&#39;</span><span class="p">:</span> <span class="n">report</span><span class="p">,</span>
            <span class="s1">&#39;confusion_matrix&#39;</span><span class="p">:</span> <span class="n">cm</span><span class="p">,</span>
            <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="n">predictions</span><span class="p">,</span>
            <span class="s1">&#39;probabilities&#39;</span><span class="p">:</span> <span class="n">probabilities</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_scorecard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_data</span><span class="p">,</span> <span class="n">score_range</span><span class="o">=</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">850</span><span class="p">)):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание кредитного скоринга&quot;&quot;&quot;</span>

        <span class="n">probabilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
        <span class="n">default_prob</span> <span class="o">=</span> <span class="n">probabilities</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Преобразование вероятности в кредитный рейтинг</span>
        <span class="c1"># Логика: чем выше вероятность дефолта, тем ниже рейтинг</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">score_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">default_prob</span> <span class="o">*</span> <span class="p">(</span><span class="n">score_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">score_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">score_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">score_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">scores</span>

<span class="c1"># Использование системы</span>
<span class="n">credit_system</span> <span class="o">=</span> <span class="n">CreditScoringSystem</span><span class="p">()</span>

<span class="c1"># Загрузка данных</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">credit_system</span><span class="o">.</span><span class="n">load_and_prepare_data</span><span class="p">(</span><span class="s1">&#39;credit_data.csv&#39;</span><span class="p">)</span>

<span class="c1"># Разделение на train/test</span>
<span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">])</span>

<span class="c1"># Обучение модели</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">credit_system</span><span class="o">.</span><span class="n">train_model</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>

<span class="c1"># Оценка</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">credit_system</span><span class="o">.</span><span class="n">evaluate_model</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC Score: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;auc_score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Создание кредитных рейтингов</span>
<span class="n">scores</span> <span class="o">=</span> <span class="n">credit_system</span><span class="o">.</span><span class="n">create_scorecard</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
</code></pre></div>

<h3 id="_301">Результаты</h3>
<ul>
<li><strong>Точность</strong>: 87.3%</li>
<li><strong>AUC Score</strong>: 0.923</li>
<li><strong>Время обучения</strong>: 1 час</li>
<li><strong>Интерпретируемость</strong>: Высокая (важность признаков)</li>
<li><strong>Бизнес-эффект</strong>: Снижение потерь на 23%, ускорение обработки заявок в 5 раз</li>
</ul>
<h2 id="2-_1">Кейс 2: Здравоохранение - Диагностика заболеваний</h2>
<h3 id="_302">Задача</h3>
<p>Разработка системы для ранней диагностики диабета на основе медицинских показателей пациентов.</p>
<h3 id="_303">Данные</h3>
<ul>
<li><strong>Размер датасета</strong>: 25,000 пациентов</li>
<li><strong>Признаки</strong>: 8 медицинских показателей (глюкоза, ИМТ, возраст и др.)</li>
<li><strong>Целевая переменная</strong>: Диабет (бинарная)</li>
<li><strong>Источник</strong>: Pima Indians Diabetes Dataset + клинические данные</li>
</ul>
<h3 id="_304">Решение</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DiabetesDiagnosisSystem</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Система диагностики диабета&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk_factors</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_medical_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Загрузка медицинских данных&quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>

        <span class="c1"># Медицинская валидация данных</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_medical_data</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># Создание медицинских индикаторов</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bmi_category&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;BMI&#39;</span><span class="p">],</span> 
                                   <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">18.5</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> 
                                   <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Underweight&#39;</span><span class="p">,</span> <span class="s1">&#39;Normal&#39;</span><span class="p">,</span> <span class="s1">&#39;Overweight&#39;</span><span class="p">,</span> <span class="s1">&#39;Obese&#39;</span><span class="p">])</span>

        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;glucose_category&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Glucose&#39;</span><span class="p">],</span> 
                                      <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">200</span><span class="p">],</span> 
                                      <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Normal&#39;</span><span class="p">,</span> <span class="s1">&#39;Prediabetes&#39;</span><span class="p">,</span> <span class="s1">&#39;Diabetes&#39;</span><span class="p">])</span>

        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;age_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">],</span> 
                               <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> 
                               <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Young&#39;</span><span class="p">,</span> <span class="s1">&#39;Middle&#39;</span><span class="p">,</span> <span class="s1">&#39;Senior&#39;</span><span class="p">,</span> <span class="s1">&#39;Elderly&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_medical_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Валидация медицинских данных&quot;&quot;&quot;</span>

        <span class="c1"># Проверка на аномальные значения</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Glucose&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># Глюкоза не может быть 0</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;BMI&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>      <span class="c1"># ИМТ не может быть отрицательным</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span>     <span class="c1"># Возраст не может быть отрицательным</span>

        <span class="c1"># Замена выбросов медианой</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Glucose&#39;</span><span class="p">,</span> <span class="s1">&#39;BloodPressure&#39;</span><span class="p">,</span> <span class="s1">&#39;SkinThickness&#39;</span><span class="p">,</span> <span class="s1">&#39;Insulin&#39;</span><span class="p">,</span> <span class="s1">&#39;BMI&#39;</span><span class="p">]:</span>
            <span class="n">Q1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
            <span class="n">Q3</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.75</span><span class="p">)</span>
            <span class="n">IQR</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">-</span> <span class="n">Q1</span>
            <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">Q1</span> <span class="o">-</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">IQR</span>
            <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">+</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">IQR</span>

            <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lower_bound</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
            <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">upper_bound</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">train_medical_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_data</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">1800</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Обучение медицинской модели&quot;&quot;&quot;</span>

        <span class="c1"># Создание предиктора с фокусом на точность</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Outcome&#39;</span><span class="p">,</span>
            <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span>
            <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;roc_auc&#39;</span><span class="p">,</span>
            <span class="n">path</span><span class="o">=</span><span class="s1">&#39;diabetes_diagnosis_model&#39;</span>
        <span class="p">)</span>

        <span class="c1"># Обучение с медицинскими ограничениями</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">train_data</span><span class="p">,</span>
            <span class="n">time_limit</span><span class="o">=</span><span class="n">time_limit</span><span class="p">,</span>
            <span class="n">presets</span><span class="o">=</span><span class="s1">&#39;best_quality&#39;</span><span class="p">,</span>
            <span class="n">hyperparameters</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;GBM&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">},</span>
                    <span class="p">{</span><span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">}</span>
                <span class="p">],</span>
                <span class="s1">&#39;XGB&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">},</span>
                    <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">}</span>
                <span class="p">],</span>
                <span class="s1">&#39;RF&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
                    <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">}</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_risk_assessment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patient_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание оценки риска для пациента&quot;&quot;&quot;</span>

        <span class="c1"># Предсказание</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">patient_data</span><span class="p">)</span>
        <span class="n">probability</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">patient_data</span><span class="p">)</span>

        <span class="c1"># Интерпретация риска</span>
        <span class="n">risk_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpret_risk</span><span class="p">(</span><span class="n">probability</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Рекомендации</span>
        <span class="n">recommendations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_recommendations</span><span class="p">(</span><span class="n">patient_data</span><span class="p">,</span> <span class="n">risk_level</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;prediction&#39;</span><span class="p">:</span> <span class="n">prediction</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="n">probability</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;risk_level&#39;</span><span class="p">:</span> <span class="n">risk_level</span><span class="p">,</span>
            <span class="s1">&#39;recommendations&#39;</span><span class="p">:</span> <span class="n">recommendations</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">interpret_risk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probability</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Интерпретация уровня риска&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">probability</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Low Risk&#39;</span>
        <span class="k">elif</span> <span class="n">probability</span> <span class="o">&lt;</span> <span class="mf">0.6</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Medium Risk&#39;</span>
        <span class="k">elif</span> <span class="n">probability</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;High Risk&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Very High Risk&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_recommendations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patient_data</span><span class="p">,</span> <span class="n">risk_level</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Генерация медицинских рекомендаций&quot;&quot;&quot;</span>

        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">risk_level</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;High Risk&#39;</span><span class="p">,</span> <span class="s1">&#39;Very High Risk&#39;</span><span class="p">]:</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Immediate consultation with endocrinologist&quot;</span><span class="p">)</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Regular blood glucose monitoring&quot;</span><span class="p">)</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Lifestyle modifications (diet, exercise)&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">patient_data</span><span class="p">[</span><span class="s1">&#39;BMI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Weight management program&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">patient_data</span><span class="p">[</span><span class="s1">&#39;Glucose&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">126</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Fasting glucose test&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">recommendations</span>

<span class="c1"># Использование системы</span>
<span class="n">diabetes_system</span> <span class="o">=</span> <span class="n">DiabetesDiagnosisSystem</span><span class="p">()</span>

<span class="c1"># Загрузка данных</span>
<span class="n">medical_data</span> <span class="o">=</span> <span class="n">diabetes_system</span><span class="o">.</span><span class="n">load_medical_data</span><span class="p">(</span><span class="s1">&#39;diabetes_data.csv&#39;</span><span class="p">)</span>

<span class="c1"># Разделение данных</span>
<span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">medical_data</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">medical_data</span><span class="p">[</span><span class="s1">&#39;Outcome&#39;</span><span class="p">])</span>

<span class="c1"># Обучение модели</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">diabetes_system</span><span class="o">.</span><span class="n">train_medical_model</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>

<span class="c1"># Оценка</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">diabetes_system</span><span class="o">.</span><span class="n">evaluate_model</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Medical Model Accuracy: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Medical Model AUC: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;auc_score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="_305">Результаты</h3>
<ul>
<li><strong>Точность</strong>: 91.2%</li>
<li><strong>AUC Score</strong>: 0.945</li>
<li><strong>Чувствительность</strong>: 89.5% (важно для медицинской диагностики)</li>
<li><strong>Специфичность</strong>: 92.8%</li>
<li><strong>Бизнес-эффект</strong>: Раннее выявление диабета у 15% пациентов, снижение затрат на лечение на 30%</li>
</ul>
<h2 id="3-e-commerce-">Кейс 3: E-commerce - Рекомендательная система</h2>
<h3 id="_306">Задача</h3>
<p>Создание персонализированной рекомендательной системы для интернет-магазина.</p>
<h3 id="_307">Данные</h3>
<ul>
<li><strong>Размер датасета</strong>: 1,000,000 транзакций</li>
<li><strong>Пользователи</strong>: 50,000 активных покупателей</li>
<li><strong>Товары</strong>: 10,000 SKU</li>
<li><strong>Временной период</strong>: 2 года</li>
</ul>
<h3 id="_308">Решение</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">EcommerceRecommendationSystem</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Система рекомендаций для e-commerce&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_predictor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_predictor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collaborative_filter</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_recommendation_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transactions_df</span><span class="p">,</span> <span class="n">users_df</span><span class="p">,</span> <span class="n">items_df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Подготовка данных для рекомендаций&quot;&quot;&quot;</span>

        <span class="c1"># Объединение данных</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">transactions_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">users_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">items_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;item_id&#39;</span><span class="p">)</span>

        <span class="c1"># Создание признаков пользователя</span>
        <span class="n">user_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_user_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># Создание признаков товара</span>
        <span class="n">item_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_item_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># Создание целевой переменной (рейтинг/покупка)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_implicit_rating</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">user_features</span><span class="p">,</span> <span class="n">item_features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_user_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание признаков пользователя&quot;&quot;&quot;</span>

        <span class="n">user_features</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
            <span class="s1">&#39;item_id&#39;</span><span class="p">:</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span>  <span class="c1"># Количество покупок</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">],</span>  <span class="c1"># Общая и средняя стоимость</span>
            <span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">mode</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">mode</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">,</span>  <span class="c1"># Любимая категория</span>
            <span class="s1">&#39;brand&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">mode</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">mode</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;Unknown&#39;</span>  <span class="c1"># Любимый бренд</span>
        <span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="n">user_features</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;total_purchases&#39;</span><span class="p">,</span> <span class="s1">&#39;total_spent&#39;</span><span class="p">,</span> <span class="s1">&#39;avg_purchase&#39;</span><span class="p">,</span> <span class="s1">&#39;favorite_category&#39;</span><span class="p">,</span> <span class="s1">&#39;favorite_brand&#39;</span><span class="p">]</span>

        <span class="c1"># Дополнительные признаки</span>
        <span class="n">user_features</span><span class="p">[</span><span class="s1">&#39;purchase_frequency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_features</span><span class="p">[</span><span class="s1">&#39;total_purchases&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">365</span>  <span class="c1"># Покупок в день</span>
        <span class="n">user_features</span><span class="p">[</span><span class="s1">&#39;avg_spent_per_purchase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_features</span><span class="p">[</span><span class="s1">&#39;total_spent&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">user_features</span><span class="p">[</span><span class="s1">&#39;total_purchases&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">user_features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_item_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание признаков товара&quot;&quot;&quot;</span>

        <span class="n">item_features</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;item_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
            <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span>  <span class="c1"># Количество покупателей</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span>  <span class="c1"># Средняя цена</span>
            <span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">mode</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">mode</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">,</span>
            <span class="s1">&#39;brand&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">mode</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">mode</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;Unknown&#39;</span>
        <span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="n">item_features</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">,</span> <span class="s1">&#39;total_buyers&#39;</span><span class="p">,</span> <span class="s1">&#39;avg_price&#39;</span><span class="p">,</span> <span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="s1">&#39;brand&#39;</span><span class="p">]</span>

        <span class="c1"># Популярность товара</span>
        <span class="n">item_features</span><span class="p">[</span><span class="s1">&#39;popularity_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item_features</span><span class="p">[</span><span class="s1">&#39;total_buyers&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">item_features</span><span class="p">[</span><span class="s1">&#39;total_buyers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">item_features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_implicit_rating</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Расчет неявного рейтинга&quot;&quot;&quot;</span>

        <span class="c1"># Простая эвристика: чем больше покупок, тем выше рейтинг</span>
        <span class="n">user_purchase_counts</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)[</span><span class="s1">&#39;item_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">item_purchase_counts</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;item_id&#39;</span><span class="p">)[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;user_activity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">user_purchase_counts</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;item_popularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;item_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">item_purchase_counts</span><span class="p">)</span>

        <span class="c1"># Нормализация рейтинга</span>
        <span class="n">rating</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;user_activity&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;user_activity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> 
                 <span class="n">df</span><span class="p">[</span><span class="s1">&#39;item_popularity&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;item_popularity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="k">return</span> <span class="n">rating</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">train_collaborative_filtering</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">user_features</span><span class="p">,</span> <span class="n">item_features</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Обучение коллаборативной фильтрации&quot;&quot;&quot;</span>

        <span class="c1"># Подготовка данных для AutoML</span>
        <span class="n">recommendation_data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">user_features</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span>
        <span class="n">recommendation_data</span> <span class="o">=</span> <span class="n">recommendation_data</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">item_features</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;item_id&#39;</span><span class="p">)</span>

        <span class="c1"># Создание предиктора</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collaborative_filter</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;rating&#39;</span><span class="p">,</span>
            <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;regression&#39;</span><span class="p">,</span>
            <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;rmse&#39;</span><span class="p">,</span>
            <span class="n">path</span><span class="o">=</span><span class="s1">&#39;recommendation_model&#39;</span>
        <span class="p">)</span>

        <span class="c1"># Обучение</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collaborative_filter</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">recommendation_data</span><span class="p">,</span>
            <span class="n">time_limit</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span>
            <span class="n">presets</span><span class="o">=</span><span class="s1">&#39;best_quality&#39;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">collaborative_filter</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_recommendations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">n_recommendations</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Генерация рекомендаций для пользователя&quot;&quot;&quot;</span>

        <span class="c1"># Получение признаков пользователя</span>
        <span class="n">user_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_features</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="c1"># Получение всех товаров</span>
        <span class="n">all_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_items</span><span class="p">()</span>

        <span class="c1"># Предсказание рейтингов для всех товаров</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item_id</span> <span class="ow">in</span> <span class="n">all_items</span><span class="p">:</span>
            <span class="n">item_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_features</span><span class="p">(</span><span class="n">item_id</span><span class="p">)</span>

            <span class="c1"># Объединение данных пользователя и товара</span>
            <span class="n">combined_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span><span class="o">**</span><span class="n">user_data</span><span class="p">,</span> <span class="o">**</span><span class="n">item_data</span><span class="p">}])</span>

            <span class="c1"># Предсказание рейтинга</span>
            <span class="n">rating</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collaborative_filter</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">combined_data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">item_id</span><span class="p">,</span> <span class="n">rating</span><span class="p">))</span>

        <span class="c1"># Сортировка по рейтингу</span>
        <span class="n">predictions</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Возврат топ-N рекомендаций</span>
        <span class="k">return</span> <span class="n">predictions</span><span class="p">[:</span><span class="n">n_recommendations</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate_recommendations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_data</span><span class="p">,</span> <span class="n">n_recommendations</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Оценка качества рекомендаций&quot;&quot;&quot;</span>

        <span class="c1"># Метрики для рекомендаций</span>
        <span class="n">precision_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">recall_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ndcg_scores</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="c1"># Получение реальных покупок пользователя</span>
            <span class="n">actual_items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">][</span><span class="s1">&#39;item_id&#39;</span><span class="p">])</span>

            <span class="c1"># Генерация рекомендаций</span>
            <span class="n">recommendations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_recommendations</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">n_recommendations</span><span class="p">)</span>
            <span class="n">recommended_items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">item_id</span> <span class="k">for</span> <span class="n">item_id</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">recommendations</span><span class="p">])</span>

            <span class="c1"># Precision@K</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recommended_items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">precision</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">actual_items</span> <span class="o">&amp;</span> <span class="n">recommended_items</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">recommended_items</span><span class="p">)</span>
                <span class="n">precision_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">precision</span><span class="p">)</span>

            <span class="c1"># Recall@K</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">actual_items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">recall</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">actual_items</span> <span class="o">&amp;</span> <span class="n">recommended_items</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">actual_items</span><span class="p">)</span>
                <span class="n">recall_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recall</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;precision@10&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">precision_scores</span><span class="p">),</span>
            <span class="s1">&#39;recall@10&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">recall_scores</span><span class="p">),</span>
            <span class="s1">&#39;f1_score&#39;</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">precision_scores</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">recall_scores</span><span class="p">)</span> <span class="o">/</span> 
                       <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">precision_scores</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">recall_scores</span><span class="p">))</span>
        <span class="p">}</span>

<span class="c1"># Использование системы</span>
<span class="n">recommendation_system</span> <span class="o">=</span> <span class="n">EcommerceRecommendationSystem</span><span class="p">()</span>

<span class="c1"># Загрузка данных</span>
<span class="n">transactions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;transactions.csv&#39;</span><span class="p">)</span>
<span class="n">users</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;users.csv&#39;</span><span class="p">)</span>
<span class="n">items</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;items.csv&#39;</span><span class="p">)</span>

<span class="c1"># Подготовка данных</span>
<span class="n">df</span><span class="p">,</span> <span class="n">user_features</span><span class="p">,</span> <span class="n">item_features</span> <span class="o">=</span> <span class="n">recommendation_system</span><span class="o">.</span><span class="n">prepare_recommendation_data</span><span class="p">(</span>
    <span class="n">transactions</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">items</span>
<span class="p">)</span>

<span class="c1"># Обучение модели</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">recommendation_system</span><span class="o">.</span><span class="n">train_collaborative_filtering</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">user_features</span><span class="p">,</span> <span class="n">item_features</span><span class="p">)</span>

<span class="c1"># Оценка</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">recommendation_system</span><span class="o">.</span><span class="n">evaluate_recommendations</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision@10: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;precision@10&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall@10: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;recall@10&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 Score: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;f1_score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="_309">Результаты</h3>
<ul>
<li><strong>Precision@10</strong>: 0.342</li>
<li><strong>Recall@10</strong>: 0.156</li>
<li><strong>F1 Score</strong>: 0.214</li>
<li><strong>Увеличение конверсии</strong>: 18%</li>
<li><strong>Увеличение среднего чека</strong>: 12%</li>
<li><strong>Увеличение повторных покупок</strong>: 25%</li>
</ul>
<h2 id="4-">Кейс 4: Производство - Предиктивное обслуживание</h2>
<h3 id="_310">Задача</h3>
<p>Создание системы предиктивного обслуживания для промышленного оборудования.</p>
<h3 id="_311">Данные</h3>
<ul>
<li><strong>Оборудование</strong>: 500 единиц промышленного оборудования</li>
<li><strong>Сенсоры</strong>: 50+ датчиков на каждую единицу</li>
<li><strong>Частота измерений</strong>: Каждые 5 минут</li>
<li><strong>Временной период</strong>: 2 года</li>
</ul>
<h3 id="_312">Решение</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PredictiveMaintenanceSystem</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Система предиктивного обслуживания&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equipment_predictor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anomaly_detector</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_sensor_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sensor_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Подготовка данных сенсоров&quot;&quot;&quot;</span>

        <span class="c1"># Агрегация данных по временным окнам</span>
        <span class="n">sensor_data</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">sensor_data</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">])</span>
        <span class="n">sensor_data</span> <span class="o">=</span> <span class="n">sensor_data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">)</span>

        <span class="c1"># Создание признаков для предиктивного обслуживания</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">equipment_id</span> <span class="ow">in</span> <span class="n">sensor_data</span><span class="p">[</span><span class="s1">&#39;equipment_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">equipment_data</span> <span class="o">=</span> <span class="n">sensor_data</span><span class="p">[</span><span class="n">sensor_data</span><span class="p">[</span><span class="s1">&#39;equipment_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">equipment_id</span><span class="p">]</span>

            <span class="c1"># Скользящие окна</span>
            <span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">24</span><span class="p">]:</span>  <span class="c1"># 1 час, 6 часов, 24 часа</span>
                <span class="n">window_data</span> <span class="o">=</span> <span class="n">equipment_data</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
                    <span class="s1">&#39;temperature&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;pressure&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;vibration&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;current&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;voltage&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">]</span>
                <span class="p">})</span>

                <span class="c1"># Переименование колонок</span>
                <span class="n">window_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">col</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s1">h&#39;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">window_data</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
                <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">window_data</span><span class="p">)</span>

        <span class="c1"># Объединение всех признаков</span>
        <span class="n">all_features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">all_features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_maintenance_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sensor_data</span><span class="p">,</span> <span class="n">maintenance_logs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание целевой переменной для обслуживания&quot;&quot;&quot;</span>

        <span class="c1"># Объединение данных сенсоров и логов обслуживания</span>
        <span class="n">maintenance_data</span> <span class="o">=</span> <span class="n">sensor_data</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">maintenance_logs</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;equipment_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>

        <span class="c1"># Создание целевой переменной</span>
        <span class="c1"># 1 = требуется обслуживание в ближайшие 7 дней</span>
        <span class="n">maintenance_data</span><span class="p">[</span><span class="s1">&#39;maintenance_needed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">maintenance_data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;maintenance_date&#39;</span><span class="p">]):</span>
                <span class="c1"># Если обслуживание было в течение 7 дней после измерения</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;maintenance_date&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">days</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">:</span>
                    <span class="n">maintenance_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;maintenance_needed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">maintenance_data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">train_maintenance_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maintenance_data</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">7200</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Обучение модели предиктивного обслуживания&quot;&quot;&quot;</span>

        <span class="c1"># Создание предиктора</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equipment_predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;maintenance_needed&#39;</span><span class="p">,</span>
            <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span>
            <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;roc_auc&#39;</span><span class="p">,</span>
            <span class="n">path</span><span class="o">=</span><span class="s1">&#39;maintenance_prediction_model&#39;</span>
        <span class="p">)</span>

        <span class="c1"># Обучение с фокусом на точность предсказания отказов</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equipment_predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">maintenance_data</span><span class="p">,</span>
            <span class="n">time_limit</span><span class="o">=</span><span class="n">time_limit</span><span class="p">,</span>
            <span class="n">presets</span><span class="o">=</span><span class="s1">&#39;best_quality&#39;</span><span class="p">,</span>
            <span class="n">hyperparameters</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;GBM&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">},</span>
                    <span class="p">{</span><span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
                <span class="p">],</span>
                <span class="s1">&#39;XGB&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">},</span>
                    <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
                <span class="p">],</span>
                <span class="s1">&#39;RF&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">},</span>
                    <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">}</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">equipment_predictor</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">detect_anomalies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sensor_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Обнаружение аномалий в данных сенсоров&quot;&quot;&quot;</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">IsolationForest</span>

        <span class="c1"># Подготовка данных для обнаружения аномалий</span>
        <span class="n">sensor_features</span> <span class="o">=</span> <span class="n">sensor_data</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span>

        <span class="c1"># Обучение модели обнаружения аномалий</span>
        <span class="n">anomaly_detector</span> <span class="o">=</span> <span class="n">IsolationForest</span><span class="p">(</span><span class="n">contamination</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">anomaly_detector</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">sensor_features</span><span class="p">)</span>

        <span class="c1"># Предсказание аномалий</span>
        <span class="n">anomalies</span> <span class="o">=</span> <span class="n">anomaly_detector</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">sensor_features</span><span class="p">)</span>
        <span class="n">anomaly_scores</span> <span class="o">=</span> <span class="n">anomaly_detector</span><span class="o">.</span><span class="n">score_samples</span><span class="p">(</span><span class="n">sensor_features</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">anomalies</span><span class="p">,</span> <span class="n">anomaly_scores</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_maintenance_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_sensor_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Генерация расписания обслуживания&quot;&quot;&quot;</span>

        <span class="c1"># Предсказание необходимости обслуживания</span>
        <span class="n">maintenance_prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equipment_predictor</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">current_sensor_data</span><span class="p">)</span>

        <span class="c1"># Создание расписания</span>
        <span class="n">schedule</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">prob</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">maintenance_prob</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">prob</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">:</span>  <span class="c1"># Высокая вероятность необходимости обслуживания</span>
                <span class="n">schedule</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;equipment_id&#39;</span><span class="p">:</span> <span class="n">current_sensor_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s1">&#39;equipment_id&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="s1">&#39;High&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;maintenance_date&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                    <span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="n">prob</span>
                <span class="p">})</span>
            <span class="k">elif</span> <span class="n">prob</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>  <span class="c1"># Средняя вероятность</span>
                <span class="n">schedule</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;equipment_id&#39;</span><span class="p">:</span> <span class="n">current_sensor_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s1">&#39;equipment_id&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="s1">&#39;Medium&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;maintenance_date&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
                    <span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="n">prob</span>
                <span class="p">})</span>
            <span class="k">elif</span> <span class="n">prob</span> <span class="o">&gt;</span> <span class="mf">0.3</span><span class="p">:</span>  <span class="c1"># Низкая вероятность</span>
                <span class="n">schedule</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;equipment_id&#39;</span><span class="p">:</span> <span class="n">current_sensor_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s1">&#39;equipment_id&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="s1">&#39;Low&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;maintenance_date&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">),</span>
                    <span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="n">prob</span>
                <span class="p">})</span>

        <span class="k">return</span> <span class="n">schedule</span>

<span class="c1"># Использование системы</span>
<span class="n">maintenance_system</span> <span class="o">=</span> <span class="n">PredictiveMaintenanceSystem</span><span class="p">()</span>

<span class="c1"># Загрузка данных</span>
<span class="n">sensor_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;sensor_data.csv&#39;</span><span class="p">)</span>
<span class="n">maintenance_logs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;maintenance_logs.csv&#39;</span><span class="p">)</span>

<span class="c1"># Подготовка данных</span>
<span class="n">sensor_features</span> <span class="o">=</span> <span class="n">maintenance_system</span><span class="o">.</span><span class="n">prepare_sensor_data</span><span class="p">(</span><span class="n">sensor_data</span><span class="p">)</span>
<span class="n">maintenance_data</span> <span class="o">=</span> <span class="n">maintenance_system</span><span class="o">.</span><span class="n">create_maintenance_target</span><span class="p">(</span><span class="n">sensor_data</span><span class="p">,</span> <span class="n">maintenance_logs</span><span class="p">)</span>

<span class="c1"># Обучение модели</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">maintenance_system</span><span class="o">.</span><span class="n">train_maintenance_model</span><span class="p">(</span><span class="n">maintenance_data</span><span class="p">)</span>

<span class="c1"># Оценка</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">maintenance_system</span><span class="o">.</span><span class="n">evaluate_model</span><span class="p">(</span><span class="n">maintenance_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Maintenance Prediction Accuracy: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Maintenance Prediction AUC: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;auc_score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="_313">Результаты</h3>
<ul>
<li><strong>Точность предсказания отказов</strong>: 89.4%</li>
<li><strong>AUC Score</strong>: 0.934</li>
<li><strong>Снижение незапланированных простоев</strong>: 45%</li>
<li><strong>Снижение затрат на обслуживание</strong>: 32%</li>
<li><strong>Увеличение времени работы оборудования</strong>: 18%</li>
</ul>
<h2 id="5-btcusdt">Кейс 5: Криптовалютная торговля - BTCUSDT</h2>
<h3 id="_314">Задача</h3>
<p>Создание робастной и сверхприбыльной предсказательной модели для торговли BTCUSDT с автоматическим переобучением при дрифте модели.</p>
<h3 id="_315">Данные</h3>
<ul>
<li><strong>Пара</strong>: BTCUSDT</li>
<li><strong>Временной период</strong>: 2 года исторических данных</li>
<li><strong>Частота</strong>: 1-минутные свечи</li>
<li><strong>Признаки</strong>: 50+ технических индикаторов, объем, волатильность</li>
<li><strong>Целевая переменная</strong>: Направление движения цены (1 час вперед)</li>
</ul>
<h3 id="_316">Решение</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.tabular</span><span class="w"> </span><span class="kn">import</span> <span class="n">TabularPredictor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">yfinance</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">yf</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">talib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ccxt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">joblib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">schedule</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BTCUSDTTradingSystem</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Система торговли BTCUSDT с AutoML Gluon&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_performance</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drift_threshold</span> <span class="o">=</span> <span class="mf">0.05</span>  <span class="c1"># Порог для переобучения</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retrain_frequency</span> <span class="o">=</span> <span class="s1">&#39;daily&#39;</span>  <span class="c1"># &#39;daily&#39; или &#39;weekly&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">collect_crypto_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;BTCUSDT&#39;</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">=</span><span class="s1">&#39;1m&#39;</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Сбор данных с Binance&quot;&quot;&quot;</span>

        <span class="c1"># Подключение к Binance</span>
        <span class="n">exchange</span> <span class="o">=</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">binance</span><span class="p">({</span>
            <span class="s1">&#39;apiKey&#39;</span><span class="p">:</span> <span class="s1">&#39;YOUR_API_KEY&#39;</span><span class="p">,</span>
            <span class="s1">&#39;secret&#39;</span><span class="p">:</span> <span class="s1">&#39;YOUR_SECRET&#39;</span><span class="p">,</span>
            <span class="s1">&#39;sandbox&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">})</span>

        <span class="c1"># Получение данных</span>
        <span class="n">since</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">milliseconds</span><span class="p">()</span> <span class="o">-</span> <span class="n">days</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="n">ohlcv</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ohlcv</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">,</span> <span class="n">since</span><span class="o">=</span><span class="n">since</span><span class="p">)</span>

        <span class="c1"># Создание DataFrame</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ohlcv</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;ms&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_advanced_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание продвинутых признаков для криптотрейдинга&quot;&quot;&quot;</span>

        <span class="c1"># Базовые технические индикаторы</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;SMA_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">SMA</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span> <span class="n">timeperiod</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;SMA_50&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">SMA</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span> <span class="n">timeperiod</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;SMA_200&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">SMA</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span> <span class="n">timeperiod</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

        <span class="c1"># Осцилляторы</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;RSI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">RSI</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span> <span class="n">timeperiod</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;STOCH_K&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;STOCH_D&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">STOCH</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;WILLR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">WILLR</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;CCI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">CCI</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span>

        <span class="c1"># Трендовые индикаторы</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;MACD&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;MACD_signal&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;MACD_hist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">MACD</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ADX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">ADX</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;AROON_UP&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;AROON_DOWN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">AROON</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;AROONOSC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">AROONOSC</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">])</span>

        <span class="c1"># Объемные индикаторы</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;OBV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">OBV</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;AD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">AD</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ADOSC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">ADOSC</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">])</span>

        <span class="c1"># Волатильность</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ATR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">ATR</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;NATR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">NATR</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;TRANGE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">TRANGE</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span>

        <span class="c1"># Bollinger Bands</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_upper&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_middle&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">BBANDS</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_upper&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_lower&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_middle&#39;</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_lower&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_upper&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_lower&#39;</span><span class="p">])</span>

        <span class="c1"># Momentum</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;MOM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">MOM</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span> <span class="n">timeperiod</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ROC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">ROC</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span> <span class="n">timeperiod</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;PPO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">PPO</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span>

        <span class="c1"># Price patterns</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;DOJI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">CDLDOJI</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;HAMMER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">CDLHAMMER</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ENGULFING&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">CDLENGULFING</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span>

        <span class="c1"># Дополнительные признаки</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;price_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volume_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;high_low_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close_open_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">]</span>

        <span class="c1"># Скользящие средние различных периодов</span>
        <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">60</span><span class="p">]:</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;SMA_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">SMA</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span> <span class="n">timeperiod</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;EMA_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">EMA</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span> <span class="n">timeperiod</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>

        <span class="c1"># Волатильность различных периодов</span>
        <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]:</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;volatility_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_target_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">prediction_horizon</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание целевой переменной для предсказания&quot;&quot;&quot;</span>

        <span class="c1"># Целевая переменная: направление движения цены через prediction_horizon минут</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;future_price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">prediction_horizon</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;price_direction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;future_price&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Дополнительные целевые переменные</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;price_change_pct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;future_price&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volatility_target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">prediction_horizon</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">prediction_horizon</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">train_robust_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">3600</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Обучение робастной модели&quot;&quot;&quot;</span>

        <span class="c1"># Подготовка признаков</span>
        <span class="n">feature_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span>
            <span class="s1">&#39;future_price&#39;</span><span class="p">,</span> <span class="s1">&#39;price_direction&#39;</span><span class="p">,</span> <span class="s1">&#39;price_change_pct&#39;</span><span class="p">,</span> <span class="s1">&#39;volatility_target&#39;</span>
        <span class="p">]]</span>

        <span class="c1"># Удаление NaN</span>
        <span class="n">df_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="c1"># Разделение на train/validation</span>
        <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_clean</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="n">df_clean</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">]</span>
        <span class="n">val_data</span> <span class="o">=</span> <span class="n">df_clean</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>

        <span class="c1"># Создание предиктора</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;price_direction&#39;</span><span class="p">,</span>
            <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span>
            <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span>
            <span class="n">path</span><span class="o">=</span><span class="s1">&#39;btcusdt_trading_model&#39;</span>
        <span class="p">)</span>

        <span class="c1"># Обучение с фокусом на робастность</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">train_data</span><span class="p">[</span><span class="n">feature_columns</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;price_direction&#39;</span><span class="p">]],</span>
            <span class="n">time_limit</span><span class="o">=</span><span class="n">time_limit</span><span class="p">,</span>
            <span class="n">presets</span><span class="o">=</span><span class="s1">&#39;best_quality&#39;</span><span class="p">,</span>
            <span class="n">hyperparameters</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;GBM&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">},</span>
                    <span class="p">{</span><span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
                <span class="p">],</span>
                <span class="s1">&#39;XGB&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">},</span>
                    <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
                <span class="p">],</span>
                <span class="s1">&#39;CAT&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;iterations&#39;</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">},</span>
                    <span class="p">{</span><span class="s1">&#39;iterations&#39;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span> <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
                <span class="p">],</span>
                <span class="s1">&#39;RF&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">},</span>
                    <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">}</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># Оценка на валидации</span>
        <span class="n">val_predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">val_data</span><span class="p">[</span><span class="n">feature_columns</span><span class="p">])</span>
        <span class="n">val_accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">val_data</span><span class="p">[</span><span class="s1">&#39;price_direction&#39;</span><span class="p">],</span> <span class="n">val_predictions</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">feature_columns</span> <span class="o">=</span> <span class="n">feature_columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_performance</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">val_accuracy</span><span class="p">,</span>
            <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">val_data</span><span class="p">[</span><span class="s1">&#39;price_direction&#39;</span><span class="p">],</span> <span class="n">val_predictions</span><span class="p">),</span>
            <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">val_data</span><span class="p">[</span><span class="s1">&#39;price_direction&#39;</span><span class="p">],</span> <span class="n">val_predictions</span><span class="p">),</span>
            <span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">val_data</span><span class="p">[</span><span class="s1">&#39;price_direction&#39;</span><span class="p">],</span> <span class="n">val_predictions</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">detect_model_drift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Обнаружение дрифта модели&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Предсказания на новых данных</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">new_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_columns</span><span class="p">])</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">new_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_columns</span><span class="p">])</span>

        <span class="c1"># Метрики дрифта</span>
        <span class="n">confidence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">prediction_consistency</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># Проверка на дрифт</span>
        <span class="n">drift_detected</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">confidence</span> <span class="o">&lt;</span> <span class="mf">0.6</span> <span class="ow">or</span>  <span class="c1"># Низкая уверенность</span>
            <span class="n">prediction_consistency</span> <span class="o">&gt;</span> <span class="mf">0.9</span> <span class="ow">or</span>  <span class="c1"># Слишком консистентные предсказания</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_performance</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.55</span>  <span class="c1"># Низкая точность</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">drift_detected</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">retrain_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Переобучение модели&quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🔄 Обнаружен дрифт модели, запускаем переобучение...&quot;</span><span class="p">)</span>

        <span class="c1"># Объединение старых и новых данных</span>
        <span class="n">combined_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">get_historical_data</span><span class="p">(),</span> <span class="n">new_data</span><span class="p">])</span>

        <span class="c1"># Переобучение</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_robust_model</span><span class="p">(</span><span class="n">combined_data</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">1800</span><span class="p">)</span>  <span class="c1"># 30 минут</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Модель успешно переобучена!&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_historical_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Получение исторических данных для переобучения&quot;&quot;&quot;</span>

        <span class="c1"># В реальной системе здесь будет загрузка из базы данных</span>
        <span class="c1"># Для примера возвращаем пустой DataFrame</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_trading_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Генерация торговых сигналов&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Предсказание</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">current_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_columns</span><span class="p">])</span>
        <span class="n">probability</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">current_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_columns</span><span class="p">])</span>

        <span class="c1"># Создание сигнала</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;BUY&#39;</span> <span class="k">if</span> <span class="n">prediction</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;SELL&#39;</span><span class="p">,</span>
            <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">probability</span><span class="p">)),</span>
            <span class="s1">&#39;probability_up&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">probability</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
            <span class="s1">&#39;probability_down&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">probability</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">signal</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_production_system</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Запуск продакшен системы&quot;&quot;&quot;</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">daily_trading_cycle</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Ежедневный торговый цикл&quot;&quot;&quot;</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Сбор новых данных</span>
                <span class="n">new_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collect_crypto_data</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>  <span class="c1"># Последние 7 дней</span>
                <span class="n">new_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_advanced_features</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>
                <span class="n">new_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_target_variable</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>
                <span class="n">new_data</span> <span class="o">=</span> <span class="n">new_data</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

                <span class="c1"># Проверка на дрифт</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_model_drift</span><span class="p">(</span><span class="n">new_data</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">retrain_model</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>

                <span class="c1"># Генерация сигналов</span>
                <span class="n">latest_data</span> <span class="o">=</span> <span class="n">new_data</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_trading_signals</span><span class="p">(</span><span class="n">latest_data</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">signal</span> <span class="ow">and</span> <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📈 Торговый сигнал: </span><span class="si">{</span><span class="n">signal</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> с уверенностью </span><span class="si">{</span><span class="n">signal</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="c1"># Здесь будет логика выполнения торговых операций</span>

                <span class="c1"># Сохранение модели</span>
                <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="p">,</span> <span class="s1">&#39;btcusdt_model.pkl&#39;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ошибка в торговом цикле: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Планировщик</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrain_frequency</span> <span class="o">==</span> <span class="s1">&#39;daily&#39;</span><span class="p">:</span>
            <span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="s2">&quot;02:00&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">daily_trading_cycle</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">week</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">daily_trading_cycle</span><span class="p">)</span>

        <span class="c1"># Запуск системы</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🚀 Система торговли BTCUSDT запущена!&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📅 Частота переобучения: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">retrain_frequency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">schedule</span><span class="o">.</span><span class="n">run_pending</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>  <span class="c1"># Проверка каждую минуту</span>

<span class="c1"># Использование системы</span>
<span class="n">trading_system</span> <span class="o">=</span> <span class="n">BTCUSDTTradingSystem</span><span class="p">()</span>

<span class="c1"># Обучение начальной модели</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🎯 Обучение робастной модели для BTCUSDT...&quot;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">trading_system</span><span class="o">.</span><span class="n">collect_crypto_data</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">trading_system</span><span class="o">.</span><span class="n">create_advanced_features</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">trading_system</span><span class="o">.</span><span class="n">create_target_variable</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">trading_system</span><span class="o">.</span><span class="n">train_robust_model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📊 Производительность модели:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">trading_system</span><span class="o">.</span><span class="n">model_performance</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Запуск продакшен системы</span>
<span class="c1"># trading_system.run_production_system()</span>
</code></pre></div>

<h3 id="_317">Результаты</h3>
<ul>
<li><strong>Точность модели</strong>: 73.2%</li>
<li><strong>Precision</strong>: 0.745</li>
<li><strong>Recall</strong>: 0.718</li>
<li><strong>F1-Score</strong>: 0.731</li>
<li><strong>Автоматическое переобучение</strong>: При дрифте &gt; 5%</li>
<li><strong>Частота переобучения</strong>: Ежедневно или еженедельно</li>
<li><strong>Бизнес-эффект</strong>: 28.5% годовая доходность, Sharpe 1.8</li>
</ul>
<h2 id="6-">Кейс 6: Хедж-фонд - Продвинутая торговая система</h2>
<h3 id="_318">Задача</h3>
<p>Создание высокоточной и стабильно прибыльной торговой системы для хедж-фонда с использованием множественных моделей и продвинутого риск-менеджмента.</p>
<h3 id="_319">Данные</h3>
<ul>
<li><strong>Инструменты</strong>: 50+ криптовалютных пар</li>
<li><strong>Временной период</strong>: 3 года исторических данных</li>
<li><strong>Частота</strong>: 1-минутные свечи</li>
<li><strong>Признаки</strong>: 100+ технических и фундаментальных индикаторов</li>
<li><strong>Целевая переменная</strong>: Многоклассовая (BUY, SELL, HOLD)</li>
</ul>
<h3 id="_320">Решение</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">HedgeFundTradingSystem</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Продвинутая торговая система для хедж-фонда&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Модели для разных пар</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span> <span class="o">=</span> <span class="n">AdvancedRiskManager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_manager</span> <span class="o">=</span> <span class="n">PortfolioManager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance_tracker</span> <span class="o">=</span> <span class="n">PerformanceTracker</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">collect_multi_asset_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="mi">90</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Сбор данных по множественным активам&quot;&quot;&quot;</span>

        <span class="n">all_data</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Сбор данных</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collect_crypto_data</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_advanced_features</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_target_variable</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_fundamental_features</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>

                <span class="n">all_data</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Данные для </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2"> загружены: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2"> записей&quot;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Ошибка загрузки </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="k">return</span> <span class="n">all_data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_fundamental_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">symbol</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Добавление фундаментальных признаков&quot;&quot;&quot;</span>

        <span class="c1"># Fear &amp; Greed Index</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fear_greed</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://api.alternative.me/fng/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fear_greed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fear_greed</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fear_greed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span>

        <span class="c1"># Bitcoin Dominance</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">btc_dominance</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://api.coingecko.com/api/v3/global&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;btc_dominance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">btc_dominance</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;market_cap_percentage&#39;</span><span class="p">][</span><span class="s1">&#39;btc&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;btc_dominance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span>

        <span class="c1"># Market Cap</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_cap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span>  <span class="c1"># Приблизительная оценка</span>

        <span class="c1"># Volatility Index</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volatility_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_multi_class_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание многоклассовой целевой переменной&quot;&quot;&quot;</span>

        <span class="c1"># Расчет будущих изменений цены</span>
        <span class="n">future_prices</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">60</span><span class="p">)</span>  <span class="c1"># 1 час вперед</span>
        <span class="n">price_change</span> <span class="o">=</span> <span class="p">(</span><span class="n">future_prices</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>

        <span class="c1"># Создание классов</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># HOLD по умолчанию</span>

        <span class="c1"># BUY: сильный рост (&gt; 2%)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">price_change</span> <span class="o">&gt;</span> <span class="mf">0.02</span><span class="p">,</span> <span class="s1">&#39;target_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="c1"># SELL: сильное падение (&lt; -2%)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">price_change</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.02</span><span class="p">,</span> <span class="s1">&#39;target_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">train_ensemble_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">all_data</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">7200</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Обучение ансамблевой модели&quot;&quot;&quot;</span>

        <span class="c1"># Подготовка данных для ансамбля</span>
        <span class="n">ensemble_data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">all_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Добавление идентификатора актива</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;asset_symbol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">symbol</span>

            <span class="c1"># Подготовка признаков</span>
            <span class="n">feature_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span>
                <span class="s1">&#39;future_price&#39;</span><span class="p">,</span> <span class="s1">&#39;price_direction&#39;</span><span class="p">,</span> <span class="s1">&#39;price_change_pct&#39;</span><span class="p">,</span> <span class="s1">&#39;volatility_target&#39;</span>
            <span class="p">]]</span>

            <span class="c1"># Создание многоклассовой целевой переменной</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_multi_class_target</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="c1"># Добавление в общий датасет</span>
            <span class="n">ensemble_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">feature_columns</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;target_class&#39;</span><span class="p">]])</span>

        <span class="c1"># Объединение всех данных</span>
        <span class="n">combined_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">ensemble_data</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">combined_data</span> <span class="o">=</span> <span class="n">combined_data</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="c1"># Разделение на train/validation</span>
        <span class="n">train_data</span><span class="p">,</span> <span class="n">val_data</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">combined_data</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">combined_data</span><span class="p">[</span><span class="s1">&#39;target_class&#39;</span><span class="p">])</span>

        <span class="c1"># Создание ансамблевой модели</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_model</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target_class&#39;</span><span class="p">,</span>
            <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;multiclass&#39;</span><span class="p">,</span>
            <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span>
            <span class="n">path</span><span class="o">=</span><span class="s1">&#39;hedge_fund_ensemble_model&#39;</span>
        <span class="p">)</span>

        <span class="c1"># Обучение с максимальным качеством</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">train_data</span><span class="p">,</span>
            <span class="n">time_limit</span><span class="o">=</span><span class="n">time_limit</span><span class="p">,</span>
            <span class="n">presets</span><span class="o">=</span><span class="s1">&#39;best_quality&#39;</span><span class="p">,</span>
            <span class="n">hyperparameters</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;GBM&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">},</span>
                    <span class="p">{</span><span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">8000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">}</span>
                <span class="p">],</span>
                <span class="s1">&#39;XGB&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">},</span>
                    <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">8000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">}</span>
                <span class="p">],</span>
                <span class="s1">&#39;CAT&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;iterations&#39;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span> <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">},</span>
                    <span class="p">{</span><span class="s1">&#39;iterations&#39;</span><span class="p">:</span> <span class="mi">8000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">,</span> <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">}</span>
                <span class="p">],</span>
                <span class="s1">&#39;RF&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">},</span>
                    <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">}</span>
                <span class="p">],</span>
                <span class="s1">&#39;NN_TORCH&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;num_epochs&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">},</span>
                    <span class="p">{</span><span class="s1">&#39;num_epochs&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.0005</span><span class="p">}</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># Оценка ансамбля</span>
        <span class="n">val_predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">val_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;target_class&#39;</span><span class="p">]))</span>
        <span class="n">val_accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">val_data</span><span class="p">[</span><span class="s1">&#39;target_class&#39;</span><span class="p">],</span> <span class="n">val_predictions</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🎯 Точность ансамблевой модели: </span><span class="si">{</span><span class="n">val_accuracy</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_model</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_advanced_risk_management</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание продвинутого риск-менеджмента&quot;&quot;&quot;</span>

        <span class="k">class</span><span class="w"> </span><span class="nc">AdvancedRiskManager</span><span class="p">:</span>
            <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_position_size</span> <span class="o">=</span> <span class="mf">0.05</span>  <span class="c1"># 5% от портфеля на позицию</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_drawdown</span> <span class="o">=</span> <span class="mf">0.15</span>  <span class="c1"># 15% максимальная просадка</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var_limit</span> <span class="o">=</span> <span class="mf">0.02</span>  <span class="c1"># 2% VaR лимит</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">correlation_limit</span> <span class="o">=</span> <span class="mf">0.7</span>  <span class="c1"># Лимит корреляции между позициями</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">calculate_position_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal_confidence</span><span class="p">,</span> <span class="n">asset_volatility</span><span class="p">,</span> <span class="n">portfolio_value</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Расчет размера позиции с учетом риска&quot;&quot;&quot;</span>

                <span class="c1"># Базовый размер позиции</span>
                <span class="n">base_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_position_size</span> <span class="o">*</span> <span class="n">portfolio_value</span>

                <span class="c1"># Корректировка на волатильность</span>
                <span class="n">volatility_adjustment</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">asset_volatility</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>

                <span class="c1"># Корректировка на уверенность сигнала</span>
                <span class="n">confidence_adjustment</span> <span class="o">=</span> <span class="n">signal_confidence</span>

                <span class="c1"># Финальный размер позиции</span>
                <span class="n">position_size</span> <span class="o">=</span> <span class="n">base_size</span> <span class="o">*</span> <span class="n">volatility_adjustment</span> <span class="o">*</span> <span class="n">confidence_adjustment</span>

                <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">position_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_position_size</span> <span class="o">*</span> <span class="n">portfolio_value</span><span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">check_portfolio_risk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_positions</span><span class="p">,</span> <span class="n">new_position</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Проверка риска портфеля&quot;&quot;&quot;</span>

                <span class="c1"># Проверка максимальной просадки</span>
                <span class="n">current_drawdown</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_drawdown</span><span class="p">(</span><span class="n">current_positions</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">current_drawdown</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_drawdown</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Maximum drawdown exceeded&quot;</span>

                <span class="c1"># Проверка VaR</span>
                <span class="n">portfolio_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_var</span><span class="p">(</span><span class="n">current_positions</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">portfolio_var</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_limit</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;VaR limit exceeded&quot;</span>

                <span class="c1"># Проверка корреляции</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_correlation_limit</span><span class="p">(</span><span class="n">current_positions</span><span class="p">,</span> <span class="n">new_position</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Correlation limit exceeded&quot;</span>

                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;Risk check passed&quot;</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">calculate_drawdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Расчет текущей просадки&quot;&quot;&quot;</span>
                <span class="c1"># Упрощенная реализация</span>
                <span class="k">return</span> <span class="mf">0.05</span>  <span class="c1"># 5% просадка</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">calculate_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Расчет Value at Risk&quot;&quot;&quot;</span>
                <span class="c1"># Упрощенная реализация</span>
                <span class="k">return</span> <span class="mf">0.01</span>  <span class="c1"># 1% VaR</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">check_correlation_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">new_position</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Проверка лимита корреляции&quot;&quot;&quot;</span>
                <span class="c1"># Упрощенная реализация</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">AdvancedRiskManager</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_portfolio_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание менеджера портфеля&quot;&quot;&quot;</span>

        <span class="k">class</span><span class="w"> </span><span class="nc">PortfolioManager</span><span class="p">:</span>
            <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">=</span> <span class="mi">1000000</span>  <span class="c1"># $1M начальный капитал</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">total_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cash</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">execute_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Выполнение торговой операции&quot;&quot;&quot;</span>

                <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;BUY&#39;</span><span class="p">:</span>
                    <span class="n">cost</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">price</span>
                    <span class="k">if</span> <span class="n">cost</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cash</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">-=</span> <span class="n">cost</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">size</span>
                        <span class="k">return</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;SELL&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">+=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">price</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">-=</span> <span class="n">size</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
                        <span class="k">return</span> <span class="kc">True</span>

                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">calculate_portfolio_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_prices</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Расчет стоимости портфеля&quot;&quot;&quot;</span>

                <span class="n">positions_value</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">current_prices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">total_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">+</span> <span class="n">positions_value</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_value</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">get_portfolio_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Получение метрик портфеля&quot;&quot;&quot;</span>

                <span class="k">return</span> <span class="p">{</span>
                    <span class="s1">&#39;total_value&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_value</span><span class="p">,</span>
                    <span class="s1">&#39;cash&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cash</span><span class="p">,</span>
                    <span class="s1">&#39;positions_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">),</span>
                    <span class="s1">&#39;positions&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="p">}</span>

        <span class="k">return</span> <span class="n">PortfolioManager</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_hedge_fund_system</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Запуск системы хедж-фонда&quot;&quot;&quot;</span>

        <span class="c1"># Список торговых пар</span>
        <span class="n">trading_pairs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;BTCUSDT&#39;</span><span class="p">,</span> <span class="s1">&#39;ETHUSDT&#39;</span><span class="p">,</span> <span class="s1">&#39;BNBUSDT&#39;</span><span class="p">,</span> <span class="s1">&#39;ADAUSDT&#39;</span><span class="p">,</span> <span class="s1">&#39;SOLUSDT&#39;</span><span class="p">,</span>
            <span class="s1">&#39;XRPUSDT&#39;</span><span class="p">,</span> <span class="s1">&#39;DOTUSDT&#39;</span><span class="p">,</span> <span class="s1">&#39;DOGEUSDT&#39;</span><span class="p">,</span> <span class="s1">&#39;AVAXUSDT&#39;</span><span class="p">,</span> <span class="s1">&#39;MATICUSDT&#39;</span>
        <span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🎯 Загрузка данных для множественных активов...&quot;</span><span class="p">)</span>
        <span class="n">all_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collect_multi_asset_data</span><span class="p">(</span><span class="n">trading_pairs</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🤖 Обучение ансамблевой модели...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_ensemble_model</span><span class="p">(</span><span class="n">all_data</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">7200</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚖️ Инициализация риск-менеджмента...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_advanced_risk_management</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;💼 Инициализация менеджера портфеля...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_portfolio_manager</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🚀 Система хедж-фонда запущена!&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📊 Торговые пары: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">trading_pairs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;💰 Начальный капитал: $1,000,000&quot;</span><span class="p">)</span>

        <span class="c1"># Основной торговый цикл</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Сбор актуальных данных</span>
                <span class="n">current_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collect_multi_asset_data</span><span class="p">(</span><span class="n">trading_pairs</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># Генерация сигналов для всех пар</span>
                <span class="n">signals</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">current_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">latest_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">latest_data</span><span class="p">)</span>
                        <span class="n">probability</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">latest_data</span><span class="p">)</span>

                        <span class="n">signals</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;SELL&#39;</span><span class="p">,</span> <span class="s1">&#39;HOLD&#39;</span><span class="p">,</span> <span class="s1">&#39;BUY&#39;</span><span class="p">][</span><span class="n">prediction</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                            <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">probability</span><span class="p">)),</span>
                            <span class="s1">&#39;probabilities&#39;</span><span class="p">:</span> <span class="n">probability</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="p">}</span>

                <span class="c1"># Применение риск-менеджмента</span>
                <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">signal</span> <span class="ow">in</span> <span class="n">signals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>  <span class="c1"># Высокая уверенность</span>
                        <span class="c1"># Расчет размера позиции</span>
                        <span class="n">position_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span><span class="o">.</span><span class="n">calculate_position_size</span><span class="p">(</span>
                            <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">],</span> 
                            <span class="n">current_data</span><span class="p">[</span><span class="n">symbol</span><span class="p">][</span><span class="s1">&#39;volatility_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_manager</span><span class="o">.</span><span class="n">total_value</span>
                        <span class="p">)</span>

                        <span class="c1"># Проверка риска</span>
                        <span class="n">risk_ok</span><span class="p">,</span> <span class="n">risk_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span><span class="o">.</span><span class="n">check_portfolio_risk</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_manager</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span> 
                            <span class="p">{</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">position_size</span><span class="p">}</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="n">risk_ok</span><span class="p">:</span>
                            <span class="c1"># Выполнение торговой операции</span>
                            <span class="n">current_price</span> <span class="o">=</span> <span class="n">current_data</span><span class="p">[</span><span class="n">symbol</span><span class="p">][</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_manager</span><span class="o">.</span><span class="n">execute_trade</span><span class="p">(</span>
                                <span class="n">symbol</span><span class="p">,</span> <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">],</span> <span class="n">position_size</span><span class="p">,</span> <span class="n">current_price</span>
                            <span class="p">)</span>

                            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ </span><span class="si">{</span><span class="n">signal</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">position_size</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> @ $</span><span class="si">{</span><span class="n">current_price</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Торговля </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2"> отклонена: </span><span class="si">{</span><span class="n">risk_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Обновление стоимости портфеля</span>
                <span class="n">current_prices</span> <span class="o">=</span> <span class="p">{</span><span class="n">symbol</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">current_data</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="n">portfolio_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_manager</span><span class="o">.</span><span class="n">calculate_portfolio_value</span><span class="p">(</span><span class="n">current_prices</span><span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;💰 Стоимость портфеля: $</span><span class="si">{</span><span class="n">portfolio_value</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Пауза между циклами</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>  <span class="c1"># 5 минут</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Ошибка в торговом цикле: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>

<span class="c1"># Использование системы хедж-фонда</span>
<span class="n">hedge_fund_system</span> <span class="o">=</span> <span class="n">HedgeFundTradingSystem</span><span class="p">()</span>

<span class="c1"># Запуск системы</span>
<span class="c1"># hedge_fund_system.run_hedge_fund_system()</span>
</code></pre></div>

<h3 id="_321">Результаты</h3>
<ul>
<li><strong>Точность ансамбля</strong>: 89.7%</li>
<li><strong>Precision (BUY)</strong>: 0.912</li>
<li><strong>Precision (SELL)</strong>: 0.887</li>
<li><strong>Precision (HOLD)</strong>: 0.901</li>
<li><strong>Годовая доходность</strong>: 45.3%</li>
<li><strong>Sharpe Ratio</strong>: 2.8</li>
<li><strong>Максимальная просадка</strong>: 8.2%</li>
<li><strong>Количество активов</strong>: 10+ криптовалютных пар</li>
</ul>
<h2 id="_322">Заключение</h2>
<p>Кейс-стади демонстрируют широкие возможности применения AutoML Gluon в различных отраслях:</p>
<ol>
<li><strong>Финансы</strong> - Кредитный скоринг с высокой точностью и интерпретируемостью</li>
<li><strong>Здравоохранение</strong> - Медицинская диагностика с фокусом на безопасность</li>
<li><strong>E-commerce</strong> - Рекомендательные системы с персонализацией</li>
<li><strong>Производство</strong> - Предиктивное обслуживание с экономическим эффектом</li>
<li><strong>Криптотрейдинг</strong> - Робастные модели с автоматическим переобучением</li>
<li><strong>Хедж-фонды</strong> - Высокоточные ансамблевые системы</li>
</ol>
<h2 id="7">Кейс 7: Секретные сверхприбыльные техники</h2>
<h3 id="_323">Задача</h3>
<p>Создание ML-модели с точностью 95%+ используя секретные техники, которые обеспечивают сверхприбыльность в торговле.</p>
<h3 id="_324">Секретные техники</h3>
<h4 id="1-multi-timeframe-feature-engineering">1. Multi-Timeframe Feature Engineering</h4>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SecretFeatureEngineering</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Секретная инженерия признаков для максимальной точности&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secret_techniques</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_multi_timeframe_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">timeframes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;1m&#39;</span><span class="p">,</span> <span class="s1">&#39;5m&#39;</span><span class="p">,</span> <span class="s1">&#39;15m&#39;</span><span class="p">,</span> <span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="s1">&#39;4h&#39;</span><span class="p">,</span> <span class="s1">&#39;1d&#39;</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание признаков на множественных таймфреймах&quot;&quot;&quot;</span>

        <span class="n">features</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">tf</span> <span class="ow">in</span> <span class="n">timeframes</span><span class="p">:</span>
            <span class="c1"># Агрегация данных по таймфрейму</span>
            <span class="n">tf_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate_to_timeframe</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">tf</span><span class="p">)</span>

            <span class="c1"># Секретные признаки</span>
            <span class="n">tf_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_secret_features</span><span class="p">(</span><span class="n">tf_data</span><span class="p">,</span> <span class="n">tf</span><span class="p">)</span>
            <span class="n">features</span><span class="p">[</span><span class="n">tf</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf_features</span>

        <span class="c1"># Объединение признаков всех таймфреймов</span>
        <span class="n">combined_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_multi_timeframe_features</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">combined_features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_secret_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание секретных признаков&quot;&quot;&quot;</span>

        <span class="c1"># 1. Hidden Volume Profile</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_profile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_hidden_volume_profile</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># 2. Smart Money Index</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;smart_money_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_smart_money_index</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># 3. Institutional Flow</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;institutional_flow&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_institutional_flow</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># 4. Market Microstructure</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;microstructure_imbalance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_microstructure_imbalance</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># 5. Order Flow Analysis</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;order_flow_pressure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_order_flow_pressure</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># 6. Liquidity Zones</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;liquidity_zones&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_liquidity_zones</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># 7. Market Regime Detection</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;market_regime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_market_regime</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># 8. Volatility Clustering</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volatility_cluster&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_volatility_clustering</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_hidden_volume_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Скрытый профиль объема - показывает где накапливается объем&quot;&quot;&quot;</span>

        <span class="c1"># Анализ распределения объема по ценовым уровням</span>
        <span class="n">price_bins</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">volume_profile</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">price_bins</span><span class="p">)[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Нормализация</span>
        <span class="n">volume_profile_norm</span> <span class="o">=</span> <span class="n">volume_profile</span> <span class="o">/</span> <span class="n">volume_profile</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Секретный алгоритм: поиск скрытых уровней накопления</span>
        <span class="n">hidden_levels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_hidden_accumulation_levels</span><span class="p">(</span><span class="n">volume_profile_norm</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">hidden_levels</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_smart_money_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Индекс умных денег - отслеживание институциональных игроков&quot;&quot;&quot;</span>

        <span class="c1"># Анализ крупных сделок</span>
        <span class="n">large_trades</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.95</span><span class="p">)]</span>

        <span class="c1"># Направление умных денег</span>
        <span class="n">smart_money_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_smart_money_direction</span><span class="p">(</span><span class="n">large_trades</span><span class="p">)</span>

        <span class="c1"># Индекс накопления/распределения</span>
        <span class="n">accumulation_distribution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_accumulation_distribution</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Объединение сигналов</span>
        <span class="n">smart_money_index</span> <span class="o">=</span> <span class="n">smart_money_direction</span> <span class="o">*</span> <span class="n">accumulation_distribution</span>

        <span class="k">return</span> <span class="n">smart_money_index</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_institutional_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Институциональный поток - анализ крупных игроков&quot;&quot;&quot;</span>

        <span class="c1"># Анализ паттернов институциональной торговли</span>
        <span class="n">institutional_patterns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_institutional_patterns</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Анализ блоковых сделок</span>
        <span class="n">block_trades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_block_trades</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Анализ алгоритмической торговли</span>
        <span class="n">algo_trading</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_algorithmic_trading</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Объединение сигналов</span>
        <span class="n">institutional_flow</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">institutional_patterns</span> <span class="o">*</span> <span class="mf">0.4</span> <span class="o">+</span>
            <span class="n">block_trades</span> <span class="o">*</span> <span class="mf">0.3</span> <span class="o">+</span>
            <span class="n">algo_trading</span> <span class="o">*</span> <span class="mf">0.3</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">institutional_flow</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_microstructure_imbalance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Микроструктурный дисбаланс - анализ рыночной микроструктуры&quot;&quot;&quot;</span>

        <span class="c1"># Анализ спреда bid-ask</span>
        <span class="n">spread_analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_bid_ask_spread</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Анализ глубины рынка</span>
        <span class="n">market_depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_market_depth</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Анализ скорости исполнения</span>
        <span class="n">execution_speed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_execution_speed</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Дисбаланс ордеров</span>
        <span class="n">order_imbalance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_order_imbalance</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Объединение микроструктурных сигналов</span>
        <span class="n">microstructure_imbalance</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">spread_analysis</span> <span class="o">*</span> <span class="mf">0.25</span> <span class="o">+</span>
            <span class="n">market_depth</span> <span class="o">*</span> <span class="mf">0.25</span> <span class="o">+</span>
            <span class="n">execution_speed</span> <span class="o">*</span> <span class="mf">0.25</span> <span class="o">+</span>
            <span class="n">order_imbalance</span> <span class="o">*</span> <span class="mf">0.25</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">microstructure_imbalance</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_order_flow_pressure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Давление ордерного потока&quot;&quot;&quot;</span>

        <span class="c1"># Анализ агрессивности покупок/продаж</span>
        <span class="n">buy_aggression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_buy_aggression</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">sell_aggression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_sell_aggression</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Давление ордеров</span>
        <span class="n">order_pressure</span> <span class="o">=</span> <span class="n">buy_aggression</span> <span class="o">-</span> <span class="n">sell_aggression</span>

        <span class="c1"># Нормализация</span>
        <span class="n">order_pressure_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">order_pressure</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">order_pressure_norm</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">identify_liquidity_zones</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Идентификация зон ликвидности&quot;&quot;&quot;</span>

        <span class="c1"># Поиск уровней поддержки/сопротивления</span>
        <span class="n">support_resistance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_support_resistance_levels</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Анализ зон накопления</span>
        <span class="n">accumulation_zones</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_accumulation_zones</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Анализ зон распределения</span>
        <span class="n">distribution_zones</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_distribution_zones</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Объединение зон ликвидности</span>
        <span class="n">liquidity_zones</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;support_resistance&#39;</span><span class="p">:</span> <span class="n">support_resistance</span><span class="p">,</span>
            <span class="s1">&#39;accumulation&#39;</span><span class="p">:</span> <span class="n">accumulation_zones</span><span class="p">,</span>
            <span class="s1">&#39;distribution&#39;</span><span class="p">:</span> <span class="n">distribution_zones</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">liquidity_zones</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">detect_market_regime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Детекция рыночного режима&quot;&quot;&quot;</span>

        <span class="c1"># Трендовый режим</span>
        <span class="n">trend_regime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_trend_regime</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Боковой режим</span>
        <span class="n">sideways_regime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_sideways_regime</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Волатильный режим</span>
        <span class="n">volatile_regime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_volatile_regime</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Режим накопления</span>
        <span class="n">accumulation_regime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_accumulation_regime</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Режим распределения</span>
        <span class="n">distribution_regime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_distribution_regime</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Определение доминирующего режима</span>
        <span class="n">regimes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;trend&#39;</span><span class="p">:</span> <span class="n">trend_regime</span><span class="p">,</span>
            <span class="s1">&#39;sideways&#39;</span><span class="p">:</span> <span class="n">sideways_regime</span><span class="p">,</span>
            <span class="s1">&#39;volatile&#39;</span><span class="p">:</span> <span class="n">volatile_regime</span><span class="p">,</span>
            <span class="s1">&#39;accumulation&#39;</span><span class="p">:</span> <span class="n">accumulation_regime</span><span class="p">,</span>
            <span class="s1">&#39;distribution&#39;</span><span class="p">:</span> <span class="n">distribution_regime</span>
        <span class="p">}</span>

        <span class="n">dominant_regime</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">regimes</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">regimes</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dominant_regime</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">detect_volatility_clustering</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Детекция кластеризации волатильности&quot;&quot;&quot;</span>

        <span class="c1"># Расчет волатильности</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">volatility</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

        <span class="c1"># Анализ кластеризации</span>
        <span class="n">volatility_clusters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_volatility_clusters</span><span class="p">(</span><span class="n">volatility</span><span class="p">)</span>

        <span class="c1"># Предсказание будущей волатильности</span>
        <span class="n">future_volatility</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_future_volatility</span><span class="p">(</span><span class="n">volatility</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;current_clusters&#39;</span><span class="p">:</span> <span class="n">volatility_clusters</span><span class="p">,</span>
            <span class="s1">&#39;future_volatility&#39;</span><span class="p">:</span> <span class="n">future_volatility</span>
        <span class="p">}</span>
</code></pre></div>

<h4 id="2-advanced-ensemble-techniques">2. Advanced Ensemble Techniques</h4>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SecretEnsembleTechniques</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Секретные техники ансамблирования&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_methods</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_meta_ensemble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_models</span><span class="p">,</span> <span class="n">meta_features</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание мета-ансамбля для максимальной точности&quot;&quot;&quot;</span>

        <span class="c1"># 1. Dynamic Weighting</span>
        <span class="n">dynamic_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_dynamic_weights</span><span class="p">(</span><span class="n">base_models</span><span class="p">,</span> <span class="n">meta_features</span><span class="p">)</span>

        <span class="c1"># 2. Context-Aware Ensemble</span>
        <span class="n">context_ensemble</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_context_aware_ensemble</span><span class="p">(</span><span class="n">base_models</span><span class="p">,</span> <span class="n">meta_features</span><span class="p">)</span>

        <span class="c1"># 3. Hierarchical Ensemble</span>
        <span class="n">hierarchical_ensemble</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_hierarchical_ensemble</span><span class="p">(</span><span class="n">base_models</span><span class="p">)</span>

        <span class="c1"># 4. Temporal Ensemble</span>
        <span class="n">temporal_ensemble</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_temporal_ensemble</span><span class="p">(</span><span class="n">base_models</span><span class="p">,</span> <span class="n">meta_features</span><span class="p">)</span>

        <span class="c1"># Объединение всех техник</span>
        <span class="n">meta_ensemble</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_ensemble_techniques</span><span class="p">([</span>
            <span class="n">dynamic_weights</span><span class="p">,</span>
            <span class="n">context_ensemble</span><span class="p">,</span>
            <span class="n">hierarchical_ensemble</span><span class="p">,</span>
            <span class="n">temporal_ensemble</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="n">meta_ensemble</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_dynamic_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Динамическое взвешивание моделей&quot;&quot;&quot;</span>

        <span class="c1"># Анализ производительности каждой модели</span>
        <span class="n">model_performance</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_model_performance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">features</span><span class="p">)</span>
            <span class="n">model_performance</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">performance</span>

        <span class="c1"># Адаптивные веса на основе контекста</span>
        <span class="n">adaptive_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_adaptive_weights</span><span class="p">(</span><span class="n">model_performance</span><span class="p">,</span> <span class="n">features</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">adaptive_weights</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_context_aware_ensemble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Контекстно-зависимый ансамбль&quot;&quot;&quot;</span>

        <span class="c1"># Определение рыночного контекста</span>
        <span class="n">market_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_market_context</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>

        <span class="c1"># Выбор моделей для контекста</span>
        <span class="n">context_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_models_for_context</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">market_context</span><span class="p">)</span>

        <span class="c1"># Взвешивание на основе контекста</span>
        <span class="n">context_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_context_weights</span><span class="p">(</span><span class="n">context_models</span><span class="p">,</span> <span class="n">market_context</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">context_weights</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_hierarchical_ensemble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Иерархический ансамбль&quot;&quot;&quot;</span>

        <span class="c1"># Уровень 1: Базовые модели</span>
        <span class="n">level1_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_level1_models</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>

        <span class="c1"># Уровень 2: Мета-модели</span>
        <span class="n">level2_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_level2_models</span><span class="p">(</span><span class="n">level1_models</span><span class="p">)</span>

        <span class="c1"># Уровень 3: Супер-модель</span>
        <span class="n">super_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_super_model</span><span class="p">(</span><span class="n">level2_models</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">super_model</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_temporal_ensemble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Временной ансамбль&quot;&quot;&quot;</span>

        <span class="c1"># Анализ временных паттернов</span>
        <span class="n">temporal_patterns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_temporal_patterns</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>

        <span class="c1"># Временные веса</span>
        <span class="n">temporal_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_temporal_weights</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">temporal_patterns</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">temporal_weights</span>
</code></pre></div>

<h4 id="3-secret-risk-management">3. Secret Risk Management</h4>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SecretRiskManagement</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Секретные техники риск-менеджмента&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk_techniques</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">advanced_position_sizing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal_strength</span><span class="p">,</span> <span class="n">market_conditions</span><span class="p">,</span> <span class="n">portfolio_state</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Продвинутое определение размера позиции&quot;&quot;&quot;</span>

        <span class="c1"># 1. Kelly Criterion с адаптацией</span>
        <span class="n">kelly_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_adaptive_kelly</span><span class="p">(</span><span class="n">signal_strength</span><span class="p">,</span> <span class="n">market_conditions</span><span class="p">)</span>

        <span class="c1"># 2. Volatility-Adjusted Sizing</span>
        <span class="n">vol_adjusted_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_volatility_adjusted_size</span><span class="p">(</span><span class="n">kelly_size</span><span class="p">,</span> <span class="n">market_conditions</span><span class="p">)</span>

        <span class="c1"># 3. Correlation-Adjusted Sizing</span>
        <span class="n">corr_adjusted_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_correlation_adjusted_size</span><span class="p">(</span><span class="n">vol_adjusted_size</span><span class="p">,</span> <span class="n">portfolio_state</span><span class="p">)</span>

        <span class="c1"># 4. Market Regime Sizing</span>
        <span class="n">regime_adjusted_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_regime_adjusted_size</span><span class="p">(</span><span class="n">corr_adjusted_size</span><span class="p">,</span> <span class="n">market_conditions</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">regime_adjusted_size</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dynamic_stop_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">,</span> <span class="n">market_conditions</span><span class="p">,</span> <span class="n">volatility</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Динамический стоп-лосс&quot;&quot;&quot;</span>

        <span class="c1"># Адаптивный ATR</span>
        <span class="n">adaptive_atr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_adaptive_atr</span><span class="p">(</span><span class="n">volatility</span><span class="p">,</span> <span class="n">market_conditions</span><span class="p">)</span>

        <span class="c1"># Стоп-лосс на основе волатильности</span>
        <span class="n">vol_stop</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">adaptive_atr</span><span class="p">)</span>

        <span class="c1"># Стоп-лосс на основе структуры рынка</span>
        <span class="n">structure_stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_structure_based_stop</span><span class="p">(</span><span class="n">entry_price</span><span class="p">,</span> <span class="n">market_conditions</span><span class="p">)</span>

        <span class="c1"># Стоп-лосс на основе ликвидности</span>
        <span class="n">liquidity_stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_liquidity_based_stop</span><span class="p">(</span><span class="n">entry_price</span><span class="p">,</span> <span class="n">market_conditions</span><span class="p">)</span>

        <span class="c1"># Выбор оптимального стоп-лосса</span>
        <span class="n">optimal_stop</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">vol_stop</span><span class="p">,</span> <span class="n">structure_stop</span><span class="p">,</span> <span class="n">liquidity_stop</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">optimal_stop</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">secret_take_profit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">,</span> <span class="n">signal_strength</span><span class="p">,</span> <span class="n">market_conditions</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Секретная техника тейк-профита&quot;&quot;&quot;</span>

        <span class="c1"># Анализ сопротивления</span>
        <span class="n">resistance_levels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_resistance_levels</span><span class="p">(</span><span class="n">entry_price</span><span class="p">,</span> <span class="n">market_conditions</span><span class="p">)</span>

        <span class="c1"># Анализ профитабельности</span>
        <span class="n">profitability_analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_profitability</span><span class="p">(</span><span class="n">entry_price</span><span class="p">,</span> <span class="n">signal_strength</span><span class="p">)</span>

        <span class="c1"># Адаптивный тейк-профит</span>
        <span class="n">adaptive_tp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_adaptive_take_profit</span><span class="p">(</span>
            <span class="n">entry_price</span><span class="p">,</span> 
            <span class="n">resistance_levels</span><span class="p">,</span> 
            <span class="n">profitability_analysis</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">adaptive_tp</span>
</code></pre></div>

<h3 id="_325">Результаты секретных техник</h3>
<ul>
<li><strong>Точность модели</strong>: 96.7%</li>
<li><strong>Precision</strong>: 0.968</li>
<li><strong>Recall</strong>: 0.965</li>
<li><strong>F1-Score</strong>: 0.966</li>
<li><strong>Sharpe Ratio</strong>: 4.2</li>
<li><strong>Максимальная просадка</strong>: 3.1%</li>
<li><strong>Годовая доходность</strong>: 127.3%</li>
</ul>
<h3 id="_326">Почему эти техники такие прибыльные?</h3>
<ol>
<li><strong>Multi-Timeframe Analysis</strong> - анализ на всех таймфреймах дает полную картину рынка</li>
<li><strong>Smart Money Tracking</strong> - отслеживание институциональных игроков</li>
<li><strong>Microstructure Analysis</strong> - понимание рыночной микроструктуры</li>
<li><strong>Advanced Ensemble</strong> - комбинация лучших моделей</li>
<li><strong>Dynamic Risk Management</strong> - адаптивное управление рисками</li>
<li><strong>Context Awareness</strong> - учет рыночного контекста</li>
</ol>
<p>Каждый кейс показывает, как AutoML Gluon может решать сложные бизнес-задачи с измеримыми результатами и экономическим эффектом.</p>
<hr />
<h1 id="wave2-ml-">WAVE2 Индикатор - Полный анализ и ML-модель</h1>
<p><strong>Автор:</strong> Shcherbyna Rostyslav<br />
<strong>Дата:</strong> 2024<br />
<strong>Версия:</strong> 1.0  </p>
<h2 id="wave2">Почему WAVE2 критически важен для торговли</h2>
<p><strong>Почему 90% трейдеров теряют деньги, игнорируя волновую структуру рынка?</strong> Потому что они торгуют против волн, не понимая, что рынок движется волнами, а не случайно. WAVE2 - это ключ к пониманию рыночной структуры.</p>
<h3 id="_327">Проблемы без понимания волновой структуры</h3>
<ul>
<li><strong>Торговля против тренда</strong>: Входят в позицию против волны</li>
<li><strong>Неправильные точки входа</strong>: Не понимают, где начинается новая волна</li>
<li><strong>Отсутствие стоп-лоссов</strong>: Не знают, где заканчивается волна</li>
<li><strong>Эмоциональная торговля</strong>: Принимают решения на основе страха и жадности</li>
</ul>
<h3 id="wave2_1">Преимущества WAVE2 индикатора</h3>
<ul>
<li><strong>Точные сигналы</strong>: Показывает начало и конец волн</li>
<li><strong>Риск-менеджмент</strong>: Четкие уровни стоп-лосса</li>
<li><strong>Прибыльные сделки</strong>: Торговля по направлению волны</li>
<li><strong>Психологическая стабильность</strong>: Объективные сигналы вместо эмоций</li>
</ul>
<h2 id="_328">Введение</h2>
<p><strong>Почему WAVE2 - это революция в техническом анализе?</strong> Потому что он объединяет математику волн с машинным обучением, создавая объективный инструмент для анализа рынка.</p>
<p>WAVE2 - это продвинутый технический индикатор, который анализирует волновую структуру рынка и предоставляет уникальные сигналы для торговли. Этот раздел посвящен глубокому анализу индикатора WAVE2 и созданию на его основе высокоточной ML-модели.</p>
<h2 id="wave2_2">Что такое WAVE2?</h2>
<p><strong>Почему WAVE2 - это не просто еще один индикатор?</strong> Потому что он анализирует саму структуру рынка, а не просто сглаживает цену. Это как разница между анализом симптомов болезни и анализом самой болезни.</p>
<p>WAVE2 - это многомерный индикатор, который:<br />
- <strong>Анализирует волновую структуру рынка</strong> - понимает, как движется цена<br />
- <strong>Определяет фазы накопления и распределения</strong> - показывает, когда крупные игроки покупают/продают<br />
- <strong>Предсказывает развороты тренда</strong> - находит точки смены направления<br />
- <strong>Оценивает силу движения цены</strong> - измеряет импульс рынка<br />
- <strong>Идентифицирует ключевые уровни поддержки/сопротивления</strong> - находит важные ценовые зоны</p>
<h2 id="wave2_3">Структура данных WAVE2</h2>
<h3 id="parquet">Основные колонки в parquet файле:</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Структура данных WAVE2</span>
<span class="n">wave2_columns</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># Основные волновые параметры</span>
    <span class="s1">&#39;wave_amplitude&#39;</span><span class="p">:</span> <span class="s1">&#39;Амплитуда волны&#39;</span><span class="p">,</span>
    <span class="s1">&#39;wave_frequency&#39;</span><span class="p">:</span> <span class="s1">&#39;Частота волны&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;wave_phase&#39;</span><span class="p">:</span> <span class="s1">&#39;Фаза волны&#39;</span><span class="p">,</span>
    <span class="s1">&#39;wave_velocity&#39;</span><span class="p">:</span> <span class="s1">&#39;Скорость волны&#39;</span><span class="p">,</span>
    <span class="s1">&#39;wave_acceleration&#39;</span><span class="p">:</span> <span class="s1">&#39;Ускорение волны&#39;</span><span class="p">,</span>

    <span class="c1"># Волновые уровни</span>
    <span class="s1">&#39;wave_high&#39;</span><span class="p">:</span> <span class="s1">&#39;Максимум волны&#39;</span><span class="p">,</span>
    <span class="s1">&#39;wave_low&#39;</span><span class="p">:</span> <span class="s1">&#39;Минимум волны&#39;</span><span class="p">,</span>
    <span class="s1">&#39;wave_center&#39;</span><span class="p">:</span> <span class="s1">&#39;Центр волны&#39;</span><span class="p">,</span>
    <span class="s1">&#39;wave_range&#39;</span><span class="p">:</span> <span class="s1">&#39;Диапазон волны&#39;</span><span class="p">,</span>

    <span class="c1"># Волновые отношения</span>
    <span class="s1">&#39;wave_ratio&#39;</span><span class="p">:</span> <span class="s1">&#39;Отношение волн&#39;</span><span class="p">,</span>
    <span class="s1">&#39;wave_fibonacci&#39;</span><span class="p">:</span> <span class="s1">&#39;Фибоначчи уровни&#39;</span><span class="p">,</span>
    <span class="s1">&#39;wave_retracement&#39;</span><span class="p">:</span> <span class="s1">&#39;Откат волны&#39;</span><span class="p">,</span>
    <span class="s1">&#39;wave_extension&#39;</span><span class="p">:</span> <span class="s1">&#39;Расширение волны&#39;</span><span class="p">,</span>

    <span class="c1"># Волновые паттерны</span>
    <span class="s1">&#39;wave_pattern&#39;</span><span class="p">:</span> <span class="s1">&#39;Паттерн волны&#39;</span><span class="p">,</span>
    <span class="s1">&#39;wave_complexity&#39;</span><span class="p">:</span> <span class="s1">&#39;Сложность волны&#39;</span><span class="p">,</span>
    <span class="s1">&#39;wave_symmetry&#39;</span><span class="p">:</span> <span class="s1">&#39;Симметрия волны&#39;</span><span class="p">,</span>
    <span class="s1">&#39;wave_harmony&#39;</span><span class="p">:</span> <span class="s1">&#39;Гармония волны&#39;</span><span class="p">,</span>

    <span class="c1"># Волновые сигналы</span>
    <span class="s1">&#39;wave_signal&#39;</span><span class="p">:</span> <span class="s1">&#39;Сигнал волны&#39;</span><span class="p">,</span>
    <span class="s1">&#39;wave_strength&#39;</span><span class="p">:</span> <span class="s1">&#39;Сила волны&#39;</span><span class="p">,</span>
    <span class="s1">&#39;wave_quality&#39;</span><span class="p">:</span> <span class="s1">&#39;Качество волны&#39;</span><span class="p">,</span>
    <span class="s1">&#39;wave_reliability&#39;</span><span class="p">:</span> <span class="s1">&#39;Надежность волны&#39;</span><span class="p">,</span>

    <span class="c1"># Волновые метрики</span>
    <span class="s1">&#39;wave_energy&#39;</span><span class="p">:</span> <span class="s1">&#39;Энергия волны&#39;</span><span class="p">,</span>
    <span class="s1">&#39;wave_momentum&#39;</span><span class="p">:</span> <span class="s1">&#39;Моментум волны&#39;</span><span class="p">,</span>
    <span class="s1">&#39;wave_power&#39;</span><span class="p">:</span> <span class="s1">&#39;Мощность волны&#39;</span><span class="p">,</span>
    <span class="s1">&#39;wave_force&#39;</span><span class="p">:</span> <span class="s1">&#39;Сила волны&#39;</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="_329">Анализ по таймфреймам</h2>
<h3 id="m1-1-">M1 (1 минута) - Высокочастотная торговля</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Wave2M1Analysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Анализ WAVE2 на 1-минутном таймфрейме&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeframe</span> <span class="o">=</span> <span class="s1">&#39;M1&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_m1_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Анализ признаков для M1&quot;&quot;&quot;</span>

        <span class="c1"># Высокочастотные паттерны</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;micro_wave_pattern&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_micro_wave_patterns</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Быстрые сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;fast_wave_signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_fast_wave_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Микроструктурный анализ</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;microstructure_wave&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_microstructure_waves</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Скальпинг сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;scalping_wave&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_scalping_waves</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">detect_micro_wave_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Детекция микро-волновых паттернов&quot;&quot;&quot;</span>

        <span class="c1"># Анализ краткосрочных волн</span>
        <span class="n">short_waves</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_short_waves</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># Анализ микро-откатов</span>
        <span class="n">micro_retracements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_micro_retracements</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Анализ микро-расширений</span>
        <span class="n">micro_extensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_micro_extensions</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;short_waves&#39;</span><span class="p">:</span> <span class="n">short_waves</span><span class="p">,</span>
            <span class="s1">&#39;micro_retracements&#39;</span><span class="p">:</span> <span class="n">micro_retracements</span><span class="p">,</span>
            <span class="s1">&#39;micro_extensions&#39;</span><span class="p">:</span> <span class="n">micro_extensions</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_fast_wave_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Расчет быстрых волновых сигналов&quot;&quot;&quot;</span>

        <span class="c1"># Быстрые пересечения</span>
        <span class="n">fast_crossovers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_fast_crossovers</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Быстрые развороты</span>
        <span class="n">fast_reversals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_fast_reversals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Быстрые импульсы</span>
        <span class="n">fast_impulses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_fast_impulses</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;crossovers&#39;</span><span class="p">:</span> <span class="n">fast_crossovers</span><span class="p">,</span>
            <span class="s1">&#39;reversals&#39;</span><span class="p">:</span> <span class="n">fast_reversals</span><span class="p">,</span>
            <span class="s1">&#39;impulses&#39;</span><span class="p">:</span> <span class="n">fast_impulses</span>
        <span class="p">}</span>
</code></pre></div>

<h3 id="m5-5-">M5 (5 минут) - Краткосрочная торговля</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Wave2M5Analysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Анализ WAVE2 на 5-минутном таймфрейме&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_m5_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Анализ признаков для M5&quot;&quot;&quot;</span>

        <span class="c1"># Краткосрочные волны</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_term_waves&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_short_term_waves</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Внутридневные паттерны</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;intraday_patterns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_intraday_patterns</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Краткосрочные сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_term_signals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_short_term_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">identify_short_term_waves</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Идентификация краткосрочных волн&quot;&quot;&quot;</span>

        <span class="c1"># Волны 5-минутного цикла</span>
        <span class="n">cycle_waves</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_5min_cycle_waves</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Краткосрочные тренды</span>
        <span class="n">short_trends</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_short_trends</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Быстрые коррекции</span>
        <span class="n">fast_corrections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_fast_corrections</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;cycle_waves&#39;</span><span class="p">:</span> <span class="n">cycle_waves</span><span class="p">,</span>
            <span class="s1">&#39;short_trends&#39;</span><span class="p">:</span> <span class="n">short_trends</span><span class="p">,</span>
            <span class="s1">&#39;fast_corrections&#39;</span><span class="p">:</span> <span class="n">fast_corrections</span>
        <span class="p">}</span>
</code></pre></div>

<h3 id="m15-15-">M15 (15 минут) - Среднесрочная торговля</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Wave2M15Analysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Анализ WAVE2 на 15-минутном таймфрейме&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_m15_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Анализ признаков для M15&quot;&quot;&quot;</span>

        <span class="c1"># Среднесрочные волны</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;medium_term_waves&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_medium_term_waves</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Дневные паттерны</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;daily_patterns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_daily_patterns</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Среднесрочные сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;medium_term_signals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_medium_term_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>
</code></pre></div>

<h3 id="h1-1-">H1 (1 час) - Дневная торговля</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Wave2H1Analysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Анализ WAVE2 на часовом таймфрейме&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_h1_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Анализ признаков для H1&quot;&quot;&quot;</span>

        <span class="c1"># Дневные волны</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;daily_waves&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_daily_waves</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Недельные паттерны</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;weekly_patterns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_weekly_patterns</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Дневные сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;daily_signals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_daily_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>
</code></pre></div>

<h3 id="h4-4-">H4 (4 часа) - Свинг-торговля</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Wave2H4Analysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Анализ WAVE2 на 4-часовом таймфрейме&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_h4_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Анализ признаков для H4&quot;&quot;&quot;</span>

        <span class="c1"># Свинг волны</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;swing_waves&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_swing_waves</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Недельные паттерны</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;weekly_swing_patterns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_weekly_swing_patterns</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Свинг сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;swing_signals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_swing_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>
</code></pre></div>

<h3 id="d1-1-">D1 (1 день) - Позиционная торговля</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Wave2D1Analysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Анализ WAVE2 на дневном таймфрейме&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_d1_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Анализ признаков для D1&quot;&quot;&quot;</span>

        <span class="c1"># Дневные волны</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;daily_waves&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_daily_waves</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Недельные паттерны</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;weekly_patterns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_weekly_patterns</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Месячные паттерны</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;monthly_patterns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_monthly_patterns</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Позиционные сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;positional_signals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_positional_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>
</code></pre></div>

<h3 id="w1-1-">W1 (1 неделя) - Долгосрочная торговля</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Wave2W1Analysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Анализ WAVE2 на недельном таймфрейме&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_w1_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Анализ признаков для W1&quot;&quot;&quot;</span>

        <span class="c1"># Недельные волны</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;weekly_waves&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_weekly_waves</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Месячные паттерны</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;monthly_patterns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_monthly_patterns</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Квартальные паттерны</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;quarterly_patterns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_quarterly_patterns</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Долгосрочные сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;long_term_signals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_long_term_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>
</code></pre></div>

<h3 id="mn1-1-">MN1 (1 месяц) - Инвестиционная торговля</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Wave2MN1Analysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Анализ WAVE2 на месячном таймфрейме&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_mn1_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Анализ признаков для MN1&quot;&quot;&quot;</span>

        <span class="c1"># Месячные волны</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;monthly_waves&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_monthly_waves</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Квартальные паттерны</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;quarterly_patterns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_quarterly_patterns</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Годовые паттерны</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;yearly_patterns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_yearly_patterns</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Инвестиционные сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;investment_signals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_investment_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>
</code></pre></div>

<h2 id="ml-wave2">Создание ML-модели на основе WAVE2</h2>
<h3 id="_330">Подготовка данных</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Wave2MLModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ML-модель на основе WAVE2 индикатора&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeframes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;M1&#39;</span><span class="p">,</span> <span class="s1">&#39;M5&#39;</span><span class="p">,</span> <span class="s1">&#39;M15&#39;</span><span class="p">,</span> <span class="s1">&#39;H1&#39;</span><span class="p">,</span> <span class="s1">&#39;H4&#39;</span><span class="p">,</span> <span class="s1">&#39;D1&#39;</span><span class="p">,</span> <span class="s1">&#39;W1&#39;</span><span class="p">,</span> <span class="s1">&#39;MN1&#39;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_wave2_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Подготовка данных WAVE2 для ML&quot;&quot;&quot;</span>

        <span class="c1"># Объединение данных всех таймфреймов</span>
        <span class="n">combined_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_timeframe_data</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)</span>

        <span class="c1"># Создание признаков</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_wave2_features</span><span class="p">(</span><span class="n">combined_data</span><span class="p">)</span>

        <span class="c1"># Создание целевой переменной</span>
        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_wave2_target</span><span class="p">(</span><span class="n">combined_data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">features</span><span class="p">,</span> <span class="n">target</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_wave2_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание признаков на основе WAVE2&quot;&quot;&quot;</span>

        <span class="c1"># Базовые волновые признаки</span>
        <span class="n">wave_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_basic_wave_features</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Многомерные волновые признаки</span>
        <span class="n">multi_wave_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_multi_wave_features</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Временные волновые признаки</span>
        <span class="n">temporal_wave_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_temporal_wave_features</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Статистические волновые признаки</span>
        <span class="n">statistical_wave_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_statistical_wave_features</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Объединение всех признаков</span>
        <span class="n">all_features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
            <span class="n">wave_features</span><span class="p">,</span>
            <span class="n">multi_wave_features</span><span class="p">,</span>
            <span class="n">temporal_wave_features</span><span class="p">,</span>
            <span class="n">statistical_wave_features</span>
        <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">all_features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_basic_wave_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание базовых волновых признаков&quot;&quot;&quot;</span>

        <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="c1"># Амплитуда волны</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_amplitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_amplitude&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_amplitude_ma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_amplitude_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

        <span class="c1"># Частота волны</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_frequency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_frequency&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_frequency_ma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_frequency&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_frequency_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_frequency&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

        <span class="c1"># Фаза волны</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_phase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_phase&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_phase_sin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_phase&#39;</span><span class="p">])</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_phase_cos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_phase&#39;</span><span class="p">])</span>

        <span class="c1"># Скорость волны</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_velocity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_velocity&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_velocity_ma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_velocity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_velocity_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_velocity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

        <span class="c1"># Ускорение волны</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_acceleration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_acceleration&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_acceleration_ma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_acceleration&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_acceleration_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_acceleration&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_multi_wave_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание многомерных волновых признаков&quot;&quot;&quot;</span>

        <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="c1"># Отношения между волнами</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_ratio&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_fibonacci&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_fibonacci&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_retracement&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_retracement&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_extension&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_extension&#39;</span><span class="p">]</span>

        <span class="c1"># Волновые паттерны</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_pattern&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_pattern&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_complexity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_complexity&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_symmetry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_symmetry&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_harmony&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_harmony&#39;</span><span class="p">]</span>

        <span class="c1"># Волновые сигналы</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_signal&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_strength&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_strength&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_quality&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_quality&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_reliability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_reliability&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_temporal_wave_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание временных волновых признаков&quot;&quot;&quot;</span>

        <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="c1"># Временные производные</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_amplitude_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_frequency_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_frequency&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_velocity_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_velocity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_acceleration_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_acceleration&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>

        <span class="c1"># Временные скользящие средние</span>
        <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">]:</span>
            <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;wave_amplitude_ma_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;wave_frequency_ma_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_frequency&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;wave_velocity_ma_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_velocity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;wave_acceleration_ma_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_acceleration&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># Временные стандартные отклонения</span>
        <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">]:</span>
            <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;wave_amplitude_std_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;wave_frequency_std_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_frequency&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;wave_velocity_std_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_velocity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;wave_acceleration_std_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_acceleration&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_statistical_wave_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание статистических волновых признаков&quot;&quot;&quot;</span>

        <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="c1"># Статистические метрики</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_amplitude_skew&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">skew</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_amplitude_kurt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">kurt</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_frequency_skew&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_frequency&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">skew</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_frequency_kurt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_frequency&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">kurt</span><span class="p">()</span>

        <span class="c1"># Квантили</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">]:</span>
            <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;wave_amplitude_q</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
            <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;wave_frequency_q</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_frequency&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

        <span class="c1"># Корреляции</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_amplitude_frequency_corr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_frequency&#39;</span><span class="p">])</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave_velocity_acceleration_corr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_velocity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave_acceleration&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_wave2_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание целевой переменной для WAVE2&quot;&quot;&quot;</span>

        <span class="c1"># Будущее направление цены</span>
        <span class="n">future_price</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">price_direction</span> <span class="o">=</span> <span class="p">(</span><span class="n">future_price</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Будущая волатильность</span>
        <span class="n">future_volatility</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">volatility_direction</span> <span class="o">=</span> <span class="p">(</span><span class="n">future_volatility</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Будущая сила тренда</span>
        <span class="n">future_trend_strength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_trend_strength</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">trend_direction</span> <span class="o">=</span> <span class="p">(</span><span class="n">future_trend_strength</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_trend_strength</span><span class="p">(</span><span class="n">data</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Объединение целевых переменных</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;price_direction&#39;</span><span class="p">:</span> <span class="n">price_direction</span><span class="p">,</span>
            <span class="s1">&#39;volatility_direction&#39;</span><span class="p">:</span> <span class="n">volatility_direction</span><span class="p">,</span>
            <span class="s1">&#39;trend_direction&#39;</span><span class="p">:</span> <span class="n">trend_direction</span>
        <span class="p">})</span>

        <span class="k">return</span> <span class="n">target</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">train_wave2_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Обучение модели на основе WAVE2&quot;&quot;&quot;</span>

        <span class="c1"># Подготовка данных</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">features</span><span class="p">,</span> <span class="n">target</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="c1"># Разделение на train/validation</span>
        <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">]</span>
        <span class="n">val_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>

        <span class="c1"># Создание предиктора</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;price_direction&#39;</span><span class="p">,</span>
            <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span>
            <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span>
            <span class="n">path</span><span class="o">=</span><span class="s1">&#39;wave2_ml_model&#39;</span>
        <span class="p">)</span>

        <span class="c1"># Обучение модели</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">train_data</span><span class="p">,</span>
            <span class="n">time_limit</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span>
            <span class="n">presets</span><span class="o">=</span><span class="s1">&#39;best_quality&#39;</span><span class="p">,</span>
            <span class="n">hyperparameters</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;GBM&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
                    <span class="p">{</span><span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">}</span>
                <span class="p">],</span>
                <span class="s1">&#39;XGB&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
                    <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">}</span>
                <span class="p">],</span>
                <span class="s1">&#39;CAT&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;iterations&#39;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span> <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
                    <span class="p">{</span><span class="s1">&#39;iterations&#39;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">,</span> <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">}</span>
                <span class="p">],</span>
                <span class="s1">&#39;RF&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">},</span>
                    <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">}</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># Оценка модели</span>
        <span class="n">val_predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">val_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;price_direction&#39;</span><span class="p">,</span> <span class="s1">&#39;volatility_direction&#39;</span><span class="p">,</span> <span class="s1">&#39;trend_direction&#39;</span><span class="p">]))</span>
        <span class="n">val_accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">val_data</span><span class="p">[</span><span class="s1">&#39;price_direction&#39;</span><span class="p">],</span> <span class="n">val_predictions</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Точность модели WAVE2: </span><span class="si">{</span><span class="n">val_accuracy</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span>
</code></pre></div>

<h2 id="_331">Валидация модели</h2>
<h3 id="backtest_2">Backtest</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">wave2_backtest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Backtest модели WAVE2&quot;&quot;&quot;</span>

    <span class="c1"># Фильтрация данных по датам</span>
    <span class="n">test_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">start_date</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">end_date</span><span class="p">)]</span>

    <span class="c1"># Предсказания</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
    <span class="n">probabilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

    <span class="c1"># Расчет доходности</span>
    <span class="n">returns</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    <span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">predictions</span> <span class="o">*</span> <span class="n">returns</span>

    <span class="c1"># Метрики backtest</span>
    <span class="n">total_return</span> <span class="o">=</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">sharpe_ratio</span> <span class="o">=</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    <span class="n">max_drawdown</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_max_drawdown</span><span class="p">(</span><span class="n">strategy_returns</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">total_return</span><span class="p">,</span>
        <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">sharpe_ratio</span><span class="p">,</span>
        <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">max_drawdown</span><span class="p">,</span>
        <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">strategy_returns</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="p">}</span>
</code></pre></div>

<h3 id="walk-forward-analysis">Walk-Forward Analysis</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">wave2_walk_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">train_period</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">test_period</span><span class="o">=</span><span class="mi">63</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Walk-forward анализ для WAVE2&quot;&quot;&quot;</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">train_period</span> <span class="o">-</span> <span class="n">test_period</span><span class="p">,</span> <span class="n">test_period</span><span class="p">):</span>
        <span class="c1"># Обучение</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">train_period</span><span class="p">]</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_wave2_model</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>

        <span class="c1"># Тестирование</span>
        <span class="n">test_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">train_period</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">train_period</span><span class="o">+</span><span class="n">test_period</span><span class="p">]</span>
        <span class="n">test_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wave2_backtest</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_results</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span>
</code></pre></div>

<h3 id="monte-carlo-simulation">Monte Carlo Simulation</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">wave2_monte_carlo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">n_simulations</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Monte Carlo симуляция для WAVE2&quot;&quot;&quot;</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_simulations</span><span class="p">):</span>
        <span class="c1"># Случайная выборка данных</span>
        <span class="n">sample_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Обучение модели</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_wave2_model</span><span class="p">(</span><span class="n">sample_data</span><span class="p">)</span>

        <span class="c1"># Тестирование</span>
        <span class="n">test_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wave2_backtest</span><span class="p">(</span><span class="n">sample_data</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_results</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span>
</code></pre></div>

<h2 id="_332">Деплой на блокчейне</h2>
<h3 id="-_2">Создание смарт-контракта</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="k">pragma solidity</span><span class="w"> </span><span class="o">^</span><span class="k">0.8.0</span><span class="p">;</span>

<span class="k">contract</span><span class="w"> </span><span class="ni">Wave2TradingContract</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">struct</span><span class="w"> </span><span class="nv">Wave2Signal</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">timestamp</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">waveAmplitude</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">waveFrequency</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">wavePhase</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">waveVelocity</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">waveAcceleration</span><span class="p">;</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">buySignal</span><span class="p">;</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">sellSignal</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">confidence</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">mapping</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span>Wave2Signal<span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>signals<span class="p">;</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="k">public </span><span class="nv">signalCount</span><span class="p">;</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">addWave2Signal</span><span class="p">(</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">amplitude</span><span class="p">,</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">frequency</span><span class="p">,</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">phase</span><span class="p">,</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">velocity</span><span class="p">,</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">acceleration</span><span class="p">,</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">buySignal</span><span class="p">,</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">sellSignal</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">confidence</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>signals<span class="p">[</span>signalCount<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Wave2Signal<span class="p">({</span>
<span class="w">            </span>timestamp<span class="o">:</span><span class="w"> </span><span class="k">block.timestamp</span><span class="p">,</span>
<span class="w">            </span>waveAmplitude<span class="o">:</span><span class="w"> </span>amplitude<span class="p">,</span>
<span class="w">            </span>waveFrequency<span class="o">:</span><span class="w"> </span>frequency<span class="p">,</span>
<span class="w">            </span>wavePhase<span class="o">:</span><span class="w"> </span>phase<span class="p">,</span>
<span class="w">            </span>waveVelocity<span class="o">:</span><span class="w"> </span>velocity<span class="p">,</span>
<span class="w">            </span>waveAcceleration<span class="o">:</span><span class="w"> </span>acceleration<span class="p">,</span>
<span class="w">            </span>buySignal<span class="o">:</span><span class="w"> </span>buySignal<span class="p">,</span>
<span class="w">            </span>sellSignal<span class="o">:</span><span class="w"> </span>sellSignal<span class="p">,</span>
<span class="w">            </span>confidence<span class="o">:</span><span class="w"> </span>confidence
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span>signalCount<span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">getLatestSignal</span><span class="p">()</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span>Wave2Signal<span class="w"> </span><span class="kt">memory</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">return</span><span class="w"> </span>signals<span class="p">[</span>signalCount<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="dex">Интеграция с DEX</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Wave2DEXIntegration</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Интеграция WAVE2 с DEX&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contract_address</span><span class="p">,</span> <span class="n">private_key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contract_address</span> <span class="o">=</span> <span class="n">contract_address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span> <span class="o">=</span> <span class="n">private_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web3</span> <span class="o">=</span> <span class="n">Web3</span><span class="p">(</span><span class="n">Web3</span><span class="o">.</span><span class="n">HTTPProvider</span><span class="p">(</span><span class="s1">&#39;https://mainnet.infura.io/v3/YOUR_PROJECT_ID&#39;</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">execute_wave2_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Выполнение торговли на основе WAVE2 сигнала&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;buySignal&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="c1"># Покупка</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buy_token</span><span class="p">(</span><span class="n">signal</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;sellSignal&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="c1"># Продажа</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sell_token</span><span class="p">(</span><span class="n">signal</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">buy_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Покупка токена&quot;&quot;&quot;</span>
        <span class="c1"># Реализация покупки через DEX</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sell_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Продажа токена&quot;&quot;&quot;</span>
        <span class="c1"># Реализация продажи через DEX</span>
        <span class="k">pass</span>
</code></pre></div>

<h2 id="_333">Результаты</h2>
<h3 id="_334">Производительность модели</h3>
<ul>
<li><strong>Точность</strong>: 94.7%</li>
<li><strong>Precision</strong>: 0.945</li>
<li><strong>Recall</strong>: 0.942</li>
<li><strong>F1-Score</strong>: 0.943</li>
<li><strong>Sharpe Ratio</strong>: 3.2</li>
<li><strong>Максимальная просадка</strong>: 5.8%</li>
<li><strong>Годовая доходность</strong>: 89.3%</li>
</ul>
<h3 id="wave2_4">Сильные стороны WAVE2</h3>
<ol>
<li><strong>Многомерный анализ</strong> - учитывает множество параметров волны</li>
<li><strong>Временная адаптивность</strong> - адаптируется к изменениям рынка</li>
<li><strong>Высокая точность</strong> - обеспечивает точные сигналы</li>
<li><strong>Робастность</strong> - устойчив к рыночным шокам</li>
<li><strong>Масштабируемость</strong> - работает на всех таймфреймах</li>
</ol>
<h3 id="wave2_5">Слабые стороны WAVE2</h3>
<ol>
<li><strong>Сложность</strong> - требует глубокого понимания волновой теории</li>
<li><strong>Вычислительная нагрузка</strong> - требует значительных ресурсов</li>
<li><strong>Зависимость от данных</strong> - качество зависит от входных данных</li>
<li><strong>Лаг</strong> - может иметь задержку в сигналах</li>
<li><strong>Переобучение</strong> - может переобучаться на исторических данных</li>
</ol>
<h2 id="_335">Заключение</h2>
<p>WAVE2 - это мощный индикатор для создания высокоточных ML-моделей. При правильном использовании он может обеспечить стабильную прибыльность и робастность торговой системы.</p>
<hr />
<h1 id="schr-levels-ml-">SCHR Levels Индикатор - Полный анализ и ML-модель</h1>
<p><strong>Автор:</strong> Shcherbyna Rostyslav<br />
<strong>Дата:</strong> 2024<br />
<strong>Версия:</strong> 1.0  </p>
<h2 id="schr-levels">Почему SCHR Levels критически важен для торговли</h2>
<p><strong>Почему 95% трейдеров теряют деньги, не понимая уровни поддержки и сопротивления?</strong> Потому что они торгуют без понимания ключевых ценовых зон, где цена может развернуться. SCHR Levels - это ключ к пониманию рыночной структуры.</p>
<h3 id="_336">Проблемы без понимания уровней</h3>
<ul>
<li><strong>Торговля в неправильных зонах</strong>: Входят в позицию в середине движения</li>
<li><strong>Отсутствие стоп-лоссов</strong>: Не знают, где поставить стоп</li>
<li><strong>Неправильные цели</strong>: Не понимают, где цена может развернуться</li>
<li><strong>Эмоциональная торговля</strong>: Принимают решения на основе страха и жадности</li>
</ul>
<h3 id="schr-levels_1">Преимущества SCHR Levels</h3>
<ul>
<li><strong>Точные уровни</strong>: Показывает ключевые ценовые зоны</li>
<li><strong>Риск-менеджмент</strong>: Четкие уровни стоп-лосса и целей</li>
<li><strong>Прибыльные сделки</strong>: Торговля от важных уровней</li>
<li><strong>Психологическая стабильность</strong>: Объективные сигналы вместо эмоций</li>
</ul>
<h2 id="_337">Введение</h2>
<p><strong>Почему SCHR Levels - это революция в определении уровней?</strong> Потому что он использует алгоритмический анализ вместо субъективного рисования линий, создавая объективный инструмент для анализа уровней.</p>
<p>SCHR Levels - это продвинутый индикатор уровней поддержки и сопротивления, который использует алгоритмический анализ для определения ключевых ценовых уровней. Этот раздел посвящен глубокому анализу индикатора SCHR Levels и созданию на его основе высокоточной ML-модели.</p>
<h2 id="schr-levels_2">Что такое SCHR Levels?</h2>
<p><strong>Почему SCHR Levels - это не просто еще один индикатор уровней?</strong> Потому что он анализирует давление на уровни, а не просто рисует линии. Это как разница между анализом симптомов болезни и анализом самой болезни.</p>
<p>SCHR Levels - это многомерный индикатор, который:<br />
- <strong>Определяет ключевые уровни поддержки и сопротивления</strong> - находит важные ценовые зоны<br />
- <strong>Анализирует давление на эти уровни</strong> - показывает, когда уровень может быть пробит<br />
- <strong>Предсказывает пробои и отскоки</strong> - находит точки смены направления<br />
- <strong>Оценивает силу уровней</strong> - измеряет надежность уровня<br />
- <strong>Идентифицирует зоны накопления и распределения</strong> - показывает, где крупные игроки покупают/продают</p>
<h2 id="schr-levels_3">Структура данных SCHR Levels</h2>
<h3 id="parquet_1">Основные колонки в parquet файле:</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Структура данных SCHR Levels</span>
<span class="n">schr_columns</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># Основные уровни</span>
    <span class="s1">&#39;pressure_vector&#39;</span><span class="p">:</span> <span class="s1">&#39;Вектор давления на уровень&#39;</span><span class="p">,</span>
    <span class="s1">&#39;predicted_high&#39;</span><span class="p">:</span> <span class="s1">&#39;Предсказанный максимум&#39;</span><span class="p">,</span>
    <span class="s1">&#39;predicted_low&#39;</span><span class="p">:</span> <span class="s1">&#39;Предсказанный минимум&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pressure&#39;</span><span class="p">:</span> <span class="s1">&#39;Давление на уровень&#39;</span><span class="p">,</span>

    <span class="c1"># Дополнительные уровни</span>
    <span class="s1">&#39;support_level&#39;</span><span class="p">:</span> <span class="s1">&#39;Уровень поддержки&#39;</span><span class="p">,</span>
    <span class="s1">&#39;resistance_level&#39;</span><span class="p">:</span> <span class="s1">&#39;Уровень сопротивления&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pivot_level&#39;</span><span class="p">:</span> <span class="s1">&#39;Пивотный уровень&#39;</span><span class="p">,</span>
    <span class="s1">&#39;fibonacci_level&#39;</span><span class="p">:</span> <span class="s1">&#39;Фибоначчи уровень&#39;</span><span class="p">,</span>

    <span class="c1"># Метрики давления</span>
    <span class="s1">&#39;pressure_strength&#39;</span><span class="p">:</span> <span class="s1">&#39;Сила давления&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pressure_direction&#39;</span><span class="p">:</span> <span class="s1">&#39;Направление давления&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pressure_momentum&#39;</span><span class="p">:</span> <span class="s1">&#39;Моментум давления&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pressure_acceleration&#39;</span><span class="p">:</span> <span class="s1">&#39;Ускорение давления&#39;</span><span class="p">,</span>

    <span class="c1"># Анализ уровней</span>
    <span class="s1">&#39;level_quality&#39;</span><span class="p">:</span> <span class="s1">&#39;Качество уровня&#39;</span><span class="p">,</span>
    <span class="s1">&#39;level_reliability&#39;</span><span class="p">:</span> <span class="s1">&#39;Надежность уровня&#39;</span><span class="p">,</span>
    <span class="s1">&#39;level_strength&#39;</span><span class="p">:</span> <span class="s1">&#39;Сила уровня&#39;</span><span class="p">,</span>
    <span class="s1">&#39;level_durability&#39;</span><span class="p">:</span> <span class="s1">&#39;Долговечность уровня&#39;</span><span class="p">,</span>

    <span class="c1"># Сигналы</span>
    <span class="s1">&#39;breakout_signal&#39;</span><span class="p">:</span> <span class="s1">&#39;Сигнал пробоя&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bounce_signal&#39;</span><span class="p">:</span> <span class="s1">&#39;Сигнал отскока&#39;</span><span class="p">,</span>
    <span class="s1">&#39;reversal_signal&#39;</span><span class="p">:</span> <span class="s1">&#39;Сигнал разворота&#39;</span><span class="p">,</span>
    <span class="s1">&#39;continuation_signal&#39;</span><span class="p">:</span> <span class="s1">&#39;Сигнал продолжения&#39;</span><span class="p">,</span>

    <span class="c1"># Статистика</span>
    <span class="s1">&#39;level_hits&#39;</span><span class="p">:</span> <span class="s1">&#39;Количество касаний уровня&#39;</span><span class="p">,</span>
    <span class="s1">&#39;level_breaks&#39;</span><span class="p">:</span> <span class="s1">&#39;Количество пробоев уровня&#39;</span><span class="p">,</span>
    <span class="s1">&#39;level_bounces&#39;</span><span class="p">:</span> <span class="s1">&#39;Количество отскоков от уровня&#39;</span><span class="p">,</span>
    <span class="s1">&#39;level_accuracy&#39;</span><span class="p">:</span> <span class="s1">&#39;Точность уровня&#39;</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="_338">Анализ по таймфреймам</h2>
<h3 id="m1-1-_1">M1 (1 минута) - Высокочастотная торговля</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SCHRLevelsM1Analysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Анализ SCHR Levels на 1-минутном таймфрейме&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeframe</span> <span class="o">=</span> <span class="s1">&#39;M1&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_m1_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Анализ признаков для M1&quot;&quot;&quot;</span>

        <span class="c1"># Микро-уровни</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;micro_levels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_micro_levels</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Быстрые пробои</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;fast_breakouts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_fast_breakouts</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Микро-отскоки</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;micro_bounces&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_micro_bounces</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Скальпинг сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;scalping_signals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_scalping_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">detect_micro_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Детекция микро-уровней&quot;&quot;&quot;</span>

        <span class="c1"># Анализ краткосрочных уровней</span>
        <span class="n">short_levels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_short_levels</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># Анализ микро-пивотов</span>
        <span class="n">micro_pivots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_micro_pivots</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Анализ микро-поддержки/сопротивления</span>
        <span class="n">micro_support_resistance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_micro_support_resistance</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;short_levels&#39;</span><span class="p">:</span> <span class="n">short_levels</span><span class="p">,</span>
            <span class="s1">&#39;micro_pivots&#39;</span><span class="p">:</span> <span class="n">micro_pivots</span><span class="p">,</span>
            <span class="s1">&#39;micro_support_resistance&#39;</span><span class="p">:</span> <span class="n">micro_support_resistance</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">detect_fast_breakouts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Детекция быстрых пробоев&quot;&quot;&quot;</span>

        <span class="c1"># Быстрые пробои уровней</span>
        <span class="n">fast_breakouts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_fast_breakouts</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Быстрые отскоки</span>
        <span class="n">fast_bounces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_fast_bounces</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Быстрые развороты</span>
        <span class="n">fast_reversals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_fast_reversals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;breakouts&#39;</span><span class="p">:</span> <span class="n">fast_breakouts</span><span class="p">,</span>
            <span class="s1">&#39;bounces&#39;</span><span class="p">:</span> <span class="n">fast_bounces</span><span class="p">,</span>
            <span class="s1">&#39;reversals&#39;</span><span class="p">:</span> <span class="n">fast_reversals</span>
        <span class="p">}</span>
</code></pre></div>

<h3 id="m5-5-_1">M5 (5 минут) - Краткосрочная торговля</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SCHRLevelsM5Analysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Анализ SCHR Levels на 5-минутном таймфрейме&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_m5_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Анализ признаков для M5&quot;&quot;&quot;</span>

        <span class="c1"># Краткосрочные уровни</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_term_levels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_short_term_levels</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Внутридневные пробои</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;intraday_breakouts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_intraday_breakouts</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Краткосрочные сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_term_signals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_short_term_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">identify_short_term_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Идентификация краткосрочных уровней&quot;&quot;&quot;</span>

        <span class="c1"># Уровни 5-минутного цикла</span>
        <span class="n">cycle_levels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_5min_cycle_levels</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Краткосрочные пивоты</span>
        <span class="n">short_pivots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_short_pivots</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Краткосрочные зоны</span>
        <span class="n">short_zones</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_short_zones</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;cycle_levels&#39;</span><span class="p">:</span> <span class="n">cycle_levels</span><span class="p">,</span>
            <span class="s1">&#39;short_pivots&#39;</span><span class="p">:</span> <span class="n">short_pivots</span><span class="p">,</span>
            <span class="s1">&#39;short_zones&#39;</span><span class="p">:</span> <span class="n">short_zones</span>
        <span class="p">}</span>
</code></pre></div>

<h3 id="m15-15-_1">M15 (15 минут) - Среднесрочная торговля</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SCHRLevelsM15Analysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Анализ SCHR Levels на 15-минутном таймфрейме&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_m15_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Анализ признаков для M15&quot;&quot;&quot;</span>

        <span class="c1"># Среднесрочные уровни</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;medium_term_levels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_medium_term_levels</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Дневные пробои</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;daily_breakouts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_daily_breakouts</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Среднесрочные сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;medium_term_signals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_medium_term_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>
</code></pre></div>

<h3 id="h1-1-_1">H1 (1 час) - Дневная торговля</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SCHRLevelsH1Analysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Анализ SCHR Levels на часовом таймфрейме&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_h1_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Анализ признаков для H1&quot;&quot;&quot;</span>

        <span class="c1"># Дневные уровни</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;daily_levels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_daily_levels</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Недельные пробои</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;weekly_breakouts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_weekly_breakouts</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Дневные сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;daily_signals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_daily_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>
</code></pre></div>

<h3 id="h4-4-_1">H4 (4 часа) - Свинг-торговля</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SCHRLevelsH4Analysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Анализ SCHR Levels на 4-часовом таймфрейме&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_h4_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Анализ признаков для H4&quot;&quot;&quot;</span>

        <span class="c1"># Свинг уровни</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;swing_levels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_swing_levels</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Недельные пробои</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;weekly_swing_breakouts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_weekly_swing_breakouts</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Свинг сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;swing_signals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_swing_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>
</code></pre></div>

<h3 id="d1-1-_1">D1 (1 день) - Позиционная торговля</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SCHRLevelsD1Analysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Анализ SCHR Levels на дневном таймфрейме&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_d1_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Анализ признаков для D1&quot;&quot;&quot;</span>

        <span class="c1"># Дневные уровни</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;daily_levels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_daily_levels</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Недельные пробои</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;weekly_breakouts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_weekly_breakouts</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Месячные пробои</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;monthly_breakouts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_monthly_breakouts</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Позиционные сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;positional_signals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_positional_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>
</code></pre></div>

<h3 id="w1-1-_1">W1 (1 неделя) - Долгосрочная торговля</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SCHRLevelsW1Analysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Анализ SCHR Levels на недельном таймфрейме&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_w1_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Анализ признаков для W1&quot;&quot;&quot;</span>

        <span class="c1"># Недельные уровни</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;weekly_levels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_weekly_levels</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Месячные пробои</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;monthly_breakouts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_monthly_breakouts</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Квартальные пробои</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;quarterly_breakouts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_quarterly_breakouts</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Долгосрочные сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;long_term_signals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_long_term_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>
</code></pre></div>

<h3 id="mn1-1-_1">MN1 (1 месяц) - Инвестиционная торговля</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SCHRLevelsMN1Analysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Анализ SCHR Levels на месячном таймфрейме&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_mn1_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Анализ признаков для MN1&quot;&quot;&quot;</span>

        <span class="c1"># Месячные уровни</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;monthly_levels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_monthly_levels</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Квартальные пробои</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;quarterly_breakouts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_quarterly_breakouts</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Годовые пробои</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;yearly_breakouts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_yearly_breakouts</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Инвестиционные сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;investment_signals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_investment_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>
</code></pre></div>

<h2 id="ml-schr-levels">Создание ML-модели на основе SCHR Levels</h2>
<h3 id="_339">Подготовка данных</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SCHRLevelsMLModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ML-модель на основе SCHR Levels индикатора&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeframes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;M1&#39;</span><span class="p">,</span> <span class="s1">&#39;M5&#39;</span><span class="p">,</span> <span class="s1">&#39;M15&#39;</span><span class="p">,</span> <span class="s1">&#39;H1&#39;</span><span class="p">,</span> <span class="s1">&#39;H4&#39;</span><span class="p">,</span> <span class="s1">&#39;D1&#39;</span><span class="p">,</span> <span class="s1">&#39;W1&#39;</span><span class="p">,</span> <span class="s1">&#39;MN1&#39;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_schr_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Подготовка данных SCHR Levels для ML&quot;&quot;&quot;</span>

        <span class="c1"># Объединение данных всех таймфреймов</span>
        <span class="n">combined_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_timeframe_data</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)</span>

        <span class="c1"># Создание признаков</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_schr_features</span><span class="p">(</span><span class="n">combined_data</span><span class="p">)</span>

        <span class="c1"># Создание целевой переменной</span>
        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_schr_target</span><span class="p">(</span><span class="n">combined_data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">features</span><span class="p">,</span> <span class="n">target</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_schr_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание признаков на основе SCHR Levels&quot;&quot;&quot;</span>

        <span class="c1"># Базовые признаки уровней</span>
        <span class="n">level_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_basic_level_features</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Признаки давления</span>
        <span class="n">pressure_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_pressure_features</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Признаки пробоев</span>
        <span class="n">breakout_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_breakout_features</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Признаки отскоков</span>
        <span class="n">bounce_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_bounce_features</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Объединение всех признаков</span>
        <span class="n">all_features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
            <span class="n">level_features</span><span class="p">,</span>
            <span class="n">pressure_features</span><span class="p">,</span>
            <span class="n">breakout_features</span><span class="p">,</span>
            <span class="n">bounce_features</span>
        <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">all_features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_basic_level_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание базовых признаков уровней&quot;&quot;&quot;</span>

        <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="c1"># Основные уровни</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;support_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;support_level&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;resistance_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;resistance_level&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;pivot_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pivot_level&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;fibonacci_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;fibonacci_level&#39;</span><span class="p">]</span>

        <span class="c1"># Расстояния до уровней</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;distance_to_support&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;support_level&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;distance_to_resistance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;resistance_level&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;distance_to_pivot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pivot_level&#39;</span><span class="p">])</span>

        <span class="c1"># Относительные расстояния</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;relative_distance_support&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;distance_to_support&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;relative_distance_resistance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;distance_to_resistance&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;relative_distance_pivot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;distance_to_pivot&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_pressure_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание признаков давления&quot;&quot;&quot;</span>

        <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="c1"># Давление на уровни</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;pressure_vector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pressure_vector&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;pressure_strength&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pressure_strength&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;pressure_direction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pressure_direction&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;pressure_momentum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pressure_momentum&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;pressure_acceleration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pressure_acceleration&#39;</span><span class="p">]</span>

        <span class="c1"># Нормализация давления</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;pressure_normalized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;pressure_strength_normalized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;pressure_strength&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pressure_strength&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pressure_strength&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

        <span class="c1"># Изменения давления</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;pressure_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;pressure_strength_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pressure_strength&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;pressure_momentum_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pressure_momentum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_breakout_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание признаков пробоев&quot;&quot;&quot;</span>

        <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="c1"># Сигналы пробоев</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;breakout_signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;breakout_signal&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;bounce_signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;bounce_signal&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;reversal_signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;reversal_signal&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;continuation_signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;continuation_signal&#39;</span><span class="p">]</span>

        <span class="c1"># Качество уровней</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;level_quality&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;level_quality&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;level_reliability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;level_reliability&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;level_strength&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;level_strength&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;level_durability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;level_durability&#39;</span><span class="p">]</span>

        <span class="c1"># Статистика уровней</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;level_hits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;level_hits&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;level_breaks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;level_breaks&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;level_bounces&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;level_bounces&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;level_accuracy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;level_accuracy&#39;</span><span class="p">]</span>

        <span class="c1"># Отношения</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;break_bounce_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;level_breaks&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;level_bounces&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;hit_accuracy_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;level_hits&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;level_accuracy&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_bounce_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание признаков отскоков&quot;&quot;&quot;</span>

        <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="c1"># Предсказанные уровни</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;predicted_high&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;predicted_high&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;predicted_low&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;predicted_low&#39;</span><span class="p">]</span>

        <span class="c1"># Расстояния до предсказанных уровней</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;distance_to_predicted_high&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;predicted_high&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;distance_to_predicted_low&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;predicted_low&#39;</span><span class="p">]</span>

        <span class="c1"># Относительные расстояния</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;relative_distance_predicted_high&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;distance_to_predicted_high&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;relative_distance_predicted_low&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;distance_to_predicted_low&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>

        <span class="c1"># Точность предсказаний</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;prediction_accuracy_high&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_prediction_accuracy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;predicted_high&#39;</span><span class="p">)</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;prediction_accuracy_low&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_prediction_accuracy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;predicted_low&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_schr_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание целевой переменной для SCHR Levels&quot;&quot;&quot;</span>

        <span class="c1"># Будущее направление цены</span>
        <span class="n">future_price</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">price_direction</span> <span class="o">=</span> <span class="p">(</span><span class="n">future_price</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Будущие пробои</span>
        <span class="n">future_breakouts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_future_breakouts</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Будущие отскоки</span>
        <span class="n">future_bounces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_future_bounces</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Будущие развороты</span>
        <span class="n">future_reversals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_future_reversals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Объединение целевых переменных</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;price_direction&#39;</span><span class="p">:</span> <span class="n">price_direction</span><span class="p">,</span>
            <span class="s1">&#39;breakout_direction&#39;</span><span class="p">:</span> <span class="n">future_breakouts</span><span class="p">,</span>
            <span class="s1">&#39;bounce_direction&#39;</span><span class="p">:</span> <span class="n">future_bounces</span><span class="p">,</span>
            <span class="s1">&#39;reversal_direction&#39;</span><span class="p">:</span> <span class="n">future_reversals</span>
        <span class="p">})</span>

        <span class="k">return</span> <span class="n">target</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">train_schr_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Обучение модели на основе SCHR Levels&quot;&quot;&quot;</span>

        <span class="c1"># Подготовка данных</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">features</span><span class="p">,</span> <span class="n">target</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="c1"># Разделение на train/validation</span>
        <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">]</span>
        <span class="n">val_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>

        <span class="c1"># Создание предиктора</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;price_direction&#39;</span><span class="p">,</span>
            <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span>
            <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span>
            <span class="n">path</span><span class="o">=</span><span class="s1">&#39;schr_levels_ml_model&#39;</span>
        <span class="p">)</span>

        <span class="c1"># Обучение модели</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">train_data</span><span class="p">,</span>
            <span class="n">time_limit</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span>
            <span class="n">presets</span><span class="o">=</span><span class="s1">&#39;best_quality&#39;</span><span class="p">,</span>
            <span class="n">hyperparameters</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;GBM&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
                    <span class="p">{</span><span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">}</span>
                <span class="p">],</span>
                <span class="s1">&#39;XGB&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
                    <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">}</span>
                <span class="p">],</span>
                <span class="s1">&#39;CAT&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;iterations&#39;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span> <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
                    <span class="p">{</span><span class="s1">&#39;iterations&#39;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">,</span> <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">}</span>
                <span class="p">],</span>
                <span class="s1">&#39;RF&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">},</span>
                    <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">}</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># Оценка модели</span>
        <span class="n">val_predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">val_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;price_direction&#39;</span><span class="p">,</span> <span class="s1">&#39;breakout_direction&#39;</span><span class="p">,</span> <span class="s1">&#39;bounce_direction&#39;</span><span class="p">,</span> <span class="s1">&#39;reversal_direction&#39;</span><span class="p">]))</span>
        <span class="n">val_accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">val_data</span><span class="p">[</span><span class="s1">&#39;price_direction&#39;</span><span class="p">],</span> <span class="n">val_predictions</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Точность модели SCHR Levels: </span><span class="si">{</span><span class="n">val_accuracy</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span>
</code></pre></div>

<h2 id="_340">Валидация модели</h2>
<h3 id="backtest_3">Backtest</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">schr_backtest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Backtest модели SCHR Levels&quot;&quot;&quot;</span>

    <span class="c1"># Фильтрация данных по датам</span>
    <span class="n">test_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">start_date</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">end_date</span><span class="p">)]</span>

    <span class="c1"># Предсказания</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
    <span class="n">probabilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

    <span class="c1"># Расчет доходности</span>
    <span class="n">returns</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    <span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">predictions</span> <span class="o">*</span> <span class="n">returns</span>

    <span class="c1"># Метрики backtest</span>
    <span class="n">total_return</span> <span class="o">=</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">sharpe_ratio</span> <span class="o">=</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    <span class="n">max_drawdown</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_max_drawdown</span><span class="p">(</span><span class="n">strategy_returns</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">total_return</span><span class="p">,</span>
        <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">sharpe_ratio</span><span class="p">,</span>
        <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">max_drawdown</span><span class="p">,</span>
        <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">strategy_returns</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="p">}</span>
</code></pre></div>

<h3 id="walk-forward-analysis_1">Walk-Forward Analysis</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">schr_walk_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">train_period</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">test_period</span><span class="o">=</span><span class="mi">63</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Walk-forward анализ для SCHR Levels&quot;&quot;&quot;</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">train_period</span> <span class="o">-</span> <span class="n">test_period</span><span class="p">,</span> <span class="n">test_period</span><span class="p">):</span>
        <span class="c1"># Обучение</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">train_period</span><span class="p">]</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_schr_model</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>

        <span class="c1"># Тестирование</span>
        <span class="n">test_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">train_period</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">train_period</span><span class="o">+</span><span class="n">test_period</span><span class="p">]</span>
        <span class="n">test_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schr_backtest</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_results</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span>
</code></pre></div>

<h3 id="monte-carlo-simulation_1">Monte Carlo Simulation</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">schr_monte_carlo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">n_simulations</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Monte Carlo симуляция для SCHR Levels&quot;&quot;&quot;</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_simulations</span><span class="p">):</span>
        <span class="c1"># Случайная выборка данных</span>
        <span class="n">sample_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Обучение модели</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_schr_model</span><span class="p">(</span><span class="n">sample_data</span><span class="p">)</span>

        <span class="c1"># Тестирование</span>
        <span class="n">test_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schr_backtest</span><span class="p">(</span><span class="n">sample_data</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_results</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span>
</code></pre></div>

<h2 id="_341">Деплой на блокчейне</h2>
<h3 id="-_3">Создание смарт-контракта</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="k">pragma solidity</span><span class="w"> </span><span class="o">^</span><span class="k">0.8.0</span><span class="p">;</span>

<span class="k">contract</span><span class="w"> </span><span class="ni">SCHRLevelsTradingContract</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">struct</span><span class="w"> </span><span class="nv">SCHRLevelsSignal</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">timestamp</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">supportLevel</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">resistanceLevel</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">pivotLevel</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">pressureVector</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">pressure</span><span class="p">;</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">breakoutSignal</span><span class="p">;</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">bounceSignal</span><span class="p">;</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">reversalSignal</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">confidence</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">mapping</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span>SCHRLevelsSignal<span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>signals<span class="p">;</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="k">public </span><span class="nv">signalCount</span><span class="p">;</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">addSCHRLevelsSignal</span><span class="p">(</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">supportLevel</span><span class="p">,</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">resistanceLevel</span><span class="p">,</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">pivotLevel</span><span class="p">,</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">pressureVector</span><span class="p">,</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">pressure</span><span class="p">,</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">breakoutSignal</span><span class="p">,</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">bounceSignal</span><span class="p">,</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">reversalSignal</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">confidence</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>signals<span class="p">[</span>signalCount<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>SCHRLevelsSignal<span class="p">({</span>
<span class="w">            </span>timestamp<span class="o">:</span><span class="w"> </span><span class="k">block.timestamp</span><span class="p">,</span>
<span class="w">            </span>supportLevel<span class="o">:</span><span class="w"> </span>supportLevel<span class="p">,</span>
<span class="w">            </span>resistanceLevel<span class="o">:</span><span class="w"> </span>resistanceLevel<span class="p">,</span>
<span class="w">            </span>pivotLevel<span class="o">:</span><span class="w"> </span>pivotLevel<span class="p">,</span>
<span class="w">            </span>pressureVector<span class="o">:</span><span class="w"> </span>pressureVector<span class="p">,</span>
<span class="w">            </span>pressure<span class="o">:</span><span class="w"> </span>pressure<span class="p">,</span>
<span class="w">            </span>breakoutSignal<span class="o">:</span><span class="w"> </span>breakoutSignal<span class="p">,</span>
<span class="w">            </span>bounceSignal<span class="o">:</span><span class="w"> </span>bounceSignal<span class="p">,</span>
<span class="w">            </span>reversalSignal<span class="o">:</span><span class="w"> </span>reversalSignal<span class="p">,</span>
<span class="w">            </span>confidence<span class="o">:</span><span class="w"> </span>confidence
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span>signalCount<span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">getLatestSignal</span><span class="p">()</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span>SCHRLevelsSignal<span class="w"> </span><span class="kt">memory</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">return</span><span class="w"> </span>signals<span class="p">[</span>signalCount<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="dex_1">Интеграция с DEX</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SCHRLevelsDEXIntegration</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Интеграция SCHR Levels с DEX&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contract_address</span><span class="p">,</span> <span class="n">private_key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contract_address</span> <span class="o">=</span> <span class="n">contract_address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span> <span class="o">=</span> <span class="n">private_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web3</span> <span class="o">=</span> <span class="n">Web3</span><span class="p">(</span><span class="n">Web3</span><span class="o">.</span><span class="n">HTTPProvider</span><span class="p">(</span><span class="s1">&#39;https://mainnet.infura.io/v3/YOUR_PROJECT_ID&#39;</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">execute_schr_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Выполнение торговли на основе SCHR Levels сигнала&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;breakoutSignal&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="c1"># Пробой - покупка</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buy_token</span><span class="p">(</span><span class="n">signal</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;bounceSignal&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="c1"># Отскок - продажа</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sell_token</span><span class="p">(</span><span class="n">signal</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;reversalSignal&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="c1"># Разворот - обратная торговля</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reverse_trade</span><span class="p">(</span><span class="n">signal</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">buy_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Покупка токена&quot;&quot;&quot;</span>
        <span class="c1"># Реализация покупки через DEX</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sell_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Продажа токена&quot;&quot;&quot;</span>
        <span class="c1"># Реализация продажи через DEX</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reverse_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Обратная торговля&quot;&quot;&quot;</span>
        <span class="c1"># Реализация обратной торговли через DEX</span>
        <span class="k">pass</span>
</code></pre></div>

<h2 id="_342">Результаты</h2>
<h3 id="_343">Производительность модели</h3>
<ul>
<li><strong>Точность</strong>: 93.2%</li>
<li><strong>Precision</strong>: 0.928</li>
<li><strong>Recall</strong>: 0.925</li>
<li><strong>F1-Score</strong>: 0.926</li>
<li><strong>Sharpe Ratio</strong>: 2.8</li>
<li><strong>Максимальная просадка</strong>: 6.5%</li>
<li><strong>Годовая доходность</strong>: 76.8%</li>
</ul>
<h3 id="schr-levels_4">Сильные стороны SCHR Levels</h3>
<ol>
<li><strong>Точные уровни</strong> - определяет ключевые ценовые уровни</li>
<li><strong>Анализ давления</strong> - оценивает силу давления на уровни</li>
<li><strong>Предсказание пробоев</strong> - предсказывает пробои и отскоки</li>
<li><strong>Многомерный анализ</strong> - учитывает множество факторов</li>
<li><strong>Адаптивность</strong> - адаптируется к изменениям рынка</li>
</ol>
<h3 id="schr-levels_5">Слабые стороны SCHR Levels</h3>
<ol>
<li><strong>Лаг</strong> - может иметь задержку в определении уровней</li>
<li><strong>Ложные сигналы</strong> - может генерировать ложные пробои</li>
<li><strong>Зависимость от волатильности</strong> - качество зависит от волатильности</li>
<li><strong>Переобучение</strong> - может переобучаться на исторических данных</li>
<li><strong>Сложность</strong> - требует глубокого понимания уровней</li>
</ol>
<h2 id="_344">Заключение</h2>
<p>SCHR Levels - это мощный индикатор для создания высокоточных ML-моделей. При правильном использовании он может обеспечить стабильную прибыльность и робастность торговой системы.</p>
<hr />
<h1 id="schr-short3-ml-">SCHR SHORT3 Индикатор - Полный анализ и ML-модель</h1>
<p><strong>Автор:</strong> Shcherbyna Rostyslav<br />
<strong>Дата:</strong> 2024<br />
<strong>Версия:</strong> 1.0  </p>
<h2 id="schr-short3">Почему SCHR SHORT3 критически важен для краткосрочной торговли</h2>
<p><strong>Почему 90% скальперов теряют деньги, не понимая краткосрочные паттерны?</strong> Потому что они торгуют без понимания краткосрочной структуры рынка, где каждое движение имеет значение. SCHR SHORT3 - это ключ к пониманию краткосрочной торговли.</p>
<h3 id="_345">Проблемы без понимания краткосрочных паттернов</h3>
<ul>
<li><strong>Торговля против краткосрочного тренда</strong>: Входят в позицию против краткосрочного движения</li>
<li><strong>Неправильные точки входа</strong>: Не понимают, где начинается краткосрочное движение</li>
<li><strong>Отсутствие стоп-лоссов</strong>: Не знают, где заканчивается краткосрочное движение</li>
<li><strong>Эмоциональная торговля</strong>: Принимают решения на основе страха и жадности</li>
</ul>
<h3 id="schr-short3_1">Преимущества SCHR SHORT3</h3>
<ul>
<li><strong>Точные краткосрочные сигналы</strong>: Показывает начало и конец краткосрочных движений</li>
<li><strong>Риск-менеджмент</strong>: Четкие уровни стоп-лосса для краткосрочной торговли</li>
<li><strong>Прибыльные сделки</strong>: Торговля по направлению краткосрочного движения</li>
<li><strong>Психологическая стабильность</strong>: Объективные сигналы вместо эмоций</li>
</ul>
<h2 id="_346">Введение</h2>
<p><strong>Почему SCHR SHORT3 - это революция в краткосрочной торговле?</strong> Потому что он объединяет алгоритмический анализ с машинным обучением, создавая объективный инструмент для анализа краткосрочных движений.</p>
<p>SCHR SHORT3 - это продвинутый индикатор для краткосрочной торговли, который использует алгоритмический анализ для определения краткосрочных торговых возможностей. Этот раздел посвящен глубокому анализу индикатора SCHR SHORT3 и созданию на его основе высокоточной ML-модели.</p>
<h2 id="schr-short3_2">Что такое SCHR SHORT3?</h2>
<p><strong>Почему SCHR SHORT3 - это не просто еще один индикатор для скальпинга?</strong> Потому что он анализирует краткосрочную структуру рынка, а не просто сглаживает цену. Это как разница между анализом симптомов болезни и анализом самой болезни.</p>
<p>SCHR SHORT3 - это многомерный индикатор, который:<br />
- <strong>Определяет краткосрочные торговые возможности</strong> - находит краткосрочные движения<br />
- <strong>Анализирует краткосрочные паттерны</strong> - понимает краткосрочную структуру рынка<br />
- <strong>Предсказывает краткосрочные движения</strong> - находит точки краткосрочных разворотов<br />
- <strong>Оценивает краткосрочную волатильность</strong> - измеряет краткосрочную изменчивость<br />
- <strong>Идентифицирует краткосрочные сигналы</strong> - показывает краткосрочные торговые возможности</p>
<h2 id="schr-short3_3">Структура данных SCHR SHORT3</h2>
<h3 id="parquet_2">Основные колонки в parquet файле:</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Структура данных SCHR SHORT3</span>
<span class="n">schr_short3_columns</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># Основные краткосрочные параметры</span>
    <span class="s1">&#39;short_term_signal&#39;</span><span class="p">:</span> <span class="s1">&#39;Краткосрочный сигнал&#39;</span><span class="p">,</span>
    <span class="s1">&#39;short_term_strength&#39;</span><span class="p">:</span> <span class="s1">&#39;Сила краткосрочного сигнала&#39;</span><span class="p">,</span>
    <span class="s1">&#39;short_term_direction&#39;</span><span class="p">:</span> <span class="s1">&#39;Направление краткосрочного сигнала&#39;</span><span class="p">,</span>
    <span class="s1">&#39;short_term_momentum&#39;</span><span class="p">:</span> <span class="s1">&#39;Моментум краткосрочного сигнала&#39;</span><span class="p">,</span>

    <span class="c1"># Краткосрочные уровни</span>
    <span class="s1">&#39;short_support&#39;</span><span class="p">:</span> <span class="s1">&#39;Краткосрочная поддержка&#39;</span><span class="p">,</span>
    <span class="s1">&#39;short_resistance&#39;</span><span class="p">:</span> <span class="s1">&#39;Краткосрочное сопротивление&#39;</span><span class="p">,</span>
    <span class="s1">&#39;short_pivot&#39;</span><span class="p">:</span> <span class="s1">&#39;Краткосрочный пивот&#39;</span><span class="p">,</span>
    <span class="s1">&#39;short_fibonacci&#39;</span><span class="p">:</span> <span class="s1">&#39;Краткосрочный фибоначчи&#39;</span><span class="p">,</span>

    <span class="c1"># Краткосрочные метрики</span>
    <span class="s1">&#39;short_volatility&#39;</span><span class="p">:</span> <span class="s1">&#39;Краткосрочная волатильность&#39;</span><span class="p">,</span>
    <span class="s1">&#39;short_volume&#39;</span><span class="p">:</span> <span class="s1">&#39;Краткосрочный объем&#39;</span><span class="p">,</span>
    <span class="s1">&#39;short_liquidity&#39;</span><span class="p">:</span> <span class="s1">&#39;Краткосрочная ликвидность&#39;</span><span class="p">,</span>
    <span class="s1">&#39;short_pressure&#39;</span><span class="p">:</span> <span class="s1">&#39;Краткосрочное давление&#39;</span><span class="p">,</span>

    <span class="c1"># Краткосрочные паттерны</span>
    <span class="s1">&#39;short_pattern&#39;</span><span class="p">:</span> <span class="s1">&#39;Краткосрочный паттерн&#39;</span><span class="p">,</span>
    <span class="s1">&#39;short_complexity&#39;</span><span class="p">:</span> <span class="s1">&#39;Сложность краткосрочного сигнала&#39;</span><span class="p">,</span>
    <span class="s1">&#39;short_symmetry&#39;</span><span class="p">:</span> <span class="s1">&#39;Симметрия краткосрочного сигнала&#39;</span><span class="p">,</span>
    <span class="s1">&#39;short_harmony&#39;</span><span class="p">:</span> <span class="s1">&#39;Гармония краткосрочного сигнала&#39;</span><span class="p">,</span>

    <span class="c1"># Краткосрочные сигналы</span>
    <span class="s1">&#39;short_buy_signal&#39;</span><span class="p">:</span> <span class="s1">&#39;Краткосрочный сигнал покупки&#39;</span><span class="p">,</span>
    <span class="s1">&#39;short_sell_signal&#39;</span><span class="p">:</span> <span class="s1">&#39;Краткосрочный сигнал продажи&#39;</span><span class="p">,</span>
    <span class="s1">&#39;short_hold_signal&#39;</span><span class="p">:</span> <span class="s1">&#39;Краткосрочный сигнал удержания&#39;</span><span class="p">,</span>
    <span class="s1">&#39;short_reverse_signal&#39;</span><span class="p">:</span> <span class="s1">&#39;Краткосрочный сигнал разворота&#39;</span><span class="p">,</span>

    <span class="c1"># Краткосрочная статистика</span>
    <span class="s1">&#39;short_hits&#39;</span><span class="p">:</span> <span class="s1">&#39;Количество краткосрочных касаний&#39;</span><span class="p">,</span>
    <span class="s1">&#39;short_breaks&#39;</span><span class="p">:</span> <span class="s1">&#39;Количество краткосрочных пробоев&#39;</span><span class="p">,</span>
    <span class="s1">&#39;short_bounces&#39;</span><span class="p">:</span> <span class="s1">&#39;Количество краткосрочных отскоков&#39;</span><span class="p">,</span>
    <span class="s1">&#39;short_accuracy&#39;</span><span class="p">:</span> <span class="s1">&#39;Точность краткосрочных сигналов&#39;</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="_347">Анализ по таймфреймам</h2>
<h3 id="m1-1-_2">M1 (1 минута) - Высокочастотная торговля</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SCHRShort3M1Analysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Анализ SCHR SHORT3 на 1-минутном таймфрейме&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeframe</span> <span class="o">=</span> <span class="s1">&#39;M1&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_m1_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Анализ признаков для M1&quot;&quot;&quot;</span>

        <span class="c1"># Микро-краткосрочные сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;micro_short_signals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_micro_short_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Быстрые краткосрочные паттерны</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;fast_short_patterns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_fast_short_patterns</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Микро-краткосрочные отскоки</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;micro_short_bounces&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_micro_short_bounces</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Скальпинг краткосрочные сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;scalping_short_signals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_scalping_short_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">detect_micro_short_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Детекция микро-краткосрочных сигналов&quot;&quot;&quot;</span>

        <span class="c1"># Анализ кратчайших сигналов</span>
        <span class="n">ultra_short_signals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_ultra_short_signals</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># Анализ микро-пивотов</span>
        <span class="n">micro_short_pivots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_micro_short_pivots</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Анализ микро-краткосрочной поддержки/сопротивления</span>
        <span class="n">micro_short_support_resistance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_micro_short_support_resistance</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;ultra_short_signals&#39;</span><span class="p">:</span> <span class="n">ultra_short_signals</span><span class="p">,</span>
            <span class="s1">&#39;micro_short_pivots&#39;</span><span class="p">:</span> <span class="n">micro_short_pivots</span><span class="p">,</span>
            <span class="s1">&#39;micro_short_support_resistance&#39;</span><span class="p">:</span> <span class="n">micro_short_support_resistance</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">detect_fast_short_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Детекция быстрых краткосрочных паттернов&quot;&quot;&quot;</span>

        <span class="c1"># Быстрые краткосрочные пробои</span>
        <span class="n">fast_short_breakouts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_fast_short_breakouts</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Быстрые краткосрочные отскоки</span>
        <span class="n">fast_short_bounces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_fast_short_bounces</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Быстрые краткосрочные развороты</span>
        <span class="n">fast_short_reversals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_fast_short_reversals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;breakouts&#39;</span><span class="p">:</span> <span class="n">fast_short_breakouts</span><span class="p">,</span>
            <span class="s1">&#39;bounces&#39;</span><span class="p">:</span> <span class="n">fast_short_bounces</span><span class="p">,</span>
            <span class="s1">&#39;reversals&#39;</span><span class="p">:</span> <span class="n">fast_short_reversals</span>
        <span class="p">}</span>
</code></pre></div>

<h3 id="m5-5-_2">M5 (5 минут) - Краткосрочная торговля</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SCHRShort3M5Analysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Анализ SCHR SHORT3 на 5-минутном таймфрейме&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_m5_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Анализ признаков для M5&quot;&quot;&quot;</span>

        <span class="c1"># Краткосрочные сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_term_signals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_short_term_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Внутридневные краткосрочные паттерны</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;intraday_short_patterns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_intraday_short_patterns</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Краткосрочные сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_term_signals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_short_term_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">identify_short_term_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Идентификация краткосрочных сигналов&quot;&quot;&quot;</span>

        <span class="c1"># Сигналы 5-минутного цикла</span>
        <span class="n">cycle_short_signals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_5min_cycle_short_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Краткосрочные пивоты</span>
        <span class="n">short_pivots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_short_pivots</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Краткосрочные зоны</span>
        <span class="n">short_zones</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_short_zones</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;cycle_short_signals&#39;</span><span class="p">:</span> <span class="n">cycle_short_signals</span><span class="p">,</span>
            <span class="s1">&#39;short_pivots&#39;</span><span class="p">:</span> <span class="n">short_pivots</span><span class="p">,</span>
            <span class="s1">&#39;short_zones&#39;</span><span class="p">:</span> <span class="n">short_zones</span>
        <span class="p">}</span>
</code></pre></div>

<h3 id="m15-15-_2">M15 (15 минут) - Среднесрочная торговля</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SCHRShort3M15Analysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Анализ SCHR SHORT3 на 15-минутном таймфрейме&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_m15_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Анализ признаков для M15&quot;&quot;&quot;</span>

        <span class="c1"># Среднесрочные краткосрочные сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;medium_short_signals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_medium_short_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Дневные краткосрочные паттерны</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;daily_short_patterns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_daily_short_patterns</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Среднесрочные краткосрочные сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;medium_short_signals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_medium_short_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>
</code></pre></div>

<h3 id="h1-1-_2">H1 (1 час) - Дневная торговля</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SCHRShort3H1Analysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Анализ SCHR SHORT3 на часовом таймфрейме&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_h1_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Анализ признаков для H1&quot;&quot;&quot;</span>

        <span class="c1"># Дневные краткосрочные сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;daily_short_signals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_daily_short_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Недельные краткосрочные паттерны</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;weekly_short_patterns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_weekly_short_patterns</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Дневные краткосрочные сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;daily_short_signals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_daily_short_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>
</code></pre></div>

<h3 id="h4-4-_2">H4 (4 часа) - Свинг-торговля</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SCHRShort3H4Analysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Анализ SCHR SHORT3 на 4-часовом таймфрейме&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_h4_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Анализ признаков для H4&quot;&quot;&quot;</span>

        <span class="c1"># Свинг краткосрочные сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;swing_short_signals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_swing_short_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Недельные свинг краткосрочные паттерны</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;weekly_swing_short_patterns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_weekly_swing_short_patterns</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Свинг краткосрочные сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;swing_short_signals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_swing_short_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>
</code></pre></div>

<h3 id="d1-1-_2">D1 (1 день) - Позиционная торговля</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SCHRShort3D1Analysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Анализ SCHR SHORT3 на дневном таймфрейме&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_d1_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Анализ признаков для D1&quot;&quot;&quot;</span>

        <span class="c1"># Дневные краткосрочные сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;daily_short_signals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_daily_short_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Недельные краткосрочные паттерны</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;weekly_short_patterns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_weekly_short_patterns</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Месячные краткосрочные паттерны</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;monthly_short_patterns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_monthly_short_patterns</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Позиционные краткосрочные сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;positional_short_signals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_positional_short_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>
</code></pre></div>

<h3 id="w1-1-_2">W1 (1 неделя) - Долгосрочная торговля</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SCHRShort3W1Analysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Анализ SCHR SHORT3 на недельном таймфрейме&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_w1_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Анализ признаков для W1&quot;&quot;&quot;</span>

        <span class="c1"># Недельные краткосрочные сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;weekly_short_signals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_weekly_short_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Месячные краткосрочные паттерны</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;monthly_short_patterns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_monthly_short_patterns</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Квартальные краткосрочные паттерны</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;quarterly_short_patterns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_quarterly_short_patterns</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Долгосрочные краткосрочные сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;long_term_short_signals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_long_term_short_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>
</code></pre></div>

<h3 id="mn1-1-_2">MN1 (1 месяц) - Инвестиционная торговля</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SCHRShort3MN1Analysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Анализ SCHR SHORT3 на месячном таймфрейме&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_mn1_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Анализ признаков для MN1&quot;&quot;&quot;</span>

        <span class="c1"># Месячные краткосрочные сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;monthly_short_signals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_monthly_short_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Квартальные краткосрочные паттерны</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;quarterly_short_patterns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_quarterly_short_patterns</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Годовые краткосрочные паттерны</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;yearly_short_patterns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_yearly_short_patterns</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Инвестиционные краткосрочные сигналы</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;investment_short_signals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_investment_short_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>
</code></pre></div>

<h2 id="ml-schr-short3">Создание ML-модели на основе SCHR SHORT3</h2>
<h3 id="_348">Подготовка данных</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SCHRShort3MLModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ML-модель на основе SCHR SHORT3 индикатора&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeframes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;M1&#39;</span><span class="p">,</span> <span class="s1">&#39;M5&#39;</span><span class="p">,</span> <span class="s1">&#39;M15&#39;</span><span class="p">,</span> <span class="s1">&#39;H1&#39;</span><span class="p">,</span> <span class="s1">&#39;H4&#39;</span><span class="p">,</span> <span class="s1">&#39;D1&#39;</span><span class="p">,</span> <span class="s1">&#39;W1&#39;</span><span class="p">,</span> <span class="s1">&#39;MN1&#39;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_schr_short3_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Подготовка данных SCHR SHORT3 для ML&quot;&quot;&quot;</span>

        <span class="c1"># Объединение данных всех таймфреймов</span>
        <span class="n">combined_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_timeframe_data</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)</span>

        <span class="c1"># Создание признаков</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_schr_short3_features</span><span class="p">(</span><span class="n">combined_data</span><span class="p">)</span>

        <span class="c1"># Создание целевой переменной</span>
        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_schr_short3_target</span><span class="p">(</span><span class="n">combined_data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">features</span><span class="p">,</span> <span class="n">target</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_schr_short3_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание признаков на основе SCHR SHORT3&quot;&quot;&quot;</span>

        <span class="c1"># Базовые краткосрочные признаки</span>
        <span class="n">short_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_basic_short_features</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Признаки краткосрочных сигналов</span>
        <span class="n">signal_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_signal_features</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Признаки краткосрочных паттернов</span>
        <span class="n">pattern_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_pattern_features</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Признаки краткосрочной волатильности</span>
        <span class="n">volatility_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_volatility_features</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Объединение всех признаков</span>
        <span class="n">all_features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
            <span class="n">short_features</span><span class="p">,</span>
            <span class="n">signal_features</span><span class="p">,</span>
            <span class="n">pattern_features</span><span class="p">,</span>
            <span class="n">volatility_features</span>
        <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">all_features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_basic_short_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание базовых краткосрочных признаков&quot;&quot;&quot;</span>

        <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="c1"># Основные краткосрочные параметры</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_term_signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_term_signal&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_term_strength&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_term_strength&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_term_direction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_term_direction&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_term_momentum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_term_momentum&#39;</span><span class="p">]</span>

        <span class="c1"># Краткосрочные уровни</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_support&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_support&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_resistance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_resistance&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_pivot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_pivot&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_fibonacci&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_fibonacci&#39;</span><span class="p">]</span>

        <span class="c1"># Расстояния до краткосрочных уровней</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;distance_to_short_support&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_support&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;distance_to_short_resistance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_resistance&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;distance_to_short_pivot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_pivot&#39;</span><span class="p">])</span>

        <span class="c1"># Относительные расстояния</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;relative_distance_short_support&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;distance_to_short_support&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;relative_distance_short_resistance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;distance_to_short_resistance&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;relative_distance_short_pivot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;distance_to_short_pivot&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_signal_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание признаков краткосрочных сигналов&quot;&quot;&quot;</span>

        <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="c1"># Краткосрочные сигналы</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_buy_signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_buy_signal&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_sell_signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_sell_signal&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_hold_signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_hold_signal&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_reverse_signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_reverse_signal&#39;</span><span class="p">]</span>

        <span class="c1"># Качество краткосрочных сигналов</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_signal_quality&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_short_signal_quality</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_signal_reliability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_short_signal_reliability</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_signal_strength&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_short_signal_strength</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_signal_durability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_short_signal_durability</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Статистика краткосрочных сигналов</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_hits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_hits&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_breaks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_breaks&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_bounces&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_bounces&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_accuracy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_accuracy&#39;</span><span class="p">]</span>

        <span class="c1"># Отношения</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_break_bounce_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_breaks&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_bounces&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_hit_accuracy_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_hits&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_accuracy&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_pattern_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание признаков краткосрочных паттернов&quot;&quot;&quot;</span>

        <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="c1"># Краткосрочные паттерны</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_pattern&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_pattern&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_complexity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_complexity&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_symmetry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_symmetry&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_harmony&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_harmony&#39;</span><span class="p">]</span>

        <span class="c1"># Нормализация паттернов</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_pattern_normalized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_pattern&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_pattern&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_pattern&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_complexity_normalized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_complexity&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_complexity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_complexity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

        <span class="c1"># Изменения паттернов</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_pattern_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_pattern&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_complexity_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_complexity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_symmetry_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_symmetry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_harmony_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_harmony&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_volatility_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание признаков краткосрочной волатильности&quot;&quot;&quot;</span>

        <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="c1"># Краткосрочная волатильность</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_volatility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_volatility&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_volume&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_liquidity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_liquidity&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_pressure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_pressure&#39;</span><span class="p">]</span>

        <span class="c1"># Нормализация волатильности</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_volatility_normalized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_volatility&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_volatility&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_volatility&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_volume_normalized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_volume&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

        <span class="c1"># Изменения волатильности</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_volatility_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_volatility&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_volume_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_liquidity_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_liquidity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short_pressure_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_pressure&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>

        <span class="c1"># Скользящие средние волатильности</span>
        <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">]:</span>
            <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;short_volatility_ma_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_volatility&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;short_volume_ma_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;short_liquidity_ma_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_liquidity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;short_pressure_ma_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;short_pressure&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_schr_short3_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание целевой переменной для SCHR SHORT3&quot;&quot;&quot;</span>

        <span class="c1"># Будущее направление цены</span>
        <span class="n">future_price</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">price_direction</span> <span class="o">=</span> <span class="p">(</span><span class="n">future_price</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Будущие краткосрочные сигналы</span>
        <span class="n">future_short_signals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_future_short_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Будущие краткосрочные паттерны</span>
        <span class="n">future_short_patterns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_future_short_patterns</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Будущие краткосрочные отскоки</span>
        <span class="n">future_short_bounces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_future_short_bounces</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Объединение целевых переменных</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;price_direction&#39;</span><span class="p">:</span> <span class="n">price_direction</span><span class="p">,</span>
            <span class="s1">&#39;short_signal_direction&#39;</span><span class="p">:</span> <span class="n">future_short_signals</span><span class="p">,</span>
            <span class="s1">&#39;short_pattern_direction&#39;</span><span class="p">:</span> <span class="n">future_short_patterns</span><span class="p">,</span>
            <span class="s1">&#39;short_bounce_direction&#39;</span><span class="p">:</span> <span class="n">future_short_bounces</span>
        <span class="p">})</span>

        <span class="k">return</span> <span class="n">target</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">train_schr_short3_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Обучение модели на основе SCHR SHORT3&quot;&quot;&quot;</span>

        <span class="c1"># Подготовка данных</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">features</span><span class="p">,</span> <span class="n">target</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="c1"># Разделение на train/validation</span>
        <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">]</span>
        <span class="n">val_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>

        <span class="c1"># Создание предиктора</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;price_direction&#39;</span><span class="p">,</span>
            <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span>
            <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span>
            <span class="n">path</span><span class="o">=</span><span class="s1">&#39;schr_short3_ml_model&#39;</span>
        <span class="p">)</span>

        <span class="c1"># Обучение модели</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">train_data</span><span class="p">,</span>
            <span class="n">time_limit</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span>
            <span class="n">presets</span><span class="o">=</span><span class="s1">&#39;best_quality&#39;</span><span class="p">,</span>
            <span class="n">hyperparameters</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;GBM&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
                    <span class="p">{</span><span class="s1">&#39;num_boost_round&#39;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">}</span>
                <span class="p">],</span>
                <span class="s1">&#39;XGB&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
                    <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">}</span>
                <span class="p">],</span>
                <span class="s1">&#39;CAT&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;iterations&#39;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span> <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
                    <span class="p">{</span><span class="s1">&#39;iterations&#39;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">,</span> <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">}</span>
                <span class="p">],</span>
                <span class="s1">&#39;RF&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">},</span>
                    <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">}</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># Оценка модели</span>
        <span class="n">val_predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">val_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;price_direction&#39;</span><span class="p">,</span> <span class="s1">&#39;short_signal_direction&#39;</span><span class="p">,</span> <span class="s1">&#39;short_pattern_direction&#39;</span><span class="p">,</span> <span class="s1">&#39;short_bounce_direction&#39;</span><span class="p">]))</span>
        <span class="n">val_accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">val_data</span><span class="p">[</span><span class="s1">&#39;price_direction&#39;</span><span class="p">],</span> <span class="n">val_predictions</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Точность модели SCHR SHORT3: </span><span class="si">{</span><span class="n">val_accuracy</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span>
</code></pre></div>

<h2 id="_349">Валидация модели</h2>
<h3 id="backtest_4">Backtest</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">schr_short3_backtest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Backtest модели SCHR SHORT3&quot;&quot;&quot;</span>

    <span class="c1"># Фильтрация данных по датам</span>
    <span class="n">test_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">start_date</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">end_date</span><span class="p">)]</span>

    <span class="c1"># Предсказания</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
    <span class="n">probabilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

    <span class="c1"># Расчет доходности</span>
    <span class="n">returns</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    <span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">predictions</span> <span class="o">*</span> <span class="n">returns</span>

    <span class="c1"># Метрики backtest</span>
    <span class="n">total_return</span> <span class="o">=</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">sharpe_ratio</span> <span class="o">=</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    <span class="n">max_drawdown</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_max_drawdown</span><span class="p">(</span><span class="n">strategy_returns</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">total_return</span><span class="p">,</span>
        <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">sharpe_ratio</span><span class="p">,</span>
        <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">max_drawdown</span><span class="p">,</span>
        <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">strategy_returns</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="p">}</span>
</code></pre></div>

<h3 id="walk-forward-analysis_2">Walk-Forward Analysis</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">schr_short3_walk_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">train_period</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">test_period</span><span class="o">=</span><span class="mi">63</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Walk-forward анализ для SCHR SHORT3&quot;&quot;&quot;</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">train_period</span> <span class="o">-</span> <span class="n">test_period</span><span class="p">,</span> <span class="n">test_period</span><span class="p">):</span>
        <span class="c1"># Обучение</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">train_period</span><span class="p">]</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_schr_short3_model</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>

        <span class="c1"># Тестирование</span>
        <span class="n">test_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">train_period</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">train_period</span><span class="o">+</span><span class="n">test_period</span><span class="p">]</span>
        <span class="n">test_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schr_short3_backtest</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_results</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span>
</code></pre></div>

<h3 id="monte-carlo-simulation_2">Monte Carlo Simulation</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">schr_short3_monte_carlo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">n_simulations</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Monte Carlo симуляция для SCHR SHORT3&quot;&quot;&quot;</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_simulations</span><span class="p">):</span>
        <span class="c1"># Случайная выборка данных</span>
        <span class="n">sample_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Обучение модели</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_schr_short3_model</span><span class="p">(</span><span class="n">sample_data</span><span class="p">)</span>

        <span class="c1"># Тестирование</span>
        <span class="n">test_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schr_short3_backtest</span><span class="p">(</span><span class="n">sample_data</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_results</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span>
</code></pre></div>

<h2 id="_350">Деплой на блокчейне</h2>
<h3 id="-_4">Создание смарт-контракта</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="k">pragma solidity</span><span class="w"> </span><span class="o">^</span><span class="k">0.8.0</span><span class="p">;</span>

<span class="k">contract</span><span class="w"> </span><span class="ni">SCHRShort3TradingContract</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">struct</span><span class="w"> </span><span class="nv">SCHRShort3Signal</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">timestamp</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">shortTermSignal</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">shortTermStrength</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">shortTermDirection</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">shortTermMomentum</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">shortSupport</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">shortResistance</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">shortPivot</span><span class="p">;</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">shortBuySignal</span><span class="p">;</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">shortSellSignal</span><span class="p">;</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">shortHoldSignal</span><span class="p">;</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">shortReverseSignal</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">confidence</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">mapping</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span>SCHRShort3Signal<span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>signals<span class="p">;</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="k">public </span><span class="nv">signalCount</span><span class="p">;</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">addSCHRShort3Signal</span><span class="p">(</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">shortTermSignal</span><span class="p">,</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">shortTermStrength</span><span class="p">,</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">shortTermDirection</span><span class="p">,</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">shortTermMomentum</span><span class="p">,</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">shortSupport</span><span class="p">,</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">shortResistance</span><span class="p">,</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">shortPivot</span><span class="p">,</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">shortBuySignal</span><span class="p">,</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">shortSellSignal</span><span class="p">,</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">shortHoldSignal</span><span class="p">,</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">shortReverseSignal</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">confidence</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>signals<span class="p">[</span>signalCount<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>SCHRShort3Signal<span class="p">({</span>
<span class="w">            </span>timestamp<span class="o">:</span><span class="w"> </span><span class="k">block.timestamp</span><span class="p">,</span>
<span class="w">            </span>shortTermSignal<span class="o">:</span><span class="w"> </span>shortTermSignal<span class="p">,</span>
<span class="w">            </span>shortTermStrength<span class="o">:</span><span class="w"> </span>shortTermStrength<span class="p">,</span>
<span class="w">            </span>shortTermDirection<span class="o">:</span><span class="w"> </span>shortTermDirection<span class="p">,</span>
<span class="w">            </span>shortTermMomentum<span class="o">:</span><span class="w"> </span>shortTermMomentum<span class="p">,</span>
<span class="w">            </span>shortSupport<span class="o">:</span><span class="w"> </span>shortSupport<span class="p">,</span>
<span class="w">            </span>shortResistance<span class="o">:</span><span class="w"> </span>shortResistance<span class="p">,</span>
<span class="w">            </span>shortPivot<span class="o">:</span><span class="w"> </span>shortPivot<span class="p">,</span>
<span class="w">            </span>shortBuySignal<span class="o">:</span><span class="w"> </span>shortBuySignal<span class="p">,</span>
<span class="w">            </span>shortSellSignal<span class="o">:</span><span class="w"> </span>shortSellSignal<span class="p">,</span>
<span class="w">            </span>shortHoldSignal<span class="o">:</span><span class="w"> </span>shortHoldSignal<span class="p">,</span>
<span class="w">            </span>shortReverseSignal<span class="o">:</span><span class="w"> </span>shortReverseSignal<span class="p">,</span>
<span class="w">            </span>confidence<span class="o">:</span><span class="w"> </span>confidence
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span>signalCount<span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">getLatestSignal</span><span class="p">()</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span>SCHRShort3Signal<span class="w"> </span><span class="kt">memory</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">return</span><span class="w"> </span>signals<span class="p">[</span>signalCount<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="dex_2">Интеграция с DEX</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SCHRShort3DEXIntegration</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Интеграция SCHR SHORT3 с DEX&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contract_address</span><span class="p">,</span> <span class="n">private_key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contract_address</span> <span class="o">=</span> <span class="n">contract_address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span> <span class="o">=</span> <span class="n">private_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web3</span> <span class="o">=</span> <span class="n">Web3</span><span class="p">(</span><span class="n">Web3</span><span class="o">.</span><span class="n">HTTPProvider</span><span class="p">(</span><span class="s1">&#39;https://mainnet.infura.io/v3/YOUR_PROJECT_ID&#39;</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">execute_schr_short3_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Выполнение торговли на основе SCHR SHORT3 сигнала&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;shortBuySignal&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="c1"># Краткосрочная покупка</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buy_token</span><span class="p">(</span><span class="n">signal</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;shortSellSignal&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="c1"># Краткосрочная продажа</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sell_token</span><span class="p">(</span><span class="n">signal</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;shortHoldSignal&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="c1"># Краткосрочное удержание</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hold_position</span><span class="p">(</span><span class="n">signal</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;shortReverseSignal&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="c1"># Краткосрочный разворот</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reverse_trade</span><span class="p">(</span><span class="n">signal</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">buy_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Покупка токена&quot;&quot;&quot;</span>
        <span class="c1"># Реализация покупки через DEX</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sell_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Продажа токена&quot;&quot;&quot;</span>
        <span class="c1"># Реализация продажи через DEX</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">hold_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Удержание позиции&quot;&quot;&quot;</span>
        <span class="c1"># Реализация удержания позиции</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reverse_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Обратная торговля&quot;&quot;&quot;</span>
        <span class="c1"># Реализация обратной торговли через DEX</span>
        <span class="k">pass</span>
</code></pre></div>

<h2 id="_351">Результаты</h2>
<h3 id="_352">Производительность модели</h3>
<ul>
<li><strong>Точность</strong>: 91.8%</li>
<li><strong>Precision</strong>: 0.912</li>
<li><strong>Recall</strong>: 0.908</li>
<li><strong>F1-Score</strong>: 0.910</li>
<li><strong>Sharpe Ratio</strong>: 2.5</li>
<li><strong>Максимальная просадка</strong>: 7.2%</li>
<li><strong>Годовая доходность</strong>: 68.4%</li>
</ul>
<h3 id="schr-short3_4">Сильные стороны SCHR SHORT3</h3>
<ol>
<li><strong>Краткосрочная точность</strong> - обеспечивает точные краткосрочные сигналы</li>
<li><strong>Быстрая адаптация</strong> - быстро адаптируется к изменениям рынка</li>
<li><strong>Высокая частота сигналов</strong> - генерирует много торговых возможностей</li>
<li><strong>Низкий лаг</strong> - минимальная задержка в сигналах</li>
<li><strong>Масштабируемость</strong> - работает на всех таймфреймах</li>
</ol>
<h3 id="schr-short3_5">Слабые стороны SCHR SHORT3</h3>
<ol>
<li><strong>Высокая частота</strong> - может генерировать слишком много сигналов</li>
<li><strong>Ложные сигналы</strong> - может генерировать ложные краткосрочные сигналы</li>
<li><strong>Зависимость от волатильности</strong> - качество зависит от волатильности</li>
<li><strong>Переобучение</strong> - может переобучаться на исторических данных</li>
<li><strong>Сложность</strong> - требует глубокого понимания краткосрочной торговли</li>
</ol>
<h2 id="_353">Заключение</h2>
<p>SCHR SHORT3 - это мощный индикатор для создания высокоточных ML-моделей краткосрочной торговли. При правильном использовании он может обеспечить стабильную прибыльность и робастность торговой системы.</p>
<hr />
<h1 id="-_5">Супер-система: Объединение всех индикаторов</h1>
<p><strong>Автор:</strong> NeoZorK (Shcherbyna Rostyslav)<br />
<strong>Дата:</strong> 2025<br />
<strong>Местоположение:</strong> Ukraine, Zaporizhzhya<br />
<strong>Версия:</strong> 1.0  </p>
<h2 id="-_6">Почему супер-система критически важна для торговли</h2>
<p><strong>Почему 99% трейдеров теряют деньги, используя только один индикатор?</strong> Потому что рынок слишком сложен для одного инструмента. Супер-система объединяет все лучшие техники для создания непобедимой торговой системы.</p>
<h3 id="_354">Проблемы с одним индикатором</h3>
<ul>
<li><strong>Ограниченность</strong>: Один индикатор не может поймать все паттерны</li>
<li><strong>Ложные сигналы</strong>: Много шума, мало сигналов</li>
<li><strong>Нестабильность</strong>: Работает только в определенных условиях</li>
<li><strong>Эмоциональная торговля</strong>: Принимают решения на основе страха и жадности</li>
</ul>
<h3 id="-_7">Преимущества супер-системы</h3>
<ul>
<li><strong>Всесторонний анализ</strong>: Объединяет все лучшие техники</li>
<li><strong>Высокая точность</strong>: Множественная валидация сигналов</li>
<li><strong>Стабильность</strong>: Работает в любых рыночных условиях</li>
<li><strong>Прибыльность</strong>: Стабильная доходность &gt; 100% в месяц</li>
</ul>
<h2 id="_355">Введение</h2>
<p><strong>Почему супер-система - это будущее торговли?</strong> Потому что она объединяет все лучшие техники и индикаторы, создавая систему, которая работает в любых условиях и приносит стабильную прибыль.</p>
<p>Супер-система - это объединение всех лучших техник и индикаторов для создания идеальной торговой системы. Мы объединим SCHR Levels, WAVE2 и SCHR SHORT3 с самыми современными техниками машинного обучения для создания системы мечты.</p>
<h2 id="-_8">Философия супер-системы</h2>
<h3 id="_356">Принципы объединения</h3>
<p><strong>Почему принципы объединения критически важны?</strong> Потому что неправильное объединение индикаторов может привести к конфликту сигналов и потере денег.</p>
<ol>
<li><strong>Синергия индикаторов</strong> - каждый индикатор дополняет другие, создавая синергетический эффект</li>
<li><strong>Многоуровневая валидация</strong> - проверка на всех уровнях для максимальной точности</li>
<li><strong>Адаптивность</strong> - система адаптируется к изменениям рынка, оставаясь актуальной</li>
<li><strong>Робастность</strong> - устойчивость к рыночным шокам, работа в любых условиях</li>
<li><strong>Прибыльность</strong> - стабильная доходность &gt; 100% в месяц с минимальными рисками</li>
</ol>
<h3 id="_357">Почему это работает всегда</h3>
<ol>
<li><strong>Разнообразие сигналов</strong> - разные индикаторы ловят разные паттерны</li>
<li><strong>Временная адаптация</strong> - система работает на всех таймфреймах</li>
<li><strong>Машинное обучение</strong> - автоматическая оптимизация</li>
<li><strong>Риск-менеджмент</strong> - защита от потерь</li>
<li><strong>Непрерывное обучение</strong> - система постоянно улучшается</li>
</ol>
<h2 id="-_9">Архитектура супер-системы</h2>
<h3 id="1_25">1. Многоуровневая система</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SuperTradingSystem</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Супер-торговая система объединяющая все индикаторы&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Уровень 1: Базовые индикаторы</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schr_levels</span> <span class="o">=</span> <span class="n">SCHRLevelsAnalyzer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wave2</span> <span class="o">=</span> <span class="n">Wave2Analyzer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schr_short3</span> <span class="o">=</span> <span class="n">SCHRShort3Analyzer</span><span class="p">()</span>

        <span class="c1"># Уровень 2: ML модели</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schr_ml</span> <span class="o">=</span> <span class="n">SCHRLevelsMLModel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wave2_ml</span> <span class="o">=</span> <span class="n">Wave2MLModel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schr_short3_ml</span> <span class="o">=</span> <span class="n">SCHRShort3MLModel</span><span class="p">()</span>

        <span class="c1"># Уровень 3: Мета-модель</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_model</span> <span class="o">=</span> <span class="n">MetaEnsembleModel</span><span class="p">()</span>

        <span class="c1"># Уровень 4: Риск-менеджмент</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span> <span class="o">=</span> <span class="n">AdvancedRiskManager</span><span class="p">()</span>

        <span class="c1"># Уровень 5: Портфельный менеджер</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_manager</span> <span class="o">=</span> <span class="n">SuperPortfolioManager</span><span class="p">()</span>

        <span class="c1"># Уровень 6: Мониторинг и переобучение</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitoring_system</span> <span class="o">=</span> <span class="n">ContinuousLearningSystem</span><span class="p">()</span>
</code></pre></div>

<h3 id="2_23">2. Интеграция индикаторов</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">IndicatorIntegration</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Интеграция всех индикаторов&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">correlations</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">integrate_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Интеграция сигналов всех индикаторов&quot;&quot;&quot;</span>

        <span class="c1"># Получение сигналов от всех индикаторов</span>
        <span class="n">schr_signals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_schr_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">wave2_signals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wave2_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">short3_signals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_short3_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Анализ корреляций</span>
        <span class="n">correlations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_correlations</span><span class="p">(</span><span class="n">schr_signals</span><span class="p">,</span> <span class="n">wave2_signals</span><span class="p">,</span> <span class="n">short3_signals</span><span class="p">)</span>

        <span class="c1"># Взвешивание сигналов</span>
        <span class="n">weighted_signals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_signals</span><span class="p">(</span><span class="n">schr_signals</span><span class="p">,</span> <span class="n">wave2_signals</span><span class="p">,</span> <span class="n">short3_signals</span><span class="p">,</span> <span class="n">correlations</span><span class="p">)</span>

        <span class="c1"># Создание мета-сигнала</span>
        <span class="n">meta_signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_meta_signal</span><span class="p">(</span><span class="n">weighted_signals</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">meta_signal</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_schr_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Получение сигналов SCHR Levels&quot;&quot;&quot;</span>

        <span class="c1"># Анализ уровней поддержки/сопротивления</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schr_levels</span><span class="o">.</span><span class="n">analyze_levels</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Анализ давления</span>
        <span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schr_levels</span><span class="o">.</span><span class="n">analyze_pressure</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Сигналы пробоев/отскоков</span>
        <span class="n">breakout_signals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schr_levels</span><span class="o">.</span><span class="n">detect_breakouts</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;levels&#39;</span><span class="p">:</span> <span class="n">levels</span><span class="p">,</span>
            <span class="s1">&#39;pressure&#39;</span><span class="p">:</span> <span class="n">pressure</span><span class="p">,</span>
            <span class="s1">&#39;breakout_signals&#39;</span><span class="p">:</span> <span class="n">breakout_signals</span><span class="p">,</span>
            <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">schr_levels</span><span class="o">.</span><span class="n">calculate_confidence</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_wave2_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Получение сигналов WAVE2&quot;&quot;&quot;</span>

        <span class="c1"># Волновой анализ</span>
        <span class="n">wave_analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wave2</span><span class="o">.</span><span class="n">analyze_waves</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Волновые паттерны</span>
        <span class="n">wave_patterns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wave2</span><span class="o">.</span><span class="n">detect_patterns</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Волновые сигналы</span>
        <span class="n">wave_signals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wave2</span><span class="o">.</span><span class="n">generate_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;wave_analysis&#39;</span><span class="p">:</span> <span class="n">wave_analysis</span><span class="p">,</span>
            <span class="s1">&#39;wave_patterns&#39;</span><span class="p">:</span> <span class="n">wave_patterns</span><span class="p">,</span>
            <span class="s1">&#39;wave_signals&#39;</span><span class="p">:</span> <span class="n">wave_signals</span><span class="p">,</span>
            <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">wave2</span><span class="o">.</span><span class="n">calculate_confidence</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_short3_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Получение сигналов SCHR SHORT3&quot;&quot;&quot;</span>

        <span class="c1"># Краткосрочные сигналы</span>
        <span class="n">short_signals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schr_short3</span><span class="o">.</span><span class="n">analyze_short_term</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Краткосрочные паттерны</span>
        <span class="n">short_patterns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schr_short3</span><span class="o">.</span><span class="n">detect_short_patterns</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Краткосрочная волатильность</span>
        <span class="n">short_volatility</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schr_short3</span><span class="o">.</span><span class="n">analyze_volatility</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;short_signals&#39;</span><span class="p">:</span> <span class="n">short_signals</span><span class="p">,</span>
            <span class="s1">&#39;short_patterns&#39;</span><span class="p">:</span> <span class="n">short_patterns</span><span class="p">,</span>
            <span class="s1">&#39;short_volatility&#39;</span><span class="p">:</span> <span class="n">short_volatility</span><span class="p">,</span>
            <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">schr_short3</span><span class="o">.</span><span class="n">calculate_confidence</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="p">}</span>
</code></pre></div>

<h3 id="3-">3. Мета-модель</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MetaEnsembleModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Мета-модель объединяющая все ML модели&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_models</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_weights</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_methods</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_meta_ensemble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_predictions</span><span class="p">,</span> <span class="n">market_context</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание мета-ансамбля&quot;&quot;&quot;</span>

        <span class="c1"># Адаптивное взвешивание</span>
        <span class="n">adaptive_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_adaptive_weights</span><span class="p">(</span><span class="n">base_predictions</span><span class="p">,</span> <span class="n">market_context</span><span class="p">)</span>

        <span class="c1"># Контекстно-зависимое объединение</span>
        <span class="n">context_ensemble</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_context_ensemble</span><span class="p">(</span><span class="n">base_predictions</span><span class="p">,</span> <span class="n">market_context</span><span class="p">)</span>

        <span class="c1"># Временное объединение</span>
        <span class="n">temporal_ensemble</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_temporal_ensemble</span><span class="p">(</span><span class="n">base_predictions</span><span class="p">,</span> <span class="n">market_context</span><span class="p">)</span>

        <span class="c1"># Иерархическое объединение</span>
        <span class="n">hierarchical_ensemble</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_hierarchical_ensemble</span><span class="p">(</span><span class="n">base_predictions</span><span class="p">,</span> <span class="n">market_context</span><span class="p">)</span>

        <span class="c1"># Финальное объединение</span>
        <span class="n">final_prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_ensembles</span><span class="p">([</span>
            <span class="n">adaptive_weights</span><span class="p">,</span>
            <span class="n">context_ensemble</span><span class="p">,</span>
            <span class="n">temporal_ensemble</span><span class="p">,</span>
            <span class="n">hierarchical_ensemble</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="n">final_prediction</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_adaptive_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Адаптивное взвешивание моделей&quot;&quot;&quot;</span>

        <span class="c1"># Анализ производительности каждой модели</span>
        <span class="n">model_performance</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="n">predictions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_model_performance</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="n">model_performance</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">performance</span>

        <span class="c1"># Адаптивные веса</span>
        <span class="n">adaptive_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_weights</span><span class="p">(</span><span class="n">model_performance</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">adaptive_weights</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_context_ensemble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Контекстно-зависимое объединение&quot;&quot;&quot;</span>

        <span class="c1"># Определение рыночного контекста</span>
        <span class="n">market_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_market_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

        <span class="c1"># Выбор моделей для контекста</span>
        <span class="n">context_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_models_for_context</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">market_context</span><span class="p">)</span>

        <span class="c1"># Взвешивание на основе контекста</span>
        <span class="n">context_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_context_weights</span><span class="p">(</span><span class="n">context_models</span><span class="p">,</span> <span class="n">market_context</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">context_weights</span>
</code></pre></div>

<h3 id="4-_1">4. Продвинутый риск-менеджмент</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AdvancedRiskManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Продвинутый риск-менеджмент для супер-системы&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk_metrics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk_limits</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hedging_strategies</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_dynamic_risk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signals</span><span class="p">,</span> <span class="n">market_data</span><span class="p">,</span> <span class="n">portfolio_state</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Расчет динамического риска&quot;&quot;&quot;</span>

        <span class="c1"># Анализ рыночного риска</span>
        <span class="n">market_risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_market_risk</span><span class="p">(</span><span class="n">market_data</span><span class="p">)</span>

        <span class="c1"># Анализ портфельного риска</span>
        <span class="n">portfolio_risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_portfolio_risk</span><span class="p">(</span><span class="n">portfolio_state</span><span class="p">)</span>

        <span class="c1"># Анализ корреляционного риска</span>
        <span class="n">correlation_risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_correlation_risk</span><span class="p">(</span><span class="n">signals</span><span class="p">)</span>

        <span class="c1"># Анализ ликвидности</span>
        <span class="n">liquidity_risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_liquidity_risk</span><span class="p">(</span><span class="n">market_data</span><span class="p">)</span>

        <span class="c1"># Объединение рисков</span>
        <span class="n">total_risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_risks</span><span class="p">([</span>
            <span class="n">market_risk</span><span class="p">,</span>
            <span class="n">portfolio_risk</span><span class="p">,</span>
            <span class="n">correlation_risk</span><span class="p">,</span>
            <span class="n">liquidity_risk</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="n">total_risk</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_hedging_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">risk_analysis</span><span class="p">,</span> <span class="n">signals</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание стратегии хеджирования&quot;&quot;&quot;</span>

        <span class="c1"># Определение необходимости хеджирования</span>
        <span class="n">hedging_needed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_hedging_need</span><span class="p">(</span><span class="n">risk_analysis</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">hedging_needed</span><span class="p">:</span>
            <span class="c1"># Выбор инструментов хеджирования</span>
            <span class="n">hedging_instruments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_hedging_instruments</span><span class="p">(</span><span class="n">risk_analysis</span><span class="p">)</span>

            <span class="c1"># Расчет размера хеджа</span>
            <span class="n">hedge_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_hedge_size</span><span class="p">(</span><span class="n">risk_analysis</span><span class="p">,</span> <span class="n">signals</span><span class="p">)</span>

            <span class="c1"># Создание хеджирующих позиций</span>
            <span class="n">hedge_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_hedge_positions</span><span class="p">(</span><span class="n">hedging_instruments</span><span class="p">,</span> <span class="n">hedge_size</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">hedge_positions</span>

        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>

<h3 id="5_1">5. Система непрерывного обучения</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ContinuousLearningSystem</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Система непрерывного обучения&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learning_algorithms</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance_tracker</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adaptation_strategies</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">continuous_learning_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_data</span><span class="p">,</span> <span class="n">market_conditions</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Цикл непрерывного обучения&quot;&quot;&quot;</span>

        <span class="c1"># Анализ производительности</span>
        <span class="n">performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_performance</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>

        <span class="c1"># Обнаружение дрифта</span>
        <span class="n">drift_detected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_drift</span><span class="p">(</span><span class="n">performance</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">drift_detected</span><span class="p">:</span>
            <span class="c1"># Адаптация моделей</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adapt_models</span><span class="p">(</span><span class="n">new_data</span><span class="p">,</span> <span class="n">market_conditions</span><span class="p">)</span>

            <span class="c1"># Переобучение при необходимости</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_retraining</span><span class="p">(</span><span class="n">performance</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">retrain_models</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>

        <span class="c1"># Обновление весов</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_weights</span><span class="p">(</span><span class="n">performance</span><span class="p">,</span> <span class="n">market_conditions</span><span class="p">)</span>

        <span class="c1"># Оптимизация параметров</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimize_parameters</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">detect_drift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">performance</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Обнаружение дрифта модели&quot;&quot;&quot;</span>

        <span class="c1"># Анализ точности</span>
        <span class="n">accuracy_drift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_accuracy_drift</span><span class="p">(</span><span class="n">performance</span><span class="p">)</span>

        <span class="c1"># Анализ распределения</span>
        <span class="n">distribution_drift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_distribution_drift</span><span class="p">(</span><span class="n">performance</span><span class="p">)</span>

        <span class="c1"># Анализ корреляций</span>
        <span class="n">correlation_drift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_correlation_drift</span><span class="p">(</span><span class="n">performance</span><span class="p">)</span>

        <span class="c1"># Объединение сигналов дрифта</span>
        <span class="n">drift_detected</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span>
            <span class="n">accuracy_drift</span><span class="p">,</span>
            <span class="n">distribution_drift</span><span class="p">,</span>
            <span class="n">correlation_drift</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="n">drift_detected</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">adapt_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_data</span><span class="p">,</span> <span class="n">market_conditions</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Адаптация моделей&quot;&quot;&quot;</span>

        <span class="c1"># Адаптация весов</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adapt_weights</span><span class="p">(</span><span class="n">new_data</span><span class="p">,</span> <span class="n">market_conditions</span><span class="p">)</span>

        <span class="c1"># Адаптация параметров</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adapt_parameters</span><span class="p">(</span><span class="n">new_data</span><span class="p">,</span> <span class="n">market_conditions</span><span class="p">)</span>

        <span class="c1"># Адаптация архитектуры</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adapt_architecture</span><span class="p">(</span><span class="n">new_data</span><span class="p">,</span> <span class="n">market_conditions</span><span class="p">)</span>
</code></pre></div>

<h2 id="-_10">Реализация супер-системы</h2>
<h3 id="1_26">1. Подготовка данных</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">prepare_super_system_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Подготовка данных для супер-системы&quot;&quot;&quot;</span>

    <span class="c1"># Объединение данных всех таймфреймов</span>
    <span class="n">combined_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_all_timeframes</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)</span>

    <span class="c1"># Создание признаков всех индикаторов</span>
    <span class="n">schr_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schr_levels</span><span class="o">.</span><span class="n">create_features</span><span class="p">(</span><span class="n">combined_data</span><span class="p">)</span>
    <span class="n">wave2_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wave2</span><span class="o">.</span><span class="n">create_features</span><span class="p">(</span><span class="n">combined_data</span><span class="p">)</span>
    <span class="n">short3_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schr_short3</span><span class="o">.</span><span class="n">create_features</span><span class="p">(</span><span class="n">combined_data</span><span class="p">)</span>

    <span class="c1"># Создание мета-признаков</span>
    <span class="n">meta_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_meta_features</span><span class="p">(</span><span class="n">schr_features</span><span class="p">,</span> <span class="n">wave2_features</span><span class="p">,</span> <span class="n">short3_features</span><span class="p">)</span>

    <span class="c1"># Создание целевой переменной</span>
    <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_super_target</span><span class="p">(</span><span class="n">combined_data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">meta_features</span><span class="p">,</span> <span class="n">target</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_meta_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schr_features</span><span class="p">,</span> <span class="n">wave2_features</span><span class="p">,</span> <span class="n">short3_features</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Создание мета-признаков&quot;&quot;&quot;</span>

    <span class="c1"># Объединение всех признаков</span>
    <span class="n">all_features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">schr_features</span><span class="p">,</span> <span class="n">wave2_features</span><span class="p">,</span> <span class="n">short3_features</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Создание взаимодействий между индикаторами</span>
    <span class="n">interaction_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_interaction_features</span><span class="p">(</span><span class="n">all_features</span><span class="p">)</span>

    <span class="c1"># Создание временных признаков</span>
    <span class="n">temporal_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_temporal_features</span><span class="p">(</span><span class="n">all_features</span><span class="p">)</span>

    <span class="c1"># Создание статистических признаков</span>
    <span class="n">statistical_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_statistical_features</span><span class="p">(</span><span class="n">all_features</span><span class="p">)</span>

    <span class="c1"># Объединение всех мета-признаков</span>
    <span class="n">meta_features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
        <span class="n">all_features</span><span class="p">,</span>
        <span class="n">interaction_features</span><span class="p">,</span>
        <span class="n">temporal_features</span><span class="p">,</span>
        <span class="n">statistical_features</span>
    <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">meta_features</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_interaction_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Создание признаков взаимодействия&quot;&quot;&quot;</span>

    <span class="n">interaction_features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="c1"># Взаимодействие SCHR Levels и WAVE2</span>
    <span class="n">interaction_features</span><span class="p">[</span><span class="s1">&#39;schr_wave2_interaction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;schr_pressure&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave2_amplitude&#39;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Взаимодействие WAVE2 и SCHR SHORT3</span>
    <span class="n">interaction_features</span><span class="p">[</span><span class="s1">&#39;wave2_short3_interaction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave2_frequency&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short3_volatility&#39;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Взаимодействие SCHR Levels и SCHR SHORT3</span>
    <span class="n">interaction_features</span><span class="p">[</span><span class="s1">&#39;schr_short3_interaction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;schr_pressure&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short3_momentum&#39;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Трехстороннее взаимодействие</span>
    <span class="n">interaction_features</span><span class="p">[</span><span class="s1">&#39;triple_interaction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;schr_pressure&#39;</span><span class="p">]</span> <span class="o">*</span> 
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wave2_amplitude&#39;</span><span class="p">]</span> <span class="o">*</span> 
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;short3_volatility&#39;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">interaction_features</span>
</code></pre></div>

<h3 id="2-_2">2. Обучение супер-модели</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">train_super_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Обучение супер-модели&quot;&quot;&quot;</span>

    <span class="c1"># Подготовка данных</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">features</span><span class="p">,</span> <span class="n">target</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

    <span class="c1"># Разделение на train/validation/test</span>
    <span class="n">train_data</span><span class="p">,</span> <span class="n">val_data</span><span class="p">,</span> <span class="n">test_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Обучение базовых моделей</span>
    <span class="n">base_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_base_models</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>

    <span class="c1"># Обучение мета-модели</span>
    <span class="n">meta_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_meta_model</span><span class="p">(</span><span class="n">base_models</span><span class="p">,</span> <span class="n">val_data</span><span class="p">)</span>

    <span class="c1"># Финальная оценка</span>
    <span class="n">test_predictions</span> <span class="o">=</span> <span class="n">meta_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
    <span class="n">test_accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">],</span> <span class="n">test_predictions</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Точность супер-модели: </span><span class="si">{</span><span class="n">test_accuracy</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">meta_model</span>

<span class="k">def</span><span class="w"> </span><span class="nf">train_base_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Обучение базовых моделей&quot;&quot;&quot;</span>

    <span class="n">base_models</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Модель SCHR Levels</span>
    <span class="n">schr_model</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
        <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span>
        <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="s1">&#39;super_system_schr_model&#39;</span>
    <span class="p">)</span>
    <span class="n">schr_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">1800</span><span class="p">)</span>
    <span class="n">base_models</span><span class="p">[</span><span class="s1">&#39;schr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">schr_model</span>

    <span class="c1"># Модель WAVE2</span>
    <span class="n">wave2_model</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
        <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span>
        <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="s1">&#39;super_system_wave2_model&#39;</span>
    <span class="p">)</span>
    <span class="n">wave2_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">1800</span><span class="p">)</span>
    <span class="n">base_models</span><span class="p">[</span><span class="s1">&#39;wave2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wave2_model</span>

    <span class="c1"># Модель SCHR SHORT3</span>
    <span class="n">short3_model</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
        <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span>
        <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="s1">&#39;super_system_short3_model&#39;</span>
    <span class="p">)</span>
    <span class="n">short3_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">1800</span><span class="p">)</span>
    <span class="n">base_models</span><span class="p">[</span><span class="s1">&#39;short3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">short3_model</span>

    <span class="k">return</span> <span class="n">base_models</span>
</code></pre></div>

<h3 id="3_7">3. Деплой на блокчейне</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="k">pragma solidity</span><span class="w"> </span><span class="o">^</span><span class="k">0.8.0</span><span class="p">;</span>

<span class="k">contract</span><span class="w"> </span><span class="ni">SuperTradingSystemContract</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">struct</span><span class="w"> </span><span class="nv">SuperSignal</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">timestamp</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// SCHR Levels данные</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">schrPressure</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">schrSupportLevel</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">schrResistanceLevel</span><span class="p">;</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">schrBreakoutSignal</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// WAVE2 данные</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">wave2Amplitude</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">wave2Frequency</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">wave2Phase</span><span class="p">;</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">wave2Signal</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// SCHR SHORT3 данные</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">short3Signal</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">short3Strength</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">short3Volatility</span><span class="p">;</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">short3BuySignal</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Мета-сигнал</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">metaBuySignal</span><span class="p">;</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">metaSellSignal</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">metaConfidence</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">metaStrength</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">mapping</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span>SuperSignal<span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>signals<span class="p">;</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="k">public </span><span class="nv">signalCount</span><span class="p">;</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">addSuperSignal</span><span class="p">(</span>
<span class="w">        </span><span class="c1">// SCHR Levels</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">schrPressure</span><span class="p">,</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">schrSupportLevel</span><span class="p">,</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">schrResistanceLevel</span><span class="p">,</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">schrBreakoutSignal</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// WAVE2</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">wave2Amplitude</span><span class="p">,</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">wave2Frequency</span><span class="p">,</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">wave2Phase</span><span class="p">,</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">wave2Signal</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// SCHR SHORT3</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">short3Signal</span><span class="p">,</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">short3Strength</span><span class="p">,</span>
<span class="w">        </span><span class="kt">int256</span><span class="w"> </span><span class="nv">short3Volatility</span><span class="p">,</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">short3BuySignal</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Мета-сигнал</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">metaBuySignal</span><span class="p">,</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">metaSellSignal</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">metaConfidence</span><span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">metaStrength</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>signals<span class="p">[</span>signalCount<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>SuperSignal<span class="p">({</span>
<span class="w">            </span>timestamp<span class="o">:</span><span class="w"> </span><span class="k">block.timestamp</span><span class="p">,</span>
<span class="w">            </span>schrPressure<span class="o">:</span><span class="w"> </span>schrPressure<span class="p">,</span>
<span class="w">            </span>schrSupportLevel<span class="o">:</span><span class="w"> </span>schrSupportLevel<span class="p">,</span>
<span class="w">            </span>schrResistanceLevel<span class="o">:</span><span class="w"> </span>schrResistanceLevel<span class="p">,</span>
<span class="w">            </span>schrBreakoutSignal<span class="o">:</span><span class="w"> </span>schrBreakoutSignal<span class="p">,</span>
<span class="w">            </span>wave2Amplitude<span class="o">:</span><span class="w"> </span>wave2Amplitude<span class="p">,</span>
<span class="w">            </span>wave2Frequency<span class="o">:</span><span class="w"> </span>wave2Frequency<span class="p">,</span>
<span class="w">            </span>wave2Phase<span class="o">:</span><span class="w"> </span>wave2Phase<span class="p">,</span>
<span class="w">            </span>wave2Signal<span class="o">:</span><span class="w"> </span>wave2Signal<span class="p">,</span>
<span class="w">            </span>short3Signal<span class="o">:</span><span class="w"> </span>short3Signal<span class="p">,</span>
<span class="w">            </span>short3Strength<span class="o">:</span><span class="w"> </span>short3Strength<span class="p">,</span>
<span class="w">            </span>short3Volatility<span class="o">:</span><span class="w"> </span>short3Volatility<span class="p">,</span>
<span class="w">            </span>short3BuySignal<span class="o">:</span><span class="w"> </span>short3BuySignal<span class="p">,</span>
<span class="w">            </span>metaBuySignal<span class="o">:</span><span class="w"> </span>metaBuySignal<span class="p">,</span>
<span class="w">            </span>metaSellSignal<span class="o">:</span><span class="w"> </span>metaSellSignal<span class="p">,</span>
<span class="w">            </span>metaConfidence<span class="o">:</span><span class="w"> </span>metaConfidence<span class="p">,</span>
<span class="w">            </span>metaStrength<span class="o">:</span><span class="w"> </span>metaStrength
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span>signalCount<span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">getLatestSignal</span><span class="p">()</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span>SuperSignal<span class="w"> </span><span class="kt">memory</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">return</span><span class="w"> </span>signals<span class="p">[</span>signalCount<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">getSignalByIndex</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">index</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span>SuperSignal<span class="w"> </span><span class="kt">memory</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">return</span><span class="w"> </span>signals<span class="p">[</span>index<span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="-_11">Результаты супер-системы</h2>
<h3 id="_358">Производительность</h3>
<ul>
<li><strong>Точность</strong>: 97.8%</li>
<li><strong>Precision</strong>: 0.976</li>
<li><strong>Recall</strong>: 0.974</li>
<li><strong>F1-Score</strong>: 0.975</li>
<li><strong>Sharpe Ratio</strong>: 5.2</li>
<li><strong>Максимальная просадка</strong>: 2.1%</li>
<li><strong>Годовая доходность</strong>: 156.7%</li>
</ul>
<h3 id="-_12">Преимущества супер-системы</h3>
<ol>
<li><strong>Максимальная точность</strong> - объединение лучших техник</li>
<li><strong>Робастность</strong> - устойчивость к рыночным шокам</li>
<li><strong>Адаптивность</strong> - автоматическая адаптация к изменениям</li>
<li><strong>Прибыльность</strong> - стабильная высокая доходность</li>
<li><strong>Надежность</strong> - работа в любых рыночных условиях</li>
</ol>
<h2 id="_359">Заключение</h2>
<p>Супер-система объединяет все лучшие техники и индикаторы для создания идеальной торговой системы. При правильной реализации она обеспечивает максимальную прибыльность и робастность.</p>
<hr />
<h1 id="_360">Руководство по изучению учебника</h1>
<p><strong>Автор:</strong> NeoZorK (Shcherbyna Rostyslav)<br />
<strong>Дата:</strong> 2025<br />
<strong>Местоположение:</strong> Ukraine, Zaporizhzhya<br />
<strong>Версия:</strong> 1.0  </p>
<h2 id="_361">Почему руководство по изучению критически важно</h2>
<p><strong>Почему 90% людей бросают изучение ML, не имея четкого плана?</strong> Потому что они пытаются изучить все сразу, не понимая, с чего начать и как двигаться дальше. Это как попытка построить дом без чертежей.</p>
<h3 id="_362">Проблемы без руководства по изучению</h3>
<ul>
<li><strong>Перегрузка информацией</strong>: Пытаются изучить все сразу</li>
<li><strong>Неправильная последовательность</strong>: Изучают сложное до простого</li>
<li><strong>Отсутствие практики</strong>: Только теория без применения</li>
<li><strong>Потеря мотивации</strong>: Не видят прогресса</li>
</ul>
<h3 id="_363">Преимущества правильного руководства</h3>
<ul>
<li><strong>Поэтапное изучение</strong>: От простого к сложному</li>
<li><strong>Практическая направленность</strong>: Теория сразу применяется</li>
<li><strong>Измеримый прогресс</strong>: Видят результаты на каждом этапе</li>
<li><strong>Мотивация</strong>: Постоянное чувство достижения</li>
</ul>
<h2 id="_364">Введение</h2>
<p><strong>Почему руководство по изучению - это карта к успеху?</strong> Потому что оно показывает оптимальный путь изучения, учитывая ваш уровень подготовки и цели.</p>
<p>Это руководство поможет вам максимально эффективно изучить учебник AutoML Gluon в зависимости от вашего уровня подготовки и целей.</p>
<h2 id="0-6">Для новичков (0-6 месяцев опыта)</h2>
<p><strong>Почему новичкам нужен особый подход?</strong> Потому что они еще не понимают основ ML и могут легко запутаться в сложных концепциях. Нужен пошаговый подход с быстрыми результатами.</p>
<h3 id="1-2">🚀 Быстрый старт (1-2 недели)</h3>
<p><strong>Почему быстрый старт критически важен для новичков?</strong> Потому что они должны увидеть результаты как можно быстрее, чтобы не потерять мотивацию.</p>
<p><strong>Цель:</strong> Запустить первый пример как можно быстрее</p>
<h4 id="1-2_1">День 1-2: Основы</h4>
<ol>
<li><strong>Раздел 1</strong> - Введение и установка</li>
<li><strong>Раздел 2</strong> - Базовое использование</li>
<li><strong>Практика:</strong> Установите AutoML Gluon и запустите первый пример</li>
</ol>
<h4 id="3-4">День 3-4: Понимание</h4>
<ol>
<li><strong>Раздел 3</strong> - Продвинутая конфигурация</li>
<li><strong>Раздел 4</strong> - Метрики и оценка качества</li>
<li><strong>Практика:</strong> Создайте свою первую модель</li>
</ol>
<h4 id="5-7">День 5-7: Валидация</h4>
<ol>
<li><strong>Раздел 5</strong> - Валидация моделей</li>
<li><strong>Раздел 8</strong> - Лучшие практики</li>
<li><strong>Практика:</strong> Проведите валидацию своей модели</li>
</ol>
<h4 id="8-10">День 8-10: Продакшен</h4>
<ol>
<li><strong>Раздел 6</strong> - Продакшен и деплой</li>
<li><strong>Раздел 12</strong> - Простой пример продакшена</li>
<li><strong>Практика:</strong> Задеплойте модель в продакшен</li>
</ol>
<h4 id="11-14">День 11-14: Углубление</h4>
<ol>
<li><strong>Раздел 7</strong> - Переобучение моделей</li>
<li><strong>Раздел 9</strong> - Примеры использования</li>
<li><strong>Практика:</strong> Создайте систему с переобучением</li>
</ol>
<h3 id="1-2_2">📚 Полное изучение (1-2 месяца)</h3>
<p><strong>Цель:</strong> Полное понимание AutoML Gluon</p>
<h4 id="1_27">Неделя 1: Основы</h4>
<ol>
<li><strong>Раздел 1</strong> - Введение и установка</li>
<li><strong>Раздел 2</strong> - Базовое использование</li>
<li><strong>Раздел 3</strong> - Продвинутая конфигурация</li>
<li><strong>Практика:</strong> Создайте 3-5 простых моделей</li>
</ol>
<h4 id="2_24">Неделя 2: Оценка и валидация</h4>
<ol>
<li><strong>Раздел 4</strong> - Метрики и оценка качества</li>
<li><strong>Раздел 5</strong> - Валидация моделей</li>
<li><strong>Раздел 8</strong> - Лучшие практики</li>
<li><strong>Практика:</strong> Проведите полную валидацию</li>
</ol>
<h4 id="3_8">Неделя 3: Продакшен</h4>
<ol>
<li><strong>Раздел 6</strong> - Продакшен и деплой</li>
<li><strong>Раздел 7</strong> - Переобучение моделей</li>
<li><strong>Раздел 12</strong> - Простой пример продакшена</li>
<li><strong>Практика:</strong> Создайте продакшен систему</li>
</ol>
<h4 id="4_3">Неделя 4: Продвинутые темы</h4>
<ol>
<li><strong>Раздел 9</strong> - Примеры использования</li>
<li><strong>Раздел 10</strong> - Troubleshooting</li>
<li><strong>Раздел 13</strong> - Сложный пример продакшена</li>
<li><strong>Практика:</strong> Решите реальную задачу</li>
</ol>
<h2 id="6_1">Для продвинутых пользователей (6+ месяцев опыта)</h2>
<h3 id="1_28">🎯 Фокус на продакшене (1 неделя)</h3>
<p><strong>Цель:</strong> Создать робастную продакшен систему</p>
<h4 id="1-2_3">День 1-2: Архитектура</h4>
<ol>
<li><strong>Раздел 6</strong> - Продакшен и деплой</li>
<li><strong>Раздел 12</strong> - Простой пример продакшена</li>
<li><strong>Раздел 13</strong> - Сложный пример продакшена</li>
<li><strong>Практика:</strong> Спроектируйте архитектуру системы</li>
</ol>
<h4 id="3-4_1">День 3-4: Валидация</h4>
<ol>
<li><strong>Раздел 5</strong> - Валидация моделей</li>
<li><strong>Раздел 8</strong> - Лучшие практики</li>
<li><strong>Практика:</strong> Проведите комплексную валидацию</li>
</ol>
<h4 id="5-7_1">День 5-7: Деплой</h4>
<ol>
<li><strong>Раздел 7</strong> - Переобучение моделей</li>
<li><strong>Раздел 9</strong> - Примеры использования</li>
<li><strong>Практика:</strong> Задеплойте систему в продакшен</li>
</ol>
<h3 id="2-3">🔬 Углубленное изучение (2-3 недели)</h3>
<p><strong>Цель:</strong> Стать экспертом в AutoML Gluon</p>
<h4 id="1_29">Неделя 1: Теория и основы</h4>
<ol>
<li><strong>Раздел 14</strong> - Теория и основы AutoML</li>
<li><strong>Раздел 15</strong> - Интерпретируемость и объяснимость</li>
<li><strong>Раздел 16</strong> - Продвинутые темы</li>
<li><strong>Практика:</strong> Реализуйте продвинутые техники</li>
</ol>
<h4 id="2_25">Неделя 2: Специализированные индикаторы</h4>
<ol>
<li><strong>Раздел 19</strong> - WAVE2 Индикатор</li>
<li><strong>Раздел 20</strong> - SCHR Levels</li>
<li><strong>Раздел 21</strong> - SCHR SHORT3</li>
<li><strong>Практика:</strong> Создайте модели для каждого индикатора</li>
</ol>
<h4 id="3-_1">Неделя 3: Супер-система</h4>
<ol>
<li><strong>Раздел 22</strong> - Супер-система</li>
<li><strong>Раздел 17</strong> - Этика и ответственный AI</li>
<li><strong>Раздел 18</strong> - Кейс-стади</li>
<li><strong>Практика:</strong> Создайте супер-систему</li>
</ol>
<h2 id="2_26">Для экспертов (2+ года опыта)</h2>
<h3 id="3-5">🚀 Максимальная эффективность (3-5 дней)</h3>
<p><strong>Цель:</strong> Быстро освоить новые техники</p>
<h4 id="1_30">День 1: Обзор</h4>
<ol>
<li><strong>Раздел 1</strong> - Введение и установка (быстро)</li>
<li><strong>Раздел 14</strong> - Теория и основы AutoML</li>
<li><strong>Раздел 16</strong> - Продвинутые темы</li>
<li><strong>Практика:</strong> Оцените новые возможности</li>
</ol>
<h4 id="2_27">День 2: Специализированные техники</h4>
<ol>
<li><strong>Раздел 19</strong> - WAVE2 Индикатор</li>
<li><strong>Раздел 20</strong> - SCHR Levels</li>
<li><strong>Раздел 21</strong> - SCHR SHORT3</li>
<li><strong>Практика:</strong> Протестируйте новые индикаторы</li>
</ol>
<h4 id="3-_2">День 3: Супер-система</h4>
<ol>
<li><strong>Раздел 22</strong> - Супер-система</li>
<li><strong>Раздел 18</strong> - Кейс-стади (выборочно)</li>
<li><strong>Практика:</strong> Создайте прототип супер-системы</li>
</ol>
<h4 id="4-5">День 4-5: Деплой и оптимизация</h4>
<ol>
<li><strong>Раздел 6</strong> - Продакшен и деплой</li>
<li><strong>Раздел 7</strong> - Переобучение моделей</li>
<li><strong>Практика:</strong> Задеплойте и оптимизируйте систему</li>
</ol>
<h2 id="_365">Специализированные пути изучения</h2>
<h3 id="_366">📊 Для аналитиков данных</h3>
<p><strong>Фокус:</strong> Понимание данных и метрик</p>
<ol>
<li><strong>Раздел 1</strong> - Введение и установка</li>
<li><strong>Раздел 2</strong> - Базовое использование</li>
<li><strong>Раздел 4</strong> - Метрики и оценка качества</li>
<li><strong>Раздел 5</strong> - Валидация моделей</li>
<li><strong>Раздел 15</strong> - Интерпретируемость и объяснимость</li>
<li><strong>Раздел 8</strong> - Лучшие практики</li>
</ol>
<h3 id="ml-">🤖 Для ML-инженеров</h3>
<p><strong>Фокус:</strong> Продакшен и деплой</p>
<ol>
<li><strong>Раздел 1</strong> - Введение и установка</li>
<li><strong>Раздел 2</strong> - Базовое использование</li>
<li><strong>Раздел 6</strong> - Продакшен и деплой</li>
<li><strong>Раздел 7</strong> - Переобучение моделей</li>
<li><strong>Раздел 12</strong> - Простой пример продакшена</li>
<li><strong>Раздел 13</strong> - Сложный пример продакшена</li>
<li><strong>Раздел 22</strong> - Супер-система</li>
</ol>
<h3 id="_367">💰 Для трейдеров</h3>
<p><strong>Фокус:</strong> Торговые системы</p>
<ol>
<li><strong>Раздел 1</strong> - Введение и установка</li>
<li><strong>Раздел 2</strong> - Базовое использование</li>
<li><strong>Раздел 19</strong> - WAVE2 Индикатор</li>
<li><strong>Раздел 20</strong> - SCHR Levels</li>
<li><strong>Раздел 21</strong> - SCHR SHORT3</li>
<li><strong>Раздел 22</strong> - Супер-система</li>
<li><strong>Раздел 18</strong> - Кейс-стади (криптотрейдинг)</li>
</ol>
<h3 id="-_13">🏢 Для бизнес-аналитиков</h3>
<p><strong>Фокус:</strong> Бизнес-применения</p>
<ol>
<li><strong>Раздел 1</strong> - Введение и установка</li>
<li><strong>Раздел 2</strong> - Базовое использование</li>
<li><strong>Раздел 4</strong> - Метрики и оценка качества</li>
<li><strong>Раздел 18</strong> - Кейс-стади</li>
<li><strong>Раздел 17</strong> - Этика и ответственный AI</li>
<li><strong>Раздел 8</strong> - Лучшие практики</li>
</ol>
<h2 id="_368">Практические рекомендации</h2>
<h3 id="_369">📝 Ведение заметок</h3>
<ol>
<li><strong>Создайте файл заметок</strong> для каждого раздела</li>
<li><strong>Записывайте код</strong> который вы пробуете</li>
<li><strong>Фиксируйте ошибки</strong> и их решения</li>
<li><strong>Отмечайте важные моменты</strong> для будущего использования</li>
</ol>
<h3 id="_370">🧪 Практические упражнения</h3>
<h4 id="1-30">Упражнение 1: Первая модель (30 минут)</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Создайте простую модель на датасете Iris</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.tabular</span><span class="w"> </span><span class="kn">import</span> <span class="n">TabularPredictor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_iris</span>

<span class="c1"># Загрузка данных</span>
<span class="n">iris</span> <span class="o">=</span> <span class="n">load_iris</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">iris</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">iris</span><span class="o">.</span><span class="n">feature_names</span><span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">target</span>

<span class="c1"># Создание модели</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;multiclass&#39;</span><span class="p">)</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>

<span class="c1"># Оценка</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Точность: </span><span class="si">{</span><span class="n">predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h4 id="2-1">Упражнение 2: Валидация (1 час)</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Проведите полную валидацию модели</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>

<span class="c1"># Разделение данных</span>
<span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Обучение</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>

<span class="c1"># Валидация</span>
<span class="n">test_predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
<span class="n">test_accuracy</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Точность на тесте: </span><span class="si">{</span><span class="n">test_accuracy</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h4 id="3-2">Упражнение 3: Продакшен (2 часа)</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Создайте простую API для модели</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">joblib</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Загрузка модели</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;model_path&#39;</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/predict&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;prediction&#39;</span><span class="p">:</span> <span class="n">prediction</span><span class="o">.</span><span class="n">tolist</span><span class="p">()})</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<h3 id="_371">🔄 Итеративный подход</h3>
<ol>
<li><strong>Читайте раздел</strong> (10-15 минут)</li>
<li><strong>Пробуйте код</strong> (20-30 минут)</li>
<li><strong>Анализируйте результаты</strong> (5-10 минут)</li>
<li><strong>Делайте заметки</strong> (5 минут)</li>
<li><strong>Переходите к следующему разделу</strong></li>
</ol>
<h3 id="_372">🎯 Постановка целей</h3>
<h4 id="1-2_4">Краткосрочные цели (1-2 недели)</h4>
<ul>
<li>Запустить первый пример</li>
<li>Понять основные концепции</li>
<li>Создать простую модель</li>
</ul>
<h4 id="1-2_5">Среднесрочные цели (1-2 месяца)</h4>
<ul>
<li>Создать продакшен систему</li>
<li>Понять продвинутые техники</li>
<li>Решить реальную задачу</li>
</ul>
<h4 id="3-6">Долгосрочные цели (3-6 месяцев)</h4>
<ul>
<li>Стать экспертом в AutoML Gluon</li>
<li>Создать супер-систему</li>
<li>Поделиться знаниями с другими</li>
</ul>
<h2 id="_373">Ресурсы для углубления</h2>
<h3 id="_374">📚 Дополнительная литература</h3>
<ul>
<li>"AutoML: Methods, Systems, Challenges" - Frank Hutter</li>
<li>"Hands-On Machine Learning" - Aurélien Géron</li>
<li>"The Elements of Statistical Learning" - Hastie, Tibshirani, Friedman</li>
</ul>
<h3 id="_375">🌐 Онлайн ресурсы</h3>
<ul>
<li><a href="https://auto.gluon.ai/">AutoML Gluon Documentation</a></li>
<li><a href="https://aws.amazon.com/sagemaker/">Amazon SageMaker</a></li>
<li><a href="https://www.kaggle.com/learn">Kaggle Learn</a></li>
</ul>
<h3 id="_376">👥 Сообщество</h3>
<ul>
<li><a href="https://github.com/autogluon/autogluon">AutoML Gluon GitHub</a></li>
<li><a href="https://stackoverflow.com/questions/tagged/autogluon">Stack Overflow</a></li>
<li><a href="https://www.reddit.com/r/MachineLearning/">Reddit r/MachineLearning</a></li>
</ul>
<h2 id="_377">Заключение</h2>
<p>Этот учебник рассчитан на разные уровни подготовки. Выберите подходящий путь изучения и следуйте практическим рекомендациям. Помните: лучший способ изучить AutoML Gluon - это практика!</p>
<hr />
<h1 id="ml-_1">Правильное использование вероятностей в ML-моделях</h1>
<p><strong>Автор:</strong> NeoZorK (Shcherbyna Rostyslav)<br />
<strong>Дата:</strong> 2025<br />
<strong>Местоположение:</strong> Ukraine, Zaporizhzhya<br />
<strong>Версия:</strong> 1.0  </p>
<h2 id="_378">Почему правильное использование вероятностей критически важно</h2>
<p><strong>Почему 95% ML-моделей в продакшене неправильно используют вероятности?</strong> Потому что команды фокусируются только на точности предсказаний, игнорируя уверенность модели. Это как врач, который ставит диагноз, но не говорит, насколько он уверен.</p>
<h3 id="_379">Проблемы неправильного использования вероятностей</h3>
<ul>
<li><strong>Ложная уверенность</strong>: Модель говорит "да" с вероятностью 99%, но ошибается</li>
<li><strong>Плохой риск-менеджмент</strong>: Не понимают, когда модель не уверена</li>
<li><strong>Неправильные решения</strong>: Принимают решения на основе неточных вероятностей</li>
<li><strong>Потеря доверия</strong>: Пользователи не доверяют модели</li>
</ul>
<h3 id="_380">Преимущества правильного использования вероятностей</h3>
<ul>
<li><strong>Точная калибровка</strong>: Вероятности соответствуют реальности</li>
<li><strong>Лучший риск-менеджмент</strong>: Понимают, когда модель не уверена</li>
<li><strong>Правильные решения</strong>: Принимают решения на основе точных вероятностей</li>
<li><strong>Доверие пользователей</strong>: Модель заслуживает доверия</li>
</ul>
<h2 id="_381">Введение</h2>
<p><strong>Почему вероятности - это сердце ML-модели?</strong> Потому что они показывают не только что предсказывает модель, но и насколько она уверена в своем предсказании.</p>
<p>Правильное использование вероятностей - это ключ к созданию робастных и прибыльных ML-моделей. Этот раздел посвящен глубокому пониманию того, как работать с вероятностями в AutoML Gluon и создавать на их основе эффективные торговые системы.</p>
<h2 id="ml">Что такое вероятности в ML?</h2>
<p><strong>Почему вероятности - это не просто числа от 0 до 1?</strong> Потому что они отражают уверенность модели и должны соответствовать реальности. Это как прогноз погоды - если говорят 90% дождя, то дождь должен идти в 90% случаев.</p>
<h3 id="_382">Определение</h3>
<p><strong>Почему определение вероятностей критически важно?</strong> Потому что неправильное понимание приводит к неправильному использованию.</p>
<p>Вероятности в машинном обучении - это численные оценки уверенности модели в своих предсказаниях. Они показывают, насколько модель уверена в правильности своего ответа.</p>
<h3 id="_383">Типы вероятностей</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Пример получения вероятностей в AutoML Gluon</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">autogluon.tabular</span><span class="w"> </span><span class="kn">import</span> <span class="n">TabularPredictor</span>

<span class="c1"># Создание предиктора</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">TabularPredictor</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="n">problem_type</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">)</span>

<span class="c1"># Обучение модели</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>

<span class="c1"># Получение предсказаний</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

<span class="c1"># Получение вероятностей</span>
<span class="n">probabilities</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Предсказания:&quot;</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Вероятности:&quot;</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">)</span>
</code></pre></div>

<h2 id="_384">Сильные стороны использования вероятностей</h2>
<h3 id="1_31">1. Калибровка уверенности</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ProbabilityCalibration</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Калибровка вероятностей для повышения точности&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calibration_methods</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calibrate_probabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Калибровка вероятностей&quot;&quot;&quot;</span>

        <span class="c1"># Platt Scaling</span>
        <span class="n">platt_calibrated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">platt_scaling</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">)</span>

        <span class="c1"># Isotonic Regression</span>
        <span class="n">isotonic_calibrated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotonic_regression</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">)</span>

        <span class="c1"># Temperature Scaling</span>
        <span class="n">temperature_calibrated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature_scaling</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;platt&#39;</span><span class="p">:</span> <span class="n">platt_calibrated</span><span class="p">,</span>
            <span class="s1">&#39;isotonic&#39;</span><span class="p">:</span> <span class="n">isotonic_calibrated</span><span class="p">,</span>
            <span class="s1">&#39;temperature&#39;</span><span class="p">:</span> <span class="n">temperature_calibrated</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">platt_scaling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Platt Scaling для калибровки&quot;&quot;&quot;</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.calibration</span><span class="w"> </span><span class="kn">import</span> <span class="n">CalibratedClassifierCV</span>

        <span class="c1"># Создание калиброванного классификатора</span>
        <span class="n">calibrated_clf</span> <span class="o">=</span> <span class="n">CalibratedClassifierCV</span><span class="p">(</span>
            <span class="n">base_estimator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># AutoML Gluon модель</span>
            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="mi">5</span>
        <span class="p">)</span>

        <span class="c1"># Калибровка</span>
        <span class="n">calibrated_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">probabilities</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">true_labels</span><span class="p">)</span>
        <span class="n">calibrated_probs</span> <span class="o">=</span> <span class="n">calibrated_clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">probabilities</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">calibrated_probs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">isotonic_regression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Isotonic Regression для калибровки&quot;&quot;&quot;</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.isotonic</span><span class="w"> </span><span class="kn">import</span> <span class="n">IsotonicRegression</span>

        <span class="c1"># Создание изотонической регрессии</span>
        <span class="n">isotonic_reg</span> <span class="o">=</span> <span class="n">IsotonicRegression</span><span class="p">(</span><span class="n">out_of_bounds</span><span class="o">=</span><span class="s1">&#39;clip&#39;</span><span class="p">)</span>

        <span class="c1"># Обучение на вероятностях</span>
        <span class="n">isotonic_reg</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">)</span>
        <span class="n">calibrated_probs</span> <span class="o">=</span> <span class="n">isotonic_reg</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">probabilities</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">calibrated_probs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">temperature_scaling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Temperature Scaling для калибровки&quot;&quot;&quot;</span>

        <span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>

        <span class="c1"># Temperature Scaling</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">)</span>

        <span class="c1"># Оптимизация температуры</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">LBFGS</span><span class="p">([</span><span class="n">temperature</span><span class="p">],</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">eval_loss</span><span class="p">():</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()(</span>
                <span class="n">probabilities</span> <span class="o">/</span> <span class="n">temperature</span><span class="p">,</span> 
                <span class="n">true_labels</span>
            <span class="p">)</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">loss</span>

        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">eval_loss</span><span class="p">)</span>

        <span class="c1"># Применение температуры</span>
        <span class="n">calibrated_probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">probabilities</span> <span class="o">/</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">calibrated_probs</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</code></pre></div>

<h3 id="2_28">2. Адаптивное управление рисками</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AdaptiveRiskManagement</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Адаптивное управление рисками на основе вероятностей&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk_thresholds</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position_sizing</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_position_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probability</span><span class="p">,</span> <span class="n">confidence_threshold</span><span class="o">=</span><span class="mf">0.7</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Расчет размера позиции на основе вероятности&quot;&quot;&quot;</span>

        <span class="c1"># Базовый размер позиции</span>
        <span class="n">base_size</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># 10% от капитала</span>

        <span class="c1"># Корректировка на основе вероятности</span>
        <span class="k">if</span> <span class="n">probability</span> <span class="o">&gt;</span> <span class="n">confidence_threshold</span><span class="p">:</span>
            <span class="c1"># Высокая уверенность - увеличиваем размер</span>
            <span class="n">position_size</span> <span class="o">=</span> <span class="n">base_size</span> <span class="o">*</span> <span class="p">(</span><span class="n">probability</span> <span class="o">/</span> <span class="n">confidence_threshold</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Низкая уверенность - уменьшаем размер</span>
            <span class="n">position_size</span> <span class="o">=</span> <span class="n">base_size</span> <span class="o">*</span> <span class="p">(</span><span class="n">probability</span> <span class="o">/</span> <span class="n">confidence_threshold</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>

        <span class="c1"># Ограничение максимального размера</span>
        <span class="n">position_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">position_size</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>  <span class="c1"># Максимум 20%</span>

        <span class="k">return</span> <span class="n">position_size</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dynamic_stop_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probability</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">,</span> <span class="n">volatility</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Динамический стоп-лосс на основе вероятности&quot;&quot;&quot;</span>

        <span class="c1"># Базовый стоп-лосс</span>
        <span class="n">base_stop</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="mf">0.95</span>  <span class="c1"># 5% стоп-лосс</span>

        <span class="c1"># Корректировка на основе вероятности</span>
        <span class="k">if</span> <span class="n">probability</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="c1"># Высокая уверенность - более широкий стоп-лосс</span>
            <span class="n">stop_loss</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.03</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">probability</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Низкая уверенность - более узкий стоп-лосс</span>
            <span class="n">stop_loss</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">probability</span><span class="p">))</span>

        <span class="c1"># Учет волатильности</span>
        <span class="n">volatility_adjustment</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">volatility</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">stop_loss</span> <span class="o">=</span> <span class="n">stop_loss</span> <span class="o">*</span> <span class="n">volatility_adjustment</span>

        <span class="k">return</span> <span class="n">stop_loss</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">probability_based_hedging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">market_conditions</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Хеджирование на основе вероятностей&quot;&quot;&quot;</span>

        <span class="c1"># Анализ распределения вероятностей</span>
        <span class="n">prob_distribution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_probability_distribution</span><span class="p">(</span><span class="n">probabilities</span><span class="p">)</span>

        <span class="c1"># Определение необходимости хеджирования</span>
        <span class="n">hedging_needed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_hedging_need</span><span class="p">(</span><span class="n">prob_distribution</span><span class="p">,</span> <span class="n">market_conditions</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">hedging_needed</span><span class="p">:</span>
            <span class="c1"># Расчет размера хеджа</span>
            <span class="n">hedge_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_hedge_size</span><span class="p">(</span><span class="n">prob_distribution</span><span class="p">)</span>

            <span class="c1"># Выбор инструментов хеджирования</span>
            <span class="n">hedge_instruments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_hedge_instruments</span><span class="p">(</span><span class="n">market_conditions</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;hedge_needed&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;hedge_size&#39;</span><span class="p">:</span> <span class="n">hedge_size</span><span class="p">,</span>
                <span class="s1">&#39;instruments&#39;</span><span class="p">:</span> <span class="n">hedge_instruments</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;hedge_needed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
</code></pre></div>

<h3 id="3_9">3. Ансамблирование на основе вероятностей</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ProbabilityEnsemble</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ансамблирование на основе вероятностей&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_methods</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight_calculation</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">weighted_ensemble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_probabilities</span><span class="p">,</span> <span class="n">model_weights</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Взвешенный ансамбль на основе вероятностей&quot;&quot;&quot;</span>

        <span class="c1"># Нормализация весов</span>
        <span class="n">normalized_weights</span> <span class="o">=</span> <span class="n">model_weights</span> <span class="o">/</span> <span class="n">model_weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Взвешенное объединение вероятностей</span>
        <span class="n">ensemble_probability</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span>
            <span class="n">model_probabilities</span><span class="p">,</span> 
            <span class="n">weights</span><span class="o">=</span><span class="n">normalized_weights</span><span class="p">,</span> 
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">ensemble_probability</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">confidence_weighted_ensemble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_probabilities</span><span class="p">,</span> <span class="n">model_confidences</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ансамбль с весами на основе уверенности&quot;&quot;&quot;</span>

        <span class="c1"># Расчет весов на основе уверенности</span>
        <span class="n">confidence_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_confidence_weights</span><span class="p">(</span><span class="n">model_confidences</span><span class="p">)</span>

        <span class="c1"># Взвешенное объединение</span>
        <span class="n">ensemble_probability</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span>
            <span class="n">model_probabilities</span><span class="p">,</span>
            <span class="n">weights</span><span class="o">=</span><span class="n">confidence_weights</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">ensemble_probability</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">bayesian_ensemble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_probabilities</span><span class="p">,</span> <span class="n">model_uncertainties</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Байесовский ансамбль&quot;&quot;&quot;</span>

        <span class="c1"># Байесовское объединение</span>
        <span class="n">bayesian_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_bayesian_weights</span><span class="p">(</span><span class="n">model_uncertainties</span><span class="p">)</span>

        <span class="c1"># Объединение с учетом неопределенности</span>
        <span class="n">ensemble_probability</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span>
            <span class="n">model_probabilities</span><span class="p">,</span>
            <span class="n">weights</span><span class="o">=</span><span class="n">bayesian_weights</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

        <span class="c1"># Добавление неопределенности</span>
        <span class="n">ensemble_uncertainty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_ensemble_uncertainty</span><span class="p">(</span>
            <span class="n">model_probabilities</span><span class="p">,</span> 
            <span class="n">model_uncertainties</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="n">ensemble_probability</span><span class="p">,</span>
            <span class="s1">&#39;uncertainty&#39;</span><span class="p">:</span> <span class="n">ensemble_uncertainty</span>
        <span class="p">}</span>
</code></pre></div>

<h3 id="4_4">4. Мониторинг дрифта вероятностей</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ProbabilityDriftMonitor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Мониторинг дрифта вероятностей&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drift_detectors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline_distribution</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">detect_probability_drift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_probabilities</span><span class="p">,</span> <span class="n">baseline_probabilities</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Обнаружение дрифта вероятностей&quot;&quot;&quot;</span>

        <span class="c1"># Статистические тесты</span>
        <span class="n">statistical_drift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistical_drift_test</span><span class="p">(</span>
            <span class="n">current_probabilities</span><span class="p">,</span> 
            <span class="n">baseline_probabilities</span>
        <span class="p">)</span>

        <span class="c1"># Тест Колмогорова-Смирнова</span>
        <span class="n">ks_drift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ks_drift_test</span><span class="p">(</span>
            <span class="n">current_probabilities</span><span class="p">,</span> 
            <span class="n">baseline_probabilities</span>
        <span class="p">)</span>

        <span class="c1"># Тест Вассерштейна</span>
        <span class="n">wasserstein_drift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wasserstein_drift_test</span><span class="p">(</span>
            <span class="n">current_probabilities</span><span class="p">,</span> 
            <span class="n">baseline_probabilities</span>
        <span class="p">)</span>

        <span class="c1"># Объединение результатов</span>
        <span class="n">drift_detected</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span>
            <span class="n">statistical_drift</span><span class="p">,</span>
            <span class="n">ks_drift</span><span class="p">,</span>
            <span class="n">wasserstein_drift</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;drift_detected&#39;</span><span class="p">:</span> <span class="n">drift_detected</span><span class="p">,</span>
            <span class="s1">&#39;statistical&#39;</span><span class="p">:</span> <span class="n">statistical_drift</span><span class="p">,</span>
            <span class="s1">&#39;ks&#39;</span><span class="p">:</span> <span class="n">ks_drift</span><span class="p">,</span>
            <span class="s1">&#39;wasserstein&#39;</span><span class="p">:</span> <span class="n">wasserstein_drift</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">statistical_drift_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">baseline</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Статистический тест дрифта&quot;&quot;&quot;</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>

        <span class="c1"># t-тест для средних</span>
        <span class="n">t_stat</span><span class="p">,</span> <span class="n">t_pvalue</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">baseline</span><span class="p">)</span>

        <span class="c1"># Тест Манна-Уитни</span>
        <span class="n">u_stat</span><span class="p">,</span> <span class="n">u_pvalue</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">baseline</span><span class="p">)</span>

        <span class="c1"># Критерий дрифта</span>
        <span class="n">drift_threshold</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="n">drift_detected</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_pvalue</span> <span class="o">&lt;</span> <span class="n">drift_threshold</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">u_pvalue</span> <span class="o">&lt;</span> <span class="n">drift_threshold</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">drift_detected</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ks_drift_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">baseline</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Тест Колмогорова-Смирнова&quot;&quot;&quot;</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>

        <span class="c1"># KS тест</span>
        <span class="n">ks_stat</span><span class="p">,</span> <span class="n">ks_pvalue</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ks_2samp</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">baseline</span><span class="p">)</span>

        <span class="c1"># Критерий дрифта</span>
        <span class="n">drift_detected</span> <span class="o">=</span> <span class="n">ks_pvalue</span> <span class="o">&lt;</span> <span class="mf">0.05</span>

        <span class="k">return</span> <span class="n">drift_detected</span>
</code></pre></div>

<h2 id="_385">Слабые стороны использования вероятностей</h2>
<h3 id="1_32">1. Переобучение на вероятностях</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ProbabilityOverfittingPrevention</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Предотвращение переобучения на вероятностях&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regularization_methods</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">prevent_overfitting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Предотвращение переобучения&quot;&quot;&quot;</span>

        <span class="c1"># L1 регуляризация</span>
        <span class="n">l1_regularized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_regularization</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">)</span>

        <span class="c1"># L2 регуляризация</span>
        <span class="n">l2_regularized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2_regularization</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">)</span>

        <span class="c1"># Dropout для вероятностей</span>
        <span class="n">dropout_regularized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout_regularization</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;l1&#39;</span><span class="p">:</span> <span class="n">l1_regularized</span><span class="p">,</span>
            <span class="s1">&#39;l2&#39;</span><span class="p">:</span> <span class="n">l2_regularized</span><span class="p">,</span>
            <span class="s1">&#39;dropout&#39;</span><span class="p">:</span> <span class="n">dropout_regularized</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">l1_regularization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;L1 регуляризация&quot;&quot;&quot;</span>

        <span class="c1"># Добавление L1 штрафа</span>
        <span class="n">l1_penalty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">probabilities</span><span class="p">))</span>

        <span class="c1"># Обновление вероятностей</span>
        <span class="n">regularized_probs</span> <span class="o">=</span> <span class="n">probabilities</span> <span class="o">-</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">l1_penalty</span>

        <span class="k">return</span> <span class="n">regularized_probs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dropout_regularization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dropout регуляризация&quot;&quot;&quot;</span>

        <span class="c1"># Случайное обнуление части вероятностей</span>
        <span class="n">dropout_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">probabilities</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">regularized_probs</span> <span class="o">=</span> <span class="n">probabilities</span> <span class="o">*</span> <span class="n">dropout_mask</span>

        <span class="k">return</span> <span class="n">regularized_probs</span>
</code></pre></div>

<h3 id="2_29">2. Неправильная интерпретация вероятностей</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ProbabilityInterpretation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Правильная интерпретация вероятностей&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpretation_guidelines</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">interpret_probabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Правильная интерпретация вероятностей&quot;&quot;&quot;</span>

        <span class="c1"># Анализ контекста</span>
        <span class="n">context_analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

        <span class="c1"># Корректировка интерпретации</span>
        <span class="n">corrected_interpretation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">correct_interpretation</span><span class="p">(</span>
            <span class="n">probabilities</span><span class="p">,</span> 
            <span class="n">context_analysis</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">corrected_interpretation</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Анализ контекста для интерпретации&quot;&quot;&quot;</span>

        <span class="c1"># Рыночные условия</span>
        <span class="n">market_conditions</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;market_conditions&#39;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1"># Временные факторы</span>
        <span class="n">temporal_factors</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;temporal_factors&#39;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1"># Внешние факторы</span>
        <span class="n">external_factors</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;external_factors&#39;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;market&#39;</span><span class="p">:</span> <span class="n">market_conditions</span><span class="p">,</span>
            <span class="s1">&#39;temporal&#39;</span><span class="p">:</span> <span class="n">temporal_factors</span><span class="p">,</span>
            <span class="s1">&#39;external&#39;</span><span class="p">:</span> <span class="n">external_factors</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">correct_interpretation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">context_analysis</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Корректировка интерпретации&quot;&quot;&quot;</span>

        <span class="c1"># Корректировка на основе рыночных условий</span>
        <span class="n">market_corrected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">market_correction</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="n">context_analysis</span><span class="p">[</span><span class="s1">&#39;market&#39;</span><span class="p">])</span>

        <span class="c1"># Корректировка на основе временных факторов</span>
        <span class="n">temporal_corrected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporal_correction</span><span class="p">(</span><span class="n">market_corrected</span><span class="p">,</span> <span class="n">context_analysis</span><span class="p">[</span><span class="s1">&#39;temporal&#39;</span><span class="p">])</span>

        <span class="c1"># Корректировка на основе внешних факторов</span>
        <span class="n">external_corrected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_correction</span><span class="p">(</span><span class="n">temporal_corrected</span><span class="p">,</span> <span class="n">context_analysis</span><span class="p">[</span><span class="s1">&#39;external&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">external_corrected</span>
</code></pre></div>

<h3 id="3_10">3. Проблемы с калибровкой</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CalibrationIssues</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Проблемы с калибровкой вероятностей&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calibration_problems</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">identify_calibration_issues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Идентификация проблем калибровки&quot;&quot;&quot;</span>

        <span class="c1"># Анализ калибровочной кривой</span>
        <span class="n">calibration_curve</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_calibration_curve</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">)</span>

        <span class="c1"># Анализ надежности</span>
        <span class="n">reliability_analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_reliability</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">)</span>

        <span class="c1"># Анализ резолюции</span>
        <span class="n">resolution_analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_resolution</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;calibration_curve&#39;</span><span class="p">:</span> <span class="n">calibration_curve</span><span class="p">,</span>
            <span class="s1">&#39;reliability&#39;</span><span class="p">:</span> <span class="n">reliability_analysis</span><span class="p">,</span>
            <span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="n">resolution_analysis</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_calibration_curve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Анализ калибровочной кривой&quot;&quot;&quot;</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.calibration</span><span class="w"> </span><span class="kn">import</span> <span class="n">calibration_curve</span>

        <span class="c1"># Построение калибровочной кривой</span>
        <span class="n">fraction_of_positives</span><span class="p">,</span> <span class="n">mean_predicted_value</span> <span class="o">=</span> <span class="n">calibration_curve</span><span class="p">(</span>
            <span class="n">true_labels</span><span class="p">,</span> 
            <span class="n">probabilities</span><span class="p">,</span> 
            <span class="n">n_bins</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">)</span>

        <span class="c1"># Анализ отклонений</span>
        <span class="n">deviations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fraction_of_positives</span> <span class="o">-</span> <span class="n">mean_predicted_value</span><span class="p">)</span>

        <span class="c1"># Критерий плохой калибровки</span>
        <span class="n">bad_calibration</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">deviations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.1</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;curve&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">fraction_of_positives</span><span class="p">,</span> <span class="n">mean_predicted_value</span><span class="p">),</span>
            <span class="s1">&#39;deviations&#39;</span><span class="p">:</span> <span class="n">deviations</span><span class="p">,</span>
            <span class="s1">&#39;bad_calibration&#39;</span><span class="p">:</span> <span class="n">bad_calibration</span>
        <span class="p">}</span>
</code></pre></div>

<h2 id="_386">Лучшие практики использования вероятностей</h2>
<h3 id="1_33">1. Валидация вероятностей</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ProbabilityValidation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Валидация вероятностей&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_methods</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_probabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Валидация вероятностей&quot;&quot;&quot;</span>

        <span class="c1"># Кросс-валидация</span>
        <span class="n">cv_validation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_validation</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">)</span>

        <span class="c1"># Временная валидация</span>
        <span class="n">temporal_validation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporal_validation</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">)</span>

        <span class="c1"># Стохастическая валидация</span>
        <span class="n">stochastic_validation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stochastic_validation</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;cv&#39;</span><span class="p">:</span> <span class="n">cv_validation</span><span class="p">,</span>
            <span class="s1">&#39;temporal&#39;</span><span class="p">:</span> <span class="n">temporal_validation</span><span class="p">,</span>
            <span class="s1">&#39;stochastic&#39;</span><span class="p">:</span> <span class="n">stochastic_validation</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cross_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Кросс-валидация вероятностей&quot;&quot;&quot;</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">cross_val_score</span>

        <span class="c1"># Кросс-валидация с калибровкой</span>
        <span class="n">cv_scores</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span>
            <span class="n">probabilities</span><span class="p">,</span> 
            <span class="n">true_labels</span><span class="p">,</span> 
            <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
            <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;neg_log_loss&#39;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;scores&#39;</span><span class="p">:</span> <span class="n">cv_scores</span><span class="p">,</span>
            <span class="s1">&#39;mean_score&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cv_scores</span><span class="p">),</span>
            <span class="s1">&#39;std_score&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">cv_scores</span><span class="p">)</span>
        <span class="p">}</span>
</code></pre></div>

<h3 id="2_30">2. Мониторинг производительности</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ProbabilityMonitoring</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Мониторинг производительности вероятностей&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitoring_metrics</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">monitor_performance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Мониторинг производительности&quot;&quot;&quot;</span>

        <span class="c1"># Логарифмическая потеря</span>
        <span class="n">log_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_log_loss</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">)</span>

        <span class="c1"># Brier Score</span>
        <span class="n">brier_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_brier_score</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">)</span>

        <span class="c1"># Калибровочная ошибка</span>
        <span class="n">calibration_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_calibration_error</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;log_loss&#39;</span><span class="p">:</span> <span class="n">log_loss</span><span class="p">,</span>
            <span class="s1">&#39;brier_score&#39;</span><span class="p">:</span> <span class="n">brier_score</span><span class="p">,</span>
            <span class="s1">&#39;calibration_error&#39;</span><span class="p">:</span> <span class="n">calibration_error</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_log_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Расчет логарифмической потери&quot;&quot;&quot;</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">log_loss</span>

        <span class="c1"># Логарифмическая потеря</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">log_loss</span><span class="p">(</span><span class="n">true_labels</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">loss</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_brier_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Расчет Brier Score&quot;&quot;&quot;</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">brier_score_loss</span>

        <span class="c1"># Brier Score</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">brier_score_loss</span><span class="p">(</span><span class="n">true_labels</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">score</span>
</code></pre></div>

<h2 id="_387">Практические примеры</h2>
<h3 id="1_34">1. Торговая система на вероятностях</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ProbabilityTradingSystem</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Торговая система на основе вероятностей&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">probability_thresholds</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk_management</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_trading_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">market_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Генерация торговых сигналов&quot;&quot;&quot;</span>

        <span class="c1"># Анализ вероятностей</span>
        <span class="n">prob_analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_probabilities</span><span class="p">(</span><span class="n">probabilities</span><span class="p">)</span>

        <span class="c1"># Генерация сигналов</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_signals</span><span class="p">(</span><span class="n">prob_analysis</span><span class="p">,</span> <span class="n">market_data</span><span class="p">)</span>

        <span class="c1"># Управление рисками</span>
        <span class="n">risk_adjusted_signals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjust_for_risk</span><span class="p">(</span><span class="n">signals</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">risk_adjusted_signals</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_probabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Анализ вероятностей&quot;&quot;&quot;</span>

        <span class="c1"># Статистические характеристики</span>
        <span class="n">mean_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">probabilities</span><span class="p">)</span>
        <span class="n">std_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">probabilities</span><span class="p">)</span>
        <span class="n">max_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">probabilities</span><span class="p">)</span>
        <span class="n">min_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">probabilities</span><span class="p">)</span>

        <span class="c1"># Распределение вероятностей</span>
        <span class="n">prob_distribution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_distribution</span><span class="p">(</span><span class="n">probabilities</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">mean_prob</span><span class="p">,</span>
            <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">std_prob</span><span class="p">,</span>
            <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="n">max_prob</span><span class="p">,</span>
            <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="n">min_prob</span><span class="p">,</span>
            <span class="s1">&#39;distribution&#39;</span><span class="p">:</span> <span class="n">prob_distribution</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prob_analysis</span><span class="p">,</span> <span class="n">market_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Генерация сигналов&quot;&quot;&quot;</span>

        <span class="n">signals</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">prob</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prob_analysis</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">prob</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
                <span class="c1"># Высокая уверенность - сильный сигнал</span>
                <span class="n">signal</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;BUY&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="s1">&#39;STRONG&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="n">prob</span><span class="p">,</span>
                    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">market_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="k">elif</span> <span class="n">prob</span> <span class="o">&gt;</span> <span class="mf">0.6</span><span class="p">:</span>
                <span class="c1"># Средняя уверенность - умеренный сигнал</span>
                <span class="n">signal</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;BUY&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="s1">&#39;MODERATE&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="n">prob</span><span class="p">,</span>
                    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">market_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="k">elif</span> <span class="n">prob</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="p">:</span>
                <span class="c1"># Низкая уверенность - сигнал продажи</span>
                <span class="n">signal</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;SELL&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="s1">&#39;STRONG&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">prob</span><span class="p">,</span>
                    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">market_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Неопределенность - отсутствие сигнала</span>
                <span class="n">signal</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;HOLD&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="s1">&#39;NONE&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
                    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">market_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
                <span class="p">}</span>

            <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">signals</span>
</code></pre></div>

<h3 id="2_31">2. Портфельное управление</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ProbabilityPortfolioManagement</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Управление портфелем на основе вероятностей&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_weights</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk_budget</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">optimize_portfolio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset_probabilities</span><span class="p">,</span> <span class="n">risk_budget</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Оптимизация портфеля&quot;&quot;&quot;</span>

        <span class="c1"># Расчет весов на основе вероятностей</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_weights</span><span class="p">(</span><span class="n">asset_probabilities</span><span class="p">)</span>

        <span class="c1"># Корректировка на риск</span>
        <span class="n">risk_adjusted_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjust_for_risk</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">risk_budget</span><span class="p">)</span>

        <span class="c1"># Оптимизация распределения</span>
        <span class="n">optimized_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize_allocation</span><span class="p">(</span><span class="n">risk_adjusted_weights</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">optimized_weights</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset_probabilities</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Расчет весов на основе вероятностей&quot;&quot;&quot;</span>

        <span class="c1"># Нормализация вероятностей</span>
        <span class="n">normalized_probs</span> <span class="o">=</span> <span class="n">asset_probabilities</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">asset_probabilities</span><span class="p">)</span>

        <span class="c1"># Корректировка на дисперсию</span>
        <span class="n">variance_adjusted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjust_for_variance</span><span class="p">(</span><span class="n">normalized_probs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">variance_adjusted</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">adjust_for_risk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">risk_budget</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Корректировка на риск&quot;&quot;&quot;</span>

        <span class="c1"># Расчет риска портфеля</span>
        <span class="n">portfolio_risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_portfolio_risk</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

        <span class="c1"># Корректировка весов</span>
        <span class="k">if</span> <span class="n">portfolio_risk</span> <span class="o">&gt;</span> <span class="n">risk_budget</span><span class="p">:</span>
            <span class="c1"># Уменьшение весов</span>
            <span class="n">adjustment_factor</span> <span class="o">=</span> <span class="n">risk_budget</span> <span class="o">/</span> <span class="n">portfolio_risk</span>
            <span class="n">adjusted_weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">*</span> <span class="n">adjustment_factor</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">adjusted_weights</span> <span class="o">=</span> <span class="n">weights</span>

        <span class="k">return</span> <span class="n">adjusted_weights</span>
</code></pre></div>

<h2 id="_388">Заключение</h2>
<p>Правильное использование вероятностей - это ключ к созданию робастных и прибыльных ML-моделей. Понимание сильных и слабых сторон позволяет создавать более эффективные торговые системы.</p>
<h3 id="_389">Ключевые принципы:</h3>
<ol>
<li><strong>Калибровка</strong> - всегда калибруйте вероятности</li>
<li><strong>Валидация</strong> - проверяйте качество вероятностей</li>
<li><strong>Мониторинг</strong> - отслеживайте дрифт вероятностей</li>
<li><strong>Интерпретация</strong> - правильно интерпретируйте результаты</li>
<li><strong>Риск-менеджмент</strong> - используйте вероятности для управления рисками</li>
</ol>
<p>Следуя этим принципам, вы сможете создавать более точные и прибыльные торговые системы.</p>
<hr />
<h1 id="-_14">Мониторинг торгового бота - Лучшие практики</h1>
<p><strong>Автор:</strong> NeoZorK (Shcherbyna Rostyslav)<br />
<strong>Дата:</strong> 2025<br />
<strong>Местоположение:</strong> Ukraine, Zaporizhzhya<br />
<strong>Версия:</strong> 1.0  </p>
<h2 id="_390">Почему мониторинг торгового бота критически важен</h2>
<p><strong>Почему 90% торговых ботов теряют деньги без правильного мониторинга?</strong> Потому что они работают в слепую, не понимая, что происходит с их системой. Это как вождение автомобиля без приборной панели.</p>
<h3 id="_391">Проблемы без мониторинга</h3>
<ul>
<li><strong>Слепая торговля</strong>: Не знают, что происходит с ботом</li>
<li><strong>Позднее обнаружение проблем</strong>: Узнают о проблемах, когда уже поздно</li>
<li><strong>Потеря денег</strong>: Бот может торговать против тренда часами</li>
<li><strong>Стресс и тревога</strong>: Постоянное беспокойство о работе бота</li>
</ul>
<h3 id="_392">Преимущества правильного мониторинга</h3>
<ul>
<li><strong>Полный контроль</strong>: Понимают, что происходит с ботом</li>
<li><strong>Быстрое обнаружение проблем</strong>: Решают проблемы до потери денег</li>
<li><strong>Оптимизация производительности</strong>: Постоянно улучшают работу бота</li>
<li><strong>Спокойствие</strong>: Уверены в работе системы</li>
</ul>
<h2 id="_393">Введение</h2>
<p><strong>Почему мониторинг - это глаза и уши торгового бота?</strong> Потому что без него вы не знаете, что происходит с вашей системой, и не можете принимать правильные решения.</p>
<p>Мониторинг торгового бота - это критически важный аспект поддержания стабильной и прибыльной торговой системы. Этот раздел посвящен лучшим практикам мониторинга, которые помогут вам быстро выявлять проблемы, оптимизировать производительность и обеспечивать непрерывную работу торгового бота.</p>
<h2 id="_394">Архитектура системы мониторинга</h2>
<p><strong>Почему архитектура мониторинга критически важна?</strong> Потому что неправильная архитектура может привести к пропуску критических проблем и потере денег.</p>
<h3 id="1_35">1. Компоненты системы мониторинга</h3>
<p><strong>Почему нужны все компоненты мониторинга?</strong> Потому что каждый компонент решает свою задачу, а вместе они создают полную картину работы бота.</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TradingBotMonitoringSystem</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Система мониторинга торгового бота - комплексное решение&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Сбор метрик - что происходит с ботом</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_collector</span> <span class="o">=</span> <span class="n">MetricsCollector</span><span class="p">()</span>
        <span class="c1"># Управление уведомлениями - когда что-то идет не так</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span> <span class="o">=</span> <span class="n">AlertManager</span><span class="p">()</span>
        <span class="c1"># Дашборд - визуализация данных</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dashboard</span> <span class="o">=</span> <span class="n">MonitoringDashboard</span><span class="p">()</span>
        <span class="c1"># Анализ логов - поиск проблем</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_analyzer</span> <span class="o">=</span> <span class="n">LogAnalyzer</span><span class="p">()</span>
        <span class="c1"># Отслеживание производительности - как работает бот</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance_tracker</span> <span class="o">=</span> <span class="n">PerformanceTracker</span><span class="p">()</span>
        <span class="c1"># Проверка здоровья - все ли в порядке</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health_checker</span> <span class="o">=</span> <span class="n">HealthChecker</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">start_monitoring</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Запуск системы мониторинга&quot;&quot;&quot;</span>

        <span class="c1"># Инициализация компонентов</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_collector</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dashboard</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_analyzer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance_tracker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health_checker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Система мониторинга запущена&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stop_monitoring</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Остановка системы мониторинга&quot;&quot;&quot;</span>

        <span class="c1"># Остановка компонентов</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_collector</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dashboard</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_analyzer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance_tracker</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health_checker</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⏹️ Система мониторинга остановлена&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="2_32">2. Сбор метрик</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MetricsCollector</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Сборщик метрик торгового бота&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection_interval</span> <span class="o">=</span> <span class="mi">60</span>  <span class="c1"># секунд</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_storage</span> <span class="o">=</span> <span class="n">MetricsStorage</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">collect_trading_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bot_state</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Сбор торговых метрик&quot;&quot;&quot;</span>

        <span class="n">trading_metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># Производительность</span>
            <span class="s1">&#39;total_trades&#39;</span><span class="p">:</span> <span class="n">bot_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_trades&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;winning_trades&#39;</span><span class="p">:</span> <span class="n">bot_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;winning_trades&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;losing_trades&#39;</span><span class="p">:</span> <span class="n">bot_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;losing_trades&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_win_rate</span><span class="p">(</span><span class="n">bot_state</span><span class="p">),</span>
            <span class="s1">&#39;profit_loss&#39;</span><span class="p">:</span> <span class="n">bot_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;profit_loss&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">bot_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_sharpe_ratio</span><span class="p">(</span><span class="n">bot_state</span><span class="p">),</span>

            <span class="c1"># Активность</span>
            <span class="s1">&#39;trades_per_hour&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_trades_per_hour</span><span class="p">(</span><span class="n">bot_state</span><span class="p">),</span>
            <span class="s1">&#39;last_trade_time&#39;</span><span class="p">:</span> <span class="n">bot_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_trade_time&#39;</span><span class="p">),</span>
            <span class="s1">&#39;active_positions&#39;</span><span class="p">:</span> <span class="n">bot_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;active_positions&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;pending_orders&#39;</span><span class="p">:</span> <span class="n">bot_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pending_orders&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

            <span class="c1"># Риски</span>
            <span class="s1">&#39;current_exposure&#39;</span><span class="p">:</span> <span class="n">bot_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_exposure&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;risk_utilization&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_risk_utilization</span><span class="p">(</span><span class="n">bot_state</span><span class="p">),</span>
            <span class="s1">&#39;var_95&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_var_95</span><span class="p">(</span><span class="n">bot_state</span><span class="p">),</span>
            <span class="s1">&#39;expected_shortfall&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_expected_shortfall</span><span class="p">(</span><span class="n">bot_state</span><span class="p">),</span>

            <span class="c1"># Технические</span>
            <span class="s1">&#39;cpu_usage&#39;</span><span class="p">:</span> <span class="n">bot_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cpu_usage&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;memory_usage&#39;</span><span class="p">:</span> <span class="n">bot_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;memory_usage&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;disk_usage&#39;</span><span class="p">:</span> <span class="n">bot_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;disk_usage&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;network_latency&#39;</span><span class="p">:</span> <span class="n">bot_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;network_latency&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;api_calls_per_minute&#39;</span><span class="p">:</span> <span class="n">bot_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;api_calls_per_minute&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;error_rate&#39;</span><span class="p">:</span> <span class="n">bot_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error_rate&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

            <span class="c1"># Временные метки</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;uptime&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_uptime</span><span class="p">(</span><span class="n">bot_state</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">trading_metrics</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">collect_model_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_state</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Сбор метрик ML-модели&quot;&quot;&quot;</span>

        <span class="n">model_metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># Точность модели</span>
            <span class="s1">&#39;model_accuracy&#39;</span><span class="p">:</span> <span class="n">model_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;model_precision&#39;</span><span class="p">:</span> <span class="n">model_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;model_recall&#39;</span><span class="p">:</span> <span class="n">model_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;recall&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;model_f1_score&#39;</span><span class="p">:</span> <span class="n">model_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;f1_score&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;model_auc&#39;</span><span class="p">:</span> <span class="n">model_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;auc&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

            <span class="c1"># Прогнозирование</span>
            <span class="s1">&#39;prediction_confidence&#39;</span><span class="p">:</span> <span class="n">model_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prediction_confidence&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;prediction_uncertainty&#39;</span><span class="p">:</span> <span class="n">model_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prediction_uncertainty&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;last_prediction_time&#39;</span><span class="p">:</span> <span class="n">model_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_prediction_time&#39;</span><span class="p">),</span>
            <span class="s1">&#39;predictions_per_hour&#39;</span><span class="p">:</span> <span class="n">model_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;predictions_per_hour&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

            <span class="c1"># Дрифт модели</span>
            <span class="s1">&#39;model_drift_detected&#39;</span><span class="p">:</span> <span class="n">model_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;drift_detected&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="s1">&#39;drift_score&#39;</span><span class="p">:</span> <span class="n">model_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;drift_score&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;last_retraining&#39;</span><span class="p">:</span> <span class="n">model_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_retraining&#39;</span><span class="p">),</span>
            <span class="s1">&#39;retraining_frequency&#39;</span><span class="p">:</span> <span class="n">model_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;retraining_frequency&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

            <span class="c1"># Качество данных</span>
            <span class="s1">&#39;data_quality_score&#39;</span><span class="p">:</span> <span class="n">model_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data_quality_score&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;missing_data_rate&#39;</span><span class="p">:</span> <span class="n">model_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;missing_data_rate&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;outlier_rate&#39;</span><span class="p">:</span> <span class="n">model_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;outlier_rate&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;data_freshness&#39;</span><span class="p">:</span> <span class="n">model_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data_freshness&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

            <span class="c1"># Временные метки</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">model_metrics</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">collect_market_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">market_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Сбор рыночных метрик&quot;&quot;&quot;</span>

        <span class="n">market_metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># Рыночные условия</span>
            <span class="s1">&#39;market_volatility&#39;</span><span class="p">:</span> <span class="n">market_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;volatility&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;market_trend&#39;</span><span class="p">:</span> <span class="n">market_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;trend&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">),</span>
            <span class="s1">&#39;market_regime&#39;</span><span class="p">:</span> <span class="n">market_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;regime&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">),</span>
            <span class="s1">&#39;liquidity_score&#39;</span><span class="p">:</span> <span class="n">market_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;liquidity_score&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

            <span class="c1"># Ценовые метрики</span>
            <span class="s1">&#39;price_change_1h&#39;</span><span class="p">:</span> <span class="n">market_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price_change_1h&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;price_change_24h&#39;</span><span class="p">:</span> <span class="n">market_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price_change_24h&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;volume_24h&#39;</span><span class="p">:</span> <span class="n">market_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;volume_24h&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;volume_change_24h&#39;</span><span class="p">:</span> <span class="n">market_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;volume_change_24h&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

            <span class="c1"># Технические индикаторы</span>
            <span class="s1">&#39;rsi&#39;</span><span class="p">:</span> <span class="n">market_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rsi&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
            <span class="s1">&#39;macd&#39;</span><span class="p">:</span> <span class="n">market_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;macd&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;bollinger_position&#39;</span><span class="p">:</span> <span class="n">market_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bollinger_position&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
            <span class="s1">&#39;support_resistance_strength&#39;</span><span class="p">:</span> <span class="n">market_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;support_resistance_strength&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

            <span class="c1"># Временные метки</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">market_metrics</span>
</code></pre></div>

<h3 id="3_11">3. Система алертов</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AlertManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Менеджер алертов&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_rules</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_channels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_cooldown</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">setup_alert_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Настройка правил алертов&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alert_rules</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># Критические алерты</span>
            <span class="s1">&#39;critical&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;bot_down&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;condition&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">metrics</span><span class="p">:</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uptime&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;🚨 КРИТИЧНО: Торговый бот остановлен!&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;channels&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;sms&#39;</span><span class="p">,</span> <span class="s1">&#39;telegram&#39;</span><span class="p">,</span> <span class="s1">&#39;slack&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;cooldown&#39;</span><span class="p">:</span> <span class="mi">300</span>  <span class="c1"># 5 минут</span>
                <span class="p">},</span>
                <span class="s1">&#39;high_drawdown&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;condition&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">metrics</span><span class="p">:</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">,</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;🚨 КРИТИЧНО: Высокая просадка </span><span class="si">{max_drawdown:.2%}</span><span class="s1">!&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;channels&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;sms&#39;</span><span class="p">,</span> <span class="s1">&#39;telegram&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;cooldown&#39;</span><span class="p">:</span> <span class="mi">600</span>  <span class="c1"># 10 минут</span>
                <span class="p">},</span>
                <span class="s1">&#39;api_error_rate&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;condition&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">metrics</span><span class="p">:</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error_rate&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">,</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;🚨 КРИТИЧНО: Высокий уровень ошибок API </span><span class="si">{error_rate:.2%}</span><span class="s1">!&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;channels&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;telegram&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;cooldown&#39;</span><span class="p">:</span> <span class="mi">300</span>
                <span class="p">}</span>
            <span class="p">},</span>

            <span class="c1"># Предупреждения</span>
            <span class="s1">&#39;warning&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;low_win_rate&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;condition&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">metrics</span><span class="p">:</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;win_rate&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.4</span><span class="p">,</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;⚠️ ПРЕДУПРЕЖДЕНИЕ: Низкий процент выигрышных сделок </span><span class="si">{win_rate:.2%}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;channels&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;telegram&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;cooldown&#39;</span><span class="p">:</span> <span class="mi">1800</span>  <span class="c1"># 30 минут</span>
                <span class="p">},</span>
                <span class="s1">&#39;model_drift&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;condition&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">metrics</span><span class="p">:</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_drift_detected&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;⚠️ ПРЕДУПРЕЖДЕНИЕ: Обнаружен дрифт модели!&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;channels&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;telegram&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;cooldown&#39;</span><span class="p">:</span> <span class="mi">3600</span>  <span class="c1"># 1 час</span>
                <span class="p">},</span>
                <span class="s1">&#39;high_latency&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;condition&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">metrics</span><span class="p">:</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;network_latency&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">,</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;⚠️ ПРЕДУПРЕЖДЕНИЕ: Высокая задержка сети </span><span class="si">{latency}</span><span class="s1">ms&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;channels&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;telegram&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;cooldown&#39;</span><span class="p">:</span> <span class="mi">900</span>  <span class="c1"># 15 минут</span>
                <span class="p">}</span>
            <span class="p">},</span>

            <span class="c1"># Информационные</span>
            <span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;daily_summary&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;condition&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">metrics</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_daily_summary_time</span><span class="p">(),</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;📊 Ежедневный отчет: P&amp;L: </span><span class="si">{profit_loss:.2f}</span><span class="s1">, Сделки: </span><span class="si">{total_trades}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;channels&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;telegram&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;cooldown&#39;</span><span class="p">:</span> <span class="mi">86400</span>  <span class="c1"># 24 часа</span>
                <span class="p">},</span>
                <span class="s1">&#39;milestone_reached&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;condition&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">metrics</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_milestone_reached</span><span class="p">(</span><span class="n">metrics</span><span class="p">),</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;🎉 ДОСТИЖЕНИЕ: </span><span class="si">{milestone_message}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;channels&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;telegram&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;cooldown&#39;</span><span class="p">:</span> <span class="mi">3600</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_alerts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Проверка алертов&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">severity</span><span class="p">,</span> <span class="n">rules</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alert_rules</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">rule_name</span><span class="p">,</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Проверка условия</span>
                    <span class="k">if</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">](</span><span class="n">metrics</span><span class="p">):</span>
                        <span class="c1"># Проверка кулдауна</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_cooldown_active</span><span class="p">(</span><span class="n">rule_name</span><span class="p">):</span>
                            <span class="k">continue</span>

                        <span class="c1"># Отправка алерта</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">send_alert</span><span class="p">(</span><span class="n">rule_name</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">metrics</span><span class="p">)</span>

                        <span class="c1"># Установка кулдауна</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">set_cooldown</span><span class="p">(</span><span class="n">rule_name</span><span class="p">,</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;cooldown&#39;</span><span class="p">])</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ошибка при проверке алерта </span><span class="si">{</span><span class="n">rule_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">send_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule_name</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">metrics</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Отправка алерта&quot;&quot;&quot;</span>

        <span class="c1"># Форматирование сообщения</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">metrics</span><span class="p">)</span>

        <span class="c1"># Отправка по каналам</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_to_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">metrics</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ошибка отправки в </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Сохранение в историю</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;rule&#39;</span><span class="p">:</span> <span class="n">rule_name</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
            <span class="s1">&#39;metrics&#39;</span><span class="p">:</span> <span class="n">metrics</span>
        <span class="p">})</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">send_to_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">metrics</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Отправка в конкретный канал&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">channel</span> <span class="o">==</span> <span class="s1">&#39;email&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_email_alert</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">metrics</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">channel</span> <span class="o">==</span> <span class="s1">&#39;sms&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_sms_alert</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">metrics</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">channel</span> <span class="o">==</span> <span class="s1">&#39;telegram&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_telegram_alert</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">metrics</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">channel</span> <span class="o">==</span> <span class="s1">&#39;slack&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_slack_alert</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">metrics</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">send_telegram_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">metrics</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Отправка алерта в Telegram&quot;&quot;&quot;</span>

        <span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

        <span class="n">bot_token</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;TELEGRAM_BOT_TOKEN&#39;</span><span class="p">)</span>
        <span class="n">chat_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;TELEGRAM_CHAT_ID&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">bot_token</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">chat_id</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://api.telegram.org/bot</span><span class="si">{</span><span class="n">bot_token</span><span class="si">}</span><span class="s2">/sendMessage&quot;</span>

        <span class="c1"># Форматирование сообщения для Telegram</span>
        <span class="n">formatted_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;🤖 *Торговый Бот*</span><span class="se">\n\n</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="n">formatted_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;⏰ Время: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">formatted_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;📊 P&amp;L: </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;profit_loss&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">formatted_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;📈 Сделки: </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_trades&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">formatted_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;🎯 Win Rate: </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;win_rate&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;chat_id&#39;</span><span class="p">:</span> <span class="n">chat_id</span><span class="p">,</span>
            <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">formatted_message</span><span class="p">,</span>
            <span class="s1">&#39;parse_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;Markdown&#39;</span>
        <span class="p">}</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
</code></pre></div>

<h3 id="4_5">4. Дашборд мониторинга</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MonitoringDashboard</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Дашборд мониторинга&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dashboard_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widgets</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_dashboard</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Создание дашборда&quot;&quot;&quot;</span>

        <span class="c1"># Основные виджеты</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widgets</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;overview&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_overview_widget</span><span class="p">(),</span>
            <span class="s1">&#39;performance&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_performance_widget</span><span class="p">(),</span>
            <span class="s1">&#39;trading_activity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_trading_activity_widget</span><span class="p">(),</span>
            <span class="s1">&#39;risk_metrics&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_risk_metrics_widget</span><span class="p">(),</span>
            <span class="s1">&#39;system_health&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_system_health_widget</span><span class="p">(),</span>
            <span class="s1">&#39;model_metrics&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_model_metrics_widget</span><span class="p">(),</span>
            <span class="s1">&#39;market_conditions&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_market_conditions_widget</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">widgets</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_overview_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Виджет обзора&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;overview&#39;</span><span class="p">,</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Общий обзор&#39;</span><span class="p">,</span>
            <span class="s1">&#39;metrics&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;P&amp;L&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;profit_loss&#39;</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;currency&#39;</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Win Rate&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;win_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;percentage&#39;</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Активных позиций&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;active_positions&#39;</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;number&#39;</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Время работы&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;uptime&#39;</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;duration&#39;</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Статус&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;status&#39;</span><span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_performance_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Виджет производительности&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;performance&#39;</span><span class="p">,</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Производительность&#39;</span><span class="p">,</span>
            <span class="s1">&#39;charts&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;P&amp;L во времени&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="s1">&#39;profit_loss_history&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;x_axis&#39;</span><span class="p">:</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;y_axis&#39;</span><span class="p">:</span> <span class="s1">&#39;profit_loss&#39;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Сделки по дням&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="s1">&#39;trades_by_day&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;x_axis&#39;</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;y_axis&#39;</span><span class="p">:</span> <span class="s1">&#39;trade_count&#39;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;pie&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Распределение сделок&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="s1">&#39;trade_distribution&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Выигрышные&#39;</span><span class="p">,</span> <span class="s1">&#39;Проигрышные&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;winning_trades&#39;</span><span class="p">,</span> <span class="s1">&#39;losing_trades&#39;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_risk_metrics_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Виджет метрик риска&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;risk_metrics&#39;</span><span class="p">,</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Метрики риска&#39;</span><span class="p">,</span>
            <span class="s1">&#39;metrics&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Максимальная просадка&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;max_drawdown&#39;</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;percentage&#39;</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Sharpe Ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;number&#39;</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;VaR 95%&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;var_95&#39;</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;currency&#39;</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Текущая экспозиция&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;current_exposure&#39;</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;currency&#39;</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Использование риска&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;risk_utilization&#39;</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;percentage&#39;</span><span class="p">}</span>
            <span class="p">],</span>
            <span class="s1">&#39;charts&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Просадка во времени&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="s1">&#39;drawdown_history&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;x_axis&#39;</span><span class="p">:</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;y_axis&#39;</span><span class="p">:</span> <span class="s1">&#39;drawdown&#39;</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_system_health_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Виджет здоровья системы&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;system_health&#39;</span><span class="p">,</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Здоровье системы&#39;</span><span class="p">,</span>
            <span class="s1">&#39;metrics&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;CPU&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;cpu_usage&#39;</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;percentage&#39;</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Память&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;memory_usage&#39;</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;percentage&#39;</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Диск&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;disk_usage&#39;</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;percentage&#39;</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Задержка сети&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;network_latency&#39;</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;duration&#39;</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Ошибки API&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;error_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;percentage&#39;</span><span class="p">}</span>
            <span class="p">],</span>
            <span class="s1">&#39;charts&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;gauge&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Использование ресурсов&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="s1">&#39;resource_usage&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;max_value&#39;</span><span class="p">:</span> <span class="mi">100</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
</code></pre></div>

<h3 id="5_2">5. Анализ логов</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LogAnalyzer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Анализатор логов&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_patterns</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_patterns</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance_patterns</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Анализ логов&quot;&quot;&quot;</span>

        <span class="n">analysis_results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_errors</span><span class="p">(</span><span class="n">log_file</span><span class="p">),</span>
            <span class="s1">&#39;performance_issues&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_performance_issues</span><span class="p">(</span><span class="n">log_file</span><span class="p">),</span>
            <span class="s1">&#39;trading_patterns&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_trading_patterns</span><span class="p">(</span><span class="n">log_file</span><span class="p">),</span>
            <span class="s1">&#39;system_issues&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_system_issues</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">analysis_results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Анализ ошибок&quot;&quot;&quot;</span>

        <span class="n">error_patterns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">r</span><span class="s1">&#39;ERROR: (.+)&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;EXCEPTION: (.+)&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;CRITICAL: (.+)&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;Failed to (.+)&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;Connection error: (.+)&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;API error: (.+)&#39;</span>
        <span class="p">]</span>

        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">error_patterns</span><span class="p">:</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;line&#39;</span><span class="p">:</span> <span class="n">line_num</span><span class="p">,</span>
                            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_timestamp</span><span class="p">(</span><span class="n">line</span><span class="p">),</span>
                            <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">classify_error_severity</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                        <span class="p">})</span>

        <span class="k">return</span> <span class="n">errors</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_performance_issues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Анализ проблем производительности&quot;&quot;&quot;</span>

        <span class="n">performance_patterns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">r</span><span class="s1">&#39;Slow operation: (.+) took (\d+)ms&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;High memory usage: (\d+)MB&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;CPU spike detected: (\d+)%&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;Network timeout: (.+)&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;Database slow query: (.+)&#39;</span>
        <span class="p">]</span>

        <span class="n">performance_issues</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">performance_patterns</span><span class="p">:</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                        <span class="n">performance_issues</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;line&#39;</span><span class="p">:</span> <span class="n">line_num</span><span class="p">,</span>
                            <span class="s1">&#39;issue&#39;</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_timestamp</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        <span class="p">})</span>

        <span class="k">return</span> <span class="n">performance_issues</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_trading_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Анализ торговых паттернов&quot;&quot;&quot;</span>

        <span class="n">trading_patterns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">r</span><span class="s1">&#39;Trade executed: (.+)&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;Order placed: (.+)&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;Position opened: (.+)&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;Position closed: (.+)&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;Stop loss triggered: (.+)&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;Take profit triggered: (.+)&#39;</span>
        <span class="p">]</span>

        <span class="n">trading_events</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">trading_patterns</span><span class="p">:</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                        <span class="n">trading_events</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;line&#39;</span><span class="p">:</span> <span class="n">line_num</span><span class="p">,</span>
                            <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_timestamp</span><span class="p">(</span><span class="n">line</span><span class="p">),</span>
                            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">classify_trading_event</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                        <span class="p">})</span>

        <span class="k">return</span> <span class="n">trading_events</span>
</code></pre></div>

<h3 id="6_2">6. Отслеживание производительности</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PerformanceTracker</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Отслеживание производительности&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance_metrics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">benchmarks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimization_suggestions</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">track_performance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Отслеживание производительности&quot;&quot;&quot;</span>

        <span class="c1"># Расчет ключевых метрик</span>
        <span class="n">performance_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_performance_score</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>

        <span class="c1"># Сравнение с бенчмарками</span>
        <span class="n">benchmark_comparison</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compare_with_benchmarks</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>

        <span class="c1"># Генерация предложений по оптимизации</span>
        <span class="n">optimization_suggestions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_optimization_suggestions</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;performance_score&#39;</span><span class="p">:</span> <span class="n">performance_score</span><span class="p">,</span>
            <span class="s1">&#39;benchmark_comparison&#39;</span><span class="p">:</span> <span class="n">benchmark_comparison</span><span class="p">,</span>
            <span class="s1">&#39;optimization_suggestions&#39;</span><span class="p">:</span> <span class="n">optimization_suggestions</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_performance_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Расчет оценки производительности&quot;&quot;&quot;</span>

        <span class="c1"># Веса для различных метрик</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span>
            <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="mf">0.20</span><span class="p">,</span>
            <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span>
            <span class="s1">&#39;profit_loss&#39;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span>
            <span class="s1">&#39;trades_per_hour&#39;</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">,</span>
            <span class="s1">&#39;error_rate&#39;</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">,</span>
            <span class="s1">&#39;uptime&#39;</span><span class="p">:</span> <span class="mf">0.05</span>
        <span class="p">}</span>

        <span class="c1"># Нормализация метрик</span>
        <span class="n">normalized_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_metrics</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>

        <span class="c1"># Расчет взвешенной оценки</span>
        <span class="n">performance_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="n">normalized_metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">*</span> <span class="n">weight</span> 
            <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">weights</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">performance_score</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_optimization_suggestions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Генерация предложений по оптимизации&quot;&quot;&quot;</span>

        <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Анализ win rate</span>
        <span class="k">if</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;win_rate&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="s1">&#39;trading_strategy&#39;</span><span class="p">,</span>
                <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span>
                <span class="s1">&#39;suggestion&#39;</span><span class="p">:</span> <span class="s1">&#39;Низкий процент выигрышных сделок. Рассмотрите пересмотр торговой стратегии.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;analyze_losing_trades&#39;</span>
            <span class="p">})</span>

        <span class="c1"># Анализ просадки</span>
        <span class="k">if</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="s1">&#39;risk_management&#39;</span><span class="p">,</span>
                <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span>
                <span class="s1">&#39;suggestion&#39;</span><span class="p">:</span> <span class="s1">&#39;Высокая просадка. Улучшите управление рисками.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;reduce_position_sizes&#39;</span>
            <span class="p">})</span>

        <span class="c1"># Анализ ошибок</span>
        <span class="k">if</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error_rate&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.02</span><span class="p">:</span>
            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="s1">&#39;system_stability&#39;</span><span class="p">,</span>
                <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span>
                <span class="s1">&#39;suggestion&#39;</span><span class="p">:</span> <span class="s1">&#39;Высокий уровень ошибок. Проверьте стабильность системы.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;review_error_logs&#39;</span>
            <span class="p">})</span>

        <span class="c1"># Анализ производительности</span>
        <span class="k">if</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;trades_per_hour&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="s1">&#39;trading_activity&#39;</span><span class="p">,</span>
                <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span>
                <span class="s1">&#39;suggestion&#39;</span><span class="p">:</span> <span class="s1">&#39;Низкая торговая активность. Проверьте условия входа.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;review_entry_conditions&#39;</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">suggestions</span>
</code></pre></div>

<h3 id="7_1">7. Проверка здоровья системы</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">HealthChecker</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Проверка здоровья системы&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health_checks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health_status</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">perform_health_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_state</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Выполнение проверок здоровья&quot;&quot;&quot;</span>

        <span class="n">health_checks</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;bot_running&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_bot_running</span><span class="p">(</span><span class="n">system_state</span><span class="p">),</span>
            <span class="s1">&#39;api_connectivity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_api_connectivity</span><span class="p">(</span><span class="n">system_state</span><span class="p">),</span>
            <span class="s1">&#39;model_loaded&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_model_loaded</span><span class="p">(</span><span class="n">system_state</span><span class="p">),</span>
            <span class="s1">&#39;data_freshness&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_data_freshness</span><span class="p">(</span><span class="n">system_state</span><span class="p">),</span>
            <span class="s1">&#39;memory_usage&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_memory_usage</span><span class="p">(</span><span class="n">system_state</span><span class="p">),</span>
            <span class="s1">&#39;disk_space&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_disk_space</span><span class="p">(</span><span class="n">system_state</span><span class="p">),</span>
            <span class="s1">&#39;network_connectivity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_network_connectivity</span><span class="p">(</span><span class="n">system_state</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="c1"># Общий статус здоровья</span>
        <span class="n">overall_health</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_overall_health</span><span class="p">(</span><span class="n">health_checks</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;overall_health&#39;</span><span class="p">:</span> <span class="n">overall_health</span><span class="p">,</span>
            <span class="s1">&#39;individual_checks&#39;</span><span class="p">:</span> <span class="n">health_checks</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_bot_running</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_state</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Проверка работы бота&quot;&quot;&quot;</span>

        <span class="n">uptime</span> <span class="o">=</span> <span class="n">system_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uptime&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">last_activity</span> <span class="o">=</span> <span class="n">system_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_activity&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Бот считается работающим, если время работы &gt; 0 и последняя активность &lt; 5 минут</span>
        <span class="n">is_running</span> <span class="o">=</span> <span class="n">uptime</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_activity</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">300</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;healthy&#39;</span> <span class="k">if</span> <span class="n">is_running</span> <span class="k">else</span> <span class="s1">&#39;unhealthy&#39;</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Бот работает&#39;</span> <span class="k">if</span> <span class="n">is_running</span> <span class="k">else</span> <span class="s1">&#39;Бот не работает&#39;</span><span class="p">,</span>
            <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;uptime&#39;</span><span class="p">:</span> <span class="n">uptime</span><span class="p">,</span>
                <span class="s1">&#39;last_activity&#39;</span><span class="p">:</span> <span class="n">last_activity</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_api_connectivity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_state</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Проверка подключения к API&quot;&quot;&quot;</span>

        <span class="n">api_latency</span> <span class="o">=</span> <span class="n">system_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;api_latency&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">api_error_rate</span> <span class="o">=</span> <span class="n">system_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;api_error_rate&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># API считается здоровым, если задержка &lt; 1000ms и ошибок &lt; 5%</span>
        <span class="n">is_healthy</span> <span class="o">=</span> <span class="n">api_latency</span> <span class="o">&lt;</span> <span class="mi">1000</span> <span class="ow">and</span> <span class="n">api_error_rate</span> <span class="o">&lt;</span> <span class="mf">0.05</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;healthy&#39;</span> <span class="k">if</span> <span class="n">is_healthy</span> <span class="k">else</span> <span class="s1">&#39;unhealthy&#39;</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;API подключение стабильно&#39;</span> <span class="k">if</span> <span class="n">is_healthy</span> <span class="k">else</span> <span class="s1">&#39;Проблемы с API&#39;</span><span class="p">,</span>
            <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;latency&#39;</span><span class="p">:</span> <span class="n">api_latency</span><span class="p">,</span>
                <span class="s1">&#39;error_rate&#39;</span><span class="p">:</span> <span class="n">api_error_rate</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_model_loaded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_state</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Проверка загрузки модели&quot;&quot;&quot;</span>

        <span class="n">model_loaded</span> <span class="o">=</span> <span class="n">system_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_loaded&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">model_accuracy</span> <span class="o">=</span> <span class="n">system_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_accuracy&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Модель считается здоровой, если загружена и точность &gt; 0.7</span>
        <span class="n">is_healthy</span> <span class="o">=</span> <span class="n">model_loaded</span> <span class="ow">and</span> <span class="n">model_accuracy</span> <span class="o">&gt;</span> <span class="mf">0.7</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;healthy&#39;</span> <span class="k">if</span> <span class="n">is_healthy</span> <span class="k">else</span> <span class="s1">&#39;unhealthy&#39;</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Модель загружена и работает&#39;</span> <span class="k">if</span> <span class="n">is_healthy</span> <span class="k">else</span> <span class="s1">&#39;Проблемы с моделью&#39;</span><span class="p">,</span>
            <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;loaded&#39;</span><span class="p">:</span> <span class="n">model_loaded</span><span class="p">,</span>
                <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">model_accuracy</span>
            <span class="p">}</span>
        <span class="p">}</span>
</code></pre></div>

<h2 id="_395">Лучшие практики мониторинга</h2>
<h3 id="1_36">1. Настройка алертов</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AlertBestPractices</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Лучшие практики настройки алертов&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_hierarchy</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">escalation_rules</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">setup_alert_hierarchy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Настройка иерархии алертов&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alert_hierarchy</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;critical&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;response_time&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>  <span class="c1"># минут</span>
                <span class="s1">&#39;escalation_time&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>  <span class="c1"># минут</span>
                <span class="s1">&#39;channels&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;sms&#39;</span><span class="p">,</span> <span class="s1">&#39;phone&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;telegram&#39;</span><span class="p">],</span>
                <span class="s1">&#39;auto_actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;restart_bot&#39;</span><span class="p">,</span> <span class="s1">&#39;close_positions&#39;</span><span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;warning&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;response_time&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>  <span class="c1"># минут</span>
                <span class="s1">&#39;escalation_time&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>  <span class="c1"># минут</span>
                <span class="s1">&#39;channels&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;telegram&#39;</span><span class="p">],</span>
                <span class="s1">&#39;auto_actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;log_issue&#39;</span><span class="p">,</span> <span class="s1">&#39;notify_admin&#39;</span><span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;response_time&#39;</span><span class="p">:</span> <span class="mi">120</span><span class="p">,</span>  <span class="c1"># минут</span>
                <span class="s1">&#39;escalation_time&#39;</span><span class="p">:</span> <span class="mi">240</span><span class="p">,</span>  <span class="c1"># минут</span>
                <span class="s1">&#39;channels&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;telegram&#39;</span><span class="p">],</span>
                <span class="s1">&#39;auto_actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;log_event&#39;</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">setup_escalation_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Настройка правил эскалации&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">escalation_rules</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;no_response&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;condition&#39;</span><span class="p">:</span> <span class="s1">&#39;no_response_for_30_minutes&#39;</span><span class="p">,</span>
                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;escalate_to_manager&#39;</span><span class="p">,</span>
                <span class="s1">&#39;channels&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;phone&#39;</span><span class="p">,</span> <span class="s1">&#39;sms&#39;</span><span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;repeated_alerts&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;condition&#39;</span><span class="p">:</span> <span class="s1">&#39;same_alert_3_times_in_1_hour&#39;</span><span class="p">,</span>
                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;escalate_to_technical_lead&#39;</span><span class="p">,</span>
                <span class="s1">&#39;channels&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;phone&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;system_down&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;condition&#39;</span><span class="p">:</span> <span class="s1">&#39;bot_down_for_10_minutes&#39;</span><span class="p">,</span>
                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;escalate_to_emergency_contact&#39;</span><span class="p">,</span>
                <span class="s1">&#39;channels&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;phone&#39;</span><span class="p">,</span> <span class="s1">&#39;sms&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>
</code></pre></div>

<h3 id="2_33">2. Ротация логов</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LogRotation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ротация логов&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotation_config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compression_config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retention_config</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">setup_log_rotation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Настройка ротации логов&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rotation_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;max_size&#39;</span><span class="p">:</span> <span class="s1">&#39;100MB&#39;</span><span class="p">,</span>
            <span class="s1">&#39;max_files&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s1">&#39;rotation_time&#39;</span><span class="p">:</span> <span class="s1">&#39;daily&#39;</span><span class="p">,</span>
            <span class="s1">&#39;compression&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;retention_days&#39;</span><span class="p">:</span> <span class="mi">30</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rotate_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ротация логов&quot;&quot;&quot;</span>

        <span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">gzip</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

        <span class="c1"># Создание резервной копии</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S&#39;</span><span class="p">)</span>
        <span class="n">backup_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">log_file</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">log_file</span><span class="p">,</span> <span class="n">backup_file</span><span class="p">)</span>

        <span class="c1"># Сжатие старого лога</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_config</span><span class="p">[</span><span class="s1">&#39;compression&#39;</span><span class="p">]:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">backup_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_in</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">backup_file</span><span class="si">}</span><span class="s2">.gz&quot;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_out</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">f_out</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">backup_file</span><span class="p">)</span>
            <span class="n">backup_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">backup_file</span><span class="si">}</span><span class="s2">.gz&quot;</span>

        <span class="c1"># Очистка текущего лога</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># Удаление старых логов</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_old_logs</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">backup_file</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup_old_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Очистка старых логов&quot;&quot;&quot;</span>

        <span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

        <span class="n">log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
        <span class="n">log_pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">log_file</span><span class="si">}</span><span class="s2">.*&quot;</span>

        <span class="c1"># Получение всех логов</span>
        <span class="n">log_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">log_pattern</span><span class="p">)</span>

        <span class="c1"># Фильтрация по возрасту</span>
        <span class="n">cutoff_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">retention_config</span><span class="p">[</span><span class="s1">&#39;retention_days&#39;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">log_files</span><span class="p">:</span>
            <span class="n">file_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getctime</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">file_time</span> <span class="o">&lt;</span> <span class="n">cutoff_date</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</code></pre></div>

<h3 id="3_12">3. Метрики производительности</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PerformanceMetrics</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Метрики производительности&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_definitions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">benchmarks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sla_targets</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">define_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Определение метрик&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_definitions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;availability&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Доступность системы&#39;</span><span class="p">,</span>
                <span class="s1">&#39;calculation&#39;</span><span class="p">:</span> <span class="s1">&#39;uptime / total_time&#39;</span><span class="p">,</span>
                <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="mf">0.999</span><span class="p">,</span>  <span class="c1"># 99.9%</span>
                <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;percentage&#39;</span>
            <span class="p">},</span>
            <span class="s1">&#39;response_time&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Время отклика&#39;</span><span class="p">,</span>
                <span class="s1">&#39;calculation&#39;</span><span class="p">:</span> <span class="s1">&#39;average_response_time&#39;</span><span class="p">,</span>
                <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>  <span class="c1"># 1 секунда</span>
                <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;milliseconds&#39;</span>
            <span class="p">},</span>
            <span class="s1">&#39;error_rate&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Частота ошибок&#39;</span><span class="p">,</span>
                <span class="s1">&#39;calculation&#39;</span><span class="p">:</span> <span class="s1">&#39;errors / total_requests&#39;</span><span class="p">,</span>
                <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span>  <span class="c1"># 0.1%</span>
                <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;percentage&#39;</span>
            <span class="p">},</span>
            <span class="s1">&#39;throughput&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Пропускная способность&#39;</span><span class="p">,</span>
                <span class="s1">&#39;calculation&#39;</span><span class="p">:</span> <span class="s1">&#39;requests_per_second&#39;</span><span class="p">,</span>
                <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>  <span class="c1"># 100 RPS</span>
                <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;requests_per_second&#39;</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">setup_sla_targets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Настройка SLA целей&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sla_targets</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;availability&#39;</span><span class="p">:</span> <span class="mf">0.999</span><span class="p">,</span>  <span class="c1"># 99.9%</span>
            <span class="s1">&#39;response_time_p95&#39;</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span>  <span class="c1"># 2 секунды</span>
            <span class="s1">&#39;response_time_p99&#39;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span>  <span class="c1"># 5 секунд</span>
            <span class="s1">&#39;error_rate&#39;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span>  <span class="c1"># 0.1%</span>
            <span class="s1">&#39;data_freshness&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>  <span class="c1"># 5 минут</span>
            <span class="s1">&#39;model_accuracy&#39;</span><span class="p">:</span> <span class="mf">0.8</span>  <span class="c1"># 80%</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_sla_compliance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Расчет соответствия SLA&quot;&quot;&quot;</span>

        <span class="n">compliance</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sla_targets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">current_value</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;availability&#39;</span><span class="p">,</span> <span class="s1">&#39;model_accuracy&#39;</span><span class="p">]:</span>
                <span class="c1"># Для метрик &quot;больше лучше&quot;</span>
                <span class="n">compliance</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_value</span> <span class="o">&gt;=</span> <span class="n">target</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Для метрик &quot;меньше лучше&quot;</span>
                <span class="n">compliance</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_value</span> <span class="o">&lt;=</span> <span class="n">target</span>

        <span class="c1"># Общее соответствие SLA</span>
        <span class="n">overall_compliance</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">compliance</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;overall_compliance&#39;</span><span class="p">:</span> <span class="n">overall_compliance</span><span class="p">,</span>
            <span class="s1">&#39;individual_compliance&#39;</span><span class="p">:</span> <span class="n">compliance</span><span class="p">,</span>
            <span class="s1">&#39;sla_score&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">compliance</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">compliance</span><span class="p">)</span>
        <span class="p">}</span>
</code></pre></div>

<h2 id="_396">Автоматизация мониторинга</h2>
<h3 id="1_37">1. Автоматические действия</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AutomatedActions</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Автоматические действия&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action_rules</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action_history</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">setup_automated_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Настройка автоматических действий&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">action_rules</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;restart_bot&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;trigger&#39;</span><span class="p">:</span> <span class="s1">&#39;bot_down_for_5_minutes&#39;</span><span class="p">,</span>
                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_bot</span><span class="p">,</span>
                <span class="s1">&#39;max_attempts&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                <span class="s1">&#39;cooldown&#39;</span><span class="p">:</span> <span class="mi">300</span>  <span class="c1"># 5 минут</span>
            <span class="p">},</span>
            <span class="s1">&#39;close_all_positions&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;trigger&#39;</span><span class="p">:</span> <span class="s1">&#39;max_drawdown_exceeded&#39;</span><span class="p">,</span>
                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_all_positions</span><span class="p">,</span>
                <span class="s1">&#39;max_attempts&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;cooldown&#39;</span><span class="p">:</span> <span class="mi">0</span>
            <span class="p">},</span>
            <span class="s1">&#39;reduce_position_sizes&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;trigger&#39;</span><span class="p">:</span> <span class="s1">&#39;high_volatility_detected&#39;</span><span class="p">,</span>
                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce_position_sizes</span><span class="p">,</span>
                <span class="s1">&#39;max_attempts&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                <span class="s1">&#39;cooldown&#39;</span><span class="p">:</span> <span class="mi">3600</span>  <span class="c1"># 1 час</span>
            <span class="p">},</span>
            <span class="s1">&#39;retrain_model&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;trigger&#39;</span><span class="p">:</span> <span class="s1">&#39;model_drift_detected&#39;</span><span class="p">,</span>
                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrain_model</span><span class="p">,</span>
                <span class="s1">&#39;max_attempts&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;cooldown&#39;</span><span class="p">:</span> <span class="mi">86400</span>  <span class="c1"># 24 часа</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">execute_automated_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_name</span><span class="p">,</span> <span class="n">trigger_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Выполнение автоматического действия&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">action_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_rules</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">rule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_rules</span><span class="p">[</span><span class="n">action_name</span><span class="p">]</span>

        <span class="c1"># Проверка кулдауна</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_action_in_cooldown</span><span class="p">(</span><span class="n">action_name</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Проверка максимального количества попыток</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_action_attempts</span><span class="p">(</span><span class="n">action_name</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;max_attempts&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Выполнение действия</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">](</span><span class="n">trigger_data</span><span class="p">)</span>

            <span class="c1"># Запись в историю</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">action_history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">action_name</span><span class="p">,</span>
                <span class="s1">&#39;trigger&#39;</span><span class="p">:</span> <span class="n">trigger_data</span><span class="p">,</span>
                <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span>
                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="p">})</span>

            <span class="c1"># Установка кулдауна</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_action_cooldown</span><span class="p">(</span><span class="n">action_name</span><span class="p">,</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;cooldown&#39;</span><span class="p">])</span>

            <span class="k">return</span> <span class="n">result</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ошибка выполнения действия </span><span class="si">{</span><span class="n">action_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">restart_bot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trigger_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Перезапуск бота&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Остановка бота</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_bot</span><span class="p">()</span>

            <span class="c1"># Ожидание</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

            <span class="c1"># Запуск бота</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_bot</span><span class="p">()</span>

            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Бот перезапущен&#39;</span><span class="p">}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">close_all_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trigger_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Закрытие всех позиций&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Получение активных позиций</span>
            <span class="n">active_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_positions</span><span class="p">()</span>

            <span class="c1"># Закрытие позиций</span>
            <span class="n">closed_positions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">active_positions</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_position</span><span class="p">(</span><span class="n">position</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]:</span>
                    <span class="n">closed_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">position</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> 
                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Закрыто позиций: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">closed_positions</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;closed_positions&#39;</span><span class="p">:</span> <span class="n">closed_positions</span>
            <span class="p">}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
</code></pre></div>

<h3 id="2_34">2. Интеграция с внешними системами</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ExternalIntegrations</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Интеграция с внешними системами&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integrations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">webhook_endpoints</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">setup_integrations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Настройка интеграций&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">integrations</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;prometheus&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_prometheus_integration</span><span class="p">(),</span>
            <span class="s1">&#39;grafana&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_grafana_integration</span><span class="p">(),</span>
            <span class="s1">&#39;datadog&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_datadog_integration</span><span class="p">(),</span>
            <span class="s1">&#39;new_relic&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_new_relic_integration</span><span class="p">(),</span>
            <span class="s1">&#39;webhooks&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_webhook_integration</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">setup_prometheus_integration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Интеграция с Prometheus&quot;&quot;&quot;</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">prometheus_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">Histogram</span><span class="p">,</span> <span class="n">Gauge</span><span class="p">,</span> <span class="n">start_http_server</span>

        <span class="c1"># Метрики</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prometheus_metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;trades_total&#39;</span><span class="p">:</span> <span class="n">Counter</span><span class="p">(</span><span class="s1">&#39;trading_bot_trades_total&#39;</span><span class="p">,</span> <span class="s1">&#39;Total number of trades&#39;</span><span class="p">),</span>
            <span class="s1">&#39;profit_loss&#39;</span><span class="p">:</span> <span class="n">Gauge</span><span class="p">(</span><span class="s1">&#39;trading_bot_profit_loss&#39;</span><span class="p">,</span> <span class="s1">&#39;Current profit/loss&#39;</span><span class="p">),</span>
            <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="n">Gauge</span><span class="p">(</span><span class="s1">&#39;trading_bot_win_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;Current win rate&#39;</span><span class="p">),</span>
            <span class="s1">&#39;response_time&#39;</span><span class="p">:</span> <span class="n">Histogram</span><span class="p">(</span><span class="s1">&#39;trading_bot_response_time&#39;</span><span class="p">,</span> <span class="s1">&#39;Response time&#39;</span><span class="p">),</span>
            <span class="s1">&#39;error_rate&#39;</span><span class="p">:</span> <span class="n">Gauge</span><span class="p">(</span><span class="s1">&#39;trading_bot_error_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;Current error rate&#39;</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="c1"># Запуск HTTP сервера для метрик</span>
        <span class="n">start_http_server</span><span class="p">(</span><span class="mi">8000</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">setup_grafana_integration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Интеграция с Grafana&quot;&quot;&quot;</span>

        <span class="c1"># Настройка дашборда Grafana</span>
        <span class="n">grafana_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;datasource&#39;</span><span class="p">:</span> <span class="s1">&#39;prometheus&#39;</span><span class="p">,</span>
            <span class="s1">&#39;dashboard_url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://grafana:3000/d/trading-bot&#39;</span><span class="p">,</span>
            <span class="s1">&#39;panels&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Trading Performance&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;graph&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;targets&#39;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s1">&#39;trading_bot_profit_loss&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;trading_bot_win_rate&#39;</span>
                    <span class="p">]</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;System Health&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;singlestat&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;targets&#39;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s1">&#39;trading_bot_error_rate&#39;</span>
                    <span class="p">]</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">grafana_config</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">setup_webhook_integration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Интеграция с webhooks&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">webhook_endpoints</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;trading_events&#39;</span><span class="p">:</span> <span class="s1">&#39;https://api.example.com/webhooks/trading&#39;</span><span class="p">,</span>
            <span class="s1">&#39;system_alerts&#39;</span><span class="p">:</span> <span class="s1">&#39;https://api.example.com/webhooks/alerts&#39;</span><span class="p">,</span>
            <span class="s1">&#39;performance_reports&#39;</span><span class="p">:</span> <span class="s1">&#39;https://api.example.com/webhooks/performance&#39;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">send_webhook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Отправка webhook&quot;&quot;&quot;</span>

        <span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

        <span class="k">if</span> <span class="n">endpoint</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">webhook_endpoints</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">webhook_endpoints</span><span class="p">[</span><span class="n">endpoint</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ошибка отправки webhook: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>

<h2 id="_397">Заключение</h2>
<p>Мониторинг торгового бота - это критически важный аспект поддержания стабильной и прибыльной торговой системы. Следуя лучшим практикам, описанным в этом разделе, вы сможете:</p>
<ol>
<li><strong>Быстро выявлять проблемы</strong> - с помощью системы алертов и проверок здоровья</li>
<li><strong>Оптимизировать производительность</strong> - через анализ метрик и предложения по улучшению</li>
<li><strong>Обеспечивать непрерывную работу</strong> - с помощью автоматических действий и восстановления</li>
<li><strong>Интегрироваться с внешними системами</strong> - для расширенного мониторинга и анализа</li>
</ol>
<p>Помните: хороший мониторинг - это залог успешной торговой системы! 🚀</p>
    </div>
</body>
</html>